<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <!-- CONTINUA a usar o mesmo CSS global -->
  <link rel="stylesheet" href="./styles.css"/>
  <link rel="stylesheet" href="./css/base.css" />
  <title>EduSphere — Login do Aluno</title>

  <!-- Supabase (global UMD) + cliente do teu projeto -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
</head>

<!-- 1) TIRAR class="home" para não usar o fundo com foto -->
<body>
  <header>
    <div class="header-inner">
      <a class="logo" href="./index.html">
        <img src="/public/img/logo-icon.svg" alt="">
        <span>EduSphere</span>
      </a>
      <!-- sem links extra aqui; este ecrã é só login do aluno -->
    </div>
  </header>

  <!-- 2) REMOVER o .capa__overlay (não precisamos de overlay escuro) -->
  <!-- <div class="capa__overlay" aria-hidden="true"></div> -->

  <!-- 3) USAR O MESMO LAYOUT DO ADMIN -->
  <!--    main.admin-main + section.auth__panel.admin-login-card -->
  <main class="admin-main">
    <section class="auth__panel admin-login-card">
      <h1>Entrar (Aluno)</h1>
      <p class="auth__hint">As credenciais são criadas pelo teu explicador.</p>

      <form id="loginForm" class="auth__form">
        <input type="email" name="email" placeholder="Email do aluno" required />
        <input type="password" name="password" placeholder="Password" required />
        <button class="button" type="submit">Entrar</button>
        <div id="msg" class="auth__msg"></div>
      </form>

      <div class="auth__links">
        <a href="./index.html">Voltar</a>
      </div>
    </section>
  </main>

  <!-- 4) Footer igual ao admin (já tinhas praticamente isto) -->
  <footer>© <span id="y"></span> EduSphere</footer>

<script>
  // ano no footer (se tiveres um span com id="y")
  const y = document.getElementById('y');
  if (y) y.textContent = new Date().getFullYear();

  // LOGIN DO ALUNO
  document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const msg = document.getElementById('msg');
    if (msg) msg.textContent = '';

    const email = e.target.email.value.trim();
    const password = e.target.password.value;

    // 1) autenticar no Supabase
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      console.error(error);
      if (msg) msg.textContent = 'Credenciais inválidas.';
      return;
    }

    // 2) obter user atual
    const { data: { user } } = await supabase.auth.getUser();

    // 3) verificar papel em app_users
    const { data: profile, error: pErr } = await supabase
      .from('app_users')
      .select('role')
      .eq('user_id', user.id)
      .single();

    if (pErr || !profile) {
      if (msg) msg.textContent = 'Conta sem perfil associado.';
      await supabase.auth.signOut().catch(() => {});
      return;
    }

    if (profile.role !== 'aluno') {
      if (msg) msg.textContent = 'Esta página é só para Aluno.';
      await supabase.auth.signOut().catch(() => {});
      return;
    }

    // 4) verificar se o aluno está ativo na tabela alunos
    const { data: alunoRow, error: aErr } = await supabase
      .from('alunos')
      .select('is_active')
      .eq('user_id', user.id)
      .maybeSingle();

    if (aErr || !alunoRow) {
      if (msg) msg.textContent = 'Perfil de aluno não encontrado.';
      await supabase.auth.signOut().catch(() => {});
      return;
    }

    if (alunoRow.is_active === false) {
      if (msg) msg.textContent = 'A tua conta foi desativada. Fala com o teu explicador.';
      await supabase.auth.signOut().catch(() => {});
      return;
    }

    // 5) tudo ok → segue para ecrã do aluno
    location.href = './aluno.html';
  });
</script>

</body>
</html>
