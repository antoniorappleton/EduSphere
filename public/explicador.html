<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />
  <title>EduSphere — Área do Explicador</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./js/supabaseClient.js"></script>
  <script src="./js/auth.js"></script>
</head>
<body>
<header>
  <div class="header-inner">
    <a class="logo" href="./index.html">
      <img src="./img/logo-icon.svg" alt=""><span>EduSphere</span>
    </a>
    <nav>
      <a href="./aluno.html">Área Aluno</a>
      <a href="#" id="logout">Sair</a>
    </nav>
  </div>
</header>

<main>
  <div class="card">
    <h1>Dashboard Explicador</h1>
    <div id="kpis" style="display:flex; gap:12px; flex-wrap:wrap;">
      <div class="card" style="flex:1;">
        <h3>Previsto (mês atual)</h3>
        <p><strong id="prevAtual">—</strong> €</p>
      </div>
      <div class="card" style="flex:1;">
        <h3>Previsto (próximo mês)</h3>
        <p><strong id="prevProx">—</strong> €</p>
      </div>
      <div class="card" style="flex:1;">
        <h3>Realizado (mês atual)</h3>
        <p><strong id="realAtual">—</strong> €</p>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Os meus explicandos</h2>
    <table class="table" id="tabAlunos">
      <thead>
        <tr>
          <th>Nome</th><th>Idade</th><th>Ano</th><th>Dia</th><th>€/sessão</th><th>#/mês</th><th>Pai</th><th>Contacto</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Criar novo explicando</h2>
    <form id="fNovo">
      <div style="display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px;">
        <input name="nome" placeholder="Nome" required>
        <input name="apelido" placeholder="Apelido">
        <input name="idade" type="number" min="5" max="25" placeholder="Idade">
        <input name="ano" type="number" min="1" max="13" placeholder="Ano de escolaridade">
        <input name="contacto" placeholder="Contacto (aluno)">
        <input name="dia" placeholder="Dia semana (ex: Seg)">
        <input name="valor" type="number" step="0.01" placeholder="Valor € por sessão">
        <input name="sessoes" type="number" min="0" placeholder="# sessões/mês">
        <input name="pai" placeholder="Nome do pai/mãe (opcional)">
        <input name="cpai" placeholder="Contacto do pai/mãe (opcional)">
      </div>
      <button class="button" style="margin-top:10px">Criar explicando</button>
      <div id="novoMsg" style="margin-top:8px;"></div>
    </form>
  </div>

  <div class="card">
    <h2>Agendar explicação extra</h2>
    <form id="fExtra">
      <div style="display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:8px;">
        <input name="aluno_id" placeholder="ID do aluno (UUID)" required>
        <input name="data" type="date" required>
        <input name="hora" type="time" required>
        <input name="local" placeholder="Local">
      </div>
      <input name="preco" type="number" step="0.01" placeholder="Preço (€)" style="margin-top:8px;">
      <input name="detalhes" placeholder="Detalhes (opcional)" style="margin-top:8px;">
      <button class="button" style="margin-top:10px">Agendar</button>
      <div id="extraMsg" style="margin-top:8px;"></div>
    </form>
  </div>

  <div class="card">
    <h2>Enviar exercício</h2>
    <form id="fEx">
      <div style="display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px;">
        <input name="aluno_id" placeholder="ID do aluno (UUID)" required>
        <input name="nome" placeholder="Nome do exercício" required>
        <input name="ficheiro" type="file" required>
      </div>
      <button class="button" style="margin-top:10px">Upload</button>
      <div id="exMsg" style="margin-top:8px;"></div>
    </form>
  </div>
</main>

<script>
(async ()=>{
  // guardião
  const me = await getAppUser();
  if(!me || me.role !== 'explicador'){ location.href = './login.html'; return; }

  // KPIs previsto/realizado
  const { data: prevs } = await supabase
    .from('v_previsto_explicador')
    .select('*')
    .eq('id_explicador', me.explicador_id);

  const now = new Date();
  const mesAtual = String(now.getMonth()+1).padStart(2,'0')+'/'+now.getFullYear();
  const mesProxD = new Date(now.getFullYear(), now.getMonth()+1, 1);
  const mesProx = String(mesProxD.getMonth()+1).padStart(2,'0')+'/'+mesProxD.getFullYear();

  const prevAtual = (prevs||[]).find(x=>x.mes===mesAtual)?.previsto ?? 0;
  const prevProx  = (prevs||[]).find(x=>x.mes===mesProx )?.previsto ?? 0;

  const { data: reals } = await supabase
    .from('v_realizado_explicador')
    .select('*')
    .eq('id_explicador', me.explicador_id)
    .eq('mes', mesAtual);

  document.getElementById('prevAtual').textContent = Number(prevAtual).toFixed(2);
  document.getElementById('prevProx').textContent  = Number(prevProx).toFixed(2);
  document.getElementById('realAtual').textContent = Number((reals?.[0]?.realizado ?? 0)).toFixed(2);

  // Lista: os meus explicandos
  const { data: meus } = await supabase
    .from('v_meus_alunos').select('*')
    .eq('id_explicador', me.explicador_id)
    .order('nome', { ascending: true });

  const tbody = document.querySelector('#tabAlunos tbody');
  tbody.innerHTML = (meus||[]).map(a=>`
    <tr>
      <td>${a.nome} ${a.apelido??''}</td>
      <td>${a.idade??''}</td>
      <td>${a.ano_escolaridade??''}</td>
      <td>${a.dia_semana_preferido??''}</td>
      <td>${a.valor_explicacao??''}</td>
      <td>${a.sessoes_mes??''}</td>
      <td>${a.pai_nome ?? a.nome_pai_cache ?? ''}</td>
      <td>${a.pai_contacto ?? a.contacto_pai_cache ?? ''}</td>
    </tr>
  `).join('') || '<tr><td colspan="8">Sem explicandos ainda.</td></tr>';

  // Criar novo aluno (e ligar a mim)
  document.getElementById('fNovo').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const msg = document.getElementById('novoMsg');
    msg.textContent = '';
    const f = Object.fromEntries(new FormData(e.target).entries());
    try{
      // 1) cria aluno
      const { data: aIns, error: aErr } = await supabase.from('alunos').insert([{
        nome: f.nome, apelido: f.apelido||null, idade: f.idade? Number(f.idade): null,
        ano_escolaridade: f.ano? Number(f.ano): null, telemovel: f.contacto||null,
        dia_semana_preferido: f.dia||null, valor_explicacao: f.valor? Number(f.valor): null,
        sessoes_mes: f.sessoes? Number(f.sessoes): null,
        nome_pai_cache: f.pai||null, contacto_pai_cache: f.cpai||null
      }]).select('id_aluno').single();
      if(aErr) throw aErr;

      // 2) ligar ao meu explicador_id
      const { error: rErr } = await supabase.from('relacoes_aluno_explicador').insert([{
        id_aluno: aIns.id_aluno, id_explicador: me.explicador_id
      }]);
      if(rErr) throw rErr;

      msg.style.color = '#126b3a';
      msg.textContent = 'Explicando criado e associado com sucesso.';
      e.target.reset();
    }catch(err){
      msg.style.color = '#a92a1f';
      msg.textContent = err.message;
    }
  });

  // Agendar extra
  document.getElementById('fExtra').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const msg = document.getElementById('extraMsg');
    msg.textContent = '';
    const f = Object.fromEntries(new FormData(e.target).entries());
    try{
      const { error } = await supabase.from('explicacoes').insert([{
        id_aluno: f.aluno_id, data: f.data, hora: f.hora,
        local: f.local||null, detalhes: f.detalhes||null,
        preco: f.preco? Number(f.preco): 0
      }]);
      if(error) throw error;
      msg.style.color = '#126b3a';
      msg.textContent = 'Explicação extra agendada.';
      e.target.reset();
    }catch(err){
      msg.style.color = '#a92a1f';
      msg.textContent = err.message;
    }
  });

  // Enviar exercício
  document.getElementById('fEx').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const msg = document.getElementById('exMsg');
    msg.textContent = '';
    const fd = new FormData(e.target);
    const aluno_id = fd.get('aluno_id');
    const nome = fd.get('nome');
    const file = fd.get('ficheiro');

    try{
      const id_exercicio = crypto.randomUUID();
      const safe = file.name.replace(/\s+/g,'_');
      const path = `${aluno_id}/${id_exercicio}/${safe}`;

      const { error: upErr } = await supabase.storage.from('exercicios').upload(path, file);
      if(upErr) throw upErr;

      const pub = supabase.storage.from('exercicios').getPublicUrl(path);
      const url = pub?.data?.publicUrl || path; // se for privado, ficarás com o path

      const { error: insErr } = await supabase.from('exercicios').insert([{
        id_aluno: aluno_id, nome, tipo: file.type||'file', url
      }]);
      if(insErr) throw insErr;

      msg.style.color = '#126b3a';
      msg.textContent = 'Exercício enviado.';
      e.target.reset();
    }catch(err){
      msg.style.color = '#a92a1f';
      msg.textContent = err.message;
    }
  });

  document.getElementById('logout').addEventListener('click', async (e)=>{
    e.preventDefault();
    await signOut(); location.href = './login.html';
  });
})();
</script>
</body>
</html>
