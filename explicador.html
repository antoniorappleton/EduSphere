<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="./styles.css"/>
  <title>EduSphere ‚Äî Explicador</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
</head>

<body class="home">
<header>
  <div class="header-inner">
    <a class="logo" href="./index.html">
      <img src="/public/img/logo-icon.svg" alt="">
      <span>EduSphere</span>
    </a>

    <!-- NAV PRINCIPAL DO PAINEL (tabs) ‚Äì s√≥ aparece depois do login -->
    <nav id="explHeaderNav" class="expl-main-nav" style="display:none">
      <button class="expl-nav-btn expl-nav-btn--active" data-target="dashboard">Dashboard</button>
      <button class="expl-nav-btn" data-target="alunos">Alunos</button>
      <button class="expl-nav-btn" data-target="calendario">Calend√°rio</button>
      <button class="expl-nav-btn" data-target="faturacao">Fatura√ß√£o</button>
      <button class="expl-nav-btn" data-target="relatorios">Relat√≥rios</button>
    </nav>

    <button id="btnLogout" class="button" style="margin-left:auto; display:none">Sair</button>
  </div>
</header>

<div class="capa__overlay"></div>

<main class="auth">

  <!-- ========== LOGIN DO EXPLICADOR ========== -->
  <section class="auth__panel" id="explLogin">
    <h1>Entrar (Explicador)</h1>
    <p class="auth__hint">Use as credenciais de professor para aceder ao painel.</p>
    <form id="fExplLogin" class="auth__form" autocomplete="on">
      <input type="email"   name="email"    placeholder="Email"    required />
      <input type="password"name="password" placeholder="Password" required />
      <button class="button" type="submit">Entrar</button>
      <div id="msgExplLogin" class="auth__msg"></div>
    </form>
  </section>

  <!-- ========== PAINEL DO EXPLICADOR (FULL PAGE) ========== -->
  <section id="explPanel" class="expl-shell" style="display:none">
    <!-- Header do painel -->
    <header class="expl-header-bar">
      <div class="expl-header-info">
        <p class="expl-hello">
          Ol√°, <span id="expl-nome-header">Professor</span>
        </p>
        <p class="expl-hello-sub">Aqui est√° o resumo da sua atividade.</p>
      </div>

      <div class="expl-header-user">
        <button class="expl-bell" aria-label="Notifica√ß√µes">
          <span class="expl-bell-icon">üîî</span>
          <span class="expl-bell-badge" id="expl-notif-count">0</span>
        </button>
        <div class="expl-header-avatar">
          <div class="expl-avatar-circle">Foto</div>
          <div class="expl-header-name">
            <p id="expl-nome-mini">Professor</p>
            <span>Explicador</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Conte√∫do -->
    <div class="expl-body">

      <!-- DASHBOARD / FATURA√á√ÉO -->
      <section class="expl-section" id="expl-sec-dashboard">
        <h2 class="expl-section-title">Resumo financeiro</h2>
        <div class="expl-cards">
          <article class="expl-card">
            <p class="expl-card-label">Total faturado (este m√™s)</p>
            <p class="expl-card-value" id="card-total-mes">‚Ç¨ 0,00</p>
          </article>

          <article class="expl-card">
            <p class="expl-card-label">Mensalidades pendentes</p>
            <p class="expl-card-value expl-card-value--warning" id="card-pendentes">
              ‚Ç¨ 0,00
            </p>
          </article>

          <article class="expl-card">
            <p class="expl-card-label">Pagamentos recebidos</p>
            <p class="expl-card-value expl-card-value--success" id="card-recebidos">
              0 / 0
            </p>
          </article>
        </div>
                <!-- Tabelas de previsto vs realizado -->
        <div class="expl-grid-2" style="margin-top:1.5rem;">
          <!-- Por aluno -->
          <article class="expl-card">
            <h3 class="expl-subsection-title">
              Previsto vs realizado por aluno (ano atual)
            </h3>
            <div class="table-wrapper">
              <table class="table" id="tblPrevRealAlunos">
                <thead>
                  <tr>
                    <th>Aluno</th>
                    <th>Previsto (‚Ç¨)</th>
                    <th>Realizado (‚Ç¨)</th>
                    <th>% Cobran√ßa</th>
                    <th>Em falta (‚Ç¨)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="5">Sem dados de fatura√ß√£o ainda.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </article>

          <!-- Por grupo (ano de escolaridade) -->
          <article class="expl-card">
            <h3 class="expl-subsection-title">
              Previsto vs realizado por ano de escolaridade
            </h3>
            <div class="table-wrapper">
              <table class="table" id="tblPrevRealGrupos">
                <thead>
                  <tr>
                    <th>Ano</th>
                    <th>Previsto (‚Ç¨)</th>
                    <th>Realizado (‚Ç¨)</th>
                    <th>% Cobran√ßa</th>
                    <th>Em falta (‚Ç¨)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="5">Sem dados de fatura√ß√£o ainda.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </article>
        </div>

      </section>

      <!-- ALUNOS -->
      <section class="expl-section" id="expl-sec-alunos">
        <div class="expl-section-header">
          <h2 class="expl-section-title">Meus Alunos</h2>
          <button class="expl-link-button" type="button" id="btn-scroll-lista">
            Ver lista
          </button>
        </div>

        <div class="expl-grid-2">
          <!-- Quota + a√ß√µes -->
          <div class="expl-card">
            <h3 class="expl-subsection-title">Quota de alunos</h3>
            <div class="expl-quota">
              <p><strong>Limite:</strong> <span id="limite">‚Äî</span></p>
              <p><strong>Ativos:</strong> <span id="contagem">0</span></p>
              <p><strong>Restantes:</strong> <span id="restantes">‚Äî</span></p>
            </div>

            <h3 class="expl-subsection-title" style="margin-top:1rem;">A√ß√µes r√°pidas</h3>
            <div class="expl-actions-row">
              <button class="button secondary" type="button" id="btn-open-add-aluno">
                + Adicionar aluno
              </button>
              <!-- futuros bot√µes: Emitir fatura, Registar pagamento -->
            </div>
          </div>

          <!-- Lista de alunos -->
          <div class="expl-card" id="lista-alunos-card">
            <h3 class="expl-subsection-title">Lista de alunos</h3>
            <div class="table-wrapper">
              <table class="table" id="tblAlunos">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Ano</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
                    <!-- Painel de detalhes do aluno (aparece ao clicar numa linha) -->
      <div class="expl-card expl-aluno-detail" id="aluno-detail-card" style="margin-top:1.5rem; display:none">
        <h3 class="expl-subsection-title">
          Detalhes do aluno:
          <span id="aluno-detail-nome" class="expl-aluno-detail__nome">‚Äî</span>
        </h3>

        <p id="aluno-detail-meta" class="expl-aluno-detail__meta"></p>

        <div class="expl-grid-2">
          <div>
            <h4 class="expl-subsection-title">Informa√ß√£o b√°sica</h4>
            <ul class="expl-detail-list">
              <li><strong>Email:</strong> <span id="aluno-detail-email">‚Äî</span></li>
              <li><strong>Telem√≥vel:</strong> <span id="aluno-detail-tel">‚Äî</span></li>
              <li><strong>Ano:</strong> <span id="aluno-detail-ano">‚Äî</span></li>
              <li><strong>Valor explica√ß√£o:</strong> <span id="aluno-detail-valor">‚Äî</span></li>
              <li><strong>Sess√µes / m√™s:</strong> <span id="aluno-detail-sessoes">‚Äî</span></li>
            </ul>
          </div>

          <div>
            <h4 class="expl-subsection-title">Resumo de mensalidades</h4>
            <ul class="expl-detail-list">
              <li><strong>Valor previsto (m√™s atual):</strong> <span id="aluno-detail-previsto-mes">‚Äî</span></li>
              <li><strong>Valor pago (m√™s atual):</strong> <span id="aluno-detail-pago-mes">‚Äî</span></li>
              <li><strong>Em falta (total):</strong> <span id="aluno-detail-emfalta">‚Äî</span></li>
            </ul>
          </div>
        </div>
      </div>
      </section>

      <!-- CALEND√ÅRIO + RELAT√ìRIOS -->
      <section class="expl-section expl-grid-2" id="expl-sec-outros">
        <div id="expl-sec-calendario">
          <h2 class="expl-section-title">Calend√°rio</h2>
          <div class="expl-card expl-placeholder">
            <p>Calend√°rio de explica√ß√µes (a integrar).</p>
          </div>
        </div>

        <div id="expl-sec-relatorios">
          <h2 class="expl-section-title">Relat√≥rios</h2>
          <div class="expl-card expl-placeholder">
            <p>Gr√°ficos de fatura√ß√£o e alunos ativos (a integrar).</p>
          </div>
        </div>
      </section>

    </div>

    <!-- Bot√£o flutuante -->
    <button class="expl-fab" id="btn-add-aluno" type="button">+</button>
  </section>
</main>

<footer>¬© <span id="y"></span> EduSphere</footer>

<!-- ========== MODAL: ADICIONAR ALUNO ========== -->
<div class="modal" id="modal-add-aluno">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2>Novo aluno</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint">Preencha os dados do aluno para criar a conta de acesso.</p>
    <form id="fNewAluno" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input name="nome" placeholder="Nome do aluno" required />
        <input name="apelido" placeholder="Apelido (opcional)" />

        <input name="telemovel" placeholder="Telem√≥vel (opcional)" />
        <input type="number" name="ano" placeholder="Ano de escolaridade" />

        <input type="number" name="idade" placeholder="Idade (opcional)" />

        <input name="dia_semana_preferido" placeholder="Dia preferido (ex.: Segunda)" />

        <input type="number" step="0.01" name="valor_explicacao" placeholder="Valor por explica√ß√£o (‚Ç¨)" />
        <input type="number" name="sessoes_mes" placeholder="Sess√µes por m√™s" />

        <input name="nome_pai_cache" placeholder="Nome do encarregado de educa√ß√£o" />
        <input name="contacto_pai_cache" placeholder="Contacto do encarregado" />

        <input type="email" name="email" placeholder="Email (login do aluno)" required />
        <input name="username" placeholder="Username (opcional)" />

        <input type="password" name="password" placeholder="Password" minlength="6" required />
      </div>

      <button id="btnCreateAluno" class="button" type="submit">Criar Aluno</button>
      <div id="msgNewAluno" class="auth__msg"></div>
    </form>


  </div>
</div>

<script>
  const $  = (s) => document.querySelector(s);
  const elYear      = $('#y');
  const btnLogout   = $('#btnLogout');
  const headerNav   = $('#explHeaderNav');
  const loginBox    = $('#explLogin');
  const panel       = $('#explPanel');
  const msgLogin    = $('#msgExplLogin');
  const formLogin   = $('#fExplLogin');

  const tblBody     = $('#tblAlunos tbody');
  const elLimite    = $('#limite');
  const elContagem  = $('#contagem');
  const elRestantes = $('#restantes');

  const elNomeHeader = $('#expl-nome-header');
  const elNomeMini   = $('#expl-nome-mini');

  const btnFab          = $('#btn-add-aluno');
  const btnOpenAddAluno = $('#btn-open-add-aluno');
  const btnScrollLista  = $('#btn-scroll-lista');

  const modalAddAluno   = $('#modal-add-aluno');
  const formNew         = $('#fNewAluno');
  const msgNewAluno     = $('#msgNewAluno');
  const btnCreate       = $('#btnCreateAluno');

  elYear.textContent = new Date().getFullYear();

  let EXPLICADOR = { userId:null, id_explicador:null, max:0 };
  let ALUNOS_CACHE = []; // cache dos alunos carregados para permitir clique e detalhes
  let PAGAMENTOS_CACHE = [];

  // ---------- helpers supabase ----------
  async function hasRole(uid, roleName){
    const { data, error } = await supabase
      .from('app_users')
      .select('role')
      .eq('user_id', uid)
      .eq('role', roleName)
      .maybeSingle();
    if (error) {
      console.error('hasRole error', error);
      return false;
    }
    return !!data;
  }

  async function getExplRow(uid){
    const { data, error } = await supabase
      .from('explicadores')
      .select('id_explicador, nome, apelido, max_alunos')
      .eq('user_id', uid)
      .maybeSingle();
    if (error) throw error;
    return data || null;
  }


  function setState({ loading=false, isExpl=false, isAuthed=false }){
    if (loading){
      loginBox.style.display = 'block';
      panel.style.display    = 'none';
      msgLogin.textContent   = 'A verificar sess√£o...';
      btnLogout.style.display = 'none';
      headerNav.style.display = 'none';
      return;
    }
    if (isAuthed && isExpl){
      loginBox.style.display = 'none';
      panel.style.display    = 'block';
      msgLogin.textContent   = '';
      btnLogout.style.display= 'inline-block';
      headerNav.style.display= 'flex';
      document.querySelector('main.auth').style.display = 'block';
    } else {
      loginBox.style.display = 'block';
      panel.style.display    = 'none';
      btnLogout.style.display= 'none';
      headerNav.style.display= 'none';
      document.querySelector('main.auth').style.display = 'grid';
    }
  }

  // ---------- Painel de detalhes por aluno ----------
  async function mostrarPainelAluno(aluno) {
  const card = document.getElementById("aluno-detail-card");
  if (!card) return;

  const nomeCompleto = [aluno.nome, aluno.apelido].filter(Boolean).join(" ");
  document.getElementById("aluno-detail-nome").textContent =
    nomeCompleto || "Aluno";

  document.getElementById("aluno-detail-meta").textContent =
    aluno.username ? `Username: ${aluno.username}` : "";

  document.getElementById("aluno-detail-email").textContent =
    aluno.email || "‚Äî";
  document.getElementById("aluno-detail-tel").textContent =
    aluno.telemovel || "‚Äî";
  document.getElementById("aluno-detail-ano").textContent =
    aluno.ano ?? "‚Äî";

  const valorExp =
    aluno.valor_explicacao != null
      ? `‚Ç¨ ${Number(aluno.valor_explicacao).toFixed(2)}`
      : "‚Äî";
  document.getElementById("aluno-detail-valor").textContent = valorExp;

  const sessoes =
    aluno.sessoes_mes != null ? String(aluno.sessoes_mes) : "‚Äî";
  document.getElementById("aluno-detail-sessoes").textContent = sessoes;

  // mostrar card
  card.style.display = "block";

  // ---- carregar resumo de pagamentos deste aluno ----
  if (!EXPLICADOR.id_explicador) return;

  const elPrevistoMes = document.getElementById("aluno-detail-previsto-mes");
  const elPagoMes     = document.getElementById("aluno-detail-pago-mes");
  const elEmFalta     = document.getElementById("aluno-detail-emfalta");

  try {
    const now = new Date();
    const anoAtual = now.getFullYear();
    const mesAtual = now.getMonth() + 1;

    const { data, error } = await supabase
      .from("v_pagamentos_detalhe")
      .select("ano, mes, valor_previsto, valor_pago, estado")
      .eq("id_explicador", EXPLICADOR.id_explicador)
      .eq("id_aluno", aluno.id_aluno);

    if (error) {
      console.error("Erro a carregar pagamentos do aluno", error);
      if (elPrevistoMes) elPrevistoMes.textContent = "‚Äî";
      if (elPagoMes)     elPagoMes.textContent     = "‚Äî";
      if (elEmFalta)     elEmFalta.textContent     = "‚Äî";
      return;
    }

    let previstoMes = 0;
    let pagoMes     = 0;
    let emFaltaTotal = 0;

    (data || []).forEach((p) => {
      const previsto = Number(p.valor_previsto) || 0;
      const pago     = Number(p.valor_pago) || 0;
      const falta    = Math.max(previsto - pago, 0);

      if (p.ano === anoAtual && p.mes === mesAtual) {
        previstoMes += previsto;
        pagoMes     += pago;
      }

      emFaltaTotal += falta;
    });

    // Fallback: se ainda n√£o h√° registos em pagamentos, estima a mensalidade
    // com base em valor_explicacao * sessoes_mes
    if ((!data || data.length === 0) &&
        aluno.valor_explicacao != null &&
        aluno.sessoes_mes != null) {

      const estimado = Number(aluno.valor_explicacao) * Number(aluno.sessoes_mes);

      previstoMes   = estimado;
      pagoMes       = 0;
      emFaltaTotal  = estimado;
    }

    if (elPrevistoMes) {
      elPrevistoMes.textContent = `‚Ç¨ ${previstoMes.toFixed(2)}`;
    }
    if (elPagoMes) {
      elPagoMes.textContent     = `‚Ç¨ ${pagoMes.toFixed(2)}`;
    }
    if (elEmFalta) {
      elEmFalta.textContent     = `‚Ç¨ ${emFaltaTotal.toFixed(2)}`;
    }
  } catch (err) {
    console.error("Erro inesperado ao calcular resumo do aluno", err);
  }
}

  // ---------- quota UI ----------
  function updateQuotaUI(total){
    const max = Number(EXPLICADOR.max || 0);
    elContagem.textContent = String(total);

    if (!max){
      elLimite.textContent    = 'Sem limite';
      elRestantes.textContent = '‚Äî';
      btnCreate && (btnCreate.disabled = false);
      return;
    }
    elLimite.textContent = String(max);
    const rest = Math.max(0, max - total);
    elRestantes.textContent = String(rest);
    if (btnCreate){
      btnCreate.disabled = rest <= 0;
      btnCreate.title    = rest <= 0 ? 'Limite de alunos atingido.' : '';
    }
  }
  // ---------- LISTAR ALUNOS via Edge Function ----------
  async function loadAlunos() {
    const { data, error } = await supabase.functions.invoke("expl-alunos", {
      body: { action: "list_alunos" },
    });

    if (error) {
      console.error("loadAlunos error", error);
      tblBody.innerHTML =
        '<tr><td colspan="3">Erro a carregar alunos.</td></tr>';
      updateQuotaUI(0);
      return;
    }

    if (!data || !data.length) {
      tblBody.innerHTML =
        '<tr><td colspan="3">Sem alunos ainda.</td></tr>';
      ALUNOS_CACHE = [];
      updateQuotaUI(0);
      return;
    }

    // guardar em cache para o painel de detalhes
    ALUNOS_CACHE = data;

    tblBody.innerHTML = data
      .map((a) => {
        const nome = [a.nome, a.apelido].filter(Boolean).join(" ");
        const valor =
          a.valor_explicacao != null
            ? Number(a.valor_explicacao).toFixed(2)
            : "-";
        const sessoes = a.sessoes_mes != null ? a.sessoes_mes : "-";

        return `
          <tr class="linha-aluno" data-id-aluno="${a.id_aluno}">
            <td>${nome || "-"}</td>
            <td>${a.email ?? "-"}</td>
            <td>${a.ano ?? "-"}</td>
          </tr>
        `;
      })
      .join("");

    // atualizar quota com o n¬∫ de alunos
    updateQuotaUI(data.length);

    // ligar clique para abrir painel de detalhes do aluno
    tblBody
      .querySelectorAll("tr.linha-aluno")
      .forEach((row) => {
        row.addEventListener("click", () => {
          const idAluno = row.dataset.idAluno;
          const aluno = ALUNOS_CACHE.find((a) => a.id_aluno === idAluno);
          if (aluno) {
            mostrarPainelAluno(aluno);
          }
        });
      });
  }

  // ---------- KPI financeiros (cards do dashboard) ----------
  async function loadKpisFinanceiros() {
    if (!EXPLICADOR.id_explicador) return;

    const cardTotalMes  = document.getElementById("card-total-mes");
    const cardPendentes = document.getElementById("card-pendentes");
    const cardRecebidos = document.getElementById("card-recebidos");

    try {
      const { data, error } = await supabase
        .from("v_pagamentos_detalhe")
        .select("ano, mes, id_aluno, aluno_nome, valor_previsto, valor_pago, estado")
        .eq("id_explicador", EXPLICADOR.id_explicador);

      if (error) {
        console.error("Erro a carregar KPI financeiros", error);
        return;
      }

      // guardar em cache para outras vis√µes (por aluno / por grupo)
      PAGAMENTOS_CACHE = data || [];

      const now = new Date();
      const anoAtual = now.getFullYear();
      const mesAtual = now.getMonth() + 1;

      // Acumuladores
      let previstoMesAtual    = 0;
      let realizadoMesAtual   = 0;
      let previstoAnoAtual    = 0;
      let realizadoAnoAtual   = 0;
      let pendenteTotal       = 0;
      let totalMensalidadesMes = 0;
      let mensalidadesPagasMes = 0;

      const alunosComPendencias = new Set();

      (PAGAMENTOS_CACHE).forEach((p) => {
        const previsto = Number(p.valor_previsto) || 0;
        const pago     = Number(p.valor_pago) || 0;
        const falta    = Math.max(previsto - pago, 0);

        // Fatura√ß√£o anual (prevista vs realizada)
        if (p.ano === anoAtual) {
          previstoAnoAtual  += previsto;
          realizadoAnoAtual += pago;
        }

        // Fatura√ß√£o mensal (m√™s corrente)
        if (p.ano === anoAtual && p.mes === mesAtual) {
          previstoMesAtual  += previsto;
          realizadoMesAtual += pago;
          totalMensalidadesMes++;
          if (p.estado === "PAGO" && previsto > 0) {
            mensalidadesPagasMes++;
          }
        }

        // Pendentes + alunos em falta
        pendenteTotal += falta;
        if (falta > 0 && p.id_aluno) {
          alunosComPendencias.add(p.id_aluno);
        }
      });

      // ---- Card 1: Total faturado (este m√™s) ----
      if (cardTotalMes) {
        cardTotalMes.textContent =
          `‚Ç¨ ${realizadoMesAtual.toFixed(2)} de ‚Ç¨ ${previstoMesAtual.toFixed(2)}`;
        cardTotalMes.title =
          `Previsto para este m√™s: ‚Ç¨ ${previstoMesAtual.toFixed(2)} ¬∑ ` +
          `Realizado: ‚Ç¨ ${realizadoMesAtual.toFixed(2)}`;
      }

      // ---- Card 2: Mensalidades pendentes ----
      if (cardPendentes) {
        const nAlunosPend = alunosComPendencias.size;
        const labelAlunos =
          nAlunosPend === 0
            ? "Nenhum aluno em falta"
            : nAlunosPend === 1
            ? "1 aluno em falta"
            : `${nAlunosPend} alunos em falta`;

        cardPendentes.textContent =
          `‚Ç¨ ${pendenteTotal.toFixed(2)} (${labelAlunos})`;
        cardPendentes.title =
          "Valor total ainda por receber (todas as mensalidades com PARCIAL ou EM_ATRASO).";
      }

      // ---- Card 3: Pagamentos recebidos ----
      const taxaCobrancaAno =
        previstoAnoAtual > 0
          ? (realizadoAnoAtual / previstoAnoAtual) * 100
          : 0;

      if (cardRecebidos) {
        const baseMes =
          totalMensalidadesMes > 0
            ? `${mensalidadesPagasMes} / ${totalMensalidadesMes}`
            : "0 / 0";

        cardRecebidos.textContent =
          `${baseMes} (${taxaCobrancaAno.toFixed(0)}%)`;
        cardRecebidos.title =
          `Taxa de cobran√ßa anual: ${taxaCobrancaAno.toFixed(
            1
          )}% (realizado vs previsto).`;
      }

      // depois de ter a cache preenchida, desenhar tabelas previsto vs realizado
      renderPrevistoRealizado();
    } catch (err) {
      console.error("Erro inesperado em loadKpisFinanceiros", err);
    }
  }

  // ---------- Tabelas de Previsto vs Realizado (por aluno e por grupo) ----------
  function renderPrevistoRealizado() {
  const tbodyAlunos = document.querySelector("#tblPrevRealAlunos tbody");
  const tbodyGrupos = document.querySelector("#tblPrevRealGrupos tbody");

  if (!tbodyAlunos || !tbodyGrupos) return;

  const now = new Date();
  const anoAtual = now.getFullYear();

  // --- 1) Agrega√ß√£o por aluno (ano atual) ---
  const porAluno = new Map(); // key: id_aluno -> { nome, previsto, pago }

  (PAGAMENTOS_CACHE || []).forEach((p) => {
    if (p.ano !== anoAtual) return;

    const id = p.id_aluno;
    if (!id) return;

    const previsto = Number(p.valor_previsto) || 0;
    const pago     = Number(p.valor_pago) || 0;

    if (!porAluno.has(id)) {
      porAluno.set(id, {
        id_aluno: id,
        nome: p.aluno_nome || "Aluno",
        previsto: 0,
        pago: 0,
      });
    }
    const reg = porAluno.get(id);
    reg.previsteo;
    reg.previsto += previsto;
    reg.pago     += pago;
  });

  // se n√£o houver dados, mostra mensagem amig√°vel
  if (!porAluno.size) {
    tbodyAlunos.innerHTML =
      '<tr><td colspan="5">Ainda n√£o existem registos de fatura√ß√£o para este ano.</td></tr>';
    tbodyGrupos.innerHTML =
      '<tr><td colspan="5">Ainda n√£o existem registos de fatura√ß√£o para este ano.</td></tr>';
    return;
  }

  // ordenar alunos pelo previsto (descendente)
  const listaAlunos = Array.from(porAluno.values()).sort(
    (a, b) => b.previsto - a.previsto
  );

  tbodyAlunos.innerHTML = listaAlunos
    .map((a) => {
      const falta = Math.max(a.previsto - a.pago, 0);
      const perc  = a.previsto > 0 ? (a.pago / a.previsto) * 100 : 0;

      return `
        <tr>
          <td>${a.nome}</td>
          <td>‚Ç¨ ${a.previsto.toFixed(2)}</td>
          <td>‚Ç¨ ${a.pago.toFixed(2)}</td>
          <td>${perc.toFixed(0)}%</td>
          <td>‚Ç¨ ${falta.toFixed(2)}</td>
        </tr>
      `;
    })
    .join("");

  // --- 2) Agrega√ß√£o por grupo (ano de escolaridade) ---
  // usa ALUNOS_CACHE para saber o ano de cada aluno
  const anoPorAluno = new Map();
  (ALUNOS_CACHE || []).forEach((al) => {
    if (al.id_aluno) {
      anoPorAluno.set(al.id_aluno, al.ano ?? al.ano_escolaridade ?? "‚Äî");
    }
  });

  const porGrupo = new Map(); // key: ano -> { ano, previsto, pago }

  listaAlunos.forEach((a) => {
    const anoEsc = anoPorAluno.get(a.id_aluno) ?? "‚Äî";
    if (!porGrupo.has(anoEsc)) {
      porGrupo.set(anoEsc, {
        ano: anoEsc,
        previsto: 0,
        pago: 0,
      });
    }
    const g = porGrupo.get(anoEsc);
    g.previsto += a.previsto;
    g.pago     += a.pago;
  });

  const listaGrupos = Array.from(porGrupo.values()).sort((a, b) => {
    // ordenar por ano num√©rico quando poss√≠vel
    const na = Number(a.ano);
    const nb = Number(b.ano);
    if (!isNaN(na) && !isNaN(nb)) return na - nb;
    return String(a.ano).localeCompare(String(b.ano));
  });

  tbodyGrupos.innerHTML = listaGrupos
    .map((g) => {
      const falta = Math.max(g.previsto - g.pago, 0);
      const perc  = g.previsto > 0 ? (g.pago / g.previsto) * 100 : 0;

      return `
        <tr>
          <td>${g.ano}</td>
          <td>‚Ç¨ ${g.previsto.toFixed(2)}</td>
          <td>‚Ç¨ ${g.pago.toFixed(2)}</td>
          <td>${perc.toFixed(0)}%</td>
          <td>‚Ç¨ ${falta.toFixed(2)}</td>
        </tr>
      `;
    })
    .join("");
}

  // ---------- CRIAR ALUNO (EDGE FUNCTION) ----------
    async function createAluno(payload){
      const { data, error } = await supabase.functions.invoke("expl-alunos", {
        body: { action: "create_aluno", payload }
      });

      if (error) {
        console.error(error);
        return { ok:false, error: error.message };
      }

      return { ok: true, data };
    }
  // ---------- login ----------
  formLogin?.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    msgLogin.textContent = 'A entrar...';

    const email    = formLogin.email.value.trim();
    const password = formLogin.password.value.trim();

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error){
      console.error(error);
      msgLogin.textContent = 'Credenciais inv√°lidas.';
      return;
    }

    const user = data.user;
    if (!(await hasRole(user.id, 'explicador'))){
      await supabase.auth.signOut().catch(()=>{});
      msgLogin.textContent = 'Esta conta n√£o √© de explicador.';
      return;
    }

    const exp = await getExplRow(user.id);
    EXPLICADOR = {
      userId: user.id,
      id_explicador: exp?.id_explicador || null,
      max: exp?.max_alunos ?? 0
    };

    const nomeCompleto = [exp?.nome, exp?.apelido].filter(Boolean).join(' ') || 'Professor';
    elNomeHeader.textContent = nomeCompleto;
    elNomeMini.textContent   = nomeCompleto;

    setState({ isExpl:true, isAuthed:true });
    await loadAlunos();
    await loadKpisFinanceiros();
  });

  // ---------- logout ----------
  btnLogout?.addEventListener('click', async () => {
    await supabase.auth.signOut().catch(()=>{});
    window.location.href = './index.html';
  });

  // ---------- sess√£o inicial ----------
  (async () => {
    setState({ loading:true });

    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user){
      setState({ isExpl:false, isAuthed:false });
      return;
    }

    const user = session.user;
    if (!(await hasRole(user.id, 'explicador'))){
      await supabase.auth.signOut().catch(()=>{});
      setState({ isExpl:false, isAuthed:false });
      msgLogin.textContent = 'Conta sem permiss√µes de explicador.';
      return;
    }

    const exp = await getExplRow(user.id);
    EXPLICADOR = {
      userId: user.id,
      id_explicador: exp?.id_explicador || null,
      max: exp?.max_alunos ?? 0
    };

    const nomeCompleto = [exp?.nome, exp?.apelido].filter(Boolean).join(' ') || 'Professor';
    elNomeHeader.textContent = nomeCompleto;
    elNomeMini.textContent   = nomeCompleto;

    setState({ isExpl:true, isAuthed:true });
    await loadAlunos();
    await loadKpisFinanceiros();
  })();

  // ---------- modais ----------
  function openModal(mod){ mod && mod.classList.add('open'); }
  function closeModal(mod){ mod && mod.classList.remove('open'); }

  modalAddAluno?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalAddAluno);
    }
  });
  $('#modal-add-aluno .modal__close')?.addEventListener('click', () => {
    closeModal(modalAddAluno);
  });

  btnFab?.addEventListener('click', () => openModal(modalAddAluno));
  btnOpenAddAluno?.addEventListener('click', () => openModal(modalAddAluno));

  // ---------- submit novo aluno ----------
  formNew?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    msgNewAluno.textContent = "";

    if (!EXPLICADOR.id_explicador) {
      msgNewAluno.textContent = "Perfil de explicador inv√°lido.";
      return;
    }

  const f = ev.target;

  const payload = {
    nome: f.nome?.value.trim() || "",
    apelido: f.apelido?.value.trim() || null,
    telemovel: f.telemovel?.value.trim() || null,
    ano: f.ano?.value ? Number(f.ano.value) : null,
    idade: f.idade?.value ? Number(f.idade.value) : null,
    dia_semana_preferido: f.dia_semana_preferido?.value.trim() || null,
    valor_explicacao: f.valor_explicacao?.value
      ? Number(f.valor_explicacao.value)
      : null,
    sessoes_mes: f.sessoes_mes?.value
      ? Number(f.sessoes_mes.value)
      : null,
    nome_pai_cache: f.nome_pai_cache?.value.trim() || null,
    contacto_pai_cache: f.contacto_pai_cache?.value.trim() || null,
    email: f.email?.value.trim() || "",
    username: f.username?.value.trim() || null,
    password: f.password?.value || "",
    is_active: true,
  };

  if (!payload.nome || !payload.email || !payload.password) {
    msgNewAluno.textContent =
      "Preenche pelo menos Nome, Email e Password.";
    return;
  }

  btnCreate.disabled = true;
  msgNewAluno.textContent = "A criar aluno...";

  // ‚¨áÔ∏è AQUI √© onde definimos *data* e *error*
  const { data, error } = await supabase.functions.invoke("expl-alunos", {
    body: { action: "create_aluno", payload },
  });

  // Tratamento de erro com leitura do body da Edge Function
  if (error) {
    let extra = "";

    if (error.context) {
      try {
        // Response do fetch
        const resp = error.context;
        const raw = await resp.text();
        console.log("Erro bruto da fun√ß√£o expl-alunos:", raw);

        try {
          const json = JSON.parse(raw);
          if (json?.error) {
            extra = " " + json.error;
          } else {
            extra = " " + raw;
          }
        } catch {
          extra = " " + raw;
        }
      } catch (e) {
        console.warn("N√£o consegui ler o body da resposta da fun√ß√£o", e);
      }
    }

    console.error("create_aluno error", error);
    msgNewAluno.textContent =
      "N√£o foi poss√≠vel criar o aluno." + extra;
    btnCreate.disabled = false;
    return;
  }

  // Sucesso
  msgNewAluno.style.color = "#126b3a";
  msgNewAluno.textContent = "Aluno criado com sucesso!";
  f.reset();
  await loadAlunos();
  btnCreate.disabled = false;
});

  // ---------- navega√ß√£o no header ----------
  const tabs = document.querySelectorAll('.expl-nav-btn');
  const sectionMap = {
    dashboard:  document.getElementById('expl-sec-dashboard'),
    alunos:     document.getElementById('expl-sec-alunos'),
    calendario: document.getElementById('expl-sec-calendario'),
    faturacao:  document.getElementById('expl-sec-dashboard'),
    relatorios: document.getElementById('expl-sec-relatorios'),
  };

  tabs.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      tabs.forEach(t => t.classList.remove('expl-nav-btn--active', 'expl-tab--active'));
      btn.classList.add('expl-nav-btn--active');
      const sec = sectionMap[target];
      if (sec) sec.scrollIntoView({ behavior:'smooth', block:'start' });
    });
  });

  btnScrollLista?.addEventListener('click', () => {
    document.querySelector('#lista-alunos-card')?.scrollIntoView({
      behavior:'smooth',
      block:'start'
    });
  });

  supabase.auth.onAuthStateChange(async (_evt, session) => {
    if (!session?.user){
      setState({ isExpl:false, isAuthed:false });
    }
  });
</script>
</body>
</html>
