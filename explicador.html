<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="./styles.css"/>
  <title>EduSphere â€” Explicador</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
</head>

<body class="home">
<header>
  <div class="header-inner">
    <a class="logo" href="./index.html">
      <img src="/public/img/logo-icon.svg" alt="">
      <span>EduSphere</span>
    </a>

    <!-- NAV PRINCIPAL DO PAINEL (tabs) â€“ sÃ³ aparece depois do login -->
    <nav id="explHeaderNav" class="expl-main-nav" style="display:none">
      <button class="expl-nav-btn expl-nav-btn--active" data-target="dashboard">Dashboard</button>
      <button class="expl-nav-btn" data-target="alunos">Alunos</button>
      <button class="expl-nav-btn" data-target="calendario">CalendÃ¡rio</button>
      <button class="expl-nav-btn" data-target="faturacao">FaturaÃ§Ã£o</button>
      <button class="expl-nav-btn" data-target="relatorios">RelatÃ³rios</button>
    </nav>

    <button id="btnLogout" class="button" style="margin-left:auto; display:none">Sair</button>
  </div>
</header>

<div class="capa__overlay"></div>

<main class="auth">

  <!-- ========== LOGIN DO EXPLICADOR ========== -->
  <section class="auth__panel" id="explLogin">
    <h1>Entrar (Explicador)</h1>
    <p class="auth__hint">Use as credenciais de professor para aceder ao painel.</p>
    <form id="fExplLogin" class="auth__form" autocomplete="on">
      <input type="email"   name="email"    placeholder="Email"    required />
      <input type="password"name="password" placeholder="Password" required />
      <button class="button" type="submit">Entrar</button>
      <div id="msgExplLogin" class="auth__msg"></div>
    </form>
  </section>

  <!-- ========== PAINEL DO EXPLICADOR (FULL PAGE) ========== -->
  <section id="explPanel" class="expl-shell" style="display:none">
    <!-- Header do painel -->
    <header class="expl-header-bar">
      <div class="expl-header-info">
        <p class="expl-hello">
          OlÃ¡, <span id="expl-nome-header">Professor</span>
        </p>
        <p class="expl-hello-sub">Aqui estÃ¡ o resumo da sua atividade.</p>
      </div>

      <div class="expl-header-user">
        <button class="expl-bell" aria-label="NotificaÃ§Ãµes">
          <span class="expl-bell-icon">ðŸ””</span>
          <span class="expl-bell-badge" id="expl-notif-count">0</span>
        </button>
        <div class="expl-header-avatar">
          <div class="expl-avatar-circle">Foto</div>
          <div class="expl-header-name">
            <p id="expl-nome-mini">Professor</p>
            <span>Explicador</span>
          </div>
        </div>
      </div>
    </header>

    <!-- ConteÃºdo -->
    <div class="expl-body">
      <!-- Resumo mensal: Pendentes vs Pagas (mÃªs atual) -->
      <div class="expl-grid-2" style="margin-top:1.5rem;">
        <!-- Mensalidades em falta (mÃªs atual) -->
        <article class="expl-card">
          <h3 class="expl-subsection-title">
            Mensalidades em falta (mÃªs atual)
          </h3>
          <div class="table-wrapper">
            <table class="table" id="tblMensalidadesPendentes">
              <thead>
              <tr>
                <th>Aluno</th>
                <th>MÃªs</th>
                <th>Previsto (â‚¬)</th>
                <th>Pago (â‚¬)</th>
                <th>Em falta (â‚¬)</th>
                <th>Estado</th>
                <th>Avisado</th>
              </tr>
              </thead>
              <tbody>
              <tr>
                <td colspan="7">Ainda nÃ£o existem mensalidades em falta neste mÃªs.</td>
              </tr>
              </tbody>
            </table>
          </div>
        </article>

        <!-- Mensalidades pagas (mÃªs atual) -->
        <article class="expl-card">
          <h3 class="expl-subsection-title">
            Mensalidades pagas (mÃªs atual)
          </h3>
          <div class="table-wrapper">
            <table class="table" id="tblMensalidadesPagas">
              <thead>
              <tr>
                <th>Aluno</th>
                <th>MÃªs</th>
                <th>Pago (â‚¬)</th>
                <th>Previsto (â‚¬)</th>
                <th>Estado</th>
              </tr>
              </thead>
              <tbody>
              <tr>
                <td colspan="5">Ainda nÃ£o existem mensalidades pagas neste mÃªs.</td>
              </tr>
              </tbody>
            </table>
          </div>
        </article>
      </div>

      <!-- ALUNOS -->
      <section class="expl-section" id="expl-sec-alunos">
        <div class="expl-section-header">
          <h2 class="expl-section-title">Meus Alunos</h2>
          <button class="expl-link-button" type="button" id="btn-scroll-lista">
            Ver lista
          </button>
        </div>

        <div class="expl-grid-2">
          <!-- Quota + aÃ§Ãµes -->
          <div class="expl-card">
            <h3 class="expl-subsection-title">Quota de alunos</h3>
            <div class="expl-quota">
              <p><strong>Limite:</strong> <span id="limite">â€”</span></p>
              <p><strong>Ativos:</strong> <span id="contagem">0</span></p>
              <p><strong>Restantes:</strong> <span id="restantes">â€”</span></p>
            </div>

            <h3 class="expl-subsection-title" style="margin-top:1rem;">AÃ§Ãµes rÃ¡pidas</h3>
            <div class="expl-actions-row">
              <button class="button secondary" type="button" id="btn-open-add-aluno">
                + Adicionar aluno
              </button>
            </div>
          </div>

          <!-- Lista de alunos -->
          <div class="expl-card" id="lista-alunos-card">
            <h3 class="expl-subsection-title">Lista de alunos</h3>
            <div class="table-wrapper">
              <table class="table" id="tblAlunos">
                <thead>
                <tr>
                  <th>Nome</th>
                  <th>Email</th>
                  <th>Ano</th>
                </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Painel de detalhes do aluno (aparece ao clicar numa linha) -->
        <div class="expl-card expl-aluno-detail" id="aluno-detail-card" style="margin-top:1.5rem; display:none">
          <h3 class="expl-subsection-title">
            Detalhes do aluno:
            <span id="aluno-detail-nome" class="expl-aluno-detail__nome">â€”</span>
          </h3>

          <p id="aluno-detail-meta" class="expl-aluno-detail__meta"></p>

          <div class="expl-grid-2">
            <div>
              <h4 class="expl-subsection-title">InformaÃ§Ã£o bÃ¡sica</h4>
              <ul class="expl-detail-list">
                <li><strong>Email:</strong> <span id="aluno-detail-email">â€”</span></li>
                <li><strong>TelemÃ³vel:</strong> <span id="aluno-detail-tel">â€”</span></li>
                <li><strong>Ano:</strong> <span id="aluno-detail-ano">â€”</span></li>
                <li><strong>Valor explicaÃ§Ã£o:</strong> <span id="aluno-detail-valor">â€”</span></li>
                <li><strong>SessÃµes / mÃªs:</strong> <span id="aluno-detail-sessoes">â€”</span></li>
              </ul>

              <div class="expl-actions-row" style="margin-top:1rem;">
                <button class="button secondary" type="button" id="btn-iniciar-faturacao">
                  Iniciar faturaÃ§Ã£o
                </button>
                <button class="button secondary" type="button" id="btn-registar-pagamento">
                  Registar pagamento
                </button>
                <button class="button" type="button" id="btn-editar-aluno">
                  Editar aluno
                </button>
              </div>


            <div>
              <h4 class="expl-subsection-title">Resumo de mensalidades</h4>
              <ul class="expl-detail-list">
                <li><strong>Valor previsto (mÃªs atual):</strong> <span id="aluno-detail-previsto-mes">â€”</span></li>
                <li><strong>Valor pago (mÃªs atual):</strong> <span id="aluno-detail-pago-mes">â€”</span></li>
                <li><strong>Em falta (total):</strong> <span id="aluno-detail-emfalta">â€”</span></li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- CALENDÃRIO + RELATÃ“RIOS -->
      <section class="expl-section expl-grid-2" id="expl-sec-outros">
        <div id="expl-sec-calendario">
          <h2 class="expl-section-title">CalendÃ¡rio</h2>
          <div class="expl-card expl-placeholder">
            <p>CalendÃ¡rio de explicaÃ§Ãµes (a integrar).</p>
          </div>
        </div>

        <div id="expl-sec-relatorios">
          <h2 class="expl-section-title">RelatÃ³rios</h2>
          <div class="expl-card expl-placeholder">
            <p>GrÃ¡ficos de faturaÃ§Ã£o e alunos ativos (a integrar).</p>
          </div>
        </div>
      </section>

    </div>

    <!-- BotÃ£o flutuante -->
    <button class="expl-fab" id="btn-add-aluno" type="button">+</button>
  </section>
</main>

<footer>Â© <span id="y"></span> EduSphere</footer>

<!-- ========== MODAL: ADICIONAR ALUNO ========== -->
<div class="modal" id="modal-add-aluno">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2>Novo aluno</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint">Preencha os dados do aluno para criar a conta de acesso.</p>
    <form id="fNewAluno" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input name="nome" placeholder="Nome do aluno" required />
        <input name="apelido" placeholder="Apelido (opcional)" />

        <input name="telemovel" placeholder="TelemÃ³vel (opcional)" />
        <input type="number" name="ano" placeholder="Ano de escolaridade" />

        <input type="number" name="idade" placeholder="Idade (opcional)" />

        <input name="dia_semana_preferido" placeholder="Dia preferido (ex.: Segunda)" />

        <input type="number" step="0.01" name="valor_explicacao" placeholder="Valor por explicaÃ§Ã£o (â‚¬)" />
        <input type="number" name="sessoes_mes" placeholder="SessÃµes por mÃªs" />

        <input name="nome_pai_cache" placeholder="Nome do encarregado de educaÃ§Ã£o" />
        <input name="contacto_pai_cache" placeholder="Contacto do encarregado" />

        <input type="email" name="email" placeholder="Email (login do aluno)" required />
        <input name="username" placeholder="Username (opcional)" />

        <input type="password" name="password" placeholder="Password" minlength="6" required />
      </div>

      <button id="btnCreateAluno" class="button" type="submit">Criar Aluno</button>
      <div id="msgNewAluno" class="auth__msg"></div>
    </form>
  </div>
</div>

<!-- ========== MODAL: EDITAR ALUNO ========== -->
<div class="modal" id="modal-edit-aluno">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2>Editar aluno</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint">Atualize os dados do aluno.</p>
    <form id="fEditAluno" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input name="nome_edit" placeholder="Nome do aluno" required />
        <input name="apelido_edit" placeholder="Apelido (opcional)" />

        <input name="telemovel_edit" placeholder="TelemÃ³vel (opcional)" />
        <input type="number" name="ano_edit" placeholder="Ano de escolaridade" />

        <input type="number" name="idade_edit" placeholder="Idade (opcional)" />

        <input name="dia_semana_preferido_edit" placeholder="Dia preferido (ex.: Segunda)" />

        <input type="number" step="0.01" name="valor_explicacao_edit" placeholder="Valor por explicaÃ§Ã£o (â‚¬)" />
        <input type="number" name="sessoes_mes_edit" placeholder="SessÃµes por mÃªs" />

        <input name="nome_pai_cache_edit" placeholder="Nome do encarregado de educaÃ§Ã£o" />
        <input name="contacto_pai_cache_edit" placeholder="Contacto do encarregado" />

        <input type="email" name="email_edit" placeholder="Email (login do aluno)" required />
        <input name="username_edit" placeholder="Username (opcional)" />

        <input type="password" name="password_edit" placeholder="Nova password (opcional)" minlength="6" />
      </div>

      <button id="btnSaveEditAluno" class="button" type="submit">Guardar alteraÃ§Ãµes</button>
      <div id="msgEditAluno" class="auth__msg"></div>
    </form>
  </div>
</div>


<script>
  const $  = (s) => document.querySelector(s);

  const elYear      = $('#y');
  const btnLogout   = $('#btnLogout');
  const headerNav   = $('#explHeaderNav');
  const loginBox    = $('#explLogin');
  const panel       = $('#explPanel');
  const msgLogin    = $('#msgExplLogin');
  const formLogin   = $('#fExplLogin');

  const tblBody     = $('#tblAlunos tbody');
  const elLimite    = $('#limite');
  const elContagem  = $('#contagem');
  const elRestantes = $('#restantes');

  const elNomeHeader = $('#expl-nome-header');
  const elNomeMini   = $('#expl-nome-mini');

  const btnFab          = $('#btn-add-aluno');
  const btnOpenAddAluno = $('#btn-open-add-aluno');
  const btnScrollLista  = $('#btn-scroll-lista');

  const modalAddAluno   = $('#modal-add-aluno');
  const formNew         = $('#fNewAluno');
  const msgNewAluno     = $('#msgNewAluno');
  const btnCreate       = $('#btnCreateAluno');

  const btnIniciarFat   = document.getElementById("btn-iniciar-faturacao");
  const btnRegistarPag  = document.getElementById("btn-registar-pagamento");

  elYear.textContent = new Date().getFullYear();

  let EXPLICADOR      = { userId:null, id_explicador:null, max:0 };
  let ALUNOS_CACHE    = []; // cache dos alunos para detalhes
  let PAGAMENTOS_CACHE = [];
  let ALUNO_ATUAL     = null; // aluno selecionado na lista

  // ---------- helpers supabase ----------
  async function hasRole(uid, roleName){
    const { data, error } = await supabase
      .from('app_users')
      .select('role')
      .eq('user_id', uid)
      .eq('role', roleName)
      .maybeSingle();
    if (error) {
      console.error('hasRole error', error);
      return false;
    }
    return !!data;
  }

  async function getExplRow(uid){
    const { data, error } = await supabase
      .from('explicadores')
      .select('id_explicador, nome, apelido, max_alunos')
      .eq('user_id', uid)
      .maybeSingle();
    if (error) throw error;
    return data || null;
  }

  function setState({ loading=false, isExpl=false, isAuthed=false }){
    if (loading){
      loginBox.style.display = 'block';
      panel.style.display    = 'none';
      msgLogin.textContent   = 'A verificar sessÃ£o...';
      btnLogout.style.display = 'none';
      headerNav.style.display = 'none';
      return;
    }
    if (isAuthed && isExpl){
      loginBox.style.display = 'none';
      panel.style.display    = 'block';
      msgLogin.textContent   = '';
      btnLogout.style.display= 'inline-block';
      headerNav.style.display= 'flex';
      document.querySelector('main.auth').style.display = 'block';
    } else {
      loginBox.style.display = 'block';
      panel.style.display    = 'none';
      btnLogout.style.display= 'none';
      headerNav.style.display= 'none';
      document.querySelector('main.auth').style.display = 'grid';
    }
  }

  // ---------- Painel de detalhes por aluno ----------
  async function mostrarPainelAluno(aluno) {
    ALUNO_ATUAL = aluno;

    const card = document.getElementById("aluno-detail-card");
    if (!card) return;

    const nomeCompleto = [aluno.nome, aluno.apelido].filter(Boolean).join(" ");
    document.getElementById("aluno-detail-nome").textContent =
      nomeCompleto || "Aluno";

    document.getElementById("aluno-detail-meta").textContent =
      aluno.username ? `Username: ${aluno.username}` : "";

    document.getElementById("aluno-detail-email").textContent =
      aluno.email || "â€”";
    document.getElementById("aluno-detail-tel").textContent =
      aluno.telemovel || "â€”";
    document.getElementById("aluno-detail-ano").textContent =
      aluno.ano ?? "â€”";

    const valorExp =
      aluno.valor_explicacao != null
        ? `â‚¬ ${Number(aluno.valor_explicacao).toFixed(2)}`
        : "â€”";
    document.getElementById("aluno-detail-valor").textContent = valorExp;

    const sessoes =
      aluno.sessoes_mes != null ? String(aluno.sessoes_mes) : "â€”";
    document.getElementById("aluno-detail-sessoes").textContent = sessoes;

    // mostrar card
    card.style.display = "block";

    // ---- carregar resumo de pagamentos deste aluno ----
    if (!EXPLICADOR.id_explicador) return;

    const elPrevistoMes = document.getElementById("aluno-detail-previsto-mes");
    const elPagoMes     = document.getElementById("aluno-detail-pago-mes");
    const elEmFalta     = document.getElementById("aluno-detail-emfalta");

    try {
      const now = new Date();
      const anoAtual = now.getFullYear();
      const mesAtual = now.getMonth() + 1;

      const { data, error } = await supabase
        .from("v_pagamentos_detalhe")
        .select("ano, mes, valor_previsto, valor_pago, estado")
        .eq("id_explicador", EXPLICADOR.id_explicador)
        .eq("id_aluno", aluno.id_aluno);

      if (error) {
        console.error("Erro a carregar pagamentos do aluno", error);
        if (elPrevistoMes) elPrevistoMes.textContent = "â€”";
        if (elPagoMes)     elPagoMes.textContent     = "â€”";
        if (elEmFalta)     elEmFalta.textContent     = "â€”";
        return;
      }

      let previstoMes = 0;
      let pagoMes     = 0;
      let emFaltaTotal = 0;

      (data || []).forEach((p) => {
        const previsto = Number(p.valor_previsto) || 0;
        const pago     = Number(p.valor_pago) || 0;
        const falta    = Math.max(previsto - pago, 0);

        if (p.ano === anoAtual && p.mes === mesAtual) {
          previstoMes += previsto;
          pagoMes     += pago;
        }

        emFaltaTotal += falta;
      });

      // Fallback: se ainda nÃ£o hÃ¡ registos em pagamentos, estima a mensalidade
      if ((!data || data.length === 0) &&
          aluno.valor_explicacao != null &&
          aluno.sessoes_mes != null) {

        const estimado = Number(aluno.valor_explicacao) * Number(aluno.sessoes_mes);

        previstoMes   = estimado;
        pagoMes       = 0;
        emFaltaTotal  = estimado;
      }

      if (elPrevistoMes) {
        elPrevistoMes.textContent = `â‚¬ ${previstoMes.toFixed(2)}`;
      }
      if (elPagoMes) {
        elPagoMes.textContent     = `â‚¬ ${pagoMes.toFixed(2)}`;
      }
      if (elEmFalta) {
        elEmFalta.textContent     = `â‚¬ ${emFaltaTotal.toFixed(2)}`;
      }
    } catch (err) {
      console.error("Erro inesperado ao calcular resumo do aluno", err);
    }
  }

  // ---------- quota UI ----------
  function updateQuotaUI(total){
    const max = Number(EXPLICADOR.max || 0);
    elContagem.textContent = String(total);

    if (!max){
      elLimite.textContent    = 'Sem limite';
      elRestantes.textContent = 'â€”';
      btnCreate && (btnCreate.disabled = false);
      return;
    }
    elLimite.textContent = String(max);
    const rest = Math.max(0, max - total);
    elRestantes.textContent = String(rest);
    if (btnCreate){
      btnCreate.disabled = rest <= 0;
      btnCreate.title    = rest <= 0 ? 'Limite de alunos atingido.' : '';
    }
  }

  // ---------- LISTAR ALUNOS via Edge Function ----------
  async function loadAlunos() {
    const { data, error } = await supabase.functions.invoke("expl-alunos", {
      body: { action: "list_alunos" },
    });

    if (error) {
      console.error("loadAlunos error", error);
      tblBody.innerHTML =
        '<tr><td colspan="3">Erro a carregar alunos.</td></tr>';
      updateQuotaUI(0);
      return;
    }

    if (!data || !data.length) {
      tblBody.innerHTML =
        '<tr><td colspan="3">Sem alunos ainda.</td></tr>';
      ALUNOS_CACHE = [];
      updateQuotaUI(0);
      return;
    }

    // guardar em cache para o painel de detalhes
    ALUNOS_CACHE = data;

    tblBody.innerHTML = data
      .map((a) => {
        const nome = [a.nome, a.apelido].filter(Boolean).join(" ");

        return `
          <tr class="linha-aluno" data-id-aluno="${a.id_aluno}">
            <td>${nome || "-"}</td>
            <td>${a.email ?? "-"}</td>
            <td>${a.ano ?? "-"}</td>
          </tr>
        `;
      })
      .join("");

    // atualizar quota com o nÂº de alunos
    updateQuotaUI(data.length);

    // ligar clique para abrir painel de detalhes do aluno
    tblBody
      .querySelectorAll("tr.linha-aluno")
      .forEach((row) => {
        row.addEventListener("click", () => {
          const idAluno = row.dataset.idAluno;
          const aluno = ALUNOS_CACHE.find((a) => String(a.id_aluno) === String(idAluno));
          if (aluno) {
            mostrarPainelAluno(aluno);
          }
        });
      });
  }

  // ---------- Resumo mensal: pendentes vs pagas (mÃªs atual) ----------
  function renderResumoMensal() {
    const tbodyPend = document.querySelector("#tblMensalidadesPendentes tbody");
    const tbodyPagas = document.querySelector("#tblMensalidadesPagas tbody");

    if (!tbodyPend || !tbodyPagas) return;

    const now = new Date();
    const anoAtual = now.getFullYear();
    const mesAtual = now.getMonth() + 1;

    const nomesMeses = [
      "Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho",
      "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro",
    ];
    const mesLabel = nomesMeses[mesAtual - 1] || String(mesAtual);

    const pendentes = [];
    const pagas = [];

    let totalPrevistoPend = 0;
    let totalFaltaPend = 0;
    let totalPagoPagas = 0;
    let totalPrevistoPagas = 0;

    (PAGAMENTOS_CACHE || []).forEach((p) => {
      if (p.ano !== anoAtual || p.mes !== mesAtual) return;

      const previsto = Number(p.valor_previsto) || 0;
      const pago = Number(p.valor_pago) || 0;
      const falta = Math.max(previsto - pago, 0);

      if (previsto === 0 && pago === 0) return;

      const avisadoLabel = "â€”"; // placeholder

      if (falta > 0) {
        pendentes.push({
          aluno: p.aluno_nome || "Aluno",
          previsto,
          pago,
          falta,
          estado: p.estado || "",
          mes: mesLabel,
          avisado: avisadoLabel,
        });
        totalPrevistoPend += previsto;
        totalFaltaPend += falta;
      } else {
        pagas.push({
          aluno: p.aluno_nome || "Aluno",
          previsto,
          pago,
          estado: p.estado || "",
          mes: mesLabel,
        });
        totalPagoPagas += pago;
        totalPrevistoPagas += previsto;
      }
    });

    // --- Tabela de pendentes ---
    if (!pendentes.length) {
      tbodyPend.innerHTML =
        '<tr><td colspan="7">Ainda nÃ£o existem mensalidades em falta neste mÃªs.</td></tr>';
    } else {
      const rowsPend = pendentes
        .map(
          (r) => `
        <tr>
          <td>${r.aluno}</td>
          <td>${r.mes}</td>
          <td>â‚¬ ${r.previsto.toFixed(2)}</td>
          <td>â‚¬ ${r.pago.toFixed(2)}</td>
          <td>â‚¬ ${r.falta.toFixed(2)}</td>
          <td>${r.estado}</td>
          <td>${r.avisado}</td>
        </tr>
      `
        )
        .join("");

      const totalRow = `
      <tr>
        <td><strong>Total</strong></td>
        <td>${mesLabel}</td>
        <td><strong>â‚¬ ${totalPrevistoPend.toFixed(2)}</strong></td>
        <td></td>
        <td><strong>â‚¬ ${totalFaltaPend.toFixed(2)}</strong></td>
        <td colspan="2"></td>
      </tr>
    `;

      tbodyPend.innerHTML = rowsPend + totalRow;
    }

    // --- Tabela de pagas ---
    if (!pagas.length) {
      tbodyPagas.innerHTML =
        '<tr><td colspan="5">Ainda nÃ£o existem mensalidades pagas neste mÃªs.</td></tr>';
    } else {
      const rowsPagas = pagas
        .map(
          (r) => `
        <tr>
          <td>${r.aluno}</td>
          <td>${r.mes}</td>
          <td>â‚¬ ${r.pago.toFixed(2)}</td>
          <td>â‚¬ ${r.previsto.toFixed(2)}</td>
          <td>${r.estado}</td>
        </tr>
      `
        )
        .join("");

      const totalRowPagas = `
      <tr>
        <td><strong>Total</strong></td>
        <td>${mesLabel}</td>
        <td><strong>â‚¬ ${totalPagoPagas.toFixed(2)}</strong></td>
        <td><strong>â‚¬ ${totalPrevistoPagas.toFixed(2)}</strong></td>
        <td></td>
      </tr>
    `;

      tbodyPagas.innerHTML = rowsPagas + totalRowPagas;
    }
  }

  // ---------- KPI financeiros (se mantiveres os cards antigos) ----------
  async function loadKpisFinanceiros() {
    if (!EXPLICADOR.id_explicador) return;

    const cardTotalMes  = document.getElementById("card-total-mes");
    const cardPendentes = document.getElementById("card-pendentes");
    const cardRecebidos = document.getElementById("card-recebidos");

    try {
      const { data, error } = await supabase
        .from("v_pagamentos_detalhe")
        .select("ano, mes, id_aluno, aluno_nome, valor_previsto, valor_pago, estado")
        .eq("id_explicador", EXPLICADOR.id_explicador);

      if (error) {
        console.error("Erro a carregar KPI financeiros", error);
        return;
      }

      PAGAMENTOS_CACHE = data || [];

      const now = new Date();
      const anoAtual = now.getFullYear();
      const mesAtual = now.getMonth() + 1;

      let previstoMesAtual    = 0;
      let realizadoMesAtual   = 0;
      let previstoAnoAtual    = 0;
      let realizadoAnoAtual   = 0;
      let pendenteTotal       = 0;
      let totalMensalidadesMes = 0;
      let mensalidadesPagasMes = 0;

      const alunosComPendencias = new Set();

      (PAGAMENTOS_CACHE).forEach((p) => {
        const previsto = Number(p.valor_previsto) || 0;
        const pago     = Number(p.valor_pago) || 0;
        const falta    = Math.max(previsto - pago, 0);

        if (p.ano === anoAtual) {
          previstoAnoAtual  += previsto;
          realizadoAnoAtual += pago;
        }

        if (p.ano === anoAtual && p.mes === mesAtual) {
          previstoMesAtual  += previsto;
          realizadoMesAtual += pago;
          totalMensalidadesMes++;
          if (p.estado === "PAGO" && previsto > 0) {
            mensalidadesPagasMes++;
          }
        }

        pendenteTotal += falta;
        if (falta > 0 && p.id_aluno) {
          alunosComPendencias.add(p.id_aluno);
        }
      });

      // Estes cards sÃ³ funcionam se existirem no HTML (senÃ£o ignoram)
      if (cardTotalMes) {
        cardTotalMes.textContent =
          `â‚¬ ${realizadoMesAtual.toFixed(2)} de â‚¬ ${previstoMesAtual.toFixed(2)}`;
        cardTotalMes.title =
          `Previsto para este mÃªs: â‚¬ ${previstoMesAtual.toFixed(2)} Â· ` +
          `Realizado: â‚¬ ${realizadoMesAtual.toFixed(2)}`;
      }

      if (cardPendentes) {
        const nAlunosPend = alunosComPendencias.size;
        const labelAlunos =
          nAlunosPend === 0
            ? "Nenhum aluno em falta"
            : nAlunosPend === 1
            ? "1 aluno em falta"
            : `${nAlunosPend} alunos em falta`;

        cardPendentes.textContent =
          `â‚¬ ${pendenteTotal.toFixed(2)} (${labelAlunos})`;
        cardPendentes.title =
          "Valor total ainda por receber (todas as mensalidades com PARCIAL ou EM_ATRASO).";
      }

      const taxaCobrancaAno =
        previstoAnoAtual > 0
          ? (realizadoAnoAtual / previstoAnoAtual) * 100
          : 0;

      if (cardRecebidos) {
        const baseMes =
          totalMensalidadesMes > 0
            ? `${mensalidadesPagasMes} / ${totalMensalidadesMes}`
            : "0 / 0";

        cardRecebidos.textContent =
          `${baseMes} (${taxaCobrancaAno.toFixed(0)}%)`;
        cardRecebidos.title =
          `Taxa de cobranÃ§a anual: ${taxaCobrancaAno.toFixed(
            1
          )}% (realizado vs previsto).`;
      }

      // atualizar tambÃ©m os cartÃµes de "Mensalidades em falta/pagas"
      renderResumoMensal();
    } catch (err) {
      console.error("Erro inesperado em loadKpisFinanceiros", err);
    }
  }

  // ---------- CRIAR ALUNO (EDGE FUNCTION) ----------
  async function createAluno(payload){
    const { data, error } = await supabase.functions.invoke("expl-alunos", {
      body: { action: "create_aluno", payload }
    });

    if (error) {
      console.error(error);
      return { ok:false, error: error.message };
    }

    return { ok: true, data };
  }

  // ---------- login ----------
  formLogin?.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    msgLogin.textContent = 'A entrar...';

    const email    = formLogin.email.value.trim();
    const password = formLogin.password.value.trim();

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error){
      console.error(error);
      msgLogin.textContent = 'Credenciais invÃ¡lidas.';
      return;
    }

    const user = data.user;
    if (!(await hasRole(user.id, 'explicador'))){
      await supabase.auth.signOut().catch(()=>{});
      msgLogin.textContent = 'Esta conta nÃ£o Ã© de explicador.';
      return;
    }

    const exp = await getExplRow(user.id);
    EXPLICADOR = {
      userId: user.id,
      id_explicador: exp?.id_explicador || null,
      max: exp?.max_alunos ?? 0
    };

    const nomeCompleto = [exp?.nome, exp?.apelido].filter(Boolean).join(' ') || 'Professor';
    elNomeHeader.textContent = nomeCompleto;
    elNomeMini.textContent   = nomeCompleto;

    setState({ isExpl:true, isAuthed:true });
    await loadAlunos();
    await loadKpisFinanceiros();
  });

  // ---------- logout ----------
  btnLogout?.addEventListener('click', async () => {
    await supabase.auth.signOut().catch(()=>{});
    window.location.href = './index.html';
  });

  // ---------- sessÃ£o inicial ----------
  (async () => {
    setState({ loading:true });

    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user){
      setState({ isExpl:false, isAuthed:false });
      return;
    }

    const user = session.user;
    if (!(await hasRole(user.id, 'explicador'))){
      await supabase.auth.signOut().catch(()=>{});
      setState({ isExpl:false, isAuthed:false });
      msgLogin.textContent = 'Conta sem permissÃµes de explicador.';
      return;
    }

    const exp = await getExplRow(user.id);
    EXPLICADOR = {
      userId: user.id,
      id_explicador: exp?.id_explicador || null,
      max: exp?.max_alunos ?? 0
    };

    const nomeCompleto = [exp?.nome, exp?.apelido].filter(Boolean).join(' ') || 'Professor';
    elNomeHeader.textContent = nomeCompleto;
    elNomeMini.textContent   = nomeCompleto;

    setState({ isExpl:true, isAuthed:true });
    await loadAlunos();
    await loadKpisFinanceiros();
  })();

  // ---------- modais ----------
  function openModal(mod){ mod && mod.classList.add('open'); }
  function closeModal(mod){ mod && mod.classList.remove('open'); }

  modalAddAluno?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalAddAluno);
    }
  });
  $('#modal-add-aluno .modal__close')?.addEventListener('click', () => {
    closeModal(modalAddAluno);
  });

  btnFab?.addEventListener('click', () => openModal(modalAddAluno));
  btnOpenAddAluno?.addEventListener('click', () => openModal(modalAddAluno));

  // ---------- submit novo aluno ----------
  formNew?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    msgNewAluno.textContent = "";

    if (!EXPLICADOR.id_explicador) {
      msgNewAluno.textContent = "Perfil de explicador invÃ¡lido.";
      return;
    }

    const f = ev.target;

    const payload = {
      nome: f.nome?.value.trim() || "",
      apelido: f.apelido?.value.trim() || null,
      telemovel: f.telemovel?.value.trim() || null,
      ano: f.ano?.value ? Number(f.ano.value) : null,
      idade: f.idade?.value ? Number(f.idade.value) : null,
      dia_semana_preferido: f.dia_semana_preferido?.value.trim() || null,
      valor_explicacao: f.valor_explicacao?.value
        ? Number(f.valor_explicacao.value)
        : null,
      sessoes_mes: f.sessoes_mes?.value
        ? Number(f.sessoes_mes.value)
        : null,
      nome_pai_cache: f.nome_pai_cache?.value.trim() || null,
      contacto_pai_cache: f.contacto_pai_cache?.value.trim() || null,
      email: f.email?.value.trim() || "",
      username: f.username?.value.trim() || null,
      password: f.password?.value || "",
      is_active: true,
    };

    if (!payload.nome || !payload.email || !payload.password) {
      msgNewAluno.textContent =
        "Preenche pelo menos Nome, Email e Password.";
      return;
    }

    btnCreate.disabled = true;
    msgNewAluno.textContent = "A criar aluno...";

    const { data, error } = await supabase.functions.invoke("expl-alunos", {
      body: { action: "create_aluno", payload },
    });

    if (error) {
      let extra = "";

      if (error.context) {
        try {
          const resp = error.context;
          const raw = await resp.text();
          console.log("Erro bruto da funÃ§Ã£o expl-alunos:", raw);

          try {
            const json = JSON.parse(raw);
            if (json?.error) {
              extra = " " + json.error;
            } else {
              extra = " " + raw;
            }
          } catch {
            extra = " " + raw;
          }
        } catch (e) {
          console.warn("NÃ£o consegui ler o body da resposta da funÃ§Ã£o", e);
        }
      }

      console.error("create_aluno error", error);
      msgNewAluno.textContent =
        "NÃ£o foi possÃ­vel criar o aluno." + extra;
      btnCreate.disabled = false;
      return;
    }

    msgNewAluno.style.color = "#126b3a";
    msgNewAluno.textContent = "Aluno criado com sucesso!";
    f.reset();
    await loadAlunos();
    await loadKpisFinanceiros();
    btnCreate.disabled = false;
  });

  // ---------- navegaÃ§Ã£o no header ----------
  const tabs = document.querySelectorAll('.expl-nav-btn');
  const sectionMap = {
    dashboard:  document.querySelector('.expl-body'),
    alunos:     document.getElementById('expl-sec-alunos'),
    calendario: document.getElementById('expl-sec-calendario'),
    faturacao:  document.querySelector('.expl-body'),
    relatorios: document.getElementById('expl-sec-relatorios'),
  };

  tabs.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      tabs.forEach(t => t.classList.remove('expl-nav-btn--active', 'expl-tab--active'));
      btn.classList.add('expl-nav-btn--active');
      const sec = sectionMap[target];
      if (sec) sec.scrollIntoView({ behavior:'smooth', block:'start' });
    });
  });

  btnScrollLista?.addEventListener('click', () => {
    document.querySelector('#lista-alunos-card')?.scrollIntoView({
      behavior:'smooth',
      block:'start'
    });
  });

  supabase.auth.onAuthStateChange(async (_evt, session) => {
    if (!session?.user){
      setState({ isExpl:false, isAuthed:false });
    }
  });

  // -------- Iniciar faturaÃ§Ã£o do aluno selecionado --------
  btnIniciarFat?.addEventListener("click", async () => {
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      alert("Seleciona um aluno na lista primeiro.");
      return;
    }

    const agora = new Date();
    const anoAtual = agora.getFullYear();
    const mesAtual = agora.getMonth() + 1;

    const anoStr = prompt("Ano de inÃ­cio da faturaÃ§Ã£o:", String(anoAtual));
    const mesStr = prompt("MÃªs de inÃ­cio (1-12):", String(mesAtual));
    const diaStr = prompt("Dia de pagamento (1-31):", "5");

    const ano = Number(anoStr);
    const mes = Number(mesStr);
    const dia = Number(diaStr);

    if (!ano || !mes || mes < 1 || mes > 12 || !dia || dia < 1 || dia > 31) {
      alert("Valores de ano/mÃªs/dia invÃ¡lidos.");
      return;
    }

    msgNewAluno.textContent = "A iniciar faturaÃ§Ã£o...";
    try {
      const { data, error } = await supabase.functions.invoke("expl-alunos", {
        body: {
          action: "iniciar_faturacao_aluno",
          payload: {
            aluno_id: ALUNO_ATUAL.id_aluno,
            ano,
            mes,
            dia_pagamento: dia,
          },
        },
      });

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro iniciar_faturacao_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        alert("NÃ£o foi possÃ­vel iniciar a faturaÃ§Ã£o." + extra);
        msgNewAluno.textContent = "";
        return;
      }

      alert("FaturaÃ§Ã£o iniciada para este aluno.");
      msgNewAluno.textContent = "";
      await loadKpisFinanceiros();
      await loadAlunos();
      const alunoAtualizado = ALUNOS_CACHE.find(
        (a) => String(a.id_aluno) === String(ALUNO_ATUAL.id_aluno)
      );
      if (alunoAtualizado) {
        mostrarPainelAluno(alunoAtualizado);
      }
    } catch (e) {
      console.error(e);
      alert("Erro inesperado ao iniciar faturaÃ§Ã£o.");
      msgNewAluno.textContent = "";
    }
  });

  // -------- Registar pagamento para o aluno selecionado --------
  btnRegistarPag?.addEventListener("click", async () => {
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      alert("Seleciona um aluno na lista primeiro.");
      return;
    }

    const agora = new Date();
    const anoAtual = agora.getFullYear();
    const mesAtual = agora.getMonth() + 1;

    const anoStr = prompt("Ano do pagamento:", String(anoAtual));
    const mesStr = prompt("MÃªs do pagamento (1-12):", String(mesAtual));
    const valorStr = prompt("Valor a registar (â‚¬):", "");

    const ano = Number(anoStr);
    const mes = Number(mesStr);
    const valor = Number(valorStr);

    if (!ano || !mes || mes < 1 || mes > 12 || !valor || valor <= 0) {
      alert("Valores de ano/mÃªs/valor invÃ¡lidos.");
      return;
    }

    msgNewAluno.textContent = "A registar pagamento...";
    try {
      const { data, error } = await supabase.functions.invoke("expl-alunos", {
        body: {
          action: "registar_pagamento_aluno",
          payload: {
            aluno_id: ALUNO_ATUAL.id_aluno,
            ano,
            mes,
            valor,
          },
        },
      });

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro registar_pagamento_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        alert("NÃ£o foi possÃ­vel registar o pagamento." + extra);
        msgNewAluno.textContent = "";
        return;
      }

      alert("Pagamento registado com sucesso.");
      msgNewAluno.textContent = "";
      await loadKpisFinanceiros();
      const alunoAtualizado = ALUNOS_CACHE.find(
        (a) => String(a.id_aluno) === String(ALUNO_ATUAL.id_aluno)
      );
      if (alunoAtualizado) {
        mostrarPainelAluno(alunoAtualizado);
      }
    } catch (e) {
      console.error(e);
      alert("Erro inesperado ao registar pagamento.");
      msgNewAluno.textContent = "";
    }
  });
</script>
</body>
</html>
