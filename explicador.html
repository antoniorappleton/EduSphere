<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="./styles.css"/>
  <title>EduSphere ‚Äî Explicador</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
</head>

<body class="home">
<header>
  <div class="header-inner">
    <a class="logo" href="./index.html">
      <img src="/public/img/logo-icon.svg" alt="">
      <span>EduSphere</span>
    </a>

    <!-- NAV PRINCIPAL DO PAINEL (tabs) ‚Äì s√≥ aparece depois do login -->
    <nav id="explHeaderNav" class="expl-main-nav" style="display:none">
      <button class="expl-nav-btn expl-nav-btn--active" data-target="dashboard">Dashboard</button>
      <button class="expl-nav-btn" data-target="alunos">Alunos</button>
      <button class="expl-nav-btn" data-target="calendario">Calend√°rio</button>
      <button class="expl-nav-btn" data-target="faturacao">Fatura√ß√£o</button>
      <button class="expl-nav-btn" data-target="relatorios">Relat√≥rios</button>
    </nav>

    <button id="btnLogout" class="button" style="margin-left:auto; display:none">Sair</button>
  </div>
</header>

<div class="capa__overlay"></div>

<main class="auth">

  <!-- ========== LOGIN DO EXPLICADOR ========== -->
  <section class="auth__panel" id="explLogin">
    <h1>Entrar (Explicador)</h1>
    <p class="auth__hint">Use as credenciais de professor para aceder ao painel.</p>
    <form id="fExplLogin" class="auth__form" autocomplete="on">
      <input type="email"   name="email"    placeholder="Email"    required />
      <input type="password"name="password" placeholder="Password" required />
      <button class="button" type="submit">Entrar</button>
      <div id="msgExplLogin" class="auth__msg"></div>
    </form>
  </section>

  <!-- ========== PAINEL DO EXPLICADOR (FULL PAGE) ========== -->
  <section id="explPanel" class="expl-shell" style="display:none">
    <!-- Header do painel -->
    <header class="expl-header-bar">
      <div class="expl-header-info">
        <p class="expl-hello">
          Ol√°, <span id="expl-nome-header">Professor</span>
        </p>
        <p class="expl-hello-sub">Aqui est√° o resumo da sua atividade.</p>
      </div>

      <div class="expl-header-user">
        <button class="expl-bell" aria-label="Notifica√ß√µes">
          <span class="expl-bell-icon">üîî</span>
          <span class="expl-bell-badge" id="expl-notif-count">0</span>
        </button>
        <div class="expl-header-avatar">
          <div class="expl-avatar-circle">Foto</div>
          <div class="expl-header-name">
            <p id="expl-nome-mini">Professor</p>
            <span>Explicador</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Conte√∫do -->
    <div class="expl-body">

      <!-- DASHBOARD / FATURA√á√ÉO -->
      <section class="expl-section" id="expl-sec-dashboard">
        <h2 class="expl-section-title">Resumo financeiro</h2>
        <div class="expl-cards">
          <article class="expl-card">
            <p class="expl-card-label">Total faturado (este m√™s)</p>
            <p class="expl-card-value" id="card-total-mes">‚Ç¨ 0,00</p>
          </article>

          <article class="expl-card">
            <p class="expl-card-label">Mensalidades pendentes</p>
            <p class="expl-card-value expl-card-value--warning" id="card-pendentes">
              ‚Ç¨ 0,00
            </p>
          </article>

          <article class="expl-card">
            <p class="expl-card-label">Pagamentos recebidos</p>
            <p class="expl-card-value expl-card-value--success" id="card-recebidos">
              0 / 0
            </p>
          </article>
        </div>
      </section>

      <!-- ALUNOS -->
      <section class="expl-section" id="expl-sec-alunos">
        <div class="expl-section-header">
          <h2 class="expl-section-title">Meus Alunos</h2>
          <button class="expl-link-button" type="button" id="btn-scroll-lista">
            Ver lista
          </button>
        </div>

        <div class="expl-grid-2">
          <!-- Quota + a√ß√µes -->
          <div class="expl-card">
            <h3 class="expl-subsection-title">Quota de alunos</h3>
            <div class="expl-quota">
              <p><strong>Limite:</strong> <span id="limite">‚Äî</span></p>
              <p><strong>Ativos:</strong> <span id="contagem">0</span></p>
              <p><strong>Restantes:</strong> <span id="restantes">‚Äî</span></p>
            </div>

            <h3 class="expl-subsection-title" style="margin-top:1rem;">A√ß√µes r√°pidas</h3>
            <div class="expl-actions-row">
              <button class="button secondary" type="button" id="btn-open-add-aluno">
                + Adicionar aluno
              </button>
              <!-- futuros bot√µes: Emitir fatura, Registar pagamento -->
            </div>
          </div>

          <!-- Lista de alunos -->
          <div class="expl-card" id="lista-alunos-card">
            <h3 class="expl-subsection-title">Lista de alunos</h3>
            <div class="table-wrapper">
              <table class="table" id="tblAlunos">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Ano</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- CALEND√ÅRIO + RELAT√ìRIOS -->
      <section class="expl-section expl-grid-2" id="expl-sec-outros">
        <div id="expl-sec-calendario">
          <h2 class="expl-section-title">Calend√°rio</h2>
          <div class="expl-card expl-placeholder">
            <p>Calend√°rio de explica√ß√µes (a integrar).</p>
          </div>
        </div>

        <div id="expl-sec-relatorios">
          <h2 class="expl-section-title">Relat√≥rios</h2>
          <div class="expl-card expl-placeholder">
            <p>Gr√°ficos de fatura√ß√£o e alunos ativos (a integrar).</p>
          </div>
        </div>
      </section>

    </div>

    <!-- Bot√£o flutuante -->
    <button class="expl-fab" id="btn-add-aluno" type="button">+</button>
  </section>
</main>

<footer>¬© <span id="y"></span> EduSphere</footer>

<!-- ========== MODAL: ADICIONAR ALUNO ========== -->
<div class="modal" id="modal-add-aluno">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2>Novo aluno</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint">Preencha os dados do aluno para criar a conta de acesso.</p>
    <form id="fNewAluno" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input name="nome" placeholder="Nome do aluno" required />
        <input name="apelido" placeholder="Apelido (opcional)" />

        <input name="telemovel" placeholder="Telem√≥vel (opcional)" />
        <input type="number" name="ano" placeholder="Ano de escolaridade" />

        <input type="number" name="idade" placeholder="Idade (opcional)" />

        <input name="dia_semana_preferido" placeholder="Dia preferido (ex.: Segunda)" />

        <input type="number" step="0.01" name="valor_explicacao" placeholder="Valor por explica√ß√£o (‚Ç¨)" />
        <input type="number" name="sessoes_mes" placeholder="Sess√µes por m√™s" />

        <input name="nome_pai_cache" placeholder="Nome do encarregado de educa√ß√£o" />
        <input name="contacto_pai_cache" placeholder="Contacto do encarregado" />

        <input type="email" name="email" placeholder="Email (login do aluno)" required />
        <input name="username" placeholder="Username (opcional)" />

        <input type="password" name="password" placeholder="Password" minlength="6" required />
      </div>

      <button id="btnCreateAluno" class="button" type="submit">Criar Aluno</button>
      <div id="msgNewAluno" class="auth__msg"></div>
    </form>


  </div>
</div>

<script>
  const $  = (s) => document.querySelector(s);

  const elYear      = $('#y');
  const btnLogout   = $('#btnLogout');
  const headerNav   = $('#explHeaderNav');
  const loginBox    = $('#explLogin');
  const panel       = $('#explPanel');
  const msgLogin    = $('#msgExplLogin');
  const formLogin   = $('#fExplLogin');

  const tblBody     = $('#tblAlunos tbody');
  const elLimite    = $('#limite');
  const elContagem  = $('#contagem');
  const elRestantes = $('#restantes');

  const elNomeHeader = $('#expl-nome-header');
  const elNomeMini   = $('#expl-nome-mini');

  const btnFab          = $('#btn-add-aluno');
  const btnOpenAddAluno = $('#btn-open-add-aluno');
  const btnScrollLista  = $('#btn-scroll-lista');

  const modalAddAluno   = $('#modal-add-aluno');
  const formNew         = $('#fNewAluno');
  const msgNewAluno     = $('#msgNewAluno');
  const btnCreate       = $('#btnCreateAluno');

  elYear.textContent = new Date().getFullYear();

  let EXPLICADOR = { userId:null, id_explicador:null, max:0 };

  // ---------- helpers supabase ----------
  async function hasRole(uid, roleName){
    const { data, error } = await supabase
      .from('app_users')
      .select('role')
      .eq('user_id', uid)
      .eq('role', roleName)
      .maybeSingle();
    if (error) {
      console.error('hasRole error', error);
      return false;
    }
    return !!data;
  }

  async function getExplRow(uid){
    const { data, error } = await supabase
      .from('explicadores')
      .select('id_explicador, nome, apelido, max')
      .eq('user_id', uid)
      .maybeSingle();
    if (error) throw error;
    return data || null;
  }

  function setState({ loading=false, isExpl=false, isAuthed=false }){
    if (loading){
      loginBox.style.display = 'block';
      panel.style.display    = 'none';
      msgLogin.textContent   = 'A verificar sess√£o...';
      btnLogout.style.display = 'none';
      headerNav.style.display = 'none';
      return;
    }
    if (isAuthed && isExpl){
      loginBox.style.display = 'none';
      panel.style.display    = 'block';
      msgLogin.textContent   = '';
      btnLogout.style.display= 'inline-block';
      headerNav.style.display= 'flex';
      document.querySelector('main.auth').style.display = 'block';
    } else {
      loginBox.style.display = 'block';
      panel.style.display    = 'none';
      btnLogout.style.display= 'none';
      headerNav.style.display= 'none';
      document.querySelector('main.auth').style.display = 'grid';
    }
  }

  // ---------- quota UI ----------
  function updateQuotaUI(total){
    const max = Number(EXPLICADOR.max || 0);
    elContagem.textContent = String(total);

    if (!max){
      elLimite.textContent    = 'Sem limite';
      elRestantes.textContent = '‚Äî';
      btnCreate && (btnCreate.disabled = false);
      return;
    }
    elLimite.textContent = String(max);
    const rest = Math.max(0, max - total);
    elRestantes.textContent = String(rest);
    if (btnCreate){
      btnCreate.disabled = rest <= 0;
      btnCreate.title    = rest <= 0 ? 'Limite de alunos atingido.' : '';
    }
  }

  // ---------- LISTAR ALUNOS via Edge Function ----------
    async function loadAlunos() {
    const { data, error } = await supabase.functions.invoke('expl-alunos', {
      body: { action: 'list_alunos' }
    });

    if (error) {
      console.error('loadAlunos error', error);
      tblBody.innerHTML = '<tr><td colspan="4">Erro a carregar alunos.</td></tr>';
      return;
    }

    if (!data || !data.length) {
      tblBody.innerHTML = '<tr><td colspan="4">Sem alunos ainda.</td></tr>';
      return;
    }

    tblBody.innerHTML = data.map(a => {
      const nome = [a.nome, a.apelido].filter(Boolean).join(' ');
      const valor = a.valor_explicacao != null ? a.valor_explicacao.toFixed(2) : '-';
      const sessoes = a.sessoes_mes != null ? a.sessoes_mes : '-';

      return `
        <tr>
          <td>${nome || '-'}</td>
          <td>${a.ano ?? '-'}</td>
          <td>${valor === '-' ? '-' : '‚Ç¨ ' + valor}</td>
          <td>${sessoes}</td>
        </tr>
      `;
    }).join('');
  }

  // ---------- CRIAR ALUNO (EDGE FUNCTION) ----------
    async function createAluno(payload){
      const { data, error } = await supabase.functions.invoke("expl-alunos", {
        body: { action: "create_aluno", payload }
      });

      if (error) {
        console.error(error);
        return { ok:false, error: error.message };
      }

      return { ok: true, data };
    }
  // ---------- login ----------
  formLogin?.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    msgLogin.textContent = 'A entrar...';

    const email    = formLogin.email.value.trim();
    const password = formLogin.password.value.trim();

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error){
      console.error(error);
      msgLogin.textContent = 'Credenciais inv√°lidas.';
      return;
    }

    const user = data.user;
    if (!(await hasRole(user.id, 'explicador'))){
      await supabase.auth.signOut().catch(()=>{});
      msgLogin.textContent = 'Esta conta n√£o √© de explicador.';
      return;
    }

    const exp = await getExplRow(user.id);
    EXPLICADOR = {
      userId: user.id,
      id_explicador: exp?.id_explicador || null,
      max: exp?.max ?? 0
    };

    const nomeCompleto = [exp?.nome, exp?.apelido].filter(Boolean).join(' ') || 'Professor';
    elNomeHeader.textContent = nomeCompleto;
    elNomeMini.textContent   = nomeCompleto;

    setState({ isExpl:true, isAuthed:true });
    await loadAlunos();
  });

  // ---------- logout ----------
  btnLogout?.addEventListener('click', async () => {
    await supabase.auth.signOut().catch(()=>{});
    window.location.href = './index.html';
  });

  // ---------- sess√£o inicial ----------
  (async () => {
    setState({ loading:true });

    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user){
      setState({ isExpl:false, isAuthed:false });
      return;
    }

    const user = session.user;
    if (!(await hasRole(user.id, 'explicador'))){
      await supabase.auth.signOut().catch(()=>{});
      setState({ isExpl:false, isAuthed:false });
      msgLogin.textContent = 'Conta sem permiss√µes de explicador.';
      return;
    }

    const exp = await getExplRow(user.id);
    EXPLICADOR = {
      userId: user.id,
      id_explicador: exp?.id_explicador || null,
      max: exp?.max ?? 0
    };

    const nomeCompleto = [exp?.nome, exp?.apelido].filter(Boolean).join(' ') || 'Professor';
    elNomeHeader.textContent = nomeCompleto;
    elNomeMini.textContent   = nomeCompleto;

    setState({ isExpl:true, isAuthed:true });
    await loadAlunos();
  })();

  // ---------- modais ----------
  function openModal(mod){ mod && mod.classList.add('open'); }
  function closeModal(mod){ mod && mod.classList.remove('open'); }

  modalAddAluno?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalAddAluno);
    }
  });
  $('#modal-add-aluno .modal__close')?.addEventListener('click', () => {
    closeModal(modalAddAluno);
  });

  btnFab?.addEventListener('click', () => openModal(modalAddAluno));
  btnOpenAddAluno?.addEventListener('click', () => openModal(modalAddAluno));

  // ---------- submit novo aluno ----------
  formNew?.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  msgNewAluno.textContent = '';

  if (!EXPLICADOR.id_explicador) {
    msgNewAluno.textContent = 'Perfil de explicador inv√°lido.';
    return;
  }

  const f = ev.target;

  const payload = {
    nome: f.nome?.value.trim() || "",
    apelido: f.apelido?.value.trim() || null,
    telemovel: f.telemovel?.value.trim() || null,
    ano: f.ano?.value ? Number(f.ano.value) : null,
    idade: f.idade?.value ? Number(f.idade.value) : null,
    dia_semana_preferido: f.dia_semana_preferido?.value.trim() || null,
    valor_explicacao: f.valor_explicacao?.value
      ? Number(f.valor_explicacao.value)
      : null,
    sessoes_mes: f.sessoes_mes?.value
      ? Number(f.sessoes_mes.value)
      : null,
    nome_pai_cache: f.nome_pai_cache?.value.trim() || null,
    contacto_pai_cache: f.contacto_pai_cache?.value.trim() || null,
    email: f.email?.value.trim() || "",
    username: f.username?.value.trim() || null,
    password: f.password?.value || "",
    is_active: true,
  };

  if (!payload.nome || !payload.email || !payload.password) {
    msgNewAluno.textContent = 'Preenche pelo menos Nome, Email e Password.';
    return;
  }

  btnCreate.disabled = true;
  msgNewAluno.textContent = 'A criar aluno...';

  const { data, error } = await supabase.functions.invoke('expl-alunos', {
    body: { action: 'create_aluno', payload }
  });

  if (error) {
    console.error(error);
    msgNewAluno.textContent = 'N√£o foi poss√≠vel criar o aluno.';
    btnCreate.disabled = false;
    return;
  }

  msgNewAluno.style.color = '#126b3a';
  msgNewAluno.textContent = 'Aluno criado com sucesso!';
  f.reset();
  await loadAlunos();
  btnCreate.disabled = false;
});

  // ---------- navega√ß√£o no header ----------
  const tabs = document.querySelectorAll('.expl-nav-btn');
  const sectionMap = {
    dashboard:  document.getElementById('expl-sec-dashboard'),
    alunos:     document.getElementById('expl-sec-alunos'),
    calendario: document.getElementById('expl-sec-calendario'),
    faturacao:  document.getElementById('expl-sec-dashboard'),
    relatorios: document.getElementById('expl-sec-relatorios'),
  };

  tabs.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      tabs.forEach(t => t.classList.remove('expl-nav-btn--active', 'expl-tab--active'));
      btn.classList.add('expl-nav-btn--active');
      const sec = sectionMap[target];
      if (sec) sec.scrollIntoView({ behavior:'smooth', block:'start' });
    });
  });

  btnScrollLista?.addEventListener('click', () => {
    document.querySelector('#lista-alunos-card')?.scrollIntoView({
      behavior:'smooth',
      block:'start'
    });
  });

  supabase.auth.onAuthStateChange(async (_evt, session) => {
    if (!session?.user){
      setState({ isExpl:false, isAuthed:false });
    }
  });
</script>
</body>
</html>
