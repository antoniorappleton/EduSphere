<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="./css/base.css" />
  <link rel="stylesheet" href="./css/explicador.css" />
  <link rel="stylesheet" href="./styles.css" />
  <title>EduSphere ‚Äî Explicador</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
</head>

<body class="home">
<header>
  <div class="header-inner">
    <a class="logo" href="./index.html">
      <img src="/public/img/logo-icon.svg" alt="">
      <span>EduSphere</span>
    </a>

    <!-- NAV SUPERIOR (opcional) -->
    <nav id="explTopNav" class="expl-main-nav" style="display:none">
      <button class="expl-nav-btn expl-nav-btn--active" data-target="dashboard">Dashboard</button>
      <button class="expl-nav-btn" data-target="alunos">Alunos</button>
      <button class="expl-nav-btn" data-target="calendario">Calend√°rio</button>
      <button class="expl-nav-btn" data-target="faturacao">Fatura√ß√£o</button>
      <button class="expl-nav-btn" data-target="relatorios">Relat√≥rios</button>
    </nav>

    <button id="btnLogout" class="button" style="margin-left:auto; display:none">Sair</button>
  </div>
</header>

<div class="capa__overlay"></div>

<main class="auth">

  <!-- ========== LOGIN DO EXPLICADOR ========== -->
  <section class="auth__panel" id="explLogin">
    <h1>Entrar (Explicador)</h1>
    <p class="auth__hint">Use as credenciais de professor para aceder ao painel.</p>
    <form id="fExplLogin" class="auth__form" autocomplete="on">
      <input type="email"   name="email"    placeholder="Email"    required />
      <input type="password" name="password" placeholder="Password" required />
      <button class="button" type="submit">Entrar</button>
      <div id="msgExplLogin" class="auth__msg"></div>
    </form>
  </section>

  <!-- ========== PAINEL DO EXPLICADOR (FULL PAGE) ========== -->
  <section id="explPanel" class="expl-shell" style="display:none">
    <!-- NAV LATERAL PRINCIPAL -->
    <nav id="explSidebarNav" class="expl-sidebar-nav" style="display:none">
      <button class="expl-nav-btn expl-nav-btn--active" data-target="dashboard">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <rect x="4" y="4" width="7" height="7" rx="1.5" />
            <rect x="13" y="4" width="7" height="7" rx="1.5" />
            <rect x="4" y="13" width="7" height="7" rx="1.5" />
            <rect x="13" y="13" width="7" height="7" rx="1.5" />
          </svg>
        </span>
        <span class="expl-nav-label">Dashboard</span>
      </button>

      <button class="expl-nav-btn" data-target="alunos">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="9" r="3.2" />
            <path d="M6.5 19.5c1.2-2.3 3-3.6 5.5-3.6s4.3 1.3 5.5 3.6" />
          </svg>
        </span>
        <span class="expl-nav-label">Alunos</span>
      </button>

      <button class="expl-nav-btn" data-target="calendario">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <rect x="4" y="5.5" width="16" height="14" rx="2" />
            <path d="M4 10h16" />
            <path d="M9 4v3" />
            <path d="M15 4v3" />
          </svg>
        </span>
        <span class="expl-nav-label">Calend√°rio</span>
      </button>

      <button class="expl-nav-btn" data-target="faturacao">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M15.5 7.5c-1-.7-2.1-1.1-3.4-1.1-2.6 0-4.6 1.8-4.6 4.6s2 4.6 4.6 4.6c1.3 0 2.4-.4 3.4-1.1" />
            <path d="M11 5v14" />
          </svg>
        </span>
        <span class="expl-nav-label">Fatura√ß√£o</span>
      </button>

      <button class="expl-nav-btn" data-target="relatorios">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 18.5h16" />
            <path d="M6.5 15l3.2-4 3.2 2.7 4.1-5.2" />
            <path d="M16.8 8.5h3v3" />
          </svg>
        </span>
        <span class="expl-nav-label">Relat√≥rios</span>
      </button>
    </nav>

    <!-- CONTE√öDO PRINCIPAL -->
    <div class="expl-main">
      <!-- Top bar -->
      <header class="expl-header-bar">
        <div class="expl-header-info">
          <h1 class="expl-page-title">Dashboard</h1>
          <p class="expl-hello-sub">
            Bem-vindo, <span id="expl-nome-header">Professor</span>
          </p>
        </div>

        <div class="expl-header-user">
          <button class="expl-bell" aria-label="Notifica√ß√µes">
            <span class="expl-bell-icon">üîî</span>
            <span class="expl-bell-badge" id="expl-notif-count">0</span>
          </button>
          <div class="expl-header-avatar">
            <div class="expl-avatar-circle">E</div>
            <div class="expl-header-name">
              <p id="expl-nome-mini">Professor</p>
              <span>Explicador</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Conte√∫do scroll√°vel -->
      <div class="expl-body">

        <!-- ========== DASHBOARD ========== -->
        <section class="expl-section" data-section="dashboard">
          <!-- RESUMO FINANCEIRO -->
          <h2 class="expl-section-title">Resumo financeiro</h2>

          <div class="expl-kpi-grid">
            <article class="expl-card expl-kpi-card">
              <p class="expl-kpi-label">Fatura√ß√£o prevista (m√™s atual)</p>
              <p class="expl-kpi-value" id="card-total-previsto">‚Äî</p>
            </article>

            <article class="expl-card expl-kpi-card">
              <p class="expl-kpi-label">Fatura√ß√£o realizada (m√™s atual)</p>
              <p class="expl-kpi-value expl-kpi-value--green" id="card-total-mes">‚Äî</p>
            </article>

            <article class="expl-card expl-kpi-card">
              <p class="expl-kpi-label">Pagamentos pendentes</p>
              <p class="expl-kpi-value expl-kpi-value--red" id="card-pendentes">‚Äî</p>
            </article>
          </div>

          <!-- ALUNOS (CARDS DE RESUMO) -->
          <div class="expl-section-header" style="margin-top:2rem;">
            <h2 class="expl-section-title">
              Alunos <span class="expl-section-sub" id="dash-alunos-contador">(0 ativos)</span>
            </h2>
            <button class="expl-link-button" type="button" id="btn-dashboard-ver-alunos">
              Ver todos &rarr;
            </button>
          </div>

          <div class="dash-alunos-grid" id="dash-alunos-grid">
            <!-- cart√µes preenchidos por JS -->
          </div>
        </section>

        <!-- ========== ALUNOS (DETALHE) ========== -->
        <section class="expl-section" id="expl-sec-alunos" data-section="alunos">
          <div class="expl-section-header">
            <h2 class="expl-section-title">
              Alunos <span class="expl-section-sub">(ativos)</span>
            </h2>
            <button class="expl-link-button" type="button" id="btn-scroll-lista">
              Ver lista &rarr;
            </button>
          </div>

          <div class="expl-grid-2">
            <!-- Quota + a√ß√µes -->
            <div class="expl-card">
              <h3 class="expl-subsection-title">Quota de alunos</h3>
              <div class="expl-quota">
                <p><strong>Limite:</strong> <span id="limite">‚Äî</span></p>
                <p><strong>Ativos:</strong> <span id="contagem">0</span></p>
                <p><strong>Restantes:</strong> <span id="restantes">‚Äî</span></p>
              </div>

              <h3 class="expl-subsection-title" style="margin-top:1rem;">A√ß√µes r√°pidas</h3>
              <div class="expl-actions-row">
                <button class="button secondary" type="button" id="btn-open-add-aluno">
                  + Adicionar aluno
                </button>
              </div>
            </div>

            <!-- Lista de alunos -->
            <div class="expl-card" id="lista-alunos-card">
              <h3 class="expl-subsection-title">Lista de alunos</h3>
              <div class="table-wrapper">
                <table class="table" id="tblAlunos">
                  <thead>
                    <tr>
                      <th>Nome</th>
                      <th>Email</th>
                      <th>Ano</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Painel de detalhes do aluno -->
          <div class="expl-card expl-aluno-detail" id="aluno-detail-card" style="margin-top:1.5rem; display:none">
            <h3 class="expl-subsection-title">
              Detalhes do aluno:
              <span id="aluno-detail-nome" class="expl-aluno-detail__nome">‚Äî</span>
            </h3>

            <p id="aluno-detail-meta" class="expl-aluno-detail__meta"></p>
            <div class="aluno-status-row">
              <span id="aluno-status-badge" class="aluno-status-badge aluno-status-badge--ativo">
                Ativo
              </span>

              <button type="button" id="toggle-aluno-ativo" class="aluno-status-toggle" aria-pressed="true">
                <span class="aluno-status-toggle__label">Aluno ativo</span>
                <span class="aluno-status-toggle__switch">
                  <span class="aluno-status-toggle__knob"></span>
                </span>
              </button>
            </div>

            <div class="expl-grid-2">
              <div>
                <h4 class="expl-subsection-title">Informa√ß√£o b√°sica</h4>
                <ul class="expl-detail-list">
                  <li><strong>Email:</strong> <span id="aluno-detail-email">‚Äî</span></li>
                  <li><strong>Telem√≥vel:</strong> <span id="aluno-detail-tel">‚Äî</span></li>
                  <li><strong>Ano:</strong> <span id="aluno-detail-ano">‚Äî</span></li>
                  <li><strong>Valor explica√ß√£o:</strong> <span id="aluno-detail-valor">‚Äî</span></li>
                  <li><strong>Sess√µes / m√™s:</strong> <span id="aluno-detail-sessoes">‚Äî</span></li>
                </ul>

                <div class="expl-actions-row" style="margin-top:1rem;">
                  <button class="button secondary" type="button" id="btn-iniciar-faturacao">
                    Iniciar fatura√ß√£o
                  </button>
                  <button class="button secondary" type="button" id="btn-registar-pagamento">
                    Registar pagamento
                  </button>
                  <button class="button secondary" type="button" id="btn-editar-pagamento">
                    Editar pagamento
                  </button>
                  <button class="button" type="button" id="btn-editar-aluno">
                    Editar aluno
                  </button>
                </div>
              </div>

              <div>
                <h4 class="expl-subsection-title">Resumo de mensalidades</h4>
                <ul class="expl-detail-list">
                  <li><strong>Valor previsto (m√™s atual):</strong> <span id="aluno-detail-previsto-mes">‚Äî</span></li>
                  <li><strong>Valor pago (m√™s atual):</strong> <span id="aluno-detail-pago-mes">‚Äî</span></li>
                  <li><strong>Em falta (total):</strong> <span id="aluno-detail-emfalta">‚Äî</span></li>
                </ul>
              </div>
            </div>

            <!-- Sess√µes do aluno -->
            <div class="expl-subsection" style="margin-top:1.5rem;">
              <div class="expl-section-header" style="margin-bottom:0.5rem;">
                <h4 class="expl-subsection-title">Sess√µes de explica√ß√£o</h4>
                <button class="button secondary" type="button" id="btn-add-sessao">
                  + Adicionar sess√£o
                </button>
              </div>

              <div class="table-wrapper">
                <table class="table" id="tblSessoesAluno">
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>In√≠cio</th>
                      <th>Fim</th>
                      <th>Dura√ß√£o (min)</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="5">Ainda n√£o existem sess√µes registadas para este aluno.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </section>

        <!-- ========== FATURA√á√ÉO (RESUMO MENSALIDADES) ========== -->
        <section class="expl-section" data-section="faturacao">
          <div class="expl-grid-2" style="margin-top:1.5rem;">
            <article class="expl-card">
              <h3 class="expl-subsection-title">
                Mensalidades em falta (m√™s atual)
              </h3>
              <div class="table-wrapper">
                <table class="table" id="tblMensalidadesPendentes">
                  <thead>
                    <tr>
                      <th>Aluno</th>
                      <th>M√™s</th>
                      <th>Previsto (‚Ç¨)</th>
                      <th>Pago (‚Ç¨)</th>
                      <th>Em falta (‚Ç¨)</th>
                      <th>Estado</th>
                      <th>Avisado</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="7">Ainda n√£o existem mensalidades em falta neste m√™s.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </article>

            <article class="expl-card">
              <h3 class="expl-subsection-title">
                Mensalidades pagas (m√™s atual)
              </h3>
              <div class="table-wrapper">
                <table class="table" id="tblMensalidadesPagas">
                  <thead>
                    <tr>
                      <th>Aluno</th>
                      <th>M√™s</th>
                      <th>Pago (‚Ç¨)</th>
                      <th>Previsto (‚Ç¨)</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="5">Ainda n√£o existem mensalidades pagas neste m√™s.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </article>
          </div>
        </section>

        <!-- ========== CALEND√ÅRIO ========== -->
        <section class="expl-section" id="expl-sec-calendario" data-section="calendario">
          <article class="expl-card expl-placeholder-card">
            <h2 class="expl-section-title">Calend√°rio</h2>
            <p class="expl-section-sub">Pr√≥ximas explica√ß√µes agendadas.</p>

            <ul class="expl-feature-list">
              <li>
                <span class="expl-feature-label">Hoje</span>
                <span class="expl-feature-value" id="cal-resumo-hoje">
                  Assim que tiveres sess√µes marcadas para hoje, elas aparecem aqui.
                </span>
              </li>
              <li>
                <span class="expl-feature-label">Pr√≥ximos 7 dias</span>
                <span class="expl-feature-value" id="cal-resumo-semana">
                  Usa o calend√°rio para garantir que tens a semana equilibrada.
                </span>
              </li>
              <li>
                <span class="expl-feature-label">Sugest√£o</span>
                <span class="expl-feature-value">
                  Regista sempre as sess√µes logo que combinas o hor√°rio com o aluno.
                </span>
              </li>
            </ul>

            <!-- CALEND√ÅRIO SEMANAL EM GRELHA -->
            <div class="calendar-week" id="calendar-week">
              <header class="calendar-week__nav">
                <button id="week-prev" class="calendar-btn">&larr;</button>
                <h3 id="week-label" class="calendar-week__title">Semana atual</h3>
                <button id="week-next" class="calendar-btn">&rarr;</button>
              </header>

              <div class="calendar-week__grid" id="calendar-grid">
                <!-- preenchido via JS -->
              </div>
            </div>

            <button type="button" class="expl-link-chip">
              <span class="expl-link-chip-icon">üìÖ</span>
              <span>Ir para o calend√°rio de explica√ß√µes</span>
            </button>
          </article>
        </section>

        <!-- ========== RELAT√ìRIOS ========== -->
        <section class="expl-section" id="expl-sec-relatorios" data-section="relatorios">
          <article class="expl-card expl-placeholder-card">
            <h2 class="expl-section-title">Relat√≥rios</h2>
            <p class="expl-section-sub">Estat√≠sticas e an√°lises da tua atividade.</p>

            <ul class="expl-feature-list">
              <li>
                <span class="expl-feature-label">Resumo mensal</span>
                <span class="expl-feature-value" id="rel-resumo-mensal">
                  Acompanha num s√≥ local mensalidades pagas, em falta e total faturado.
                </span>
              </li>
              <li>
                <span class="expl-feature-label">Tend√™ncia anual</span>
                <span class="expl-feature-value" id="rel-tendencia-anual">
                  V√™ a evolu√ß√£o da fatura√ß√£o ao longo do ano lectivo e identifica √©pocas fortes.
                </span>
              </li>
              <li>
                <span class="expl-feature-label">Alunos ativos</span>
                <span class="expl-feature-value" id="rel-alunos-ativos">
                  Controla rapidamente quantos alunos acompanhas e como evolui a tua carteira.
                </span>
              </li>
            </ul>

            <button type="button" class="expl-link-chip">
              <span class="expl-link-chip-icon">üìà</span>
              <span>Ver gr√°ficos e relat√≥rios (brevemente)</span>
            </button>
          </article>
        </section>

      </div>

      <!-- Bot√£o flutuante para novo aluno -->
      <button class="expl-fab" id="btn-add-aluno" type="button">+</button>
    </div>
  </section>

</main>

<!-- ========== MODAIS ========== -->

<!-- ADICIONAR ALUNO -->
<div class="modal" id="modal-add-aluno">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2>Novo aluno</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint">Preencha os dados do aluno para criar a conta de acesso.</p>
    <form id="fNewAluno" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input name="nome" placeholder="Nome do aluno" required />
        <input name="apelido" placeholder="Apelido (opcional)" />
        <input name="telemovel" placeholder="Telem√≥vel (opcional)" />
        <input type="number" name="ano" placeholder="Ano de escolaridade" />
        <input type="number" name="idade" placeholder="Idade (opcional)" />
        <input name="dia_semana_preferido" placeholder="Dia preferido (ex.: Segunda)" />
        <input type="number" step="0.01" name="valor_explicacao" placeholder="Valor por explica√ß√£o (‚Ç¨)" />
        <input type="number" name="sessoes_mes" placeholder="Sess√µes por m√™s" />
        <input name="nome_pai_cache" placeholder="Nome do encarregado de educa√ß√£o" />
        <input name="contacto_pai_cache" placeholder="Contacto do encarregado" />
        <input type="email" name="email" placeholder="Email (login do aluno)" required />
        <input name="username" placeholder="Username (opcional)" />
        <input type="password" name="password" placeholder="Password" minlength="6" required />
      </div>

      <button id="btnCreateAluno" class="button" type="submit">Criar Aluno</button>
      <div id="msgNewAluno" class="auth__msg"></div>
    </form>
  </div>
</div>

<!-- EDITAR ALUNO -->
<div class="modal" id="modal-edit-aluno">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2>Editar aluno</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint">Atualize os dados do aluno.</p>
    <form id="fEditAluno" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input name="nome_edit" placeholder="Nome do aluno" required />
        <input name="apelido_edit" placeholder="Apelido (opcional)" />
        <input name="telemovel_edit" placeholder="Telem√≥vel (opcional)" />
        <input type="number" name="ano_edit" placeholder="Ano de escolaridade" />
        <input type="number" name="idade_edit" placeholder="Idade (opcional)" />
        <input name="dia_semana_preferido_edit" placeholder="Dia preferido (ex.: Segunda)" />
        <input type="number" step="0.01" name="valor_explicacao_edit" placeholder="Valor por explica√ß√£o (‚Ç¨)" />
        <input type="number" name="sessoes_mes_edit" placeholder="Sess√µes por m√™s" />
        <input name="nome_pai_cache_edit" placeholder="Nome do encarregado de educa√ß√£o" />
        <input name="contacto_pai_cache_edit" placeholder="Contacto do encarregado" />
        <input type="email" name="email_edit" placeholder="Email (login do aluno)" required />
        <input name="username_edit" placeholder="Username (opcional)" />
        <input type="password" name="password_edit" placeholder="Nova password (opcional)" minlength="6" />
      </div>

      <button id="btnSaveEditAluno" class="button" type="submit">Guardar altera√ß√µes</button>
      <div id="msgEditAluno" class="auth__msg"></div>
    </form>
  </div>
</div>

<!-- SESS√ÉO (ADICIONAR / EDITAR) -->
<div class="modal" id="modal-sessao">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2>Sess√£o de explica√ß√£o</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint">Registe ou edite uma sess√£o deste aluno.</p>
    <form id="fSessao" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input type="date" name="data_sessao" placeholder="Data" required />
        <input type="time" name="hora_inicio" placeholder="Hora in√≠cio (opcional)" />
        <input type="time" name="hora_fim" placeholder="Hora fim (opcional)" />
        <input type="number" name="duracao_min" placeholder="Dura√ß√£o (min, opcional)" />
        <select name="estado">
          <option value="AGENDADA">Agendada</option>
          <option value="REALIZADA">Realizada</option>
          <option value="FALTOU">Faltou</option>
          <option value="CANCELADA">Cancelada</option>
        </select>
        <input name="observacoes" placeholder="Observa√ß√µes (opcional)" />
      </div>

      <div class="expl-actions-row" style="margin-top:0.75rem;">
        <button id="btnSaveSessao" class="button" type="submit">Guardar sess√£o</button>
        <button id="btnDeleteSessao" class="button secondary" type="button" style="display:none;">
          Apagar sess√£o
        </button>
      </div>

      <div id="msgSessao" class="auth__msg"></div>
    </form>
  </div>
</div>

<!-- PAGAMENTO ALUNO -->
<div class="modal" id="modal-pagamento-aluno">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2 id="pag-modal-title">Registar pagamento</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint" id="pag-modal-hint">
      Preencha os dados do pagamento deste aluno.
    </p>

    <form id="fPagamentoAluno" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input type="number" name="ano" placeholder="Ano" required />
        <input type="number" name="mes" placeholder="M√™s (1-12)" min="1" max="12" required />

        <input
          type="number"
          name="dia_pagamento"
          placeholder="Dia de pagamento (1-31)"
          min="1"
          max="31"
          style="display:none;"
        />

        <input
          type="number"
          step="0.01"
          name="valor"
          placeholder="Valor (‚Ç¨)"
          style="display:none;"
        />
      </div>

      <input type="hidden" name="modo" value="registar" />

      <button id="btnSavePagamento" class="button" type="submit">
        Guardar
      </button>
      <div id="msgPagamentoAluno" class="auth__msg"></div>
    </form>
  </div>
</div>

<footer>¬© <span id="y"></span> EduSphere</footer>

<script>
  // ---------- helper DOM ----------
  const $ = (s) => document.querySelector(s);

  // -------- Helper para chamar a Edge Function expl-alunos com token --------
  async function callExplFn(action, payload = null) {
    const { data: { session } } = await supabase.auth.getSession();
    const accessToken = session?.access_token;

    if (!accessToken) {
      return {
        data: null,
        error: { message: 'Sem sess√£o v√°lida (faz login primeiro).', status: 401 },
      };
    }

    return supabase.functions.invoke("expl-alunos", {
      body: { action, payload },
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
    });
  }

  let SESSOES_EXPLICADOR = [];
  let semanaOffset = 0; // 0 = semana atual, -1 = anterior, +1 = pr√≥xima

  const weekLabel   = document.querySelector('#week-label');
  const btnWeekPrev = document.querySelector('#week-prev');
  const btnWeekNext = document.querySelector('#week-next');

  // Pagamento modal refs
  const modalPag        = $('#modal-pagamento-aluno');
  const formPag         = $('#fPagamentoAluno');
  const msgPag          = $('#msgPagamentoAluno');
  const btnSavePag      = $('#btnSavePagamento');
  const pagModalTitle   = $('#pag-modal-title');
  const pagModalHint    = $('#pag-modal-hint');
  const inputAno        = formPag ? formPag.ano : null;
  const inputMes        = formPag ? formPag.mes : null;
  const inputDiaPag     = formPag ? formPag.dia_pagamento : null;
  const inputValor      = formPag ? formPag.valor : null;

  const elYear      = $('#y');
  const btnLogout   = $('#btnLogout');
  const headerNav   = $('#explSidebarNav');
  const loginBox    = $('#explLogin');
  const panel       = $('#explPanel');
  const msgLogin    = $('#msgExplLogin');
  const formLogin   = $('#fExplLogin');

  const tblBody     = $('#tblAlunos tbody');
  const elLimite    = $('#limite');
  const elContagem  = $('#contagem');
  const elRestantes = $('#restantes');

  const elNomeHeader = $('#expl-nome-header');
  const elNomeMini   = $('#expl-nome-mini');

  const btnFab          = $('#btn-add-aluno');
  const btnOpenAddAluno = $('#btn-open-add-aluno');
  const btnScrollLista  = $('#btn-scroll-lista');

  const modalAddAluno   = $('#modal-add-aluno');
  const formNew         = $('#fNewAluno');
  const msgNewAluno     = $('#msgNewAluno');
  const btnCreate       = $('#btnCreateAluno');

  const modalEditAluno  = $('#modal-edit-aluno');
  const formEdit        = $('#fEditAluno');
  const msgEditAluno    = $('#msgEditAluno');
  const btnSaveEdit     = $('#btnSaveEditAluno');
  const btnEditarAluno  = $('#btn-editar-aluno');

  const alunoStatusBadge = $('#aluno-status-badge');
  const toggleAlunoAtivo = $('#toggle-aluno-ativo');

  const btnIniciarFat   = $('#btn-iniciar-faturacao');
  const btnRegistarPag  = $('#btn-registar-pagamento');
  const btnEditarPag    = $('#btn-editar-pagamento');

  const modalSessao     = $('#modal-sessao');
  const formSessao      = $('#fSessao');
  const msgSessao       = $('#msgSessao');
  const btnSaveSessao   = $('#btnSaveSessao');
  const btnDeleteSessao = $('#btnDeleteSessao');
  const btnAddSessao    = $('#btn-add-sessao');
  const tblSessoesBody  = $('#tblSessoesAluno tbody');

  const btnDashVerAlunos = $('#btn-dashboard-ver-alunos');

  elYear.textContent = new Date().getFullYear();

  let EXPLICADOR       = { userId: null, id_explicador: null, max: 0 };
  let ALUNOS_CACHE     = [];
  let PAGAMENTOS_CACHE = [];
  let ALUNO_ATUAL      = null;
  let SESSAO_ATUAL_ID  = null;

  function getInicioSemana(date) {
    const d = new Date(date);
    const day = d.getDay(); // 0=Dom,1=Seg,...6=S√°b
    const diff = (day + 6) % 7; // queremos come√ßar em SEG
    d.setDate(d.getDate() - diff);
    d.setHours(0, 0, 0, 0);
    return d;
  }

  const NOMES_DIAS_CURTOS = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];

  // ---------- helpers supabase ----------
  async function hasRole(uid, roleName) {
    const { data, error } = await supabase
      .from('app_users')
      .select('role')
      .eq('user_id', uid)
      .eq('role', roleName)
      .maybeSingle();
    if (error) {
      console.error('hasRole error', error);
      return false;
    }
    return !!data;
  }

  async function getExplRow(uid) {
    const { data, error } = await supabase
      .from('explicadores')
      .select('id_explicador, nome, apelido, max_alunos')
      .eq('user_id', uid)
      .maybeSingle();
    if (error) throw error;
    return data || null;
  }

  function setState({ loading = false, isExpl = false, isAuthed = false }) {
    if (loading) {
      loginBox.style.display = 'block';
      panel.style.display    = 'none';
      msgLogin.textContent   = 'A verificar sess√£o...';
      btnLogout.style.display = 'none';
      headerNav.style.display = 'none';
      return;
    }
    if (isAuthed && isExpl) {
      loginBox.style.display = 'none';
      panel.style.display    = 'flex';
      msgLogin.textContent   = '';
      btnLogout.style.display = 'inline-block';
      headerNav.style.display = 'flex';
      document.querySelector('main.auth').style.display = 'block';
    } else {
      loginBox.style.display = 'block';
      panel.style.display    = 'none';
      btnLogout.style.display = 'none';
      headerNav.style.display = 'none';
      document.querySelector('main.auth').style.display = 'grid';
    }
  }

  // ---------- QUOTA UI ----------
  function updateQuotaUI(total) {
    const max = Number(EXPLICADOR.max || 0);
    elContagem.textContent = String(total);

    if (!max) {
      elLimite.textContent    = 'Sem limite';
      elRestantes.textContent = '‚Äî';
      btnCreate && (btnCreate.disabled = false);
      return;
    }

    elLimite.textContent = String(max);
    const rest = Math.max(0, max - total);
    elRestantes.textContent = String(rest);

    if (btnCreate) {
      btnCreate.disabled = rest <= 0;
      btnCreate.title    = rest <= 0 ? 'Limite de alunos atingido.' : '';
    }
  }

  // ---------- DASHBOARD: CARDS DE ALUNOS ----------
  function renderDashboardAlunos() {
    const grid = document.getElementById("dash-alunos-grid");
    const contador = document.getElementById("dash-alunos-contador");
    if (!grid) return;

    const alunosAtivos = (ALUNOS_CACHE || []).filter(a => a.is_active !== false);
    const totalAtivos = alunosAtivos.length;

    if (contador) {
      contador.textContent =
        totalAtivos === 1 ? "(1 ativo)" : `(${totalAtivos} ativos)`;
    }

    if (!totalAtivos) {
      grid.innerHTML =
        '<p class="expl-section-sub">Ainda n√£o tens alunos ativos registados.</p>';
      return;
    }

    // s√≥ mostramos at√© 3, como no mock
    const top3 = alunosAtivos.slice(0, 3);

    // helper para mapear estado ‚Üí label + classe de badge
    function getEstadoInfo(rawEstado) {
      const e = (rawEstado || "").toString().trim().toUpperCase();

      switch (e) {
        case "PAGO":
          return {
            label: "Pago",
            badgeClass:
              "dash-aluno-card__badge dash-aluno-card__badge--pago",
          };
        case "PARCIAL":
          return {
            label: "Parcial",
            badgeClass:
              "dash-aluno-card__badge dash-aluno-card__badge--parcial",
          };
        case "PENDENTE":
        default:
          return {
            label: e ? e.charAt(0) + e.slice(1).toLowerCase() : "Pendente",
            badgeClass:
              "dash-aluno-card__badge dash-aluno-card__badge--pendente",
          };
      }
    }

    grid.innerHTML = top3
      .map((a) => {
        const nome = [a.nome, a.apelido].filter(Boolean).join(" ") || "Aluno";
        const anoLabel = a.ano ? `${a.ano}¬∫ Ano` : "‚Äî";

        const proximaMensalidade = a.proxima_mensalidade || "‚Äî";
        const { label: estadoLabel, badgeClass } = getEstadoInfo(
          a.estado_mensalidade || "PENDENTE"
        );

        return `
          <article class="dash-aluno-card">
            <div>
              <div class="dash-aluno-card__top">
                <div class="dash-aluno-card__avatar"></div>
                <div>
                  <h3 class="dash-aluno-card__name">${nome}</h3>
                  <p class="dash-aluno-card__year">${anoLabel}</p>
                </div>
              </div>

              <p class="dash-aluno-card__label">Pr√≥xima mensalidade:</p>
              <p class="dash-aluno-card__date">${proximaMensalidade}</p>

              <span class="${badgeClass}">
                ${estadoLabel}
              </span>
            </div>

            <button
              type="button"
              class="button secondary dash-aluno-card__btn"
              data-id-aluno="${a.id_aluno}"
            >
              Ver detalhes
            </button>
          </article>
        `;
      })
      .join("");

    // clique em "Ver detalhes" -> vai para sec√ß√£o Alunos e abre o painel
    grid.querySelectorAll("[data-id-aluno]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const idAluno = btn.getAttribute("data-id-aluno");
        const aluno = ALUNOS_CACHE.find(
          (x) => String(x.id_aluno) === String(idAluno)
        );
        if (!aluno) return;

        const tabAlunos = document.querySelector(
          '.expl-nav-btn[data-target="alunos"]'
        );
        tabAlunos?.click();

        setTimeout(() => {
          mostrarPainelAluno(aluno);
        }, 150);
      });
    });
  }

  // ---------- STATUS ALUNO (Ativo / Bloqueado) ----------
  function updateAlunoStatusUI(aluno) {
    if (!aluno) return;

    const ativo = aluno.is_active !== false;

    if (alunoStatusBadge) {
      alunoStatusBadge.textContent = ativo ? 'Ativo' : 'Bloqueado';
      alunoStatusBadge.classList.toggle('aluno-status-badge--ativo', ativo);
      alunoStatusBadge.classList.toggle('aluno-status-badge--inativo', !ativo);
    }

    if (toggleAlunoAtivo) {
      toggleAlunoAtivo.classList.toggle('is-off', !ativo);
      toggleAlunoAtivo.setAttribute('aria-pressed', ativo ? 'true' : 'false');
    }
  }

  // ---------- LISTAR ALUNOS ----------
  async function loadAlunos() {
    const { data, error } = await callExplFn("list_alunos", null);

    if (error) {
      console.error("loadAlunos error", error);
      tblBody.innerHTML =
        '<tr><td colspan="3">Erro a carregar alunos.</td></tr>';
      ALUNOS_CACHE = [];
      updateQuotaUI(0);
      renderDashboardAlunos();
      return;
    }

    if (!data || !data.length) {
      tblBody.innerHTML =
        '<tr><td colspan="3">Sem alunos ainda.</td></tr>';
      ALUNOS_CACHE = [];
      updateQuotaUI(0);
      renderDashboardAlunos();
      return;
    }

    ALUNOS_CACHE = data;

    tblBody.innerHTML = data
      .map((a) => {
        const nome = [a.nome, a.apelido].filter(Boolean).join(" ");

        return `
          <tr class="linha-aluno" data-id-aluno="${a.id_aluno}">
            <td>${nome || "-"}</td>
            <td>${a.email ?? "-"}</td>
            <td>${a.ano ?? "-"}</td>
          </tr>
        `;
      })
      .join("");

    updateQuotaUI(data.length);
    renderDashboardAlunos();

    tblBody
      .querySelectorAll("tr.linha-aluno")
      .forEach((row) => {
        row.addEventListener("click", () => {
          const idAluno = row.dataset.idAluno;
          const aluno = ALUNOS_CACHE.find((a) => String(a.id_aluno) === String(idAluno));
          if (aluno) {
            mostrarPainelAluno(aluno);
          }
        });
      });
  }

  // ---------- RESUMO MENSAL ----------
  function renderResumoMensal() {
    const tbodyPend = document.querySelector("#tblMensalidadesPendentes tbody");
    const tbodyPagas = document.querySelector("#tblMensalidadesPagas tbody");

    if (!tbodyPend || !tbodyPagas) return;

    const now = new Date();
    const anoAtual = now.getFullYear();
    const mesAtual = now.getMonth() + 1;

    const nomesMeses = [
      "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
      "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro",
    ];
    const mesLabel = nomesMeses[mesAtual - 1] || String(mesAtual);

    const pendentes = [];
    const pagas = [];

    let totalPrevistoPend = 0;
    let totalFaltaPend = 0;
    let totalPagoPagas = 0;
    let totalPrevistoPagas = 0;

    (PAGAMENTOS_CACHE || []).forEach((p) => {
      // ignorar alunos bloqueados
      const alunoRef = (ALUNOS_CACHE || []).find(
        (a) => String(a.id_aluno) === String(p.id_aluno)
      );
      if (alunoRef && alunoRef.is_active === false) return;

      if (p.ano !== anoAtual || p.mes !== mesAtual) return;

      const previsto = Number(p.valor_previsto) || 0;
      const pago = Number(p.valor_pago) || 0;
      const falta = Math.max(previsto - pago, 0);

      if (previsto === 0 && pago === 0) return;

      const avisadoLabel = "‚Äî";

      if (falta > 0) {
        pendentes.push({
          aluno: p.aluno_nome || "Aluno",
          previsto,
          pago,
          falta,
          estado: p.estado || "",
          mes: mesLabel,
          avisado: avisadoLabel,
        });
        totalPrevistoPend += previsto;
        totalFaltaPend += falta;
      } else {
        pagas.push({
          aluno: p.aluno_nome || "Aluno",
          previsto,
          pago,
          estado: p.estado || "",
          mes: mesLabel,
        });
        totalPagoPagas += pago;
        totalPrevistoPagas += previsto;
      }
    });

    if (!pendentes.length) {
      tbodyPend.innerHTML =
        '<tr><td colspan="7">Ainda n√£o existem mensalidades em falta neste m√™s.</td></tr>';
    } else {
      const rowsPend = pendentes
        .map(
          (r) => `
        <tr>
          <td>${r.aluno}</td>
          <td>${r.mes}</td>
          <td>‚Ç¨ ${r.previsto.toFixed(2)}</td>
          <td>‚Ç¨ ${r.pago.toFixed(2)}</td>
          <td>‚Ç¨ ${r.falta.toFixed(2)}</td>
          <td>${r.estado}</td>
          <td>${r.avisado}</td>
        </tr>
      `
        )
        .join("");

      const totalRow = `
      <tr>
        <td><strong>Total</strong></td>
        <td>${mesLabel}</td>
        <td><strong>‚Ç¨ ${totalPrevistoPend.toFixed(2)}</strong></td>
        <td></td>
        <td><strong>‚Ç¨ ${totalFaltaPend.toFixed(2)}</strong></td>
        <td colspan="2"></td>
      </tr>
    `;

      tbodyPend.innerHTML = rowsPend + totalRow;
    }

    if (!pagas.length) {
      tbodyPagas.innerHTML =
        '<tr><td colspan="5">Ainda n√£o existem mensalidades pagas neste m√™s.</td></tr>';
    } else {
      const rowsPagas = pagas
        .map(
          (r) => `
        <tr>
          <td>${r.aluno}</td>
          <td>${r.mes}</td>
          <td>‚Ç¨ ${r.pago.toFixed(2)}</td>
          <td>‚Ç¨ ${r.previsto.toFixed(2)}</td>
          <td>${r.estado}</td>
        </tr>
      `
        )
        .join("");

      const totalRowPagas = `
      <tr>
        <td><strong>Total</strong></td>
        <td>${mesLabel}</td>
        <td><strong>‚Ç¨ ${totalPagoPagas.toFixed(2)}</strong></td>
        <td><strong>‚Ç¨ ${totalPrevistoPagas.toFixed(2)}</strong></td>
        <td></td>
      </tr>
    `;

      tbodyPagas.innerHTML = rowsPagas + totalRowPagas;
    }
  }

  // ---------- RELAT√ìRIOS: RESUMOS NO CART√ÉO ----------
  function updateResumoRelatorios({
    previstoMesAtual = 0,
    realizadoMesAtual = 0,
    pendenteTotal = 0,
    previstoAnoAtual = 0,
    realizadoAnoAtual = 0,
    nAlunosAtivos = 0,
  } = {}) {
    const elMensal   = document.querySelector('#rel-resumo-mensal');
    const elTend     = document.querySelector('#rel-tendencia-anual');
    const elAlunos   = document.querySelector('#rel-alunos-ativos');

    if (elMensal) {
      elMensal.textContent =
        `Este m√™s: ‚Ç¨ ${realizadoMesAtual.toFixed(2)} recebidos ` +
        `de ‚Ç¨ ${previstoMesAtual.toFixed(2)} previstos ¬∑ ` +
        `‚Ç¨ ${pendenteTotal.toFixed(2)} em falta.`;
    }

    if (elTend) {
      elTend.textContent =
        `Ano atual: ‚Ç¨ ${realizadoAnoAtual.toFixed(2)} faturados ` +
        `de ‚Ç¨ ${previstoAnoAtual.toFixed(2)} previstos.`;
    }

    if (elAlunos) {
      if (nAlunosAtivos <= 0) {
        elAlunos.textContent = "Ainda n√£o tens alunos ativos registados.";
      } else if (nAlunosAtivos === 1) {
        elAlunos.textContent = "A acompanhar 1 aluno ativo.";
      } else {
        elAlunos.textContent = `A acompanhar ${nAlunosAtivos} alunos ativos.`;
      }
    }
  }

  // ---------- KPI financeiros ----------
  async function loadKpisFinanceiros() {
    if (!EXPLICADOR.id_explicador) return;

    const cardTotalPrev = document.getElementById("card-total-previsto");
    const cardTotalMes  = document.getElementById("card-total-mes");
    const cardPendentes = document.getElementById("card-pendentes");

    try {
      const { data, error } = await supabase
        .from("v_pagamentos_detalhe")
        .select("ano, mes, id_aluno, aluno_nome, valor_previsto, valor_pago, estado")
        .eq("id_explicador", EXPLICADOR.id_explicador);

      if (error) {
        console.error("Erro a carregar KPI financeiros", error);
        return;
      }

      PAGAMENTOS_CACHE = data || [];

      const now = new Date();
      const anoAtual = now.getFullYear();
      const mesAtual = now.getMonth() + 1;

      let previstoMesAtual    = 0;
      let realizadoMesAtual   = 0;
      let previstoAnoAtual    = 0;
      let realizadoAnoAtual   = 0;
      let pendenteTotal       = 0;
      const alunosComPendencias = new Set();

      (PAGAMENTOS_CACHE || []).forEach((p) => {
        // ignorar alunos bloqueados
        const alunoRef = (ALUNOS_CACHE || []).find(
          (a) => String(a.id_aluno) === String(p.id_aluno)
        );
        if (alunoRef && alunoRef.is_active === false) return;

        const previsto = Number(p.valor_previsto) || 0;
        const pago     = Number(p.valor_pago) || 0;
        const falta    = Math.max(previsto - pago, 0);

        if (p.ano === anoAtual) {
          previstoAnoAtual  += previsto;
          realizadoAnoAtual += pago;
        }

        if (p.ano === anoAtual && p.mes === mesAtual) {
          previstoMesAtual  += previsto;
          realizadoMesAtual += pago;
        }

        pendenteTotal += falta;
        if (falta > 0 && p.id_aluno) {
          alunosComPendencias.add(p.id_aluno);
        }
      });

      if (cardTotalPrev) {
        cardTotalPrev.textContent = `‚Ç¨ ${previstoMesAtual.toFixed(2)}`;
      }

      if (cardTotalMes) {
        cardTotalMes.textContent =
          `‚Ç¨ ${realizadoMesAtual.toFixed(2)} de ‚Ç¨ ${previstoMesAtual.toFixed(2)}`;
      }

      if (cardPendentes) {
        const nAlunosPend = alunosComPendencias.size;
        const labelAlunos =
          nAlunosPend === 0
            ? "Nenhum aluno em falta"
            : nAlunosPend === 1
            ? "1 aluno em falta"
            : `${nAlunosPend} alunos em falta`;

        cardPendentes.textContent =
          `‚Ç¨ ${pendenteTotal.toFixed(2)} (${labelAlunos})`;
      }

      const nAlunosAtivos = (ALUNOS_CACHE || []).filter(a => a.is_active !== false).length;

      updateResumoRelatorios({
        previstoMesAtual,
        realizadoMesAtual,
        pendenteTotal,
        previstoAnoAtual,
        realizadoAnoAtual,
        nAlunosAtivos,
      });

      renderResumoMensal();
    } catch (err) {
      console.error("Erro inesperado em loadKpisFinanceiros", err);
    }
  }

  // ---------- CARREGAR SESS√ïES DO ALUNO ----------
  async function loadSessoesAluno(alunoId) {
    if (!tblSessoesBody) return;

    tblSessoesBody.innerHTML =
      '<tr><td colspan="5">A carregar sess√µes...</td></tr>';

    const { data, error } = await callExplFn("list_sessoes_aluno", {
      aluno_id: alunoId,
    });

    if (error) {
      console.error("list_sessoes_aluno error", error);
      tblSessoesBody.innerHTML =
        '<tr><td colspan="5">Erro ao carregar sess√µes.</td></tr>';
      return;
    }

    if (!data || !data.length) {
      tblSessoesBody.innerHTML =
        '<tr><td colspan="5">Ainda n√£o existem sess√µes registadas para este aluno.</td></tr>';
      return;
    }

    tblSessoesBody.innerHTML = data
      .map((s) => {
        const dataLabel = s.data || "‚Äî";
        const hIni = s.hora_inicio || "‚Äî";
        const hFim = s.hora_fim || "‚Äî";
        const dur = s.duracao_min != null ? s.duracao_min : "‚Äî";
        const est = s.estado || "‚Äî";

        return `
          <tr class="linha-sessao" data-id-sessao="${s.id_sessao}">
            <td>${dataLabel}</td>
            <td>${hIni}</td>
            <td>${hFim}</td>
            <td>${dur}</td>
            <td>${est}</td>
          </tr>
        `;
      })
      .join("");

    tblSessoesBody.querySelectorAll("tr.linha-sessao").forEach((row) => {
      row.addEventListener("click", () => {
        const idSessao = row.dataset.idSessao;
        const sessao = (data || []).find(
          (s) => String(s.id_sessao) === String(idSessao),
        );
        if (sessao) {
          abrirModalSessao(sessao);
        }
      });
    });
  }

  // ---------- OPEN/CLOSE MODAL ----------
  function openModal(mod) { mod && mod.classList.add('open'); }
  function closeModal(mod) { mod && mod.classList.remove('open'); }

  // ---------- MODAL PAGAMENTO: ABRIR ----------
  function abrirModalPagamento(modo) {
    if (!formPag) return;
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      alert("Seleciona primeiro um aluno na lista.");
      return;
    }

    const agora = new Date();

    inputAno.value = String(agora.getFullYear());
    inputMes.value = String(agora.getMonth() + 1);
    inputDiaPag.value = "";
    inputValor.value = "";

    formPag.modo.value = modo;
    msgPag.textContent = "";
    msgPag.style.color = "";

    inputDiaPag.style.display = "none";
    inputValor.style.display = "none";

    if (modo === "iniciar") {
      pagModalTitle.textContent = "Iniciar fatura√ß√£o";
      pagModalHint.textContent  =
        "Defina o m√™s/ano de in√≠cio e o dia de pagamento da mensalidade.";
      inputDiaPag.style.display = "block";
      btnSavePag.textContent    = "Iniciar fatura√ß√£o";

    } else if (modo === "registar") {
      pagModalTitle.textContent = "Registar pagamento";
      pagModalHint.textContent  =
        "Regista um pagamento a acrescentar ao valor j√° pago nesse m√™s.";
      inputValor.style.display  = "block";
      btnSavePag.textContent    = "Registar pagamento";

    } else { // "editar"
      pagModalTitle.textContent = "Editar pagamento";
      pagModalHint.textContent  =
        "Substitui o valor pago nesse m√™s pelo valor indicado.";
      inputValor.style.display  = "block";
      btnSavePag.textContent    = "Guardar altera√ß√µes";
    }

    openModal(modalPag);
  }

  btnIniciarFat?.addEventListener("click", () => abrirModalPagamento("iniciar"));
  btnRegistarPag?.addEventListener("click", () => abrirModalPagamento("registar"));
  btnEditarPag?.addEventListener("click", () => abrirModalPagamento("editar"));

  $('#modal-pagamento-aluno .modal__close')?.addEventListener('click', () => {
    closeModal(modalPag);
  });

  modalPag?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalPag);
    }
  });

  // ---------- SUBMIT MODAL PAGAMENTO ----------
  formPag?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      msgPag.textContent = "Nenhum aluno selecionado.";
      return;
    }

    const modo  = formPag.modo.value;
    const ano   = Number(inputAno.value);
    const mes   = Number(inputMes.value);
    const dia   = inputDiaPag.value ? Number(inputDiaPag.value) : null;
    const valor = inputValor.value ? Number(inputValor.value) : null;

    if (!ano || !mes || mes < 1 || mes > 12) {
      msgPag.textContent = "Ano ou m√™s inv√°lidos.";
      return;
    }

    if (modo === "iniciar") {
      if (!dia || dia < 1 || dia > 31) {
        msgPag.textContent = "Dia de pagamento inv√°lido.";
        return;
      }
    } else {
      if (valor === null || isNaN(valor) || valor < 0) {
        msgPag.textContent = "Valor inv√°lido.";
        return;
      }
    }

    btnSavePag.disabled = true;
    msgPag.textContent  = "A guardar...";

    try {
      let action, payload;

      if (modo === "iniciar") {
        action = "iniciar_faturacao_aluno";
        payload = {
          aluno_id: ALUNO_ATUAL.id_aluno,
          ano,
          mes,
          dia_pagamento: dia,
        };
      } else if (modo === "registar") {
        action = "registar_pagamento_aluno";
        payload = {
          aluno_id: ALUNO_ATUAL.id_aluno,
          ano,
          mes,
          valor,
        };
      } else {
        action = "update_pagamento_aluno";
        payload = {
          aluno_id: ALUNO_ATUAL.id_aluno,
          ano,
          mes,
          valor_pago: valor,
        };
      }

      const { data, error } = await callExplFn(action, payload);

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro pagamento_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
              else extra = " " + raw;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        msgPag.textContent = "N√£o foi poss√≠vel guardar." + extra;
        btnSavePag.disabled = false;
        return;
      }

      msgPag.style.color = "#126b3a";
      msgPag.textContent = "Guardado com sucesso.";

      await loadKpisFinanceiros();
      const alunoAtualizado = ALUNOS_CACHE.find(
        (a) => String(a.id_aluno) === String(ALUNO_ATUAL.id_aluno)
      );
      if (alunoAtualizado) {
        await mostrarPainelAluno(alunoAtualizado);
      }

      setTimeout(() => closeModal(modalPag), 600);
    } catch (e) {
      console.error("pagamento_aluno error", e);
      msgPag.textContent = "Erro inesperado ao guardar.";
    } finally {
      btnSavePag.disabled = false;
    }
  });

  // ---------- Painel de detalhes por aluno ----------
  async function mostrarPainelAluno(aluno) {
    ALUNO_ATUAL = aluno;

    const card = document.getElementById("aluno-detail-card");
    if (!card) return;

    const nomeCompleto = [aluno.nome, aluno.apelido].filter(Boolean).join(" ");
    document.getElementById("aluno-detail-nome").textContent =
      nomeCompleto || "Aluno";

    // Atualizar estado (Ativo / Bloqueado + switch)
    updateAlunoStatusUI(aluno);

    document.getElementById("aluno-detail-meta").textContent =
      aluno.username ? `Username: ${aluno.username}` : "";

    document.getElementById("aluno-detail-email").textContent =
      aluno.email || "‚Äî";
    document.getElementById("aluno-detail-tel").textContent =
      aluno.telemovel || "‚Äî";
    document.getElementById("aluno-detail-ano").textContent =
      aluno.ano ?? "‚Äî";

    const valorExp =
      aluno.valor_explicacao != null
        ? `‚Ç¨ ${Number(aluno.valor_explicacao).toFixed(2)}`
        : "‚Äî";
    document.getElementById("aluno-detail-valor").textContent = valorExp;

    const sessoes =
      aluno.sessoes_mes != null ? String(aluno.sessoes_mes) : "‚Äî";
    document.getElementById("aluno-detail-sessoes").textContent = sessoes;

    card.style.display = "block";

    if (!EXPLICADOR.id_explicador) return;

    const elPrevistoMes = document.getElementById("aluno-detail-previsto-mes");
    const elPagoMes     = document.getElementById("aluno-detail-pago-mes");
    const elEmFalta     = document.getElementById("aluno-detail-emfalta");

    try {
      const now = new Date();
      const anoAtual = now.getFullYear();
      const mesAtual = now.getMonth() + 1;

      const { data, error } = await supabase
        .from("v_pagamentos_detalhe")
        .select("ano, mes, valor_previsto, valor_pago, estado")
        .eq("id_explicador", EXPLICADOR.id_explicador)
        .eq("id_aluno", aluno.id_aluno);

      if (error) {
        console.error("Erro a carregar pagamentos do aluno", error);
        if (elPrevistoMes) elPrevistoMes.textContent = "‚Äî";
        if (elPagoMes)     elPagoMes.textContent     = "‚Äî";
        if (elEmFalta)     elEmFalta.textContent     = "‚Äî";
        return;
      }

      let previstoMes = 0;
      let pagoMes     = 0;
      let emFaltaTotal = 0;

      (data || []).forEach((p) => {
        const previsto = Number(p.valor_previsto) || 0;
        const pago     = Number(p.valor_pago) || 0;
        const falta    = Math.max(previsto - pago, 0);

        if (p.ano === anoAtual && p.mes === mesAtual) {
          previstoMes += previsto;
          pagoMes     += pago;
        }

        emFaltaTotal += falta;
      });

      if ((!data || data.length === 0) &&
          aluno.valor_explicacao != null &&
          aluno.sessoes_mes != null) {

        const estimado = Number(aluno.valor_explicacao) * Number(aluno.sessoes_mes);
        previstoMes   = estimado;
        pagoMes       = 0;
        emFaltaTotal  = estimado;
      }

      if (elPrevistoMes) {
        elPrevistoMes.textContent = `‚Ç¨ ${previstoMes.toFixed(2)}`;
      }
      if (elPagoMes) {
        elPagoMes.textContent     = `‚Ç¨ ${pagoMes.toFixed(2)}`;
      }
      if (elEmFalta) {
        elEmFalta.textContent     = `‚Ç¨ ${emFaltaTotal.toFixed(2)}`;
      }
    } catch (err) {
      console.error("Erro inesperado ao calcular resumo do aluno", err);
    }

    await loadSessoesAluno(aluno.id_aluno);
  }

  // ---------- CRIAR ALUNO ----------
  async function createAluno(payload) {
    const { data, error } = await callExplFn("create_aluno", payload);

    if (error) {
      console.error(error);
      return { ok: false, error: error.message };
    }

    return { ok: true, data };
  }

  // ---------- MODAIS (add / edit / sess√£o) ----------
  modalAddAluno?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalAddAluno);
    }
  });

  $('#modal-add-aluno .modal__close')?.addEventListener('click', () => {
    closeModal(modalAddAluno);
  });

  btnFab?.addEventListener('click', () => openModal(modalAddAluno));
  btnOpenAddAluno?.addEventListener('click', () => openModal(modalAddAluno));

  $('#modal-edit-aluno .modal__close')?.addEventListener('click', () => {
    closeModal(modalEditAluno);
  });

  modalEditAluno?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalEditAluno);
    }
  });

  $('#modal-sessao .modal__close')?.addEventListener('click', () => {
    closeModal(modalSessao);
  });

  modalSessao?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalSessao);
    }
  });

  // ---------- PREENCHER MODAL DE EDI√á√ÉO DO ALUNO ----------
  function preencherModalEdicao(aluno) {
    if (!formEdit || !aluno) return;

    formEdit.nome_edit.value  = aluno.nome || "";
    formEdit.apelido_edit.value = aluno.apelido || "";
    formEdit.telemovel_edit.value = aluno.telemovel || "";
    formEdit.ano_edit.value = aluno.ano != null ? aluno.ano : "";
    formEdit.idade_edit.value = aluno.idade != null ? aluno.idade : "";
    formEdit.dia_semana_preferido_edit.value = aluno.dia_semana_preferido || "";
    formEdit.valor_explicacao_edit.value =
      aluno.valor_explicacao != null ? aluno.valor_explicacao : "";
    formEdit.sessoes_mes_edit.value =
      aluno.sessoes_mes != null ? aluno.sessoes_mes : "";
    formEdit.nome_pai_cache_edit.value = aluno.nome_pai_cache || "";
    formEdit.contacto_pai_cache_edit.value = aluno.contacto_pai_cache || "";
    formEdit.email_edit.value = aluno.email || "";
    formEdit.username_edit.value = aluno.username || "";
    formEdit.password_edit.value = "";
    msgEditAluno.textContent = "";
    msgEditAluno.style.color = "";
  }

  btnEditarAluno?.addEventListener("click", () => {
    if (!ALUNO_ATUAL) {
      alert("Seleciona primeiro um aluno na lista.");
      return;
    }
    preencherModalEdicao(ALUNO_ATUAL);
    openModal(modalEditAluno);
  });

  // ---------- TOGGLE ATIVO / BLOQUEADO ----------
  toggleAlunoAtivo?.addEventListener('click', async () => {
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) return;

    const estavaAtivo = ALUNO_ATUAL.is_active !== false;
    const novoEstado = !estavaAtivo;

    if (!novoEstado) {
      const confirma = confirm(
        'Ao bloquear este aluno ele deixa de conseguir fazer login e deixa de contar como aluno ativo. Continuar?'
      );
      if (!confirma) return;
    }

    // feedback m√≠nimo
    if (alunoStatusBadge) {
      alunoStatusBadge.textContent = 'A atualizar...';
    }

    const { error } = await callExplFn('update_aluno', {
      id_aluno: ALUNO_ATUAL.id_aluno,
      is_active: novoEstado,
    });

    if (error) {
      console.error('Erro ao alterar estado do aluno', error);
      alert('N√£o foi poss√≠vel atualizar o estado do aluno.');
      // volta ao estado anterior no UI
      updateAlunoStatusUI(ALUNO_ATUAL);
      return;
    }

    // Atualizar caches
    ALUNO_ATUAL.is_active = novoEstado;
    const idx = (ALUNOS_CACHE || []).findIndex(
      a => String(a.id_aluno) === String(ALUNO_ATUAL.id_aluno)
    );
    if (idx >= 0) {
      ALUNOS_CACHE[idx].is_active = novoEstado;
    }

    // Atualizar UI dependentes
    updateAlunoStatusUI(ALUNO_ATUAL);
    renderDashboardAlunos();
    await loadKpisFinanceiros();
  });

  // ---------- SUBMIT EDITAR ALUNO ----------
  formEdit?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    msgEditAluno.textContent = "";

    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      msgEditAluno.textContent = "Nenhum aluno selecionado.";
      return;
    }

    const f = ev.target;

    const payload = {
      id_aluno: ALUNO_ATUAL.id_aluno,
      nome: f.nome_edit.value.trim() || null,
      apelido: f.apelido_edit.value.trim() || null,
      telemovel: f.telemovel_edit.value.trim() || null,
      ano: f.ano_edit.value ? Number(f.ano_edit.value) : null,
      idade: f.idade_edit.value ? Number(f.idade_edit.value) : null,
      dia_semana_preferido: f.dia_semana_preferido_edit.value.trim() || null,
      valor_explicacao: f.valor_explicacao_edit.value
        ? Number(f.valor_explicacao_edit.value)
        : null,
      sessoes_mes: f.sessoes_mes_edit.value
        ? Number(f.sessoes_mes_edit.value)
        : null,
      nome_pai_cache: f.nome_pai_cache_edit.value.trim() || null,
      contacto_pai_cache: f.contacto_pai_cache_edit.value.trim() || null,
      email: f.email_edit.value.trim() || null,
      username: f.username_edit.value.trim() || null,
      password: f.password_edit.value.trim() || undefined,
      is_active: ALUNO_ATUAL?.is_active ?? true,
    };

    btnSaveEdit.disabled = true;
    msgEditAluno.textContent = "A guardar altera√ß√µes...";

    try {
      const { data, error } = await callExplFn("update_aluno", payload);

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro update_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        msgEditAluno.textContent =
          "N√£o foi poss√≠vel guardar as altera√ß√µes." + extra;
        btnSaveEdit.disabled = false;
        return;
      }

      msgEditAluno.style.color = "#126b3a";
      msgEditAluno.textContent = "Altera√ß√µes guardadas com sucesso.";

      await loadAlunos();
      const alunoAtualizado = ALUNOS_CACHE.find(
        (a) => String(a.id_aluno) === String(ALUNO_ATUAL.id_aluno)
      );
      if (alunoAtualizado) {
        mostrarPainelAluno(alunoAtualizado);
      }

      setTimeout(() => {
        closeModal(modalEditAluno);
      }, 600);
    } catch (e) {
      console.error("update_aluno error", e);
      msgEditAluno.textContent = "Erro inesperado ao guardar altera√ß√µes.";
    } finally {
      btnSaveEdit.disabled = false;
    }
  });

  // ---------- SUBMIT NOVO ALUNO ----------
  formNew?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    msgNewAluno.textContent = "";

    if (!EXPLICADOR.id_explicador) {
      msgNewAluno.textContent = "Perfil de explicador inv√°lido.";
      return;
    }

    const f = ev.target;

    const payload = {
      nome: f.nome?.value.trim() || "",
      apelido: f.apelido?.value.trim() || null,
      telemovel: f.telemovel?.value.trim() || null,
      ano: f.ano?.value ? Number(f.ano.value) : null,
      idade: f.idade?.value ? Number(f.idade.value) : null,
      dia_semana_preferido: f.dia_semana_preferido?.value.trim() || null,
      valor_explicacao: f.valor_explicacao?.value
        ? Number(f.valor_explicacao.value)
        : null,
      sessoes_mes: f.sessoes_mes?.value
        ? Number(f.sessoes_mes.value)
        : null,
      nome_pai_cache: f.nome_pai_cache?.value.trim() || null,
      contacto_pai_cache: f.contacto_pai_cache?.value.trim() || null,
      email: f.email?.value.trim() || "",
      username: f.username?.value.trim() || null,
      password: f.password?.value || "",
      is_active: true,
    };

    if (!payload.nome || !payload.email || !payload.password) {
      msgNewAluno.textContent =
        "Preenche pelo menos Nome, Email e Password.";
      return;
    }

    btnCreate.disabled = true;
    msgNewAluno.textContent = "A criar aluno...";

    const { data, error } = await callExplFn("create_aluno", payload);

    if (error) {
      let extra = "";

      if (error.context) {
        try {
          const resp = error.context;
          const raw = await resp.text();
          console.log("Erro bruto da fun√ß√£o expl-alunos:", raw);

          try {
            const json = JSON.parse(raw);
            if (json?.error) {
              extra = " " + json.error;
            } else {
              extra = " " + raw;
            }
          } catch {
            extra = " " + raw;
          }
        } catch (e) {
          console.warn("N√£o consegui ler o body da resposta da fun√ß√£o", e);
        }
      }

      console.error("create_aluno error", error);
      msgNewAluno.textContent =
        "N√£o foi poss√≠vel criar o aluno." + extra;
      btnCreate.disabled = false;
      return;
    }

    msgNewAluno.style.color = "#126b3a";
    msgNewAluno.textContent = "Aluno criado com sucesso!";
    f.reset();
    await loadAlunos();
    await loadKpisFinanceiros();
    btnCreate.disabled = false;
  });

  // ---------- LOGIN ----------
  formLogin?.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    msgLogin.textContent = 'A entrar...';

    const email    = formLogin.email.value.trim();
    const password = formLogin.password.value.trim();

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      console.error(error);
      msgLogin.textContent = 'Credenciais inv√°lidas.';
      return;
    }

    const user = data.user;
    if (!(await hasRole(user.id, 'explicador'))) {
      await supabase.auth.signOut().catch(()=>{});
      msgLogin.textContent = 'Esta conta n√£o √© de explicador.';
      return;
    }

    const exp = await getExplRow(user.id);
    EXPLICADOR = {
      userId: user.id,
      id_explicador: exp?.id_explicador || null,
      max: exp?.max_alunos ?? 0
    };

    const nomeCompleto = [exp?.nome, exp?.apelido].filter(Boolean).join(' ') || 'Professor';
    elNomeHeader.textContent = nomeCompleto;
    elNomeMini.textContent   = nomeCompleto;

    setState({ isExpl: true, isAuthed: true });
    await loadAlunos();
    await loadKpisFinanceiros();
    await loadResumoCalendario();
  });

  // ---------- LOGOUT ----------
  btnLogout?.addEventListener('click', async () => {
    await supabase.auth.signOut().catch(()=>{});
    window.location.href = './index.html';
  });

  // ---------- SESS√ÉO INICIAL ----------
  (async () => {
    setState({ loading: true });

    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) {
      setState({ isExpl: false, isAuthed: false });
      return;
    }

    const user = session.user;
    if (!(await hasRole(user.id, 'explicador'))) {
      await supabase.auth.signOut().catch(()=>{});
      setState({ isExpl: false, isAuthed: false });
      msgLogin.textContent = 'Conta sem permiss√µes de explicador.';
      return;
    }

    const exp = await getExplRow(user.id);
    EXPLICADOR = {
      userId: user.id,
      id_explicador: exp?.id_explicador || null,
      max: exp?.max_alunos ?? 0
    };

    const nomeCompleto = [exp?.nome, exp?.apelido].filter(Boolean).join(' ') || 'Professor';
    elNomeHeader.textContent = nomeCompleto;
    elNomeMini.textContent   = nomeCompleto;

    setState({ isExpl: true, isAuthed: true });
    await loadAlunos();
    await loadKpisFinanceiros();
    await loadResumoCalendario();
  })();

  // ---------- NAVEGA√á√ÉO LATERAL (tabs) ----------
  const tabs = document.querySelectorAll('.expl-nav-btn');
  const screens = document.querySelectorAll('.expl-section[data-section]');

  function ativarScreen(target) {
    screens.forEach(sec => {
      const key = sec.dataset.section;
      sec.style.display = key === target ? '' : 'none';
    });

    document.querySelector('.expl-body')?.scrollTo({ top: 0, behavior: 'smooth' });
    const title = document.querySelector('.expl-page-title');
    if (title) {
      const mapTitle = {
        dashboard: 'Dashboard',
        alunos: 'Alunos',
        calendario: 'Calend√°rio',
        faturacao: 'Fatura√ß√£o',
        relatorios: 'Relat√≥rios',
      };
      title.textContent = mapTitle[target] || 'Dashboard';
    }
  }

  tabs.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      tabs.forEach(t => t.classList.remove('expl-nav-btn--active'));
      btn.classList.add('expl-nav-btn--active');
      ativarScreen(target);
    });
  });

  // bot√£o "Ver todos" na dashboard -> tab Alunos
  btnDashVerAlunos?.addEventListener('click', () => {
    const tabAlunos = document.querySelector('.expl-nav-btn[data-target="alunos"]');
    tabAlunos?.click();
  });

  // scroll para lista de alunos
  btnScrollLista?.addEventListener('click', () => {
    document.querySelector('#lista-alunos-card')?.scrollIntoView({
      behavior:'smooth',
      block:'start'
    });
  });

  supabase.auth.onAuthStateChange(async (_evt, session) => {
    if (!session?.user) {
      setState({ isExpl: false, isAuthed: false });
    }
  });

  // ---------- SESS√ïES: ABRIR MODAL ----------
  function abrirModalSessao(sessao) {
    if (!formSessao) return;

    if (sessao) {
      SESSAO_ATUAL_ID = sessao.id_sessao;
      formSessao.data_sessao.value = sessao.data || "";
      formSessao.hora_inicio.value = sessao.hora_inicio || "";
      formSessao.hora_fim.value = sessao.hora_fim || "";
      formSessao.duracao_min.value =
        sessao.duracao_min != null ? sessao.duracao_min : "";
      formSessao.estado.value = sessao.estado || "AGENDADA";
      formSessao.observacoes.value = sessao.observacoes || "";
      btnDeleteSessao.style.display = "inline-block";
    } else {
      SESSAO_ATUAL_ID = null;
      formSessao.data_sessao.value = "";
      formSessao.hora_inicio.value = "";
      formSessao.hora_fim.value = "";
      formSessao.duracao_min.value = "";
      formSessao.estado.value = "AGENDADA";
      formSessao.observacoes.value = "";
      btnDeleteSessao.style.display = "none";
    }

    msgSessao.textContent = "";
    msgSessao.style.color = "";
    openModal(modalSessao);
  }

  btnAddSessao?.addEventListener("click", () => {
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      alert("Seleciona primeiro um aluno na lista.");
      return;
    }
    abrirModalSessao(null);
  });

  // ---------- SESS√ïES: SUBMIT ----------
  formSessao?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    msgSessao.textContent = "";

    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      msgSessao.textContent = "Nenhum aluno selecionado.";
      return;
    }

    const f = ev.target;

    const data = f.data_sessao.value;
    if (!data) {
      msgSessao.textContent = "Data √© obrigat√≥ria.";
      return;
    }

    const payload = {
      id_sessao: SESSAO_ATUAL_ID || undefined,
      aluno_id: ALUNO_ATUAL.id_aluno,
      data,
      hora_inicio: f.hora_inicio.value || null,
      hora_fim: f.hora_fim.value || null,
      duracao_min: f.duracao_min.value || null,
      estado: f.estado.value || "AGENDADA",
      observacoes: f.observacoes.value || null,
    };

    btnSaveSessao.disabled = true;
    msgSessao.textContent = "A guardar sess√£o...";

    try {
      const { data, error } = await callExplFn("upsert_sessao_aluno", payload);

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro upsert_sessao_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        msgSessao.textContent =
          "N√£o foi poss√≠vel guardar a sess√£o." + extra;
        btnSaveSessao.disabled = false;
        return;
      }

      msgSessao.style.color = "#126b3a";
      msgSessao.textContent = "Sess√£o guardada com sucesso.";

      await loadSessoesAluno(ALUNO_ATUAL.id_aluno);
      setTimeout(() => {
        closeModal(modalSessao);
      }, 500);
    } catch (e) {
      console.error("upsert_sessao_aluno error", e);
      msgSessao.textContent = "Erro inesperado ao guardar sess√£o.";
    } finally {
      btnSaveSessao.disabled = false;
    }
  });

  // ---------- SESS√ïES: APAGAR ----------
  btnDeleteSessao?.addEventListener("click", async () => {
    if (!SESSAO_ATUAL_ID) {
      return;
    }
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      alert("Nenhum aluno selecionado.");
      return;
    }

    const conf = confirm("Tens a certeza que queres apagar esta sess√£o?");
    if (!conf) return;

    msgSessao.textContent = "A apagar sess√£o...";
    btnDeleteSessao.disabled = true;

    try {
      const { data, error } = await callExplFn("delete_sessao_aluno", {
        id_sessao: SESSAO_ATUAL_ID,
      });

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro delete_sessao_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        msgSessao.textContent =
          "N√£o foi poss√≠vel apagar a sess√£o." + extra;
        btnDeleteSessao.disabled = false;
        return;
      }

      msgSessao.style.color = "#126b3a";
      msgSessao.textContent = "Sess√£o apagada com sucesso.";

      await loadSessoesAluno(ALUNO_ATUAL.id_aluno);
      setTimeout(() => {
        closeModal(modalSessao);
      }, 400);
    } catch (e) {
      console.error("delete_sessao_aluno error", e);
      msgSessao.textContent = "Erro inesperado ao apagar sess√£o.";
    } finally {
      btnDeleteSessao.disabled = false;
    }
  });

  // ------------------------------------------------------------------
  // RENDER CALEND√ÅRIO SEMANAL
  // ------------------------------------------------------------------
  function renderCalendarioSemanal() {
    const grid = document.getElementById("calendar-grid");
    const label = document.getElementById("week-label");
    if (!grid || !label) return;

    const hoje = new Date();
    const inicio = getInicioSemana(hoje);
    inicio.setDate(inicio.getDate() + semanaOffset * 7);

    const dias = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(inicio);
      d.setDate(inicio.getDate() + i);
      dias.push(d);
    }

    const fmt = { day: "2-digit", month: "2-digit" };
    label.textContent = `Semana ${dias[0].toLocaleDateString("pt-PT", fmt)} ‚Äì ${dias[6].toLocaleDateString("pt-PT", fmt)}`;

    const nomes = ["Seg", "Ter", "Qua", "Qui", "Sex", "S√°b", "Dom"];

    grid.innerHTML = dias.map((d, idx) => {
      const dataStr = d.toISOString().slice(0, 10);
      const sessoes = SESSOES_EXPLICADOR.filter(s => s.data === dataStr);

      const temRealizada = sessoes.some(s => s.estado === "REALIZADA");
      const temAgendada  = sessoes.some(s => s.estado === "AGENDADA");
      const temExtra     = sessoes.some(s => s.estado === "EXTRA");

      const dotsHTML = `
        ${temRealizada ? `<span class="dot dot-green"></span>` : ""}
        ${temAgendada  ? `<span class="dot dot-yellow"></span>` : ""}
        ${temExtra     ? `<span class="dot dot-orange"></span>` : ""}
      `.trim();

      const lista = sessoes.length === 0
        ? `<p class="calendar-empty">Sem sess√µes</p>`
        : sessoes.map(s => `
            <div class="calendar-session">
              <strong>${s.hora_inicio?.slice(0,5) || "--:--"}</strong>
              <span>${s.aluno_nome}</span>
            </div>
          `).join("");

      return `
        <div class="calendar-day">
          <div class="calendar-day__header">
            <span class="calendar-day__weekday">${nomes[idx]}</span>
            <span class="calendar-day__date">${d.toLocaleDateString("pt-PT", fmt)}</span>
          </div>

          <div class="calendar-day__dots">${dotsHTML}</div>
          <div class="calendar-day__list">${lista}</div>
        </div>
      `;
    }).join("");
  }

  btnWeekPrev?.addEventListener('click', () => {
    semanaOffset -= 1;
    renderCalendarioSemanal();
  });

  btnWeekNext?.addEventListener('click', () => {
    semanaOffset += 1;
    renderCalendarioSemanal();
  });

  // --------------------------------------------------------------------
  // CARREGAR RESUMO DE CALEND√ÅRIO
  // --------------------------------------------------------------------
  async function loadResumoCalendario() {
    const { data, error } = await callExplFn("list_sessoes_explicador", null);

    if (error) {
      console.error("Erro a carregar sess√µes do explicador", error);
      return;
    }

    const sessoes = data || [];
    SESSOES_EXPLICADOR = sessoes;

    // HOJE
    const hojeStr = new Date().toISOString().slice(0, 10);
    const sessoesHoje = sessoes.filter(s => s.data === hojeStr);

    let txtHoje = "Sem sess√µes registadas";
    if (sessoesHoje.length > 0) {
      const detalhes = sessoesHoje
        .map(s => `${s.hora_inicio?.slice(0, 5) || "--:--"} ${s.aluno_nome || ""}`.trim())
        .join(", ");

      txtHoje = `${sessoesHoje.length} sess√£o(√µes) hoje ¬∑ ${detalhes}`;
    }

    const elHoje = document.querySelector("#cal-resumo-hoje");
    if (elHoje) elHoje.textContent = txtHoje;

    // PR√ìXIMOS 7 DIAS
    const hojeDate = new Date();
    const seteDiasDepois = new Date();
    seteDiasDepois.setDate(hojeDate.getDate() + 7);

    const sessoesSemana = sessoes.filter(s => {
      const dataSess = new Date(s.data);
      dataSess.setHours(0, 0, 0, 0);
      return dataSess >= hojeDate && dataSess <= seteDiasDepois;
    });

    let txtSemana = "Agenda em branco por agora";
    if (sessoesSemana.length > 0) {
      const alunosUnicos = new Set(sessoesSemana.map(s => s.aluno_nome));
      txtSemana =
        `${sessoesSemana.length} sess√µes nos pr√≥ximos 7 dias ¬∑ ` +
        `${alunosUnicos.size} aluno(s) diferente(s)`;
    }

    const elSemana = document.querySelector("#cal-resumo-semana");
    if (elSemana) elSemana.textContent = txtSemana;

    renderCalendarioSemanal();
  }

  // estado inicial dos tabs
  ativarScreen('dashboard');
</script>


</body>
</html>