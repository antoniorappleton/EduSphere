<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="./styles.css"/>
  <title>EduSphere ‚Äî Explicador</title>

  <!-- Supabase UMD + client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
</head>

<body class="home">
<header>
  <div class="header-inner">
    <a class="logo" href="./index.html">
      <img src="/public/img/logo-icon.svg" alt="">
      <span>EduSphere</span>
    </a>
    <button id="btnLogout" class="button" style="margin-left:auto; display:none">Sair</button>
  </div>
</header>

<div class="capa__overlay"></div>

<main class="auth">

  <!-- ========= LOGIN DO EXPLICADOR ========= -->
  <section class="auth__panel" id="explLogin">
    <h1>Entrar (Explicador)</h1>
    <form id="fExplLogin" class="auth__form" autocomplete="on">
      <input type="email"   name="email"    placeholder="Email"    required />
      <input type="password" name="password" placeholder="Password" required />
      <button class="button" type="submit">Entrar</button>
      <div id="msgExplLogin" class="auth__msg"></div>
    </form>
  </section>

  <!-- ========= PAINEL DO EXPLICADOR ========= -->
  <section class="auth__panel" id="explPanel" style="display:none">

    <div class="expl-layout">
      <!-- Sidebar -->
      <aside class="expl-sidebar">
        <div class="expl-brand">
          <span class="expl-logo">E</span>
          <div>
            <p class="expl-app-name">EduSphere</p>
            <p class="expl-app-sub">Painel do Professor</p>
          </div>
        </div>

        <nav class="expl-nav">
          <button class="expl-nav-item expl-nav-item--active"><span>Dashboard</span></button>
          <button class="expl-nav-item"><span>Alunos</span></button>
          <button class="expl-nav-item"><span>Calend√°rio</span></button>
          <button class="expl-nav-item"><span>Fatura√ß√£o</span></button>
          <button class="expl-nav-item"><span>Relat√≥rios</span></button>
        </nav>
      </aside>

      <!-- Conte√∫do principal -->
      <div class="expl-main">
        <!-- Header -->
        <header class="expl-header">
          <div class="expl-header-left">
            <h1 class="expl-title">
              Ol√°, <span id="expl-nome-header">Professor</span>
            </h1>
            <p class="expl-subtitle">Aqui est√° o resumo da sua atividade.</p>
          </div>

          <div class="expl-header-right">
            <button class="expl-notifications" aria-label="Notifica√ß√µes">
              üîî
              <span class="expl-badge" id="expl-notif-count">0</span>
            </button>
            <div class="expl-user">
              <img src="https://via.placeholder.com/40" class="expl-avatar" alt="Foto do explicador">
              <div>
                <p class="expl-user-name" id="expl-nome-mini">Professor</p>
                <p class="expl-user-role">Explicador</p>
              </div>
            </div>
          </div>
        </header>

        <!-- √Årea principal -->
        <div class="expl-content">

          <!-- Resumo financeiro (neste momento placeholders, depois ligas √† BD) -->
          <section class="expl-section">
            <h2 class="expl-section-title">Resumo financeiro</h2>
            <div class="expl-cards">
              <article class="expl-card">
                <p class="expl-card-label">Total faturado (este m√™s)</p>
                <p class="expl-card-value" id="card-total-mes">‚Ç¨ 0,00</p>
              </article>

              <article class="expl-card">
                <p class="expl-card-label">Mensalidades pendentes</p>
                <p class="expl-card-value expl-card-value--warning" id="card-pendentes">
                  ‚Ç¨ 0,00
                </p>
              </article>

              <article class="expl-card">
                <p class="expl-card-label">Pagamentos recebidos</p>
                <p class="expl-card-value expl-card-value--success" id="card-recebidos">
                  0 / 0
                </p>
              </article>
            </div>
          </section>

          <!-- Sec√ß√£o Meus Alunos: quota + formul√°rio + tabela -->
          <section class="expl-section">
            <div class="expl-section-header">
              <h2 class="expl-section-title">Meus Alunos</h2>
              <button class="expl-link-button" type="button" id="btn-scroll-lista">
                Ver lista
              </button>
            </div>

            <div class="expl-grid-2">
              <!-- Coluna esquerda: quota + formul√°rio -->
              <div class="expl-card">

                <h3 style="margin-bottom:.5rem;">Quota de alunos</h3>
                <div class="card" id="quotaCard">
                  <p><strong>Limite:</strong> <span id="limite">‚Äî</span></p>
                  <p><strong>Ativos:</strong> <span id="contagem">0</span></p>
                  <p><strong>Restantes:</strong> <span id="restantes">‚Äî</span></p>
                </div>

                <h3 style="margin:1rem 0 .5rem;">Criar novo aluno</h3>
                <form id="fNewAluno" class="auth__form" style="margin-bottom:0;">
                  <div class="grid2">
                    <input name="nome"      placeholder="Nome"                 required />
                    <input name="apelido"   placeholder="Apelido (opcional)" />
                    <input name="contacto"  placeholder="Contacto (opcional)" />
                    <input type="number" name="ano" min="1" max="12"
                           placeholder="Ano escolaridade (opcional)" />
                    <input type="email"   name="email"
                           placeholder="Email (login do aluno)" required />
                    <input type="password" name="password" minlength="6"
                           placeholder="Password" required />
                  </div>
                  <button id="btnCreateAluno" class="button" type="submit">
                    Criar Aluno
                  </button>
                  <div id="msgNewAluno" class="auth__msg"></div>
                </form>
              </div>

              <!-- Coluna direita: tabela de alunos -->
              <div class="expl-card" id="lista-alunos-card">
                <h3 style="margin-bottom:.5rem;">Lista de alunos</h3>
                <div class="table-wrapper">
                  <table class="table" id="tblAlunos">
                    <thead>
                      <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Ano</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- Calend√°rio + Relat√≥rios (placeholders) -->
          <section class="expl-section expl-grid-2">
            <div>
              <h2 class="expl-section-title">Calend√°rio</h2>
              <div class="expl-card expl-calendar-placeholder">
                <p>Calend√°rio de explica√ß√µes (a integrar)</p>
              </div>
            </div>

            <div>
              <h2 class="expl-section-title">Relat√≥rios</h2>
              <div class="expl-card expl-chart-placeholder">
                <p>Gr√°ficos de fatura√ß√£o e alunos ativos (a integrar)</p>
              </div>
            </div>
          </section>

        </div>

        <!-- Bot√£o flutuante para centrar no formul√°rio de aluno -->
        <button class="expl-fab" id="btn-add-aluno" type="button">+</button>
      </div>
    </div>
  </section>
</main>

<footer>¬© <span id="y"></span> EduSphere</footer>

<script>
  const $  = (s) => document.querySelector(s);

  // Elementos globais
  const elYear      = $('#y');
  const btnLogout   = $('#btnLogout');
  const loginBox    = $('#explLogin');
  const panel       = $('#explPanel');
  const msgLogin    = $('#msgExplLogin');
  const formLogin   = $('#fExplLogin');

  const formNew     = $('#fNewAluno');
  const msgNewAluno = $('#msgNewAluno');
  const btnCreate   = $('#btnCreateAluno');

  const elLimite    = $('#limite');
  const elContagem  = $('#contagem');
  const elRestantes = $('#restantes');
  const tblBody     = $('#tblAlunos tbody');

  const btnFab      = $('#btn-add-aluno');
  const btnScrollLista = $('#btn-scroll-lista');

  const elNomeHeader = $('#expl-nome-header');
  const elNomeMini   = $('#expl-nome-mini');

  elYear.textContent = new Date().getFullYear();

  // Estado do explicador
  let EXPLICADOR = { userId:null, id_explicador:null, max:0 };

  // Helpers Supabase
  async function hasRole(uid, roleName){
    const { data, error } = await supabase
      .from('app_users')
      .select('role')
      .eq('user_id', uid)
      .eq('role', roleName)
      .maybeSingle();
    if (error) {
      console.error('hasRole error', error);
      return false;
    }
    return !!data;
  }

  async function getExplRow(uid){
    const { data, error } = await supabase
      .from('explicadores')
      .select('id_explicador, nome, apelido, max')
      .eq('user_id', uid)
      .maybeSingle();
    if (error) throw error;
    return data || null;
  }


  function setState({ loading=false, isExpl=false, isAuthed=false }){
    if (loading){
      loginBox.style.display = 'block';
      panel.style.display    = 'none';
      msgLogin.textContent   = 'A verificar sess√£o...';
      btnLogout.style.display = 'none';
      return;
    }
    if (isAuthed && isExpl){
      loginBox.style.display = 'none';
      panel.style.display    = 'block';
      msgLogin.textContent   = '';
      btnLogout.style.display= 'inline-block';
    } else {
      loginBox.style.display = 'block';
      panel.style.display    = 'none';
      btnLogout.style.display= 'none';
    }
  }

  // UI da quota
  function updateQuotaUI(total){
    const max = Number(EXPLICADOR.max || 0);
    elContagem.textContent = String(total);

    if (!max){
      elLimite.textContent    = 'Sem limite';
      elRestantes.textContent = '‚Äî';
      btnCreate.disabled      = false;
      btnCreate.title         = '';
      return;
    }
    elLimite.textContent = String(max);
    const rest = Math.max(0, max - total);
    elRestantes.textContent = String(rest);
    btnCreate.disabled = rest <= 0;
    btnCreate.title    = rest <= 0 ? 'Limite de alunos atingido.' : '';
  }

  // Listar alunos deste explicador
  async function loadAlunos(){
    if (!EXPLICADOR.id_explicador) return;

    const { data, error } = await supabase
      .from('alunos')
      .select('nome, apelido, email, ano')
      .eq('id_explicador', EXPLICADOR.id_explicador)
      .order('nome', { ascending: true });


    if (error){
      console.error('loadAlunos error', error);
      tblBody.innerHTML = '<tr><td colspan="3">Erro a carregar alunos.</td></tr>';
      updateQuotaUI(0);
      return;
    }
    if (!data?.length){
      tblBody.innerHTML = '<tr><td colspan="3">Sem alunos ainda.</td></tr>';
      updateQuotaUI(0);
      return;
    }

    tblBody.innerHTML = data.map(a => {
      const nome = [a.nome, a.apelido].filter(Boolean).join(' ');
      const ano = a.ano ?? '-';
      return `<tr><td>${nome || '-'}</td><td>${a.email || '-'}</td><td>${ano}</td></tr>`;
    }).join('');

    updateQuotaUI(data.length);
  }

  // Criar aluno via Edge Function
  async function createAluno(payload){
    try{
      const { data, error } = await supabase.functions.invoke('expl-alunos', {
        body: { action: 'create_aluno', payload }
      });
      if (error) throw error;
      return { ok:true, data };
    }catch(err){
      return { ok:false, error: err };
    }
  }

  // LOGIN
  formLogin?.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    msgLogin.textContent = 'A entrar...';

    const email    = formLogin.email.value.trim();
    const password = formLogin.password.value.trim();

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error){
      console.error(error);
      msgLogin.textContent = 'Credenciais inv√°lidas.';
      return;
    }

    const user = data.user;
    if (!(await hasRole(user.id, 'explicador'))){
      await supabase.auth.signOut().catch(()=>{});
      msgLogin.textContent = 'Esta conta n√£o √© de explicador.';
      return;
    }

    const exp = await getExplRow(user.id);
    EXPLICADOR = {
      userId: user.id,
      id_explicador: exp?.id_explicador || null,
      max: exp?.max ?? 0
    };


    // Atualizar nome no header
    const nomeCompleto = [exp?.nome, exp?.apelido].filter(Boolean).join(' ') || 'Professor';
    elNomeHeader.textContent = nomeCompleto;
    elNomeMini.textContent   = nomeCompleto;

    setState({ isExpl:true, isAuthed:true });
    await loadAlunos();
  });

  // LOGOUT
  btnLogout?.addEventListener('click', async () => {
    await supabase.auth.signOut().catch(()=>{});
    window.location.href = './index.html';
  });

  // Sess√£o inicial (auto-login se sess√£o j√° existe)
  (async () => {
    setState({ loading:true });

    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user){
      setState({ isExpl:false, isAuthed:false });
      return;
    }

    const user = session.user;
    if (!(await hasRole(user.id, 'explicador'))){
      await supabase.auth.signOut().catch(()=>{});
      setState({ isExpl:false, isAuthed:false });
      msgLogin.textContent = 'Conta sem permiss√µes de explicador.';
      return;
    }

    const exp = await getExplRow(user.id);
      EXPLICADOR = {
        userId: user.id,
        id_explicador: exp?.id_explicador || null,
        max: exp?.max ?? 0
    };


    const nomeCompleto = [exp?.nome, exp?.apelido].filter(Boolean).join(' ') || 'Professor';
    elNomeHeader.textContent = nomeCompleto;
    elNomeMini.textContent   = nomeCompleto;

    setState({ isExpl:true, isAuthed:true });
    await loadAlunos();
  })();

  // Criar novo aluno
  formNew?.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    msgNewAluno.textContent = '';
    msgNewAluno.style.color = '';

    if (!EXPLICADOR.id_explicador){
      msgNewAluno.textContent = 'Perfil de explicador inv√°lido.';
      return;
    }

    const max     = Number(EXPLICADOR.max || 0);
    const atuais  = Number(elContagem.textContent || 0);
    if (max && atuais >= max){
      msgNewAluno.textContent = 'Limite de alunos atingido.';
      return;
    }

    const f = ev.target;
    const payload = {
      nome:     f.nome.value.trim(),
      apelido:  f.apelido.value.trim()  || null,
      contacto: f.contacto.value.trim() || null,
      ano:      f.ano.value ? Number(f.ano.value) : null,
      email:    f.email.value.trim(),
      password: f.password.value,
      explicador_id: EXPLICADOR.id_explicador
    };

    if (!payload.nome || !payload.email || !payload.password){
      msgNewAluno.textContent = 'Preenche pelo menos Nome, Email e Password.';
      return;
    }

    btnCreate.disabled = true;
    msgNewAluno.textContent = 'A criar aluno...';

    const { ok, error } = await createAluno(payload);
    if (!ok){
      console.error(error);
      msgNewAluno.textContent = 'N√£o foi poss√≠vel criar o aluno.';
      btnCreate.disabled = false;
      return;
    }

    msgNewAluno.style.color = '#126b3a';
    msgNewAluno.textContent = 'Aluno criado com sucesso!';
    f.reset();
    await loadAlunos();
    btnCreate.disabled = false;
  });

  // FAB: scroll at√© ao formul√°rio
  btnFab?.addEventListener('click', () => {
    formNew?.scrollIntoView({ behavior:'smooth', block:'start' });
  });
  btnScrollLista?.addEventListener('click', () => {
    document.querySelector('#lista-alunos-card')?.scrollIntoView({ behavior:'smooth', block:'start' });
  });

  // Listener auth (multi-abas)
  supabase.auth.onAuthStateChange(async (_evt, session) => {
    if (!session?.user){
      setState({ isExpl:false, isAuthed:false });
    }
  });
</script>
</body>
</html>
