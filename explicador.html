<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="stylesheet" href="./css/aluno-perfil.css" />

  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#b91c1c">
  <link rel="icon" type="image/png" href="./public/img/icon-192.png" />
  
  <title>EduSphere ‚Äî Explicador</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
</head>

<body class="home">
<header>
  <div class="header-inner">
    <a class="logo" href="./index.html">
      <img src="./public/img/imagens/logo-icon192.png" alt="EduSphere">
      <span>EduSphere</span>
    </a>
    <button id="btnLogout" class="button" style="margin-left:auto; display:none">Sair</button>
  </div>
</header>

<div class="capa__overlay"></div>

<main class="auth">

  <!-- ========== LOGIN DO EXPLICADOR ========== -->
  <section class="auth__panel" id="explLogin">
    <h1>Entrar (Explicador)</h1>
    <p class="auth__hint">Use as credenciais de professor para aceder ao painel.</p>
    <form id="fExplLogin" class="auth__form" autocomplete="on">
      <input type="email"   name="email"    placeholder="Email"    required />
      <input type="password" name="password" placeholder="Password" required />
      <button class="button" type="submit">Entrar</button>
      <div id="msgExplLogin" class="auth__msg"></div>
    </form>
  </section>

  <!-- ========== PAINEL DO EXPLICADOR (FULL PAGE) ========== -->
  <section id="explPanel" class="expl-shell" style="display:none">
    <!-- NAV LATERAL PRINCIPAL -->
    <nav id="explSidebarNav" class="expl-sidebar-nav" style="display:none">
      <button class="expl-nav-btn expl-nav-btn--active" data-target="dashboard">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <rect x="4" y="4" width="7" height="7" rx="1.5" />
            <rect x="13" y="4" width="7" height="7" rx="1.5" />
            <rect x="4" y="13" width="7" height="7" rx="1.5" />
            <rect x="13" y="13" width="7" height="7" rx="1.5" />
          </svg>
        </span>
        <span class="expl-nav-label">Dashboard</span>
      </button>

      <button class="expl-nav-btn" data-target="alunos">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="9" r="3.2" />
            <path d="M6.5 19.5c1.2-2.3 3-3.6 5.5-3.6s4.3 1.3 5.5 3.6" />
          </svg>
        </span>
        <span class="expl-nav-label">Alunos</span>
      </button>

      <button class="expl-nav-btn" data-target="calendario">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <rect x="4" y="5.5" width="16" height="14" rx="2" />
            <path d="M4 10h16" />
            <path d="M9 4v3" />
            <path d="M15 4v3" />
          </svg>
        </span>
        <span class="expl-nav-label">Calend√°rio</span>
      </button>

      <button class="expl-nav-btn" data-target="faturacao">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M15.5 7.5c-1-.7-2.1-1.1-3.4-1.1-2.6 0-4.6 1.8-4.6 4.6s2 4.6 4.6 4.6c1.3 0 2.4-.4 3.4-1.1" />
            <path d="M11 5v14" />
          </svg>
        </span>
        <span class="expl-nav-label">Fatura√ß√£o</span>
      </button>

      <button class="expl-nav-btn" data-target="relatorios">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 18.5h16" />
            <path d="M6.5 15l3.2-4 3.2 2.7 4.1-5.2" />
            <path d="M16.8 8.5h3v3" />
          </svg>
        </span>
        <span class="expl-nav-label">Relat√≥rios</span>
      </button>
    </nav>

    <!-- CONTE√öDO PRINCIPAL -->
    <div class="expl-main">
      <!-- Top bar -->
      <header class="expl-header-bar">
        <div class="expl-header-info">
          <h1 class="expl-page-title">Dashboard</h1>
          <p class="expl-hello-sub">
            Bem-vindo, <span id="expl-nome-header">Professor</span>
          </p>
        </div>

        <div class="expl-header-user">
          <button class="expl-bell" aria-label="Notifica√ß√µes">
            <span class="expl-bell-icon">üîî</span>
            <span class="expl-bell-badge" id="expl-notif-count">0</span>
          </button>
          <div class="expl-header-avatar">
            <div class="expl-avatar-circle">E</div>
            <div class="expl-header-name">
              <p id="expl-nome-mini">Professor</p>
              <span>Explicador</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Conte√∫do scroll√°vel -->
      <div class="expl-body">

        <!-- ========== DASHBOARD ========== -->
        <section class="expl-section" data-section="dashboard">
          <!-- RESUMO FINANCEIRO -->
          <h2 class="expl-section-title">Resumo financeiro</h2>

          <div class="expl-kpi-grid">
            <article class="expl-card expl-kpi-card">
              <p class="expl-kpi-label">Fatura√ß√£o prevista (m√™s atual)</p>
              <p class="expl-kpi-value" id="card-total-previsto">‚Äî</p>
            </article>

            <article class="expl-card expl-kpi-card">
              <p class="expl-kpi-label">Fatura√ß√£o realizada (m√™s atual)</p>
              <p class="expl-kpi-value expl-kpi-value--green" id="card-total-mes">‚Äî</p>
            </article>

            <article class="expl-card expl-kpi-card">
              <p class="expl-kpi-label">Pagamentos pendentes</p>
              <p class="expl-kpi-value expl-kpi-value--red" id="card-pendentes">‚Äî</p>
            </article>
          </div>

          <!-- ALUNOS (CARDS DE RESUMO) -->
          <div class="expl-section-header" style="margin-top:2rem;">
            <h2 class="expl-section-title">
              Alunos <span class="expl-section-sub" id="dash-alunos-contador">(0 ativos)</span>
            </h2>
            <button class="expl-link-button" type="button" id="btn-dashboard-ver-alunos">
              Ver todos &rarr;
            </button>
          </div>

          <div class="dash-alunos-grid" id="dash-alunos-grid">
            <!-- cart√µes preenchidos por JS -->
          </div>
        </section>

        <!-- ========== ALUNOS (DETALHE) ========== -->
        <section class="expl-section" id="expl-sec-alunos" data-section="alunos">
          <div class="expl-section-header">
            <h2 class="expl-section-title">
              Alunos <span class="expl-section-sub">(ativos)</span>
            </h2>
            <button class="expl-link-button" type="button" id="btn-scroll-lista">
              Ver lista &rarr;
            </button>
          </div>

          <!-- CART√ÉO PEQUENO: QUOTA + A√á√ïES R√ÅPIDAS -->
          <div class="expl-card expl-card--quota">
            <h3 class="expl-subsection-title">Quota de alunos</h3>

            <div class="expl-quota">
              <p><strong>Limite:</strong> <span id="limite">Sem limite</span></p>
              <p><strong>Ativos:</strong> <span id="contagem">0</span></p>
              <p><strong>Restantes:</strong> <span id="restantes">‚Äî</span></p>
            </div>

            <h3 class="expl-subsection-title" style="margin-top:1rem;">A√ß√µes r√°pidas</h3>
            <div class="expl-actions-row">
              <button class="button secondary" id="btn-open-add-aluno">
                + Adicionar aluno
              </button>
            </div>
          </div>

          <!-- CART√ÉO GRANDE: LISTA DE ALUNOS (FULL WIDTH) -->
          <div class="expl-card" id="lista-alunos-card" style="margin-top:1.5rem;">
            <h3 class="expl-subsection-title">Lista de alunos</h3>

            <!-- Grelha de cart√µes de alunos -->
            <div class="dash-alunos-grid" id="alunos-cards-grid">
              <!-- cart√µes preenchidos por JS -->
            </div>
          </div>

          <!-- PAINEL DE DETALHES DO ALUNO -->
          <div
            class="expl-card expl-aluno-detail"
            id="aluno-detail-card"
            style="margin-top:1.5rem; display:none"
          >
            <h3 class="expl-subsection-title">
              Detalhes do aluno:
              <span id="aluno-detail-nome" class="expl-aluno-detail__nome">‚Äî</span>
            </h3>

            <p id="aluno-detail-meta" class="expl-aluno-detail__meta"></p>

            <div class="aluno-status-row">
              <span
                id="aluno-status-badge"
                class="aluno-status-badge aluno-status-badge--ativo"
              >
                Ativo
              </span>

              <button
                type="button"
                id="toggle-aluno-ativo"
                class="aluno-status-toggle"
                aria-pressed="true"
              >
                <span class="aluno-status-toggle__label">Aluno ativo</span>
                <span class="aluno-status-toggle__switch">
                  <span class="aluno-status-toggle__knob"></span>
                </span>
              </button>
            </div>

            <div class="expl-grid-2">
              <!-- Informa√ß√£o b√°sica -->
              <div>
                <h4 class="expl-subsection-title">Informa√ß√£o b√°sica</h4>

                <ul class="expl-detail-list">
                  <li>
                    <strong>Email:</strong>
                    <span id="aluno-detail-email">‚Äî</span>
                  </li>
                  <li>
                    <strong>Telem√≥vel:</strong>
                    <span id="aluno-detail-tel">‚Äî</span>
                  </li>
                  <li>
                    <strong>Ano:</strong>
                    <span id="aluno-detail-ano">‚Äî</span>
                  </li>
                  <li>
                    <strong>Valor explica√ß√£o:</strong>
                    <span id="aluno-detail-valor">‚Äî</span>
                  </li>
                  <li>
                    <strong>Sess√µes / m√™s:</strong>
                    <span id="aluno-detail-sessoes">‚Äî</span>
                  </li>
                </ul>

                <div class="expl-actions-row" style="margin-top:1rem;">
                  <button class="button secondary" id="btn-iniciar-faturacao">
                    Iniciar fatura√ß√£o
                  </button>
                  <button class="button secondary" id="btn-registar-pagamento">
                    Registar pagamento
                  </button>
                  <button class="button secondary" id="btn-editar-pagamento">
                    Editar pagamento
                  </button>
                  <button class="button" id="btn-editar-aluno">
                    Editar aluno
                  </button>
                </div>
              </div>

              <!-- Resumo de mensalidades -->
              <div>
                <h4 class="expl-subsection-title">Resumo de mensalidades</h4>

                <ul class="expl-detail-list">
                  <li>
                    <strong>Valor previsto (m√™s atual):</strong>
                    <span id="aluno-detail-previsto-mes">‚Äî</span>
                  </li>

                  <li>
                    <strong>Valor pago (m√™s atual):</strong>
                    <span id="aluno-detail-pago-mes">‚Äî</span>
                  </li>

                  <li>
                    <strong>Em falta (total):</strong>
                    <span id="aluno-detail-emfalta">‚Äî</span>
                  </li>
                </ul>
              </div>
            </div>

            <!-- (opcional) Hist√≥rico de pagamentos por aluno
            <div class="expl-subsection" style="margin-top:1.5rem;">
              <h4 class="expl-subsection-title">Hist√≥rico de pagamentos</h4>

              <div class="table-wrapper">
                <table class="table" id="tblPagamentosAluno">
                  <thead>
                    <tr>
                      <th>Ano</th>
                      <th>M√™s</th>
                      <th>Previsto (‚Ç¨)</th>
                      <th>Pago (‚Ç¨)</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="5">
                        Ainda n√£o existem pagamentos registados para este aluno.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            -->
          </div>
        </section>


        <!-- ========== PERFIL DO ALUNO (SCREEN) ========== -->
        <section
          class="expl-section"
          id="expl-sec-aluno-perfil"
          data-section="aluno-perfil"
          style="display:none"
        >
          <div class="perfil-wrapper">

            <!-- HEADER -->
            <div class="perfil-header">
              <button class="back-btn" onclick="voltarParaAlunos()">
                ‚Üê Voltar
              </button>
              <h2>Perfil do Aluno</h2>
              <p class="subtitle">Informa√ß√£o detalhada e hist√≥rico</p>
            </div>

            <!-- INFO CARD -->
            <section class="perfil-card perfil-card--main" id="aluno-info-card">
              <div class="perfil-left">
                <div class="avatar" id="alunoAvatar">??</div>

                <div>
                  <h3 id="alunoNome">Carregando.</h3>
                  <p class="ano" id="alunoAno">‚Äî</p>

                  <div class="badge-row">
                    <span class="badge status active" id="alunoStatus">Ativo</span>
                  </div>

                  <div class="contact-row">
                    <p><strong>Email:</strong> <span id="alunoEmail">‚Äî</span></p>
                    <p><strong>Telem√≥vel:</strong> <span id="alunoTele">‚Äî</span></p>
                    <p><strong>Inscrito desde:</strong> <span id="alunoDataInscricao">‚Äî</span></p>
                  </div>
                </div>
              </div>

              <div class="perfil-right">
                <div class="kpi">
                  <div class="kpi-icon">üìò</div>
                  <div class="kpi-value" id="kpiAulas">‚Äî</div>
                  <div class="kpi-label">Aulas Conclu√≠das</div>
                </div>

                <div class="kpi">
                  <div class="kpi-icon">üìà</div>
                  <div class="kpi-value" id="kpiMedia">‚Äî</div>
                  <div class="kpi-label">M√©dia Atual</div>
                </div>

                <button id="btnPerfilEditar" class="edit-btn">Editar Perfil</button>
              </div>
            </section>

            <!-- PR√ìXIMA AULA -->
            <section class="perfil-card perfil-card--next">
              <div class="proxima-aula">
                <span class="icon">üïí</span>
                <span><strong>Pr√≥xima Aula:</strong>
                  <span id="proximaAulaTxt">A carregar.</span></span>
              </div>
            </section>

            <!-- TABS -->
            <section class="perfil-card perfil-card--tabs">
              <div class="tabs">
                <button class="tab active"
                        data-tab="explicacoes"
                        onclick="showPerfilTab('explicacoes')">
                  Explica√ß√µes
                </button>
                <button class="tab"
                        data-tab="pagamentos"
                        onclick="showPerfilTab('pagamentos')">
                  Pagamentos
                </button>
              </div>

              <div class="tabs-content-wrapper">
                <!-- EXPLICA√á√ïES -->
                <div id="tab-explicacoes" class="tab-content active">
                  <h3>Hist√≥rico de Explica√ß√µes</h3>
                  <p class="descricao">Todas as aulas realizadas com este aluno</p>

                  <div class="table-wrapper perfil-table-wrapper">
                    <table class="tabela perfil-tabela">
                      <thead>
                        <tr>
                          <th>Data</th>
                          <th>In√≠cio</th>
                          <th>Fim</th>
                          <th>Dura√ß√£o (min)</th>
                          <th>Estado</th>
                        </tr>
                      </thead>
                      <tbody id="listaExplicacoes"></tbody>
                    </table>
                  </div>
                </div>

                <!-- PAGAMENTOS -->
                <div id="tab-pagamentos" class="tab-content">
                  <div class="pag-header">
                    <h3>Hist√≥rico de Pagamentos</h3>
                    <div class="total">
                      ‚Ç¨<span id="pagTotal">0.00</span>
                      <small>Total Recebido</small>
                    </div>
                  </div>

                  <div class="table-wrapper perfil-table-wrapper">
                    <table class="tabela perfil-tabela">
                      <thead>
                        <tr>
                          <th>Data</th>
                          <th>Per√≠odo</th>
                          <th>Valor</th>
                          <th>M√©todo</th>
                          <th>Estado</th>
                        </tr>
                      </thead>
                      <tbody id="listaPagamentos"></tbody>
                    </table>
                  </div>
                </div>

              </div>
            </section>

          </div>
        </section>

        <!-- ========== FATURA√á√ÉO (RESUMO MENSALIDADES) ========== -->
        <section class="expl-section" data-section="faturacao">
                <div class="expl-filter-row">
                  <div>
                    <h2 class="expl-section-title">Fatura√ß√£o</h2>
                    <p class="expl-section-sub">
                      Consulta mensalidades pagas e em falta por m√™s/ano.
                    </p>
                  </div>

                  <div class="expl-filter-controls">
                    <label class="expl-filter-field">
                      <span>M√™s</span>
                      <select id="fat-filtro-mes">
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Mar√ßo</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                      </select>
                    </label>

                    <label class="expl-filter-field">
                      <span>Ano</span>
                      <select id="fat-filtro-ano">
                        <!-- JS preenche automaticamente com os anos existentes -->
                      </select>
                    </label>
                  </div>
                </div>
          <div class="expl-grid-2" style="margin-top:1.5rem;">
            <article class="expl-card">
              <h3 class="expl-subsection-title">
                Mensalidades em falta (m√™s atual)
              </h3>
              <div class="table-wrapper">
                <table class="table table--wide" id="tblMensalidadesPendentes">
                  <thead>
                    <tr>
                      <th>Aluno</th>
                      <th>M√™s</th>
                      <th>Previsto (‚Ç¨)</th>
                      <th>Pago (‚Ç¨)</th>
                      <th>Em falta (‚Ç¨)</th>
                      <th>Estado</th>
                      <th>Avisado</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="7">Ainda n√£o existem mensalidades em falta neste m√™s.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </article>

            <article class="expl-card">
              <h3 class="expl-subsection-title">
                Mensalidades pagas (m√™s atual)
              </h3>
              <div class="table-wrapper">
                <table class="table table--wide" id="tblMensalidadesPagas">
                  <thead>
                    <tr>
                      <th>Aluno</th>
                      <th>M√™s</th>
                      <th>Pago (‚Ç¨)</th>
                      <th>Previsto (‚Ç¨)</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="5">Ainda n√£o existem mensalidades pagas neste m√™s.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </article>
          </div>
        </section>

        <!-- ========== CALEND√ÅRIO ========== -->
        <section class="expl-section" id="expl-sec-calendario" data-section="calendario">
          <div class="expl-section-header">
            <div>
              <h2 class="expl-section-title">Calend√°rio</h2>
              <p class="expl-section-sub">Gerir explica√ß√µes e hor√°rios.</p>
            </div>

            <button type="button" class="button secondary" id="btn-agendar-explicacao">
              Agendar explica√ß√£o
            </button>
          </div>

          <div class="expl-grid-2" style="margin-top:1.5rem;">
            <!-- Cart√£o: Calend√°rio semanal -->
            <article class="expl-card">
              <h3 class="expl-subsection-title">Calend√°rio semanal</h3>
              <p class="expl-section-sub">
                V√™, por semana, em que dias tens explica√ß√µes e o estado de cada sess√£o.
              </p>

              <!-- Legenda dos estados -->
              <div class="calendar-legend">
                <span><span class="dot dot-yellow"></span> Agendada</span>
                <span><span class="dot dot-green"></span> Realizada</span>
                <span><span class="dot dot-orange"></span> Extra / outro</span>
              </div>

              <div class="calendar-week" id="calendar-week">
                <header class="calendar-week__nav">
                  <button id="week-prev" class="calendar-btn" type="button">&#8592;</button>
                  <h3 id="week-label" class="calendar-week__title">Semana atual</h3>
                  <button id="week-next" class="calendar-btn" type="button">&#8594;</button>
                </header>

                <div class="calendar-week__grid" id="calendar-grid">
                  <!-- preenchido via JS -->
                </div>
              </div>
            </article>

            <!-- Cart√£o: Pr√≥ximas explica√ß√µes -->
            <article class="expl-card">
              <h3 class="expl-subsection-title">Pr√≥ximas explica√ß√µes</h3>
              <p class="expl-section-sub">
                Lista das pr√≥ximas sess√µes agendadas, por ordem cronol√≥gica.
              </p>

              <div id="calendar-proximas" class="calendar-proximas">
                <!-- preenchido via JS -->
              </div>
            </article>
          </div>
        </section>

        <!-- ========== RELAT√ìRIOS ========== -->
        <section class="expl-section" id="expl-sec-relatorios" data-section="relatorios">
          <div class="rel-kpi-grid">
            <article class="rel-kpi-card">
              <p class="rel-kpi-label">Total de alunos</p>
              <p class="rel-kpi-value" id="rel-kpi-total-alunos">‚Äî</p>
              <p class="rel-kpi-sub" id="rel-kpi-total-alunos-sub">‚Äî</p>
            </article>

            <article class="rel-kpi-card">
              <p class="rel-kpi-label">Fatura√ß√£o m√©dia</p>
              <p class="rel-kpi-value" id="rel-kpi-fat-media">‚Äî</p>
              <p class="rel-kpi-sub">Por m√™s (ano atual)</p>
            </article>

            <article class="rel-kpi-card">
              <p class="rel-kpi-label">Sess√µes / m√™s</p>
              <p class="rel-kpi-value" id="rel-kpi-sessoes-mes">‚Äî</p>
              <p class="rel-kpi-sub">M√©dia nos √∫ltimos 3 meses</p>
            </article>

            <article class="rel-kpi-card">
              <p class="rel-kpi-label">Crescimento</p>
              <p class="rel-kpi-value" id="rel-kpi-crescimento">‚Äî</p>
              <p class="rel-kpi-sub">vs m√™s anterior</p>
            </article>
          </div>
          <article class="expl-card expl-placeholder-card">
            <h2 class="expl-section-title">Relat√≥rios</h2>
            <p class="expl-section-sub">Estat√≠sticas e an√°lises da tua atividade.</p>

            <ul class="expl-feature-list">
              <li>
                <span class="expl-feature-label">Resumo mensal</span>
                <span class="expl-feature-value" id="rel-resumo-mensal">
                  Este m√™s: ‚Ç¨ 0.00 recebidos de ‚Ç¨ 0.00 previstos ¬∑ ‚Ç¨ 0.00 em falta.
                </span>
              </li>
              <li>
                <span class="expl-feature-label">Tend√™ncia anual</span>
                <span class="expl-feature-value" id="rel-tendencia-anual">
                  Ano atual: ‚Ç¨ 0.00 faturados de ‚Ç¨ 0.00 previstos.
                </span>
              </li>
              <li>
                <span class="expl-feature-label">Alunos ativos</span>
                <span class="expl-feature-value" id="rel-alunos-ativos">
                  Ainda n√£o tens alunos ativos registados.
                </span>
              </li>
            </ul>

            <button type="button" class="expl-link-chip">
              <span class="expl-link-chip-icon">üìà</span>
              <span>Ver gr√°ficos e relat√≥rios</span>
            </button>
          </article>
          <div class="relatorios-grid">
            <div class="rel-card">
              <h3 class="expl-subsection-title">Previsto vs Pago (m√™s selecionado)</h3>
              <p class="expl-section-sub">
                Compara o total previsto, pago e em falta para o m√™s escolhido na fatura√ß√£o.
              </p>
              <div class="rel-chart-box">
                <canvas id="chart-previsto-pago"></canvas>
              </div>
            </div>

            <div class="rel-card">
              <h3 class="expl-subsection-title">Pagamentos por aluno (m√™s selecionado)</h3>
              <p class="expl-section-sub">
                V√™ quanto cada aluno devia pagar e quanto j√° pagou nesse m√™s.
              </p>
              <div class="rel-chart-box">
                <canvas id="chart-por-aluno"></canvas>
              </div>
            </div>

            <div class="rel-card">
              <h3 class="expl-subsection-title">Evolu√ß√£o mensal (ano atual)</h3>
              <p class="expl-section-sub">
                Compara o total previsto e faturado em cada m√™s do ano atual.
              </p>
              <div class="rel-chart-box">
                <canvas id="chart-evolucao-anual"></canvas>
              </div>
            </div>

          </div>
        </section>
      </div>
      <!-- FAB NAV FLUTUANTE -->
      <nav class="fab-nav" id="fabNav">
        <!-- Bot√£o principal -->
        <button class="fab-nav__toggle" id="fabToggle" aria-label="Menu r√°pido">
          <svg viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14"
                  stroke="white"
                  stroke-width="2.4"
                  fill="none"
                  stroke-linecap="round" />
          </svg>
        </button>

        <!-- Itens radiais -->
        <div id="fabItems" class="fab-nav__items" hidden aria-hidden="true">

          <!-- Dashboard -->
          <button class="fab-item" data-target="dashboard" aria-label="Dashboard">
            <svg class="fab-icon" viewBox="0 0 24 24" aria-hidden="true">
              <rect x="4"  y="4"  width="7" height="7" rx="1.5" />
              <rect x="13" y="4"  width="7" height="7" rx="1.5" />
              <rect x="4"  y="13" width="7" height="7" rx="1.5" />
              <rect x="13" y="13" width="7" height="7" rx="1.5" />
            </svg>
            <span class="fab-label">Dashboard</span>
          </button>

          <!-- Alunos -->
          <button class="fab-item" data-target="alunos" aria-label="Alunos">
            <svg class="fab-icon" viewBox="0 0 24 24" aria-hidden="true">
              <circle cx="12" cy="9" r="3.2" />
              <path d="M6.5 19.5c1.2-2.3 3-3.6 5.5-3.6s4.3 1.3 5.5 3.6" />
            </svg>
            <span class="fab-label">Alunos</span>
          </button>

          <!-- Calend√°rio -->
          <button class="fab-item" data-target="calendario" aria-label="Calend√°rio">
            <svg class="fab-icon" viewBox="0 0 24 24" aria-hidden="true">
              <rect x="4" y="5.5" width="16" height="14" rx="2" />
              <path d="M4 10h16" />
              <path d="M9 4v3" />
              <path d="M15 4v3" />
            </svg>
            <span class="fab-label">Calend√°rio</span>
          </button>

          <!-- Fatura√ß√£o -->
          <button class="fab-item" data-target="faturacao" aria-label="Fatura√ß√£o">
            <svg class="fab-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M15.5 7.5c-1-.7-2.1-1.1-3.4-1.1-2.6 0-4.6 1.8-4.6 4.6s2 4.6 4.6 4.6c1.3 0 2.4-.4 3.4-1.1" />
              <path d="M11 5v14" />
            </svg>
            <span class="fab-label">Fatura√ß√£o</span>
          </button>

          <!-- Relat√≥rios -->
          <button class="fab-item" data-target="relatorios" aria-label="Relat√≥rios">
            <svg class="fab-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M4 18.5h16" />
              <path d="M6.5 15l3.2-4 3.2 2.7 4.1-5.2" />
              <path d="M16.8 8.5h3v3" />
            </svg>
            <span class="fab-label">Relat√≥rios</span>
          </button>

        </div>
      </nav>
    </div>
  </section>

</main>

<!-- ========== MODAIS ========== -->

<!-- ADICIONAR ALUNO -->
<div class="modal" id="modal-add-aluno">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2>Novo aluno</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint">Preencha os dados do aluno para criar a conta de acesso.</p>
    <form id="fNewAluno" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input name="nome" placeholder="Nome do aluno" required />
        <input name="apelido" placeholder="Apelido (opcional)" />
        <input name="telemovel" placeholder="Telem√≥vel (opcional)" />
        <input type="number" name="ano" placeholder="Ano de escolaridade" />
        <input type="number" name="idade" placeholder="Idade (opcional)" />
        <input name="dia_semana_preferido" placeholder="Dia preferido (ex.: Segunda)" />
        <input type="time" name="hora_preferida" placeholder="Hora da sess√£o" />
        <input type="number" step="0.01" name="valor_explicacao" placeholder="Valor por explica√ß√£o (‚Ç¨)" />
        <input type="number" name="sessoes_mes" placeholder="Sess√µes por m√™s" />
        <input name="nome_pai_cache" placeholder="Nome do encarregado de educa√ß√£o" />
        <input name="contacto_pai_cache" placeholder="Contacto do encarregado" />
        <input type="email" name="email" placeholder="Email (login do aluno)" required />
        <input name="username" placeholder="Username (opcional)" />
        <input type="password" name="password" placeholder="Password" minlength="6" required />
      </div>

      <button id="btnCreateAluno" class="button" type="submit">Criar Aluno</button>
      <div id="msgNewAluno" class="auth__msg"></div>
    </form>
  </div>
</div>

<!-- EDITAR ALUNO -->
<div class="modal" id="modal-edit-aluno">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2>Editar aluno</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint">Atualize os dados do aluno.</p>
    <form id="fEditAluno" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input name="nome_edit" placeholder="Nome do aluno" required />
        <input name="apelido_edit" placeholder="Apelido (opcional)" />
        <input name="telemovel_edit" placeholder="Telem√≥vel (opcional)" />
        <input type="number" name="ano_edit" placeholder="Ano de escolaridade" />
        <input type="number" name="idade_edit" placeholder="Idade (opcional)" />
        <input name="dia_semana_preferido_edit" placeholder="Dia preferido (ex.: Segunda)" />
        <input type="time" name="hora_preferida" placeholder="Hora da sess√£o" />
        <input type="number" step="0.01" name="valor_explicacao_edit" placeholder="Valor por explica√ß√£o (‚Ç¨)" />
        <input type="number" name="sessoes_mes_edit" placeholder="Sess√µes por m√™s" />
        <input name="nome_pai_cache_edit" placeholder="Nome do encarregado de educa√ß√£o" />
        <input name="contacto_pai_cache_edit" placeholder="Contacto do encarregado" />
        <input type="email" name="email_edit" placeholder="Email (login do aluno)" required />
        <input name="username_edit" placeholder="Username (opcional)" />
        <input type="password" name="password_edit" placeholder="Nova password (opcional)" minlength="6" />
      </div>

      <button id="btnSaveEditAluno" class="button" type="submit">Guardar altera√ß√µes</button>
      <div id="msgEditAluno" class="auth__msg"></div>
    </form>
  </div>
</div>

<!-- SESS√ÉO (ADICIONAR / EDITAR) -->
<div class="modal" id="modal-sessao">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2>Sess√£o de explica√ß√£o</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint">Registe ou edite uma sess√£o deste aluno.</p>
    <form id="fSessao" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input type="date" name="data_sessao" placeholder="Data" required />
        <input type="time" name="hora_inicio" placeholder="Hora in√≠cio (opcional)" />
        <input type="time" name="hora_fim" placeholder="Hora fim (opcional)" />
        <input type="number" name="duracao_min" placeholder="Dura√ß√£o (min, opcional)" />
        <select name="estado">
          <option value="AGENDADA">Agendada</option>
          <option value="REALIZADA">Realizada</option>
          <option value="FALTOU">Faltou</option>
          <option value="CANCELADA">Cancelada</option>
        </select>
        <input name="observacoes" placeholder="Observa√ß√µes (opcional)" />
      </div>

      <div class="expl-actions-row" style="margin-top:0.75rem;">
        <button id="btnSaveSessao" class="button" type="submit">Guardar sess√£o</button>
        <button id="btnDeleteSessao" class="button secondary" type="button" style="display:none;">
          Apagar sess√£o
        </button>
      </div>

      <div id="msgSessao" class="auth__msg"></div>
    </form>
  </div>
</div>

<!-- PAGAMENTO ALUNO -->
<div class="modal" id="modal-pagamento-aluno">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2 id="pag-modal-title">Registar pagamento</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint" id="pag-modal-hint">
      Preencha os dados do pagamento deste aluno.
    </p>

    <form id="fPagamentoAluno" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input type="number" name="ano" placeholder="Ano" required />
        <input type="number" name="mes" placeholder="M√™s (1-12)" min="1" max="12" required />

        <input
          type="number"
          name="dia_pagamento"
          placeholder="Dia de pagamento (1-31)"
          min="1"
          max="31"
          style="display:none;"
        />

        <input
          type="number"
          step="0.01"
          name="valor"
          placeholder="Valor (‚Ç¨)"
          style="display:none;"
        />
      </div>

      <input type="hidden" name="modo" value="registar" />

      <button id="btnSavePagamento" class="button" type="submit">
        Guardar
      </button>
      <div id="msgPagamentoAluno" class="auth__msg"></div>
    </form>
  </div>
</div>

<footer>¬© <span id="y"></span> EduSphere</footer>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // ---------- helper DOM ----------
  const $ = (s) => document.querySelector(s);

  // -------- Helper para chamar a Edge Function expl-alunos com token --------
  async function callExplFn(action, payload = null) {
  const { data: { session } } = await supabase.auth.getSession();
  const accessToken = session?.access_token;

  if (!accessToken) {
    return {
      data: null,
      error: { message: 'Sem sess√£o v√°lida (faz login primeiro).', status: 401 },
    };
  }

  try {
    const res = await supabase.functions.invoke("expl-alunos", {
      body: { action, payload },
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
    });

    return res;
  } catch (err) {
    console.error("Erro bruto da Edge Function:", err);

    if (err && err.context && typeof err.context.text === "function") {
      try {
        const txt = await err.context.text();
        console.error("Contexto expl-alunos:", txt);
      } catch (e) {
        console.error("Falha a ler contexto:", e);
      }
    }

    return { data: null, error: err };
  }
}
  let chartEvolucaoAnual = null;   // <-- novo
  let chartPrevistoPago = null;
  let chartPagamentosPorAluno = null;
  let SESSOES_EXPLICADOR = [];
  let semanaOffset = 0; // 0 = semana atual, -1 = anterior, +1 = pr√≥xima

  const weekLabel   = document.querySelector('#week-label');
  const btnWeekPrev = document.querySelector('#week-prev');
  const btnWeekNext = document.querySelector('#week-next');
  const btnAgendarExplicacao = document.querySelector('#btn-agendar-explicacao');
  const listaProximas        = document.querySelector('#calendar-proximas');

  // Pagamento modal refs
  const modalPag        = $('#modal-pagamento-aluno');
  const formPag         = $('#fPagamentoAluno');
  const msgPag          = $('#msgPagamentoAluno');
  const btnSavePag      = $('#btnSavePagamento');
  const pagModalTitle   = $('#pag-modal-title');
  const pagModalHint    = $('#pag-modal-hint');
  const inputAno        = formPag ? formPag.ano : null;
  const inputMes        = formPag ? formPag.mes : null;
  const inputDiaPag     = formPag ? formPag.dia_pagamento : null;
  const inputValor      = formPag ? formPag.valor : null;

  const elYear      = $('#y');
  const btnLogout   = $('#btnLogout');
  const headerNav   = $('#explSidebarNav');
  const loginBox    = $('#explLogin');
  const panel       = $('#explPanel');
  const msgLogin    = $('#msgExplLogin');
  const formLogin   = $('#fExplLogin');

  const alunosGrid  = document.getElementById('alunos-cards-grid');
  const elLimite    = $('#limite');
  const elContagem  = $('#contagem');
  const elRestantes = $('#restantes');

  const elNomeHeader = $('#expl-nome-header');
  const elNomeMini   = $('#expl-nome-mini');

  const btnFab          = $('#btn-add-aluno');
  const btnOpenAddAluno = $('#btn-open-add-aluno');
  const btnScrollLista  = $('#btn-scroll-lista');

  const modalAddAluno   = $('#modal-add-aluno');
  const formNew         = $('#fNewAluno');
  const msgNewAluno     = $('#msgNewAluno');
  const btnCreate       = $('#btnCreateAluno');

  const modalEditAluno  = $('#modal-edit-aluno');
  const formEdit        = $('#fEditAluno');
  const msgEditAluno    = $('#msgEditAluno');
  const btnSaveEdit     = $('#btnSaveEditAluno');
  const btnEditarAluno  = $('#btn-editar-aluno');

  const alunoStatusBadge = $('#aluno-status-badge');
  const toggleAlunoAtivo = $('#toggle-aluno-ativo');

  const btnIniciarFat   = $('#btn-iniciar-faturacao');
  const btnRegistarPag  = $('#btn-registar-pagamento');
  const btnEditarPag    = $('#btn-editar-pagamento');

  const modalSessao     = $('#modal-sessao');
  const formSessao      = $('#fSessao');
  const msgSessao       = $('#msgSessao');
  const btnSaveSessao   = $('#btnSaveSessao');
  const btnDeleteSessao = $('#btnDeleteSessao');
  const btnAddSessao    = $('#btn-add-sessao');
  const tblSessoesBody  = $('#tblSessoesAluno tbody');

  const btnDashVerAlunos = $('#btn-dashboard-ver-alunos');
  const selFatMes  = document.getElementById("fat-filtro-mes");
  const selFatAno  = document.getElementById("fat-filtro-ano");

  elYear.textContent = new Date().getFullYear();
  
  let EXPLICADOR       = { userId: null, id_explicador: null, max: 0 };
  let ALUNOS_CACHE     = [];
  let PAGAMENTOS_CACHE = [];
  let ALUNO_ATUAL      = null;
  let SESSAO_ATUAL_ID  = null;
    // Filtros atuais da sec√ß√£o de fatura√ß√£o
  let FAT_ANO_SELEC = null;
  let FAT_MES_SELEC = null;
  let SESSOES_ALUNO_ATUAL = [];


  function preencherPerfilAlunoBasico(aluno) {
    if (!aluno) return;

    const nomeCompleto = [aluno.nome, aluno.apelido].filter(Boolean).join(" ");

    const elNome   = document.getElementById("alunoNome");
    const elAno    = document.getElementById("alunoAno");
    const elEmail  = document.getElementById("alunoEmail");
    const elTele   = document.getElementById("alunoTele");
    const elAvatar = document.getElementById("alunoAvatar");
    const elStatus = document.getElementById("alunoStatus");

    if (elNome)   elNome.textContent = nomeCompleto || "Aluno";
    if (elAno)    elAno.textContent  = aluno.ano ? `${aluno.ano}¬∫ Ano` : "‚Äî";
    if (elEmail)  elEmail.textContent = aluno.email || "‚Äî";
    if (elTele)   elTele.textContent  = aluno.telemovel || "‚Äî";

    if (elAvatar) {
      const ini =
        (aluno.nome?.[0] || "") + (aluno.apelido?.[0] || "");
      elAvatar.textContent = ini.toUpperCase() || "??";
    }

    if (elStatus) {
      const ativo = aluno.is_active !== false;
      elStatus.textContent = ativo ? "Ativo" : "Inativo";
      elStatus.classList.toggle("active", ativo);
    }

    // (se quiseres, podes preencher alunoDataInscricao quando tiveres esse campo)
  }

  function getInicioSemana(date) {
    const d = new Date(date);
    const day = d.getDay(); // 0=Dom,1=Seg,...6=S√°b
    const diff = (day + 6) % 7; // queremos come√ßar em SEG
    d.setDate(d.getDate() - diff);
    d.setHours(0, 0, 0, 0);
    return d;
  }

  const NOMES_DIAS_CURTOS = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];

  // ---------- helpers supabase ----------
  async function hasRole(uid, roleName) {
    const { data, error } = await supabase
      .from('app_users')
      .select('role')
      .eq('user_id', uid)
      .eq('role', roleName)
      .maybeSingle();
    if (error) {
      console.error('hasRole error', error);
      return false;
    }
    return !!data;
  }

  async function getExplRow(uid) {
    const { data, error } = await supabase
      .from('explicadores')
      .select('id_explicador, nome, apelido, max_alunos')
      .eq('user_id', uid)
      .maybeSingle();
    if (error) throw error;
    return data || null;
  }

  function setState({ loading = false, isExpl = false, isAuthed = false }) {
    if (loading) {
      loginBox.style.display = 'block';
      panel.style.display    = 'none';
      msgLogin.textContent   = 'A verificar sess√£o...';
      btnLogout.style.display = 'none';
      headerNav.style.display = 'none';
      return;
    }
    if (isAuthed && isExpl) {
      loginBox.style.display = 'none';
      panel.style.display    = 'flex';
      msgLogin.textContent   = '';
      btnLogout.style.display = 'inline-block';
      headerNav.style.display = 'flex';
      document.querySelector('main.auth').style.display = 'block';
    } else {
      loginBox.style.display = 'block';
      panel.style.display    = 'none';
      btnLogout.style.display = 'none';
      headerNav.style.display = 'none';
      document.querySelector('main.auth').style.display = 'grid';
    }
  }

  // ---------- QUOTA UI ----------
  function updateQuotaUI(total) {
    const max = Number(EXPLICADOR.max || 0);
    elContagem.textContent = String(total);

    if (!max) {
      elLimite.textContent    = 'Sem limite';
      elRestantes.textContent = '‚Äî';
      btnCreate && (btnCreate.disabled = false);
      return;
    }

    elLimite.textContent = String(max);
    const rest = Math.max(0, max - total);
    elRestantes.textContent = String(rest);

    if (btnCreate) {
      btnCreate.disabled = rest <= 0;
      btnCreate.title    = rest <= 0 ? 'Limite de alunos atingido.' : '';
    }
  }

  // ---------- DASHBOARD: CARDS DE ALUNOS ----------
    // ---------- DASHBOARD: CARDS DE ALUNOS ----------
  function renderDashboardAlunos() {
    const grid = document.getElementById("dash-alunos-grid");
    const contador = document.getElementById("dash-alunos-contador");
    if (!grid) return;

    const alunosAtivos = (ALUNOS_CACHE || []).filter((a) => a.is_active !== false);
    const totalAtivos = alunosAtivos.length;

    if (contador) {
      contador.textContent =
        totalAtivos === 1 ? "(1 ativo)" : `(${totalAtivos} ativos)`;
    }

    if (!totalAtivos) {
      grid.innerHTML =
        '<p class="expl-section-sub">Ainda n√£o tens alunos ativos registados.</p>';
      return;
    }

    // S√≥ mostramos at√© 3, como no mock
    const top3 = alunosAtivos.slice(0, 3);

    // helper para mapear estado ‚Üí label + classe de badge
    function getEstadoInfo(rawEstado) {
      const e = (rawEstado || "").toString().trim().toUpperCase();

      switch (e) {
        case "PAGO":
          return {
            label: "Pago",
            badgeClass:
              "dash-aluno-card__badge dash-aluno-card__badge--pago",
          };
        case "PARCIAL":
          return {
            label: "Parcial",
            badgeClass:
              "dash-aluno-card__badge dash-aluno-card__badge--parcial",
          };
        case "PENDENTE":
        default:
          return {
            label: e ? e.charAt(0) + e.slice(1).toLowerCase() : "Pendente",
            badgeClass:
              "dash-aluno-card__badge dash-aluno-card__badge--pendente",
          };
      }
    }

    grid.innerHTML = top3
      .map((a) => {
        const nome = [a.nome, a.apelido].filter(Boolean).join(" ") || "Aluno";
        const anoLabel = a.ano ? `${a.ano}¬∫ Ano` : "‚Äî";
        const proximaMensalidade = a.proxima_mensalidade || "‚Äî";
        const { label: estadoLabel, badgeClass } = getEstadoInfo(
          a.estado_mensalidade || "PENDENTE"
        );

        const avisado = !!a.mensalidade_avisada;

        return `
          <article class="dash-aluno-card">
            <div>
              <div class="dash-aluno-card__top">
                <div class="dash-aluno-card__avatar"></div>
                <div>
                  <h3 class="dash-aluno-card__name">${nome}</h3>
                  <p class="dash-aluno-card__year">${anoLabel}</p>
                </div>
              </div>

              <p class="dash-aluno-card__label">Pr√≥xima mensalidade:</p>
              <div class="dash-aluno-card__mensalidade-row">
                <span class="dash-aluno-card__date">
                  ${proximaMensalidade}
                </span>

                <button
                  type="button"
                  class="aluno-card__bell"
                  data-id-aluno="${a.id_aluno}"
                  data-avisado="${avisado ? "true" : "false"}"
                  aria-pressed="${avisado ? "true" : "false"}"
                  title="${avisado ? "Encarregado avisado" : "Marcar como avisado"}"
                >
                  <svg
                    class="aluno-bell-icon${avisado ? " aluno-bell-icon--active" : ""}"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.7"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    aria-hidden="true"
                  >
                    <path d="M12 3a4 4 0 0 0-4 4v1.1c0 .5-.2 1-.4 1.5L6.3 12A2 2 0 0 0 8 15h8a2 2 0 0 0 1.7-3l-1.3-2.4c-.2-.5-.4-1-.4-1.5V7a4 4 0 0 0-4-4z" />
                    <path d="M10 18a2 2 0 0 0 4 0" />
                  </svg>
                </button>
              </div>

              <span class="${badgeClass}">
                ${estadoLabel}
              </span>
            </div>

            <button
              type="button"
              class="button secondary dash-aluno-card__btn"
              data-id-aluno="${a.id_aluno}"
            >
              Ver detalhes
            </button>
          </article>
        `;
      })
      .join("");

    // clique em "Ver detalhes" -> vai direto para o PERFIL do aluno
    grid.querySelectorAll(".dash-aluno-card__btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const idAluno = btn.getAttribute("data-id-aluno");
        const aluno = (ALUNOS_CACHE || []).find(
          (x) => String(x.id_aluno) === String(idAluno)
        );
        if (!aluno) return;

        if (typeof preencherPerfilAlunoBasico === "function") {
          preencherPerfilAlunoBasico(aluno);
        }
        if (typeof mostrarPainelAluno === "function") {
          mostrarPainelAluno(aluno);
        }

        ativarScreen("aluno-perfil");
      });
    });
  }

  // Eventos nos bot√µes da lista de alunos
    alunosGrid
      .querySelectorAll(".aluno-card__btn")
      .forEach((btn) => {
        btn.addEventListener("click", () => {
          const idAluno = btn.getAttribute("data-id-aluno");
          const acao    = btn.dataset.action; // "ver" ou "perfil"

          const aluno = ALUNOS_CACHE.find(
            (x) => String(x.id_aluno) === String(idAluno)
          );
          if (!aluno) return;

          // ‚ûú Ver perfil completo (tabs Explica√ß√µes / Pagamentos)
          if (acao === "ver") {
            preencherPerfilAlunoBasico(aluno);
            mostrarPainelAluno(aluno);
            ativarScreen("aluno-perfil");
            return;
          }

          // ‚ûú Informa√ß√µes r√°pidas (cart√£o grande na sec√ß√£o Alunos)
          if (acao === "perfil") {
            mostrarPainelAluno(aluno);
            ativarScreen("alunos");

            const card = document.getElementById("aluno-detail-card");
            if (card) {
              card.style.display = "block";
              card.scrollIntoView({ behavior: "smooth", block: "start" });
            }
          }
        });
      });
  
  // ---------- STATUS ALUNO (Ativo / Bloqueado) ----------
  function updateAlunoStatusUI(aluno) {
    if (!aluno) return;

    const ativo = aluno.is_active !== false;

    if (alunoStatusBadge) {
      alunoStatusBadge.textContent = ativo ? 'Ativo' : 'Bloqueado';
      alunoStatusBadge.classList.toggle('aluno-status-badge--ativo', ativo);
      alunoStatusBadge.classList.toggle('aluno-status-badge--inativo', !ativo);
    }

    if (toggleAlunoAtivo) {
      toggleAlunoAtivo.classList.toggle('is-off', !ativo);
      toggleAlunoAtivo.setAttribute('aria-pressed', ativo ? 'true' : 'false');
    }
  }

    // ---------- LISTAR ALUNOS ----------
  async function loadAlunos() {
    const { data, error } = await callExplFn("list_alunos", null);

    if (!alunosGrid) {
      console.warn("alunos-cards-grid n√£o encontrado no DOM.");
      return;
    }

    if (error) {
      console.error("loadAlunos error", error);
      alunosGrid.innerHTML =
        '<p class="expl-section-sub">Erro a carregar alunos.</p>';
      ALUNOS_CACHE = [];
      updateQuotaUI(0);
      renderDashboardAlunos();
      return;
    }

    if (!data || !data.length) {
      alunosGrid.innerHTML =
        '<p class="expl-section-sub">Sem alunos ainda.</p>';
      ALUNOS_CACHE = [];
      updateQuotaUI(0);
      renderDashboardAlunos();
      return;
    }

    ALUNOS_CACHE = data;
    updateQuotaUI(data.length);
    renderDashboardAlunos();

    // helper para o badge de estado da mensalidade
    function getEstadoInfo(rawEstado) {
      const e = (rawEstado || "").toString().trim().toUpperCase();

      switch (e) {
        case "PAGO":
          return {
            label: "Pago",
            badgeClass:
              "dash-aluno-card__badge dash-aluno-card__badge--pago",
          };
        case "PARCIAL":
          return {
            label: "Parcial",
            badgeClass:
              "dash-aluno-card__badge dash-aluno-card__badge--parcial",
          };
        case "PENDENTE":
        default:
          return {
            label: e ? e.charAt(0) + e.slice(1).toLowerCase() : "Pendente",
            badgeClass:
              "dash-aluno-card__badge dash-aluno-card__badge--pendente",
          };
      }
    }

    // desenhar cart√µes da sec√ß√£o ALUNOS
    alunosGrid.innerHTML = data
      .map((a) => {
        const nome = [a.nome, a.apelido].filter(Boolean).join(" ") || "Aluno";
        const anoLabel = a.ano ? `${a.ano}¬∫ Ano` : "‚Äî";
        const tel = a.telemovel || "‚Äî";

        // pr√≥xima explica√ß√£o (se vier do back-end)
        let proxExpLabel = "‚Äî";
        if (a.proxima_sessao_data) {
          const d = new Date(a.proxima_sessao_data);
          const dd = String(d.getDate()).padStart(2, "0");
          const mm = String(d.getMonth() + 1).padStart(2, "0");
          const yyyy = d.getFullYear();
          const hora = (a.proxima_sessao_hora || "").slice(0, 5);
          proxExpLabel = hora
            ? `${dd}/${mm}/${yyyy} √†s ${hora}`
            : `${dd}/${mm}/${yyyy}`;
        }

        const proximaMensalidade = a.proxima_mensalidade || "‚Äî";
        const { label: estadoLabel, badgeClass } = getEstadoInfo(
          a.estado_mensalidade || "PENDENTE"
        );

        const ativo = a.is_active !== false;
        const statusLabel = ativo ? "Ativo" : "Inativo";
        const statusClass = ativo
          ? "aluno-status-badge aluno-status-badge--ativo"
          : "aluno-status-badge aluno-status-badge--inativo";

        const avisado = !!a.mensalidade_avisada;

        return `
          <article class="dash-aluno-card aluno-card">
            <div>
              <div class="dash-aluno-card__top" style="justify-content: space-between;">
                <div style="display:flex; gap:12px;">
                  <div class="dash-aluno-card__avatar"></div>
                  <div>
                    <h3 class="dash-aluno-card__name">${nome}</h3>
                    <p class="dash-aluno-card__year">${anoLabel}</p>
                    <p class="aluno-card__phone">
                      Telem√≥vel: <span>${tel}</span>
                    </p>
                  </div>
                </div>

                <span class="${statusClass}">
                  ${statusLabel}
                </span>
              </div>

              <p class="dash-aluno-card__label">Pr√≥xima explica√ß√£o:</p>
              <p class="dash-aluno-card__date">${proxExpLabel}</p>

              <div class="aluno-card__mensalidade-row">
                <div>
                  <p class="dash-aluno-card__label">Mensalidade:</p>
                  <span class="${badgeClass}">
                    ${estadoLabel}
                  </span>
                </div>

                <button
                  type="button"
                  class="aluno-card__bell"
                  data-id-aluno="${a.id_aluno}"
                  data-avisado="${avisado ? "true" : "false"}"
                  aria-pressed="${avisado ? "true" : "false"}"
                  title="${avisado ? "Encarregado avisado" : "Marcar como avisado"}"
                >
                  <svg
                    class="aluno-bell-icon${avisado ? " aluno-bell-icon--active" : ""}"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.7"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    aria-hidden="true"
                  >
                    <path d="M12 3a4 4 0 0 0-4 4v1.1c0 .5-.2 1-.4 1.5L6.3 12A2 2 0 0 0 8 15h8a2 2 0 0 0 1.7-3l-1.3-2.4c-.2-.5-.4-1-.4-1.5V7a4 4 0 0 0-4-4z" />
                    <path d="M10 18a2 2 0 0 0 4 0" />
                  </svg>
                </button>
              </div>
            </div>

            <div class="aluno-card__actions">
              <button
                type="button"
                class="button secondary aluno-card__btn"
                data-action="ver"
                data-id-aluno="${a.id_aluno}"
              >
                Ver perfil
              </button>

              <button
                type="button"
                class="button secondary aluno-card__btn"
                data-action="perfil"
                data-id-aluno="${a.id_aluno}"
              >
                Informa√ß√µes r√°pidas
              </button>
            </div>
          </article>
        `;
      })
      .join("");

    // --- BOT√ïES "Ver perfil" / "Informa√ß√µes r√°pidas" ---
    alunosGrid
      .querySelectorAll(".aluno-card__btn")
      .forEach((btn) => {
        btn.addEventListener("click", () => {
          const idAluno = btn.getAttribute("data-id-aluno");
          const acao = btn.dataset.action; // "ver" ou "perfil"

          const aluno = (ALUNOS_CACHE || []).find(
            (x) => String(x.id_aluno) === String(idAluno)
          );
          if (!aluno) return;

          // ‚ûú Ver perfil completo
          if (acao === "ver") {
            preencherPerfilAlunoBasico(aluno);
            mostrarPainelAluno(aluno);
            ativarScreen("aluno-perfil");
            return;
          }

          // ‚ûú Informa√ß√µes r√°pidas
          if (acao === "perfil") {
            mostrarPainelAluno(aluno);
            ativarScreen("alunos");

            const card = document.getElementById("aluno-detail-card");
            if (card) {
              card.style.display = "block";
              card.scrollIntoView({ behavior: "smooth", block: "start" });
            }
          }
        });
      });

    // --- SINOS (avisar mensalidade) ---
    alunosGrid
      .querySelectorAll(".aluno-card__bell")
      .forEach((btn) => {
        btn.addEventListener("click", async () => {
          const idAluno = btn.getAttribute("data-id-aluno");
          const aluno = (ALUNOS_CACHE || []).find(
            (x) => String(x.id_aluno) === String(idAluno)
          );
          if (!aluno) return;

          const avisadoAtual = !!aluno.mensalidade_avisada;
          const novoEstado   = !avisadoAtual;

          // feedback visual imediato
          const svg = btn.querySelector("svg");
          if (svg) {
            svg.classList.toggle("aluno-bell-icon--active", novoEstado);
          }
          btn.setAttribute("aria-pressed", novoEstado ? "true" : "false");
          btn.dataset.avisado = String(novoEstado);

          // chamada ao backend
          btn.disabled = true;
          try {
            const { error } = await callExplFn("set_mensalidade_avisada", {
              aluno_id: aluno.id_aluno,   // TEM de ser aluno_id (como no backend)
              avisado: novoEstado,
            });

            if (error) {
              console.error("Erro ao atualizar aviso:", error);

              // reverte visual se der erro
              if (svg) {
                svg.classList.toggle("aluno-bell-icon--active", avisadoAtual);
              }
              btn.setAttribute(
                "aria-pressed",
                avisadoAtual ? "true" : "false"
              );
              btn.dataset.avisado = String(avisadoAtual);

              alert("N√£o foi poss√≠vel atualizar o estado de aviso.");
              return;
            }

            // se correu bem, atualiza cache
            aluno.mensalidade_avisada = novoEstado;
          } finally {
            btn.disabled = false;
          }
        });
      });
  }

// Devolve { ano, mes, mesLabel } garantindo que escolhemos um m√™s com dados
  function getMesAnoSelecionadosOuUltimoComDados() {
    const selMes = document.getElementById("fat-filtro-mes");
    const selAno = document.getElementById("fat-filtro-ano");
    const now = new Date();

    let ano = selAno && selAno.value ? Number(selAno.value) : null;
    let mes = selMes && selMes.value ? Number(selMes.value) : null;

    const temDadosPara = (a, m) =>
      (PAGAMENTOS_CACHE || []).some(
        (p) => p.ano === a && p.mes === m
      );

    // Se n√£o houver sele√ß√£o OU n√£o houver dados para esse m√™s/ano,
    // escolhemos o √∫ltimo m√™s que tenha dados
    if (!ano || !mes || !temDadosPara(ano, mes)) {
      if (PAGAMENTOS_CACHE && PAGAMENTOS_CACHE.length) {
        const ultimo = PAGAMENTOS_CACHE.reduce((max, p) => {
          if (!max) return p;
          if (p.ano > max.ano) return p;
          if (p.ano === max.ano && p.mes > max.mes) return p;
          return max;
        }, null);
        ano = ultimo.ano;
        mes = ultimo.mes;
      } else {
        ano = now.getFullYear();
        mes = now.getMonth() + 1;
      }
    }

    // Sincronizar selects com esta escolha
    if (selAno) selAno.value = String(ano);
    if (selMes) selMes.value = String(mes);

    const nomesMeses = [
      "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
      "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro",
    ];
    const mesLabel = nomesMeses[mes - 1] || String(mes);

    return { ano, mes, mesLabel };
  }

  // ---------- RESUMO MENSAL ----------
  function getDadosMesSelecionado() {
    const tbodyPend  = document.querySelector("#tblMensalidadesPendentes tbody");
    const tbodyPagas = document.querySelector("#tblMensalidadesPagas tbody");
    if (!tbodyPend || !tbodyPagas) return null;

    const { ano, mes, mesLabel } = getMesAnoSelecionadosOuUltimoComDados();

    const pendentes = [];
    const pagas     = [];

    let totalPrevistoPend  = 0;
    let totalFaltaPend     = 0;
    let totalPagoPagas     = 0;
    let totalPrevistoPagas = 0;

    (PAGAMENTOS_CACHE || []).forEach((p) => {
      // ignorar alunos bloqueados
      const alunoRef = (ALUNOS_CACHE || []).find(
        (a) => String(a.id_aluno) === String(p.id_aluno)
      );
      if (alunoRef && alunoRef.is_active === false) return;

      if (p.ano !== ano || p.mes !== mes) return;

      const previsto = Number(p.valor_previsto) || 0;
      const pago     = Number(p.valor_pago) || 0;
      const falta    = Math.max(previsto - pago, 0);

      if (previsto === 0 && pago === 0) return;

      const linha = {
        aluno:  p.aluno_nome || "Aluno",
        previsto,
        pago,
        falta,
        estado: p.estado || "",
        mes:    mesLabel,
        avisado:"‚Äî",
      };

      if (falta > 0) {
        pendentes.push(linha);
        totalPrevistoPend += previsto;
        totalFaltaPend    += falta;
      } else {
        pagas.push(linha);
        totalPagoPagas     += pago;
        totalPrevistoPagas += previsto;
      }
    });

    return {
      anoAtual: ano,
      mesAtual: mes,
      mesLabel,
      pendentes,
      pagas,
      totalPrevistoPend,
      totalFaltaPend,
      totalPagoPagas,
      totalPrevistoPagas,
    };
  }

  // ---------- RESUMO MENSAL (tabelas) ----------
  function renderResumoMensal() {
    const tbodyPend = document.querySelector("#tblMensalidadesPendentes tbody");
    const tbodyPagas = document.querySelector("#tblMensalidadesPagas tbody");

    if (!tbodyPend || !tbodyPagas) return;

    const dados = getDadosMesSelecionado();
    if (!dados) return;

    const {
      mesLabel,
      pendentes,
      pagas,
      totalPrevistoPend,
      totalFaltaPend,
      totalPagoPagas,
      totalPrevistoPagas,
    } = dados;

    // Pendentes
    if (!pendentes.length) {
      tbodyPend.innerHTML =
        '<tr><td colspan="7">Ainda n√£o existem mensalidades em falta neste m√™s.</td></tr>';
    } else {
      const rowsPend = pendentes
        .map(
          (r) => `
        <tr>
          <td>${r.aluno}</td>
          <td>${r.mes}</td>
          <td>‚Ç¨ ${r.previsto.toFixed(2)}</td>
          <td>‚Ç¨ ${r.pago.toFixed(2)}</td>
          <td>‚Ç¨ ${r.falta.toFixed(2)}</td>
          <td>${r.estado}</td>
          <td>${r.avisado}</td>
        </tr>
      `
        )
        .join("");

      const totalRow = `
      <tr>
        <td><strong>Total</strong></td>
        <td>${mesLabel}</td>
        <td><strong>‚Ç¨ ${totalPrevistoPend.toFixed(2)}</strong></td>
        <td></td>
        <td><strong>‚Ç¨ ${totalFaltaPend.toFixed(2)}</strong></td>
        <td colspan="2"></td>
      </tr>
    `;

      tbodyPend.innerHTML = rowsPend + totalRow;
    }

    // Pagas
    if (!pagas.length) {
      tbodyPagas.innerHTML =
        '<tr><td colspan="5">Ainda n√£o existem mensalidades pagas neste m√™s.</td></tr>';
    } else {
      const rowsPagas = pagas
        .map(
          (r) => `
        <tr>
          <td>${r.aluno}</td>
          <td>${r.mes}</td>
          <td>‚Ç¨ ${r.pago.toFixed(2)}</td>
          <td>‚Ç¨ ${r.previsto.toFixed(2)}</td>
          <td>${r.estado}</td>
        </tr>
      `
        )
        .join("");

      const totalRowPagas = `
      <tr>
        <td><strong>Total</strong></td>
        <td>${mesLabel}</td>
        <td><strong>‚Ç¨ ${totalPagoPagas.toFixed(2)}</strong></td>
        <td><strong>‚Ç¨ ${totalPrevistoPagas.toFixed(2)}</strong></td>
        <td></td>
      </tr>
    `;

      tbodyPagas.innerHTML = rowsPagas + totalRowPagas;
    }
  }

  function atualizarGraficosPagamentos() {
    const canvasResumo   = document.getElementById("chart-previsto-pago");
    const canvasPorAluno = document.getElementById("chart-por-aluno");

    if (!canvasResumo && !canvasPorAluno) return;

    const dados = getDadosMesSelecionado();
    if (!dados) return;

    const { mesLabel, pendentes, pagas } = dados;
    const todos = [...pendentes, ...pagas];

    const totalPrevisto = todos.reduce((acc, r) => acc + (r.previsto || 0), 0);
    const totalPago     = todos.reduce((acc, r) => acc + (r.pago || 0), 0);
    const totalFalta    = Math.max(totalPrevisto - totalPago, 0);

    // --- Gr√°fico 1: Previsto vs Pago vs Em falta ---
    if (chartPrevistoPago) {
      chartPrevistoPago.destroy();
    }
    if (canvasResumo) {
      const ctxResumo = canvasResumo.getContext("2d");
      chartPrevistoPago = new Chart(ctxResumo, {
        type: "bar",
        data: {
          labels: ["Previsto", "Pago", "Em falta"],
          datasets: [
            {
              label: mesLabel,
              data: [totalPrevisto, totalPago, totalFalta],
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,   // <‚Äì importante com CSS que vamos p√¥r
          plugins: {
            legend: { display: false },
          },
          scales: {
            y: { beginAtZero: true },
          },
        },
      });
    }

    // --- Gr√°fico 2: Pagamentos por aluno ---
    if (chartPagamentosPorAluno) {
      chartPagamentosPorAluno.destroy();
    }
    if (canvasPorAluno) {
      const ctxPorAluno = canvasPorAluno.getContext("2d");

      const porAluno = new Map();
      todos.forEach((r) => {
        const entry = porAluno.get(r.aluno) || { previsto: 0, pago: 0 };
        entry.previsto += r.previsto || 0;
        entry.pago     += r.pago || 0;
        porAluno.set(r.aluno, entry);
      });

      const labels = Array.from(porAluno.keys());
      const datasetPrevisto = labels.map((nome) => porAluno.get(nome).previsto);
      const datasetPago     = labels.map((nome) => porAluno.get(nome).pago);

      chartPagamentosPorAluno = new Chart(ctxPorAluno, {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Previsto", data: datasetPrevisto },
            { label: "Pago", data: datasetPago },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,   // idem
          scales: {
            y: { beginAtZero: true },
          },
        },
      });
    }
  }

  function atualizarGraficoEvolucaoAnual() {
    const canvas = document.getElementById("chart-evolucao-anual");
    if (!canvas) return;

    const ctx = canvas.getContext("2d");

    const now = new Date();
    const anoAtual = now.getFullYear();

    const nomesMesesCurtos = [
      "Jan","Fev","Mar","Abr","Mai","Jun",
      "Jul","Ago","Set","Out","Nov","Dez"
    ];

    const previstoPorMes = new Array(12).fill(0);
    const pagoPorMes     = new Array(12).fill(0);

    (PAGAMENTOS_CACHE || []).forEach((p) => {
      if (p.ano !== anoAtual) return;

      // ignorar alunos bloqueados
      const alunoRef = (ALUNOS_CACHE || []).find(
        (a) => String(a.id_aluno) === String(p.id_aluno)
      );
      if (alunoRef && alunoRef.is_active === false) return;

      const idxMes = (p.mes || 1) - 1;
      const previsto = Number(p.valor_previsto) || 0;
      const pago     = Number(p.valor_pago) || 0;

      previstoPorMes[idxMes] += previsto;
      pagoPorMes[idxMes]     += pago;
    });

    if (chartEvolucaoAnual) {
      chartEvolucaoAnual.destroy();
    }

    chartEvolucaoAnual = new Chart(ctx, {
      type: "line",
      data: {
        labels: nomesMesesCurtos,
        datasets: [
          {
            label: "Previsto",
            data: previstoPorMes,
          },
          {
            label: "Pago",
            data: pagoPorMes,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "top" },
        },
        scales: {
          y: { beginAtZero: true },
        },
      },
    });
  }


  // ---------- FATURA√á√ÉO: INICIAR FILTROS (M√äS/ANO) ----------
  function initFiltrosFaturacao() {
    if (!selFatMes || !selFatAno) return;

    const agora        = new Date();
    const anoSistema   = agora.getFullYear();
    const mesSistema   = agora.getMonth() + 1;

    // Se ainda n√£o houver sele√ß√£o, usar m√™s/ano atuais
    if (!FAT_ANO_SELEC) FAT_ANO_SELEC = anoSistema;
    if (!FAT_MES_SELEC) FAT_MES_SELEC = mesSistema;

    // Preencher lista de anos com base nos dados + ano atual
    if (!selFatAno.dataset.initialized) {
      const anos = new Set([anoSistema]);
      (PAGAMENTOS_CACHE || []).forEach((p) => {
        if (p.ano) anos.add(p.ano);
      });

      const anosOrdenados = Array.from(anos).sort((a, b) => a - b);
      selFatAno.innerHTML = anosOrdenados
        .map((a) => `<option value="${a}">${a}</option>`)
        .join("");

      selFatAno.dataset.initialized = "1";
    }

    // Sincronizar selects com o estado atual
    selFatMes.value = String(FAT_MES_SELEC);
    selFatAno.value = String(FAT_ANO_SELEC);

    // Listeners (s√≥ ligamos uma vez)
    if (!selFatMes.dataset.bound) {
      selFatMes.addEventListener("change", () => {
        FAT_MES_SELEC = Number(selFatMes.value) || mesSistema;
        renderResumoMensal();
      });
      selFatMes.dataset.bound = "1";
    }

    if (!selFatAno.dataset.bound) {
      selFatAno.addEventListener("change", () => {
        FAT_ANO_SELEC = Number(selFatAno.value) || anoSistema;
        renderResumoMensal();
      });
      selFatAno.dataset.bound = "1";
    }
  }

  // ---------- RELAT√ìRIOS: RESUMOS NO CART√ÉO ----------
  function updateResumoRelatorios({
    previstoMesAtual = 0,
    realizadoMesAtual = 0,
    pendenteTotal = 0,
    previstoAnoAtual = 0,
    realizadoAnoAtual = 0,
    nAlunosAtivos = 0,
  } = {}) {
    const elMensal   = document.querySelector('#rel-resumo-mensal');
    const elTend     = document.querySelector('#rel-tendencia-anual');
    const elAlunos   = document.querySelector('#rel-alunos-ativos');

    if (elMensal) {
      elMensal.textContent =
        `Este m√™s: ‚Ç¨ ${realizadoMesAtual.toFixed(2)} recebidos ` +
        `de ‚Ç¨ ${previstoMesAtual.toFixed(2)} previstos ¬∑ ` +
        `‚Ç¨ ${pendenteTotal.toFixed(2)} em falta.`;
    }

    if (elTend) {
      elTend.textContent =
        `Ano atual: ‚Ç¨ ${realizadoAnoAtual.toFixed(2)} faturados ` +
        `de ‚Ç¨ ${previstoAnoAtual.toFixed(2)} previstos.`;
    }

    if (elAlunos) {
      if (nAlunosAtivos <= 0) {
        elAlunos.textContent = "Ainda n√£o tens alunos ativos registados.";
      } else if (nAlunosAtivos === 1) {
        elAlunos.textContent = "A acompanhar 1 aluno ativo.";
      } else {
        elAlunos.textContent = `A acompanhar ${nAlunosAtivos} alunos ativos.`;
      }
    }
  }

  // ------- KPI's Report cart√µes -----------
  function updateRelatorioKpis({
      previstoMesAtual = 0,
      realizadoMesAtual = 0,
      previstoAnoAtual = 0,
      realizadoAnoAtual = 0,
    } = {}) {
      // 1) Total de alunos
      const total = (ALUNOS_CACHE || []).length;
      const ativos = (ALUNOS_CACHE || []).filter(a => a.is_active !== false).length;

      const elTot = document.getElementById("rel-kpi-total-alunos");
      const elTotSub = document.getElementById("rel-kpi-total-alunos-sub");
      if (elTot) elTot.textContent = String(total);
      if (elTotSub) {
        elTotSub.textContent =
          ativos === 1 ? "1 ativo" : `${ativos} ativos`;
      }

      // 2) Fatura√ß√£o m√©dia / m√™s (ano atual)
      const hoje = new Date();
      const mesAtual = hoje.getMonth() + 1;
      const mesesConsiderados = Math.max(mesAtual, 1);
      const mediaMes = realizadoAnoAtual / mesesConsiderados;

      const elFatMed = document.getElementById("rel-kpi-fat-media");
      if (elFatMed) elFatMed.textContent = `‚Ç¨ ${mediaMes.toFixed(0)}/m√™s`;

      // 3) Crescimento vs m√™s anterior
      let realizadoMesAnterior = 0;
      const anoAtual = hoje.getFullYear();
      let mesAnterior = mesAtual - 1;
      let anoMesAnterior = anoAtual;

      if (mesAnterior < 1) {
        mesAnterior = 12;
        anoMesAnterior = anoAtual - 1;
      }

      (PAGAMENTOS_CACHE || []).forEach(p => {
        if (p.ano === anoMesAnterior && p.mes === mesAnterior) {
          realizadoMesAnterior += Number(p.valor_pago) || 0;
        }
      });

      let crescimentoTxt = "‚Äî";
      if (realizadoMesAnterior > 0) {
        const diff = realizadoMesAtual - realizadoMesAnterior;
        const perc = (diff / realizadoMesAnterior) * 100;
        const sinal = perc >= 0 ? "+" : "";
        crescimentoTxt = `${sinal}${perc.toFixed(1)}%`;
      }

      const elCresc = document.getElementById("rel-kpi-crescimento");
      if (elCresc) elCresc.textContent = crescimentoTxt;

      // 4) Sess√µes / m√™s (m√©dia √∫ltimos 3 meses)
      const elSessoes = document.getElementById("rel-kpi-sessoes-mes");
      if (elSessoes) {
        if (!SESSOES_EXPLICADOR || !SESSOES_EXPLICADOR.length) {
          elSessoes.textContent = "‚Äî";
        } else {
          const hoje = new Date();
          const limite = new Date();
          limite.setMonth(hoje.getMonth() - 2); // √∫ltimos 3 meses

          let cont = 0;
          (SESSOES_EXPLICADOR || []).forEach(s => {
            if (!s.data) return;
            const d = new Date(s.data);
            if (d >= limite && d <= hoje) cont++;
          });

          const media3m = cont / 3;
          elSessoes.textContent = media3m.toFixed(1);
        }
      }
    }

  // ---------- KPI financeiros ----------
  async function loadKpisFinanceiros() {
    if (!EXPLICADOR.id_explicador) return;

    const cardTotalPrev = document.getElementById("card-total-previsto");
    const cardTotalMes  = document.getElementById("card-total-mes");
    const cardPendentes = document.getElementById("card-pendentes");

    try {
      const { data, error } = await supabase
        .from("v_pagamentos_detalhe")
        .select("ano, mes, id_aluno, aluno_nome, valor_previsto, valor_pago, estado")
        .eq("id_explicador", EXPLICADOR.id_explicador);

      if (error) {
        console.error("Erro a carregar KPI financeiros", error);
        return;
      }

      // cache global com todos os pagamentos
      PAGAMENTOS_CACHE = data || [];

      const now      = new Date();
      const anoAtual = now.getFullYear();
      const mesAtual = now.getMonth() + 1;

      let previstoMesAtual      = 0;
      let realizadoMesAtual     = 0;
      let previstoAnoAtual      = 0;
      let realizadoAnoAtual     = 0;
      let pendenteTotalMesAtual = 0;
      const alunosComPendencias = new Set();

      (PAGAMENTOS_CACHE || []).forEach((p) => {
        const previsto = Number(p.valor_previsto) || 0;
        const pago     = Number(p.valor_pago) || 0;
        const falta    = Math.max(previsto - pago, 0);

        // Ano inteiro
        if (p.ano === anoAtual) {
          previstoAnoAtual  += previsto;
          realizadoAnoAtual += pago;
        }

        // S√≥ m√™s atual (para os cards da dashboard)
        if (p.ano === anoAtual && p.mes === mesAtual) {
          previstoMesAtual      += previsto;
          realizadoMesAtual     += pago;
          pendenteTotalMesAtual += falta;

          if (falta > 0 && p.id_aluno) {
            alunosComPendencias.add(p.id_aluno);
          }
        }
      });

      // ---- Cards na dashboard ----
      if (cardTotalPrev) {
        cardTotalPrev.textContent = `‚Ç¨ ${previstoMesAtual.toFixed(2)}`;
      }

      if (cardTotalMes) {
        cardTotalMes.textContent =
          `‚Ç¨ ${realizadoMesAtual.toFixed(2)} de ‚Ç¨ ${previstoMesAtual.toFixed(2)}`;
      }

      if (cardPendentes) {
        const nAlunosPend = alunosComPendencias.size;
        const labelAlunos =
          nAlunosPend === 0
            ? "Nenhum aluno em falta"
            : nAlunosPend === 1
            ? "1 aluno em falta"
            : `${nAlunosPend} alunos em falta`;

        cardPendentes.textContent =
          `‚Ç¨ ${pendenteTotalMesAtual.toFixed(2)} (${labelAlunos})`;
      }

      // ---- Resumo dos relat√≥rios (texto) ----
      const nAlunosAtivos = (ALUNOS_CACHE || []).filter(a => a.is_active !== false).length;
      updateResumoRelatorios({
        previstoMesAtual,
        realizadoMesAtual,
        pendenteTotal: pendenteTotalMesAtual,
        previstoAnoAtual,
        realizadoAnoAtual,
        nAlunosAtivos,
      });
      updateRelatorioKpis({
        previstoMesAtual,
        realizadoMesAtual,
        previstoAnoAtual,
        realizadoAnoAtual,
      });

      // ---- Sec√ß√£o Fatura√ß√£o + Gr√°ficos ----
      prepararFiltrosFaturacao();   // preenche <select> de m√™s/ano e liga eventos
      renderResumoMensal();         // preenche tabelas "pagas" + "em falta"
      atualizarGraficosPagamentos && atualizarGraficosPagamentos();
      atualizarGraficoEvolucaoAnual && atualizarGraficoEvolucaoAnual(); // se j√° definiste os gr√°ficos
    } catch (err) {
      console.error("Erro inesperado em loadKpisFinanceiros", err);
    }
  }

  // ---------- FATURA√á√ÉO: filtros de m√™s/ano ----------
  function prepararFiltrosFaturacao() {
    const selMes = document.getElementById("fat-filtro-mes");
    const selAno = document.getElementById("fat-filtro-ano");
    if (!selMes || !selAno) return;

    // criar lista de anos com base nos dados existentes
    const anos = new Set();
    (PAGAMENTOS_CACHE || []).forEach((p) => {
      if (p.ano) anos.add(p.ano);
    });
    if (!anos.size) {
      anos.add(new Date().getFullYear());
    }
    const anosArr = Array.from(anos).sort();

    selAno.innerHTML = anosArr
      .map((a) => `<option value="${a}">${a}</option>`)
      .join("");

    // m√™s/ano por defeito
    const now = new Date();
    if (!selMes.value) {
      selMes.value = String(now.getMonth() + 1);
    }
    if (!selAno.value) {
      selAno.value = anosArr.includes(now.getFullYear())
        ? String(now.getFullYear())
        : String(anosArr[0]);
    }

    const onChange = () => {
      renderResumoMensal();
      atualizarGraficosPagamentos && atualizarGraficosPagamentos();
    };

    // evitar adicionar m√∫ltiplos listeners cada vez que chamas loadKpisFinanceiros
    if (!selMes.dataset.bound) {
      selMes.addEventListener("change", onChange);
      selMes.dataset.bound = "1";
    }
    if (!selAno.dataset.bound) {
      selAno.addEventListener("change", onChange);
      selAno.dataset.bound = "1";
    }
  }

// ---------- CARREGAR SESS√ïES DO ALUNO ----------
async function loadSessoesAluno(alunoId) {
  if (!alunoId) return;

  const { data, error } = await callExplFn("list_sessoes_aluno", {
    aluno_id: alunoId,
  });

  if (error) {
    console.error("list_sessoes_aluno error", error);
    const tblBody = document.querySelector("#listaExplicacoes");
    if (tblBody) {
      tblBody.innerHTML =
        '<tr><td colspan="5">Erro a carregar sess√µes do aluno.</td></tr>';
    }
    return;
  }

  SESSOES_ALUNO_ATUAL = data || [];

  // Atualiza tabela + KPI + pr√≥xima aula
  atualizarPerfilComSessoes(SESSOES_ALUNO_ATUAL);
}

  function atualizarPerfilComSessoes(sessoes) {
  const tbody      = document.getElementById("listaExplicacoes");
  const kpiAulasEl = document.getElementById("kpiAulas");
  const proxEl     = document.getElementById("proximaAulaTxt");

  if (!tbody) return;

  if (!sessoes || !sessoes.length) {
    tbody.innerHTML =
      '<tr><td colspan="5">Ainda n√£o existem explica√ß√µes registadas.</td></tr>';
    if (kpiAulasEl) kpiAulasEl.textContent = "0/0";
    if (proxEl) proxEl.textContent = "Nenhuma aula agendada";
    return;
  }

  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);
  let proximaSessao = null;

  const rows = sessoes.map((s) => {
    // Data formatada yyyy-mm-dd -> dd/mm/yyyy
    let dataLabel = "‚Äî";
    if (s.data) {
      const [ano, mes, dia] = s.data.split("-");
      dataLabel = `${dia}/${mes}/${ano}`;
    }

    const inicio = s.hora_inicio ? s.hora_inicio.slice(0, 5) : "--:--";
    const fim    = s.hora_fim ? s.hora_fim.slice(0, 5) : "--:--";
    const dur    = s.duracao_min != null ? s.duracao_min : "‚Äî";
    const estado = s.estado || "‚Äî";

    // Pr√≥xima aula (AGENDADA no futuro)
    if (s.data) {
      const d = new Date(s.data);
      d.setHours(0, 0, 0, 0);
      if (
        !isNaN(d.getTime()) &&
        d >= hoje &&
        estado.toUpperCase() !== "CANCELADA"
      ) {
        if (!proximaSessao || d < new Date(proximaSessao.data)) {
          proximaSessao = s;
        }
      }
    }

    return `
      <tr data-id="${s.id_sessao}">
        <td>${dataLabel}</td>
        <td>${inicio}</td>
        <td>${fim}</td>
        <td>${dur}</td>
        <td>
          ${estado}
          <span class="acoes-exp">
            <!-- editar -->
            <button class="sessao-btn sessao-acao" data-acao="editar">
              <svg class="icon16" viewBox="0 0 24 24">
                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" fill="#b91c1c"/>
                <path d="M20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z" fill="#b91c1c"/>
              </svg>
            </button>

            <!-- marcar como realizada -->
            <button class="sessao-btn sessao-acao" data-acao="realizada">
              <svg class="icon16" viewBox="0 0 24 24">
                <path d="M9 16.2l-3.5-3.5L4 14.2 9 19l11-11-1.5-1.5L9 16.2z"
                      fill="#b91c1c"/>
              </svg>
            </button>

            <!-- apagar -->
            <button class="sessao-btn sessao-acao" data-acao="apagar">
              <svg class="icon16" viewBox="0 0 24 24">
                <path d="M3 6h18" stroke="#b91c1c" stroke-width="2" stroke-linecap="round"/>
                <path d="M8 6V4h8v2" stroke="#b91c1c" stroke-width="2" stroke-linecap="round"/>
                <path d="M10 11v6M14 11v6" stroke="#b91c1c" stroke-width="2" stroke-linecap="round"/>
                <path d="M5 6h14v13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6z"
                      stroke="#b91c1c" stroke-width="2" fill="none"/>
              </svg>
            </button>
          </span>
        </td>
      </tr>
    `;
  });

  tbody.innerHTML = rows.join("");

  // KPI aulas conclu√≠das
  if (kpiAulasEl) {
    const total = sessoes.length;
    const concluidas = sessoes.filter(
      (s) => (s.estado || "").toUpperCase() === "REALIZADA"
    ).length;
    kpiAulasEl.textContent = `${concluidas}/${total}`;
  }

  // Pr√≥xima aula
  if (proxEl) {
    if (!proximaSessao) {
      proxEl.textContent = "Nenhuma aula agendada";
    } else {
      const [ano, mes, dia] = proximaSessao.data.split("-");
      const dataNice = `${dia}/${mes}/${ano}`;
      const hora = proximaSessao.hora_inicio
        ? proximaSessao.hora_inicio.slice(0, 5)
        : "";
      proxEl.textContent = hora ? `${dataNice} √†s ${hora}` : dataNice;
    }
  }

  // ligar handlers uma vez (delega√ß√£o no tbody)
  if (!tbody.dataset.boundSessao) {
    tbody.addEventListener("click", onClickAcaoSessao);
    tbody.dataset.boundSessao = "1";
  }
}

  async function onClickAcaoSessao(ev) {
  const btn = ev.target.closest(".sessao-acao");
  if (!btn) return;

  ev.stopPropagation();

  const tr   = btn.closest("tr");
  const id   = tr?.dataset.id;
  const acao = btn.dataset.acao;
  if (!id || !acao) return;

  const sessao = (SESSOES_ALUNO_ATUAL || []).find(
    (s) => String(s.id_sessao) === String(id)
  );
  if (!sessao) return;

  // EDITAR ‚Üí abre modal da sess√£o (N√ÉO o perfil do aluno)
  if (acao === "editar") {
    if (typeof preencherModalSessao === "function") {
      preencherModalSessao(sessao);   // fun√ß√£o que preenche o form da sess√£o
    }
    if (typeof modalSessao !== "undefined") {
      openModal(modalSessao);
    }
    return;
  }

  // MARCAR COMO REALIZADA
  if (acao === "realizada") {
    try {
      const payload = {
        id_sessao: sessao.id_sessao,
        aluno_id: sessao.aluno_id || (ALUNO_ATUAL && ALUNO_ATUAL.id_aluno),
        data: sessao.data,
        hora_inicio: sessao.hora_inicio,
        hora_fim: sessao.hora_fim,
        duracao_min: sessao.duracao_min,
        estado: "REALIZADA",
        observacoes: sessao.observacoes,
      };

      const { error } = await callExplFn("upsert_sessao_aluno", payload);
      if (error) {
        console.error(error);
        alert("N√£o foi poss√≠vel atualizar a sess√£o.");
        return;
      }

      await loadSessoesAluno(ALUNO_ATUAL.id_aluno);
      await loadResumoCalendario();
    } catch (e) {
      console.error(e);
      alert("Erro inesperado ao atualizar sess√£o.");
    }
    return;
  }

  // APAGAR
  if (acao === "apagar") {
    const conf = confirm("Tens a certeza que queres apagar esta sess√£o?");
    if (!conf) return;

    try {
      const { error } = await callExplFn("delete_sessao_aluno", {
        id_sessao: sessao.id_sessao,
      });

      if (error) {
        console.error(error);
        alert("N√£o foi poss√≠vel apagar a sess√£o.");
        return;
      }

      await loadSessoesAluno(ALUNO_ATUAL.id_aluno);
      await loadResumoCalendario();
    } catch (e) {
      console.error(e);
      alert("Erro inesperado ao apagar sess√£o.");
    }
  }
}

  function obterIdAluno(alunoOuId) {
  if (!alunoOuId) return null;

  // j√° √© id
  if (typeof alunoOuId === "number" || typeof alunoOuId === "string") {
    return alunoOuId;
  }

  // √© objeto aluno
  if (typeof alunoOuId === "object" && alunoOuId.id_aluno) {
    return alunoOuId.id_aluno;
  }

  return null;
}

async function carregarPerfilAluno(alunoOuId) {
  const idAluno = obterIdAluno(alunoOuId);

  if (!idAluno) {
    console.error("carregarPerfilAluno: idAluno inv√°lido", alunoOuId);
    return;
  }

  const aluno = await fetchAluno(idAluno);
  if (!aluno) {
    alert("Erro ao carregar aluno.");
    return;
  }

  ALUNO_ATUAL = aluno;

  // Preenche o cart√£o grande
  if (typeof preencherCartaoPerfil === "function") {
    preencherCartaoPerfil(ALUNO_ATUAL);
  }

  // Mostra a sec√ß√£o de detalhe
  mostrarSecao("aluno-perfil");
}


  async function carregarPerfilAluno(alunoOuId) {
    const idAluno = obterIdAluno(alunoOuId);
    if (!idAluno) {
      console.error("carregarPerfilAluno: idAluno inv√°lido", alunoOuId);
      return;
    }

    const aluno = await fetchAluno(idAluno);
    if (!aluno) {
      alert("Erro ao carregar aluno.");
      return;
    }

    ALUNO_ATUAL = aluno;

    // aqui usas a tua fun√ß√£o que preenche o cart√£o grande
    if (typeof preencherCartaoPerfil === "function") {
      preencherCartaoPerfil(ALUNO_ATUAL);
    }

    // e mostra a sec√ß√£o correta
    mostrarSecao("aluno-perfil");
  }

// ---------- ATUALIZAR PERFIL DO ALUNO: PAGAMENTOS ----------
  function atualizarPerfilComPagamentos(pagamentos) {
  const tbody   = document.getElementById("listaPagamentos");
  const totalEl = document.getElementById("pagTotal");
  if (!tbody) return;

  if (!pagamentos || !pagamentos.length) {
    tbody.innerHTML =
      '<tr><td colspan="5">Ainda n√£o existem pagamentos registados.</td></tr>';
    if (totalEl) totalEl.textContent = "0.00";
    return;
  }

  const nomesMesesLong = [
    "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
    "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro",
  ];

  let totalRecebido = 0;

  const rows = pagamentos.map((p) => {
    const pago = Number(p.valor_pago) || 0;
    totalRecebido += pago;

    const ano = p.ano;
    const mes = p.mes;
    const periodo = (nomesMesesLong[mes - 1] || mes) + " " + ano;

    const dataLabel =
      p.data_pagamento ||
      `${String(1).padStart(2, "0")}/${String(mes).padStart(2, "0")}/${ano}`;

    const metodo = "‚Äî";
    const estado = p.estado || "‚Äî";

    return `
      <tr>
        <td>${dataLabel}</td>
        <td>${periodo}</td>
        <td>‚Ç¨ ${pago.toFixed(2)}</td>
        <td>${metodo}</td>
        <td>
          ${estado}
          <span class="acoes-exp">
            <!-- editar -->
            <button
              class="pag-btn"
              data-acao="editar"
              data-id="${p.id_pagamento}"
              type="button"
            >
              <svg class="icon16" viewBox="0 0 24 24">
                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" fill="#b91c1c"/>
                <path d="M20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z" fill="#b91c1c"/>
              </svg>
            </button>

            <!-- apagar -->
            <button
              class="pag-btn"
              data-acao="apagar"
              data-id="${p.id_pagamento}"
              type="button"
            >
              <svg class="icon16" viewBox="0 0 24 24">
                <path d="M3 6h18" stroke="#b91c1c" stroke-width="2" stroke-linecap="round"/>
                <path d="M8 6V4h8v2" stroke="#b91c1c" stroke-width="2" stroke-linecap="round"/>
                <path d="M10 11v6M14 11v6" stroke="#b91c1c" stroke-width="2" stroke-linecap="round"/>
                <path d="M5 6h14v13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6z"
                      stroke="#b91c1c" stroke-width="2" fill="none"/>
              </svg>
            </button>
          </span>
        </td>
      </tr>
    `;
  });

  tbody.innerHTML = rows.join("");

  if (totalEl) {
    totalEl.textContent = totalRecebido.toFixed(2);
  }

  // Ligar bot√µes de EDITAR / APAGAR (pagamentos)
  tbody.querySelectorAll(".pag-btn").forEach((btn) => {
    btn.addEventListener("click", async (ev) => {
      ev.stopPropagation();

      const acao = btn.dataset.acao;
      const id   = btn.dataset.id;

      const pagamento = pagamentos.find(
        (p) => String(p.id_pagamento) === String(id)
      );
      if (!pagamento) return;

      // EDITAR
      if (acao === "editar") {
        // usa o mesmo modal que j√° tens para pagamentos do aluno
        // -> modo "editar"
        if (typeof abrirModalPagamento === "function") {
          // se tiveres esta fun√ß√£o, podes passarlhe o pagamento
          abrirModalPagamento("editar", pagamento);
        } else if (typeof preencherModalPagamento === "function") {
          // fallback para a tua fun√ß√£o antiga
          preencherModalPagamento(pagamento);
        }
        return;
      }

      // APAGAR
      if (acao === "apagar") {
        if (!confirm("Tens certeza que queres apagar este pagamento?")) return;

        const { error } = await callExplFn("delete_pagamento", {
          id_pagamento: id,
        });

        if (error) {
          console.error(error);
          alert("Erro ao apagar pagamento.");
          return;
        }

        // recarrega pagamentos/summary desse aluno
        await loadPagamentosAluno(ALUNO_ATUAL.id_aluno);
      }
    });
  });
}

  // ---------- OPEN/CLOSE MODAL ----------
  function openModal(mod) { mod && mod.classList.add('open'); }
  function closeModal(mod) { mod && mod.classList.remove('open'); }

  // ---------- MODAL PAGAMENTO: ABRIR ----------
  function abrirModalPagamento(modo) {
    if (!formPag) return;
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      alert("Seleciona primeiro um aluno na lista.");
      return;
    }

    const agora = new Date();

    inputAno.value = String(agora.getFullYear());
    inputMes.value = String(agora.getMonth() + 1);
    inputDiaPag.value = "";
    inputValor.value = "";

    formPag.modo.value = modo;
    msgPag.textContent = "";
    msgPag.style.color = "";

    inputDiaPag.style.display = "none";
    inputValor.style.display = "none";

    if (modo === "iniciar") {
      pagModalTitle.textContent = "Iniciar fatura√ß√£o";
      pagModalHint.textContent  =
        "Defina o m√™s/ano de in√≠cio e o dia de pagamento da mensalidade.";
      inputDiaPag.style.display = "block";
      btnSavePag.textContent    = "Iniciar fatura√ß√£o";

    } else if (modo === "registar") {
      pagModalTitle.textContent = "Registar pagamento";
      pagModalHint.textContent  =
        "Regista um pagamento a acrescentar ao valor j√° pago nesse m√™s.";
      inputValor.style.display  = "block";
      btnSavePag.textContent    = "Registar pagamento";

    } else { // "editar"
      pagModalTitle.textContent = "Editar pagamento";
      pagModalHint.textContent  =
        "Substitui o valor pago nesse m√™s pelo valor indicado.";
      inputValor.style.display  = "block";
      btnSavePag.textContent    = "Guardar altera√ß√µes";
    }

    openModal(modalPag);
  }

  btnIniciarFat?.addEventListener("click", () => abrirModalPagamento("iniciar"));
  btnRegistarPag?.addEventListener("click", () => abrirModalPagamento("registar"));
  btnEditarPag?.addEventListener("click", () => abrirModalPagamento("editar"));

  $('#modal-pagamento-aluno .modal__close')?.addEventListener('click', () => {
    closeModal(modalPag);
  });

  modalPag?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalPag);
    }
  });

  // ---------- SUBMIT MODAL PAGAMENTO ----------
  formPag?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      msgPag.textContent = "Nenhum aluno selecionado.";
      return;
    }

    const modo  = formPag.modo.value;
    const ano   = Number(inputAno.value);
    const mes   = Number(inputMes.value);
    const dia   = inputDiaPag.value ? Number(inputDiaPag.value) : null;
    const valor = inputValor.value ? Number(inputValor.value) : null;

    if (!ano || !mes || mes < 1 || mes > 12) {
      msgPag.textContent = "Ano ou m√™s inv√°lidos.";
      return;
    }

    if (modo === "iniciar") {
      if (!dia || dia < 1 || dia > 31) {
        msgPag.textContent = "Dia de pagamento inv√°lido.";
        return;
      }
    } else {
      if (valor === null || isNaN(valor) || valor < 0) {
        msgPag.textContent = "Valor inv√°lido.";
        return;
      }
    }

    btnSavePag.disabled = true;
    msgPag.textContent  = "A guardar...";

    try {
      let action, payload;

      if (modo === "iniciar") {
        action = "iniciar_faturacao_aluno";
        payload = {
          aluno_id: ALUNO_ATUAL.id_aluno,
          ano,
          mes,
          dia_pagamento: dia,
        };
      } else if (modo === "registar") {
        action = "registar_pagamento_aluno";
        payload = {
          aluno_id: ALUNO_ATUAL.id_aluno,
          ano,
          mes,
          valor,
        };
      } else {
        action = "update_pagamento_aluno";
        payload = {
          aluno_id: ALUNO_ATUAL.id_aluno,
          ano,
          mes,
          valor_pago: valor,
        };
      }

      const { data, error } = await callExplFn(action, payload);

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro pagamento_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
              else extra = " " + raw;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        msgPag.textContent = "N√£o foi poss√≠vel guardar." + extra;
        btnSavePag.disabled = false;
        return;
      }

      msgPag.style.color = "#126b3a";
      msgPag.textContent = "Guardado com sucesso.";

      // 1) Recarrega alunos a partir da BD
      await loadAlunos();              // <- NOVO

      // 2) Atualiza os KPIs financeiros
      await loadKpisFinanceiros();

      // 3) Volta a mostrar o painel do aluno com os dados frescos
      const alunoAtualizado = ALUNOS_CACHE.find(
        (a) => String(a.id_aluno) === String(ALUNO_ATUAL.id_aluno)
      );
      if (alunoAtualizado) {
        await mostrarPainelAluno(alunoAtualizado);
      }

      // 4) Atualiza o resumo do calend√°rio
      await loadResumoCalendario();
      setTimeout(() => closeModal(modalPag), 600);
    } catch (e) {
      console.error("pagamento_aluno error", e);
      msgPag.textContent = "Erro inesperado ao guardar.";
    } finally {
      btnSavePag.disabled = false;
    }
  });

  // ---------- Painel de detalhes por aluno ----------
  async function mostrarPainelAluno(aluno) {

  ALUNO_ATUAL = aluno;

  const card = document.getElementById("aluno-detail-card");
  if (!card) return;

  const nomeCompleto = [aluno.nome, aluno.apelido].filter(Boolean).join(" ");
  document.getElementById("aluno-detail-nome").textContent =
    nomeCompleto || "Aluno";

  updateAlunoStatusUI(aluno);

  document.getElementById("aluno-detail-meta").textContent =
    aluno.username ? `Username: ${aluno.username}` : "";

  document.getElementById("aluno-detail-email").textContent =
    aluno.email || "‚Äî";
  document.getElementById("aluno-detail-tel").textContent =
    aluno.telemovel || "‚Äî";
  document.getElementById("aluno-detail-ano").textContent =
    aluno.ano ?? "‚Äî";

  document.getElementById("aluno-detail-valor").textContent =
    aluno.valor_explicacao != null
      ? `‚Ç¨ ${Number(aluno.valor_explicacao).toFixed(2)}`
      : "‚Äî";

  document.getElementById("aluno-detail-sessoes").textContent =
    aluno.sessoes_mes != null ? String(aluno.sessoes_mes) : "‚Äî";

  card.style.display = "block";

  if (!EXPLICADOR.id_explicador) return;

  const elPrevistoMes = document.getElementById("aluno-detail-previsto-mes");
  const elPagoMes = document.getElementById("aluno-detail-pago-mes");
  const elEmFalta = document.getElementById("aluno-detail-emfalta");

  // üî• CORRE√á√ÉO ‚Äî declarar antes do try
  let pagamentosAluno = [];

  try {
    const now = new Date();
    const anoAtual = now.getFullYear();
    const mesAtual = now.getMonth() + 1;

    const { data, error } = await supabase
      .from("v_pagamentos_detalhe")
      .select(
        "ano, mes, valor_previsto, valor_pago, estado, data_pagamento"
      )
      .eq("id_explicador", EXPLICADOR.id_explicador)
      .eq("id_aluno", aluno.id_aluno);

    if (error) {
      console.error("Erro a carregar pagamentos do aluno", error);
      if (elPrevistoMes) elPrevistoMes.textContent = "‚Äî";
      if (elPagoMes) elPagoMes.textContent = "‚Äî";
      if (elEmFalta) elEmFalta.textContent = "‚Äî";
      return;
    }

    // üî• CORRE√á√ÉO ‚Äî guardar os pagamentos lidos
    pagamentosAluno = data || [];

    let previstoMes = 0;
    let pagoMes = 0;
    let emFaltaTotal = 0;

    (data || []).forEach((p) => {
      const previsto = Number(p.valor_previsto) || 0;
      const pago = Number(p.valor_pago) || 0;
      const falta = Math.max(previsto - pago, 0);

      if (p.ano === anoAtual && p.mes === mesAtual) {
        previstoMes += previsto;
        pagoMes += pago;
      }

      emFaltaTotal += falta;
    });

    if (
      (!data || data.length === 0) &&
      aluno.valor_explicacao != null &&
      aluno.sessoes_mes != null
    ) {
      const estimado =
        Number(aluno.valor_explicacao) * Number(aluno.sessoes_mes);

      previstoMes = estimado;
      pagoMes = 0;
      emFaltaTotal = estimado;
    }

    if (elPrevistoMes)
      elPrevistoMes.textContent = `‚Ç¨ ${previstoMes.toFixed(2)}`;
    if (elPagoMes) elPagoMes.textContent = `‚Ç¨ ${pagoMes.toFixed(2)}`;
    if (elEmFalta) elEmFalta.textContent = `‚Ç¨ ${emFaltaTotal.toFixed(2)}`;

    // (tabela original mant√©m-se)
  } catch (err) {
    console.error("Erro inesperado ao calcular resumo do aluno", err);
  }

  // üî• CORRE√á√ÉO ‚Äî esta vari√°vel AGORA existe sempre
  atualizarPerfilComPagamentos(pagamentosAluno);

  // Carregar sess√µes do aluno para preencher tab "Explica√ß√µes"
  await loadSessoesAluno(aluno.id_aluno);
}

  // ---------- CRIAR ALUNO ----------
  async function createAluno(payload) {
    const { data, error } = await callExplFn("create_aluno", payload);

    if (error) {
      console.error(error);
      return { ok: false, error: error.message };
    }

    return { ok: true, data };
  }

  // ---------- MODAIS (add / edit / sess√£o) ----------
  modalAddAluno?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalAddAluno);
    }
  });

  $('#modal-add-aluno .modal__close')?.addEventListener('click', () => {
    closeModal(modalAddAluno);
  });

  btnFab?.addEventListener('click', () => openModal(modalAddAluno));
  btnOpenAddAluno?.addEventListener('click', () => openModal(modalAddAluno));

  $('#modal-edit-aluno .modal__close')?.addEventListener('click', () => {
    closeModal(modalEditAluno);
  });

  modalEditAluno?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalEditAluno);
    }
  });

  $('#modal-sessao .modal__close')?.addEventListener('click', () => {
    closeModal(modalSessao);
  });

  modalSessao?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalSessao);
    }
  });

  // ---------- PREENCHER MODAL DE EDI√á√ÉO DO ALUNO ----------
  function preencherModalEdicao(aluno) {
    if (!formEdit || !aluno) return;

    formEdit.nome_edit.value  = aluno.nome || "";
    formEdit.apelido_edit.value = aluno.apelido || "";
    formEdit.telemovel_edit.value = aluno.telemovel || "";
    formEdit.ano_edit.value = aluno.ano != null ? aluno.ano : "";
    formEdit.idade_edit.value = aluno.idade != null ? aluno.idade : "";
    formEdit.dia_semana_preferido_edit.value = aluno.dia_semana_preferido || "";
    formEdit.valor_explicacao_edit.value =
      aluno.valor_explicacao != null ? aluno.valor_explicacao : "";
    formEdit.sessoes_mes_edit.value =
      aluno.sessoes_mes != null ? aluno.sessoes_mes : "";
    formEdit.nome_pai_cache_edit.value = aluno.nome_pai_cache || "";
    formEdit.contacto_pai_cache_edit.value = aluno.contacto_pai_cache || "";
    formEdit.email_edit.value = aluno.email || "";
    formEdit.username_edit.value = aluno.username || "";
    formEdit.password_edit.value = "";
    msgEditAluno.textContent = "";
    msgEditAluno.style.color = "";
  }

  btnEditarAluno?.addEventListener("click", () => {
    if (!ALUNO_ATUAL) {
      alert("Seleciona primeiro um aluno na lista.");
      return;
    }
    preencherModalEdicao(ALUNO_ATUAL);
    openModal(modalEditAluno);
  });

  // ---------- TOGGLE ATIVO / BLOQUEADO ----------
  toggleAlunoAtivo?.addEventListener('click', async () => {
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) return;

    const estavaAtivo = ALUNO_ATUAL.is_active !== false;
    const novoEstado = !estavaAtivo;

    if (!novoEstado) {
      const confirma = confirm(
        'Ao bloquear este aluno ele deixa de conseguir fazer login e deixa de contar como aluno ativo. Continuar?'
      );
      if (!confirma) return;
    }

    // feedback m√≠nimo
    if (alunoStatusBadge) {
      alunoStatusBadge.textContent = 'A atualizar...';
    }

    const { error } = await callExplFn('update_aluno', {
      id_aluno: ALUNO_ATUAL.id_aluno,
      is_active: novoEstado,
    });

    if (error) {
      console.error('Erro ao alterar estado do aluno', error);
      alert('N√£o foi poss√≠vel atualizar o estado do aluno.');
      // volta ao estado anterior no UI
      updateAlunoStatusUI(ALUNO_ATUAL);
      return;
    }

    // Atualizar caches
    ALUNO_ATUAL.is_active = novoEstado;
    const idx = (ALUNOS_CACHE || []).findIndex(
      a => String(a.id_aluno) === String(ALUNO_ATUAL.id_aluno)
    );
    if (idx >= 0) {
      ALUNOS_CACHE[idx].is_active = novoEstado;
    }

    // Atualizar UI dependentes
    updateAlunoStatusUI(ALUNO_ATUAL);
    renderDashboardAlunos();
    await loadKpisFinanceiros();
  });

  // ---------- SUBMIT EDITAR ALUNO ----------
  formEdit?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    msgEditAluno.textContent = "";

    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      msgEditAluno.textContent = "Nenhum aluno selecionado.";
      return;
    }

    const f = ev.target;

    const payload = {
      id_aluno: ALUNO_ATUAL.id_aluno,
      nome: f.nome_edit.value.trim() || null,
      apelido: f.apelido_edit.value.trim() || null,
      telemovel: f.telemovel_edit.value.trim() || null,
      ano: f.ano_edit.value ? Number(f.ano_edit.value) : null,
      idade: f.idade_edit.value ? Number(f.idade_edit.value) : null,
      dia_semana_preferido: f.dia_semana_preferido_edit.value.trim() || null,
      valor_explicacao: f.valor_explicacao_edit.value
        ? Number(f.valor_explicacao_edit.value)
        : null,
      sessoes_mes: f.sessoes_mes_edit.value
        ? Number(f.sessoes_mes_edit.value)
        : null,
      nome_pai_cache: f.nome_pai_cache_edit.value.trim() || null,
      contacto_pai_cache: f.contacto_pai_cache_edit.value.trim() || null,
      email: f.email_edit.value.trim() || null,
      username: f.username_edit.value.trim() || null,
      password: f.password_edit.value.trim() || undefined,
      is_active: ALUNO_ATUAL?.is_active ?? true,
    };

    btnSaveEdit.disabled = true;
    msgEditAluno.textContent = "A guardar altera√ß√µes...";

    try {
      const { data, error } = await callExplFn("update_aluno", payload);

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro update_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        msgEditAluno.textContent =
          "N√£o foi poss√≠vel guardar as altera√ß√µes." + extra;
        btnSaveEdit.disabled = false;
        return;
      }

      msgEditAluno.style.color = "#126b3a";
      msgEditAluno.textContent = "Altera√ß√µes guardadas com sucesso.";

      await loadAlunos();
      const alunoAtualizado = ALUNOS_CACHE.find(
        (a) => String(a.id_aluno) === String(ALUNO_ATUAL.id_aluno)
      );
      if (alunoAtualizado) {
        mostrarPainelAluno(alunoAtualizado);
      }

      setTimeout(() => {
        closeModal(modalEditAluno);
      }, 600);
    } catch (e) {
      console.error("update_aluno error", e);
      msgEditAluno.textContent = "Erro inesperado ao guardar altera√ß√µes.";
    } finally {
      btnSaveEdit.disabled = false;
    }
  });

  // ---------- SUBMIT NOVO ALUNO ----------
  formNew?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    msgNewAluno.textContent = "";

    if (!EXPLICADOR.id_explicador) {
      msgNewAluno.textContent = "Perfil de explicador inv√°lido.";
      return;
    }

    const f = ev.target;

    const payload = {
      nome: f.nome?.value.trim() || "",
      apelido: f.apelido?.value.trim() || null,
      telemovel: f.telemovel?.value.trim() || null,
      ano: f.ano?.value ? Number(f.ano.value) : null,
      idade: f.idade?.value ? Number(f.idade.value) : null,
      dia_semana_preferido: f.dia_semana_preferido?.value.trim() || null,
      valor_explicacao: f.valor_explicacao?.value
        ? Number(f.valor_explicacao.value)
        : null,
      sessoes_mes: f.sessoes_mes?.value
        ? Number(f.sessoes_mes.value)
        : null,
      nome_pai_cache: f.nome_pai_cache?.value.trim() || null,
      contacto_pai_cache: f.contacto_pai_cache?.value.trim() || null,
      email: f.email?.value.trim() || "",
      username: f.username?.value.trim() || null,
      password: f.password?.value || "",
      is_active: true,
    };

    if (!payload.nome || !payload.email || !payload.password) {
      msgNewAluno.textContent =
        "Preenche pelo menos Nome, Email e Password.";
      return;
    }

    btnCreate.disabled = true;
    msgNewAluno.textContent = "A criar aluno...";

    const { data, error } = await callExplFn("create_aluno", payload);

    if (error) {
      let extra = "";

      if (error.context) {
        try {
          const resp = error.context;
          const raw = await resp.text();
          console.log("Erro bruto da fun√ß√£o expl-alunos:", raw);

          try {
            const json = JSON.parse(raw);
            if (json?.error) {
              extra = " " + json.error;
            } else {
              extra = " " + raw;
            }
          } catch {
            extra = " " + raw;
          }
        } catch (e) {
          console.warn("N√£o consegui ler o body da resposta da fun√ß√£o", e);
        }
      }

      console.error("create_aluno error", error);
      msgNewAluno.textContent =
        "N√£o foi poss√≠vel criar o aluno." + extra;
      btnCreate.disabled = false;
      return;
    }

    msgNewAluno.style.color = "#126b3a";
    msgNewAluno.textContent = "Aluno criado com sucesso!";
    f.reset();
    await loadAlunos();
    await loadKpisFinanceiros();
    btnCreate.disabled = false;
  });

  // ---------- LOGIN ----------
  formLogin?.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    msgLogin.textContent = 'A entrar...';

    const email    = formLogin.email.value.trim();
    const password = formLogin.password.value.trim();

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      console.error(error);
      msgLogin.textContent = 'Credenciais inv√°lidas.';
      return;
    }

    const user = data.user;
    if (!(await hasRole(user.id, 'explicador'))) {
      await supabase.auth.signOut().catch(()=>{});
      msgLogin.textContent = 'Esta conta n√£o √© de explicador.';
      return;
    }

    const exp = await getExplRow(user.id);
    EXPLICADOR = {
      userId: user.id,
      id_explicador: exp?.id_explicador || null,
      max: exp?.max_alunos ?? 0
    };

    const nomeCompleto = [exp?.nome, exp?.apelido].filter(Boolean).join(' ') || 'Professor';
    elNomeHeader.textContent = nomeCompleto;
    elNomeMini.textContent   = nomeCompleto;

    setState({ isExpl: true, isAuthed: true });
    await loadAlunos();
    await loadKpisFinanceiros();
    await loadResumoCalendario();
  });

  // ---------- LOGOUT ----------
  btnLogout?.addEventListener('click', async () => {
    await supabase.auth.signOut().catch(()=>{});
    window.location.href = './index.html';
  });

  // ---------- SESS√ÉO INICIAL ----------
  (async () => {
    setState({ loading: true });

    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) {
      setState({ isExpl: false, isAuthed: false });
      return;
    }

    const user = session.user;
    if (!(await hasRole(user.id, 'explicador'))) {
      await supabase.auth.signOut().catch(()=>{});
      setState({ isExpl: false, isAuthed: false });
      msgLogin.textContent = 'Conta sem permiss√µes de explicador.';
      return;
    }

    const exp = await getExplRow(user.id);
    EXPLICADOR = {
      userId: user.id,
      id_explicador: exp?.id_explicador || null,
      max: exp?.max_alunos ?? 0
    };

    const nomeCompleto = [exp?.nome, exp?.apelido].filter(Boolean).join(' ') || 'Professor';
    elNomeHeader.textContent = nomeCompleto;
    elNomeMini.textContent   = nomeCompleto;

    setState({ isExpl: true, isAuthed: true });
    await loadAlunos();
    await loadKpisFinanceiros();
    await loadResumoCalendario();
  })();

  // ---------- NAVEGA√á√ÉO LATERAL (tabs) ----------
  const tabs = document.querySelectorAll('.expl-nav-btn');
  const screens = document.querySelectorAll('.expl-section[data-section]');

  function ativarScreen(target) {
    screens.forEach(sec => {
      const key = sec.dataset.section;
      sec.style.display = key === target ? '' : 'none';
    });

    document.querySelector('.expl-body')?.scrollTo({ top: 0, behavior: 'smooth' });
    const title = document.querySelector('.expl-page-title');
    if (title) {
      const mapTitle = {
        dashboard: "Dashboard",
        alunos: "Alunos",
        "aluno-perfil": "Perfil do aluno",
        calendario: "Calend√°rio",
        faturacao: "Fatura√ß√£o",
        relatorios: "Relat√≥rios",
      };
      title.textContent = mapTitle[target] || 'Dashboard';
    }
  }

  tabs.forEach(btn => {
    btn.addEventListener('click', async () => {
      const target = btn.dataset.target;
      tabs.forEach(t => t.classList.remove('expl-nav-btn--active'));
      btn.classList.add('expl-nav-btn--active');
      ativarScreen(target);

      // Sempre que abres o separador Calend√°rio, recarregas as sess√µes do explicador
      if (target === 'calendario') {
        await loadResumoCalendario();
      }
    });
  });


  // bot√£o "Ver todos" na dashboard -> tab Alunos
  btnDashVerAlunos?.addEventListener('click', () => {
    const tabAlunos = document.querySelector('.expl-nav-btn[data-target="alunos"]');
    tabAlunos?.click();
  });

  // scroll para lista de alunos
  btnScrollLista?.addEventListener('click', () => {
    document.querySelector('#lista-alunos-card')?.scrollIntoView({
      behavior:'smooth',
      block:'start'
    });
  });

  supabase.auth.onAuthStateChange(async (_evt, session) => {
    if (!session?.user) {
      setState({ isExpl: false, isAuthed: false });
    }
  });

  // ---------- SESS√ïES: ABRIR MODAL ----------
  function abrirModalSessao(sessao) {
    if (!formSessao) return;

    if (sessao) {
      SESSAO_ATUAL_ID = sessao.id_sessao;
      formSessao.data_sessao.value = sessao.data || "";
      formSessao.hora_inicio.value = sessao.hora_inicio || "";
      formSessao.hora_fim.value = sessao.hora_fim || "";
      formSessao.duracao_min.value =
        sessao.duracao_min != null ? sessao.duracao_min : "";
      formSessao.estado.value = sessao.estado || "AGENDADA";
      formSessao.observacoes.value = sessao.observacoes || "";
      btnDeleteSessao.style.display = "inline-block";
    } else {
      SESSAO_ATUAL_ID = null;
      formSessao.data_sessao.value = "";
      formSessao.hora_inicio.value = "";
      formSessao.hora_fim.value = "";
      formSessao.duracao_min.value = "";
      formSessao.estado.value = "AGENDADA";
      formSessao.observacoes.value = "";
      btnDeleteSessao.style.display = "none";
    }

    msgSessao.textContent = "";
    msgSessao.style.color = "";
    openModal(modalSessao);
  }

  btnAddSessao?.addEventListener("click", () => {
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      alert("Seleciona primeiro um aluno na lista.");
      return;
    }
    abrirModalSessao(null);
  });

  // Bot√£o "Agendar explica√ß√£o" no topo da sec√ß√£o Calend√°rio
  btnAgendarExplicacao?.addEventListener('click', () => {
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      alert('Seleciona primeiro um aluno na lista de Alunos para agendar uma sess√£o.');

      // muda para o tab Alunos automaticamente
      const tabAlunos = document.querySelector('.expl-nav-btn[data-target="alunos"]');
      tabAlunos?.click();
      return;
    }

    // abre o modal de sess√£o em modo "nova sess√£o"
    abrirModalSessao(null);
  });

  // ---------- SESS√ïES: SUBMIT ----------
  formSessao?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    msgSessao.textContent = "";

    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      msgSessao.textContent = "Nenhum aluno selecionado.";
      return;
    }

    const f = ev.target;

    const data = f.data_sessao.value;
    if (!data) {
      msgSessao.textContent = "Data √© obrigat√≥ria.";
      return;
    }

    const payload = {
      id_sessao: SESSAO_ATUAL_ID || undefined,
      aluno_id: ALUNO_ATUAL.id_aluno,
      data,
      hora_inicio: f.hora_inicio.value || null,
      hora_fim: f.hora_fim.value || null,
      duracao_min: f.duracao_min.value || null,
      estado: f.estado.value || "AGENDADA",
      observacoes: f.observacoes.value || null,
    };

    btnSaveSessao.disabled = true;
    msgSessao.textContent = "A guardar sess√£o...";

    try {
      const { data, error } = await callExplFn("upsert_sessao_aluno", payload);

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro upsert_sessao_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        msgSessao.textContent =
          "N√£o foi poss√≠vel guardar a sess√£o." + extra;
        btnSaveSessao.disabled = false;
        return;
      }

      msgSessao.style.color = "#126b3a";
      msgSessao.textContent = "Sess√£o guardada com sucesso.";

      await loadSessoesAluno(ALUNO_ATUAL.id_aluno);
      await loadResumoCalendario();
      setTimeout(() => {
        closeModal(modalSessao);
      }, 500);
    } catch (e) {
      console.error("upsert_sessao_aluno error", e);
      msgSessao.textContent = "Erro inesperado ao guardar sess√£o.";
    } finally {
      btnSaveSessao.disabled = false;
    }
  });

  // ---------- SESS√ïES: APAGAR ----------
  btnDeleteSessao?.addEventListener("click", async () => {
    if (!SESSAO_ATUAL_ID) {
      return;
    }
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      alert("Nenhum aluno selecionado.");
      return;
    }

    const conf = confirm("Tens a certeza que queres apagar esta sess√£o?");
    if (!conf) return;

    msgSessao.textContent = "A apagar sess√£o...";
    btnDeleteSessao.disabled = true;

    try {
      const { data, error } = await callExplFn("delete_sessao_aluno", {
        id_sessao: SESSAO_ATUAL_ID,
      });

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro delete_sessao_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        msgSessao.textContent =
          "N√£o foi poss√≠vel apagar a sess√£o." + extra;
        btnDeleteSessao.disabled = false;
        return;
      }

      msgSessao.style.color = "#126b3a";
      msgSessao.textContent = "Sess√£o apagada com sucesso.";

      await loadSessoesAluno(ALUNO_ATUAL.id_aluno);
      await loadResumoCalendario(); 
      setTimeout(() => {
        closeModal(modalSessao);
      }, 400);
    } catch (e) {
      console.error("delete_sessao_aluno error", e);
      msgSessao.textContent = "Erro inesperado ao apagar sess√£o.";
    } finally {
      btnDeleteSessao.disabled = false;
    }
  });

  // ------------------------------------------------------------------
  // RENDER CALEND√ÅRIO SEMANAL
  // ------------------------------------------------------------------
  function renderCalendarioSemanal() {
    const grid = document.getElementById("calendar-grid");
    const label = document.getElementById("week-label");
    if (!grid || !label) return;

    const hoje = new Date();
    const inicio = getInicioSemana(hoje);
    inicio.setDate(inicio.getDate() + semanaOffset * 7);

    const dias = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(inicio);
      d.setDate(inicio.getDate() + i);
      dias.push(d);
    }

    const fmt = { day: "2-digit", month: "2-digit" };
    label.textContent = `Semana ${dias[0].toLocaleDateString("pt-PT", fmt)} ‚Äì ${dias[6].toLocaleDateString("pt-PT", fmt)}`;

    const nomes = ["Seg", "Ter", "Qua", "Qui", "Sex", "S√°b", "Dom"];

    grid.innerHTML = dias.map((d, idx) => {
      const dataStr = d.toISOString().slice(0, 10);
      const sessoes = SESSOES_EXPLICADOR.filter(s => s.data === dataStr);

      const temRealizada = sessoes.some(s => s.estado === "REALIZADA");
      const temAgendada  = sessoes.some(s => s.estado === "AGENDADA");
      const temExtra     = sessoes.some(s => s.estado === "EXTRA");

      const dotsHTML = `
        ${temRealizada ? `<span class="dot dot-green"></span>` : ""}
        ${temAgendada  ? `<span class="dot dot-yellow"></span>` : ""}
        ${temExtra     ? `<span class="dot dot-orange"></span>` : ""}
      `.trim();

      const lista = sessoes.length === 0
        ? `<p class="calendar-empty">Sem sess√µes</p>`
        : sessoes.map(s => `
            <div class="calendar-session">
              <strong>${s.hora_inicio?.slice(0,5) || "--:--"}</strong>
              <span>${s.aluno_nome}</span>
            </div>
          `).join("");

      return `
        <div class="calendar-day">
          <div class="calendar-day__header">
            <span class="calendar-day__weekday">${nomes[idx]}</span>
            <span class="calendar-day__date">${d.toLocaleDateString("pt-PT", fmt)}</span>
          </div>

          <div class="calendar-day__dots">${dotsHTML}</div>
          <div class="calendar-day__list">${lista}</div>
        </div>
      `;
    }).join("");
  }

  function getBadgeInfoSessao(estadoRaw) {
  const e = (estadoRaw || "").toString().trim().toUpperCase();

    switch (e) {
      case "REALIZADA":
        return { label: "Realizada", className: "sessao-badge sessao-badge--realizada" };
      case "FALTOU":
        return { label: "Faltou", className: "sessao-badge sessao-badge--faltou" };
      case "CANCELADA":
        return { label: "Cancelada", className: "sessao-badge sessao-badge--cancelada" };
      case "EXTRA":
        return { label: "Extra", className: "sessao-badge sessao-badge--extra" };
      case "AGENDADA":
      default:
        return { label: "Agendada", className: "sessao-badge sessao-badge--agendada" };
    }
  }

  function renderProximasSessoes(sessoes) {
  const container = document.getElementById("calendar-proximas");
  if (!container) return;

  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);

  const proximas = (sessoes || [])
    .filter((s) => s.data)                            // tem data
    .map((s) => {
      const d = new Date(s.data);
      d.setHours(0, 0, 0, 0);
      return { ...s, _dataObj: d };
    })
    .filter((s) => s._dataObj >= hoje)                // de hoje para a frente
    .sort((a, b) => {
      if (a._dataObj - b._dataObj !== 0) {
        return a._dataObj - b._dataObj;
      }
      // ordenar tamb√©m por hora se existir
      const ha = a.hora_inicio || "";
      const hb = b.hora_inicio || "";
      return ha.localeCompare(hb);
    })
    .slice(0, 10);                                    // top 10 pr√≥ximas

  if (!proximas.length) {
    container.innerHTML =
      '<p class="calendar-empty">N√£o tens pr√≥ximas explica√ß√µes agendadas.</p>';
    return;
  }

  const fmtData = { day: "2-digit", month: "2-digit", year: "numeric" };

  container.innerHTML = proximas
    .map((s) => {
      const dataObj = s._dataObj;
      const dataLabel = dataObj.toLocaleDateString("pt-PT", fmtData);
      const hora = (s.hora_inicio || "").slice(0, 5) || "--:--";
      const dur = s.duracao_min != null ? `${s.duracao_min} min` : "";
      const aluno = s.aluno_nome || "Aluno";
      const local = s.local || ""; // se algum dia tiveres campo local

      const { label: badgeLabel, className: badgeClass } = getBadgeInfoSessao(s.estado);

      return `
        <article class="sessao-card">
          <header class="sessao-card__header">
            <div>
              <p class="sessao-card__aluno">${aluno}</p>
              <p class="sessao-card__meta">${dataLabel} ¬∑ ${hora}${dur ? " ¬∑ " + dur : ""}</p>
            </div>
            <span class="${badgeClass}">${badgeLabel}</span>
          </header>

          ${
            local
              ? `<p class="sessao-card__footer">${local}</p>`
              : ""
          }
        </article>
      `;
    })
    .join("");
}


  btnWeekPrev?.addEventListener('click', () => {
    semanaOffset -= 1;
    renderCalendarioSemanal();
    updateRelatorioKpis(); // volta a calcular, agora com SESSOES_EXPLICADOR preenchido
  });

  btnWeekNext?.addEventListener('click', () => {
    semanaOffset += 1;
    renderCalendarioSemanal();
  });

  // --------------------------------------------------------------------
  // CARREGAR RESUMO DE CALEND√ÅRIO
  // --------------------------------------------------------------------
  async function loadResumoCalendario() {
    const { data, error } = await callExplFn("list_sessoes_explicador", null);

    if (error) {
      console.error("Erro a carregar sess√µes do explicador", error);
      return;
    }

    const sessoes = data || [];
    SESSOES_EXPLICADOR = sessoes;

    // HOJE
    const hojeStr = new Date().toISOString().slice(0, 10);
    const sessoesHoje = sessoes.filter(s => s.data === hojeStr);

    let txtHoje = "Sem sess√µes registadas";
    if (sessoesHoje.length > 0) {
      const detalhes = sessoesHoje
        .map(s => `${s.hora_inicio?.slice(0, 5) || "--:--"} ${s.aluno_nome || ""}`.trim())
        .join(", ");

      txtHoje = `${sessoesHoje.length} sess√£o(√µes) hoje ¬∑ ${detalhes}`;
    }

    const elHoje = document.querySelector("#cal-resumo-hoje");
    if (elHoje) elHoje.textContent = txtHoje;

    // PR√ìXIMOS 7 DIAS
    const hojeDate = new Date();
    const seteDiasDepois = new Date();
    seteDiasDepois.setDate(hojeDate.getDate() + 7);

    const sessoesSemana = sessoes.filter(s => {
      const dataSess = new Date(s.data);
      dataSess.setHours(0, 0, 0, 0);
      return dataSess >= hojeDate && dataSess <= seteDiasDepois;
    });

    let txtSemana = "Agenda em branco por agora";
    if (sessoesSemana.length > 0) {
      const alunosUnicos = new Set(sessoesSemana.map(s => s.aluno_nome));
      txtSemana =
        `${sessoesSemana.length} sess√µes nos pr√≥ximos 7 dias ¬∑ ` +
        `${alunosUnicos.size} aluno(s) diferente(s)`;
    }

    const elSemana = document.querySelector("#cal-resumo-semana");
    if (elSemana) elSemana.textContent = txtSemana;

        // ----------------------------------------------------
    // PR√ìXIMAS EXPLICA√á√ïES (lista √† direita)
    // ----------------------------------------------------
    if (listaProximas) {
      // s√≥ sess√µes futuras ou de hoje com hora >= agora
      const agora = new Date();
      const futuras = (sessoes || [])
        .filter((s) => {
          if (!s.data) return false;
          const d = new Date(s.data);
          if (s.hora_inicio) {
            const [h, m] = s.hora_inicio.split(':').map(Number);
            d.setHours(h || 0, m || 0, 0, 0);
          }
          return d >= agora;
        })
        .sort((a, b) => {
          const da = new Date(a.data + 'T' + (a.hora_inicio || '00:00'));
          const db = new Date(b.data + 'T' + (b.hora_inicio || '00:00'));
          return da - db;
        })
        .slice(0, 10); // mostra no m√°ximo 10

      if (!futuras.length) {
        listaProximas.innerHTML =
          '<p class="expl-section-sub">N√£o tens pr√≥ximas explica√ß√µes agendadas.</p>';
      } else {
        listaProximas.innerHTML = futuras
          .map((s) => {
            const dataLabel = s.data
              ? new Date(s.data).toLocaleDateString('pt-PT', {
                  day: '2-digit',
                  month: '2-digit',
                  year: 'numeric'
                })
              : '‚Äî';

            const horaLabel = s.hora_inicio
              ? s.hora_inicio.slice(0, 5)
              : '--:--';

            const dur = s.duracao_min != null
              ? `${s.duracao_min} min`
              : '';

            const estado = s.estado || 'AGENDADA';
            const aluno  = s.aluno_nome || 'Aluno';

            return `
              <div class="calendar-proxima-card">
                <div class="calendar-proxima-main">
                  <p class="calendar-proxima-aluno">${aluno}</p>
                  <span class="calendar-proxima-badge">${estado}</span>
                </div>
                <p class="calendar-proxima-meta">
                  <span>${dataLabel}</span> ¬∑
                  <span>${horaLabel}</span>
                  ${dur ? ` ¬∑ <span>${dur}</span>` : ''}
                </p>
              </div>
            `;
          })
          .join('');
      }
    }

    // Finalmente, atualizar grelha semanal
    renderCalendarioSemanal();
    renderProximasSessoes(sessoes);
  }

  // estado inicial dos tabs
  ativarScreen('dashboard');
  (function () {
  const fab    = document.getElementById("fabNav");
  const toggle = document.getElementById("fabToggle");
  const itemsWrapper = document.getElementById("fabItems");
  const items  = Array.from(document.querySelectorAll(".fab-item"));

  // raio do arco
  const RADIUS_DESKTOP = 160;
  const RADIUS_MOBILE  = 135;

  // dist√¢ncia das labels para fora do arco (se as estiveres a usar)
  const LABEL_OFFSET = 70;

  function getRadius() {
    return window.innerWidth < 640 ? RADIUS_MOBILE : RADIUS_DESKTOP;
  }

  function positionItems() {
    const total  = items.length;
    if (!total) return;

    const radius = getRadius();

    // CANTO INFERIOR ESQUERDO:
    // centro do arco a 315¬∫ (diagonal para cima/direita)
    // abertura de 90¬∫ -> de 270¬∫ (cima) at√© 360¬∫ (direita)
    const centerDeg = 315;
    const spreadDeg = 90;
    const startDeg  = centerDeg - spreadDeg / 2;
    const step      = total > 1 ? spreadDeg / (total - 1) : 0;

    items.forEach((btn, i) => {
      const angleDeg = startDeg + step * i;     // 270, 292.5, 315, 337.5, 360
      const angleRad = angleDeg * Math.PI / 180;

      const x = Math.cos(angleRad) * radius;
      const y = Math.sin(angleRad) * radius;

      // move o bot√£o
      btn.style.setProperty("--tx", x + "px");
      btn.style.setProperty("--ty", y + "px");

      // ---- LABELS (se estiveres a usar .fab-label com --lx/--ly) ----
      const len = Math.sqrt(x * x + y * y) || 1;
      const ux = x / len;
      const uy = y / len;

      const dx = ux * LABEL_OFFSET;
      const dy = uy * LABEL_OFFSET;

      const label = btn.querySelector(".fab-label");
      if (label) {
        label.style.setProperty("--lx", dx + "px");
        label.style.setProperty("--ly", dy + "px");
      }
    });
  }

  function openFab() {
    fab.classList.add("is-open");
    itemsWrapper.hidden = false;
    itemsWrapper.setAttribute("aria-hidden", "false");
    positionItems();
  }

  function closeFab() {
    fab.classList.remove("is-open");
    itemsWrapper.setAttribute("aria-hidden", "true");

    // volta tudo ao centro do bot√£o principal
    items.forEach(btn => {
      btn.style.setProperty("--tx", "0px");
      btn.style.setProperty("--ty", "0px");
      const label = btn.querySelector(".fab-label");
      if (label) {
        label.style.setProperty("--lx", "0px");
        label.style.setProperty("--ly", "0px");
      }
    });

    setTimeout(() => {
      itemsWrapper.hidden = true;
    }, 300); // espera a anima√ß√£o acabar
  }

  // toggle abre/fecha
  toggle.addEventListener("click", () => {
    if (fab.classList.contains("is-open")) {
      closeFab();
    } else {
      openFab();
    }
  });

  // clicar num item -> navega para a sec√ß√£o e fecha o menu
  items.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.target;
      const original = document.querySelector(
        '.expl-nav-btn[data-target="' + target + '"]'
      );
      if (original) original.click();
      closeFab();
    });
  });

  // se redimensionar o ecr√£ com o menu aberto, recalcula posi√ß√µes
  window.addEventListener("resize", () => {
    if (fab.classList.contains("is-open")) {
      positionItems();
    }
  });

    function closeFab() {
    const itemsWrapper = document.getElementById("fabItems");
    items.forEach(btn => {
      btn.style.setProperty('--tx', '0px');
      btn.style.setProperty('--ty', '0px');

      const label = btn.querySelector('.fab-label');
      if (label) {
        label.style.setProperty('--lx', '0px');
        label.style.setProperty('--ly', '0px');
      }
    });
    fab.classList.remove("is-open");
    itemsWrapper.setAttribute("aria-hidden", "true");
    setTimeout(() => { itemsWrapper.hidden = true; }, 300);
  }


  // cada item navega para a sec√ß√£o e fecha o menu
  items.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.target;
      const original = document.querySelector(
        `.expl-nav-btn[data-target="${target}"]`
      );
      if (original) original.click();
      closeFab();
    });
  });

    // Disponibilizar no global para o HTML
  window.ativarScreen = ativarScreen;
  window.voltarParaAlunos = function () {
    ativarScreen("alunos");
  };

  window.showPerfilTab = function (tab) {
    const sec = document.getElementById("expl-sec-aluno-perfil");
    if (!sec) return;

    sec.querySelectorAll(".tab").forEach((btn) => {
      btn.classList.toggle("active", btn.dataset.tab === tab);
    });

    sec.querySelectorAll(".tab-content").forEach((div) => {
      div.classList.toggle("active", div.id === `tab-${tab}`);
    });
  };

})();
  
// Listener global para todos os sinos da p√°gina (dashboard + lista)
  document.addEventListener("click", async (ev) => {
    const btn = ev.target.closest(".aluno-card__bell");
    if (!btn) return;

    const idAluno =
      btn.dataset.idAluno || btn.getAttribute("data-id-aluno");
    if (!idAluno) return;

    const aluno = (ALUNOS_CACHE || []).find(
      (x) => String(x.id_aluno) === String(idAluno)
    );
    if (!aluno) return;

    const avisadoAtual = !!aluno.mensalidade_avisada;
    const novoEstado = !avisadoAtual;

    // feedback visual imediato (optimista)
    const svg = btn.querySelector("svg");
    if (svg) {
      svg.classList.toggle("aluno-bell-icon--active", novoEstado);
    }
    btn.dataset.avisado = String(novoEstado);
    btn.setAttribute("aria-pressed", novoEstado ? "true" : "false");

    try {
      const { error } = await callExplFn("set_mensalidade_avisada", {
        aluno_id: aluno.id_aluno,   // ‚ö†Ô∏è o backend espera "aluno_id"
        avisado: novoEstado,
      });

      if (error) {
        console.error("Erro ao atualizar aviso:", error);

        // reverte se falhar
        aluno.mensalidade_avisada = avisadoAtual;
        if (svg) {
          svg.classList.toggle("aluno-bell-icon--active", avisadoAtual);
        }
        btn.dataset.avisado = String(avisadoAtual);
        btn.setAttribute("aria-pressed", avisadoAtual ? "true" : "false");
        alert("N√£o foi poss√≠vel atualizar o estado de aviso.");
        return;
      }

      aluno.mensalidade_avisada = novoEstado;
    } catch (e) {
      console.error("Erro inesperado ao atualizar aviso:", e);
    }
  });
</script>


</body>
</html>