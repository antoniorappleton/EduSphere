<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#b91c1c">
  <link rel="icon" type="image/png" href="./public/img/icon-192.png" />
  
  <title>EduSphere â€” Explicador</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
</head>

<body class="home">
<header>
  <div class="header-inner">
    <a class="logo" href="./index.html">
      <img src="./public/img/imagens/logo-icon192.png" alt="EduSphere">
      <span>EduSphere</span>
    </a>
    <button id="btnLogout" class="button" style="margin-left:auto; display:none">Sair</button>
  </div>
</header>

<div class="capa__overlay"></div>

<main class="auth">

  <!-- ========== LOGIN DO EXPLICADOR ========== -->
  <section class="auth__panel" id="explLogin">
    <h1>Entrar (Explicador)</h1>
    <p class="auth__hint">Use as credenciais de professor para aceder ao painel.</p>
    <form id="fExplLogin" class="auth__form" autocomplete="on">
      <input type="email"   name="email"    placeholder="Email"    required />
      <input type="password" name="password" placeholder="Password" required />
      <button class="button" type="submit">Entrar</button>
      <div id="msgExplLogin" class="auth__msg"></div>
    </form>
  </section>

  <!-- ========== PAINEL DO EXPLICADOR (FULL PAGE) ========== -->
  <section id="explPanel" class="expl-shell" style="display:none">
    <!-- NAV LATERAL PRINCIPAL -->
    <nav id="explSidebarNav" class="expl-sidebar-nav" style="display:none">
      <button class="expl-nav-btn expl-nav-btn--active" data-target="dashboard">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <rect x="4" y="4" width="7" height="7" rx="1.5" />
            <rect x="13" y="4" width="7" height="7" rx="1.5" />
            <rect x="4" y="13" width="7" height="7" rx="1.5" />
            <rect x="13" y="13" width="7" height="7" rx="1.5" />
          </svg>
        </span>
        <span class="expl-nav-label">Dashboard</span>
      </button>

      <button class="expl-nav-btn" data-target="alunos">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="9" r="3.2" />
            <path d="M6.5 19.5c1.2-2.3 3-3.6 5.5-3.6s4.3 1.3 5.5 3.6" />
          </svg>
        </span>
        <span class="expl-nav-label">Alunos</span>
      </button>

      <button class="expl-nav-btn" data-target="calendario">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <rect x="4" y="5.5" width="16" height="14" rx="2" />
            <path d="M4 10h16" />
            <path d="M9 4v3" />
            <path d="M15 4v3" />
          </svg>
        </span>
        <span class="expl-nav-label">CalendÃ¡rio</span>
      </button>

      <button class="expl-nav-btn" data-target="faturacao">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M15.5 7.5c-1-.7-2.1-1.1-3.4-1.1-2.6 0-4.6 1.8-4.6 4.6s2 4.6 4.6 4.6c1.3 0 2.4-.4 3.4-1.1" />
            <path d="M11 5v14" />
          </svg>
        </span>
        <span class="expl-nav-label">FaturaÃ§Ã£o</span>
      </button>

      <button class="expl-nav-btn" data-target="relatorios">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 18.5h16" />
            <path d="M6.5 15l3.2-4 3.2 2.7 4.1-5.2" />
            <path d="M16.8 8.5h3v3" />
          </svg>
        </span>
        <span class="expl-nav-label">RelatÃ³rios</span>
      </button>
    </nav>

    <!-- CONTEÃšDO PRINCIPAL -->
    <div class="expl-main">
      <!-- Top bar -->
      <header class="expl-header-bar">
        <div class="expl-header-info">
          <h1 class="expl-page-title">Dashboard</h1>
          <p class="expl-hello-sub">
            Bem-vindo, <span id="expl-nome-header">Professor</span>
          </p>
        </div>

        <div class="expl-header-user">
          <button class="expl-bell" aria-label="NotificaÃ§Ãµes">
            <span class="expl-bell-icon">ðŸ””</span>
            <span class="expl-bell-badge" id="expl-notif-count">0</span>
          </button>
          <div class="expl-header-avatar">
            <div class="expl-avatar-circle">E</div>
            <div class="expl-header-name">
              <p id="expl-nome-mini">Professor</p>
              <span>Explicador</span>
            </div>
          </div>
        </div>
      </header>

      <!-- ConteÃºdo scrollÃ¡vel -->
      <div class="expl-body">

        <!-- ========== DASHBOARD ========== -->
        <section class="expl-section" data-section="dashboard">
          <!-- RESUMO FINANCEIRO -->
          <h2 class="expl-section-title">Resumo financeiro</h2>

          <div class="expl-kpi-grid">
            <article class="expl-card expl-kpi-card">
              <p class="expl-kpi-label">FaturaÃ§Ã£o prevista (mÃªs atual)</p>
              <p class="expl-kpi-value" id="card-total-previsto">â€”</p>
            </article>

            <article class="expl-card expl-kpi-card">
              <p class="expl-kpi-label">FaturaÃ§Ã£o realizada (mÃªs atual)</p>
              <p class="expl-kpi-value expl-kpi-value--green" id="card-total-mes">â€”</p>
            </article>

            <article class="expl-card expl-kpi-card">
              <p class="expl-kpi-label">Pagamentos pendentes</p>
              <p class="expl-kpi-value expl-kpi-value--red" id="card-pendentes">â€”</p>
            </article>
          </div>

          <!-- ALUNOS (CARDS DE RESUMO) -->
          <div class="expl-section-header" style="margin-top:2rem;">
            <h2 class="expl-section-title">
              Alunos <span class="expl-section-sub" id="dash-alunos-contador">(0 ativos)</span>
            </h2>
            <button class="expl-link-button" type="button" id="btn-dashboard-ver-alunos">
              Ver todos &rarr;
            </button>
          </div>

          <div class="dash-alunos-grid" id="dash-alunos-grid">
            <!-- cartÃµes preenchidos por JS -->
          </div>
        </section>

        <!-- ========== ALUNOS (DETALHE) ========== -->
        <section class="expl-section" id="expl-sec-alunos" data-section="alunos">
          <div class="expl-section-header">
            <h2 class="expl-section-title">
              Alunos <span class="expl-section-sub">(ativos)</span>
            </h2>
            <button class="expl-link-button" type="button" id="btn-scroll-lista">
              Ver lista &rarr;
            </button>
          </div>
          <div class="expl-grid-2">

            <!-- =======================
                CARTÃƒO: QUOTA + AÃ‡Ã•ES
                ======================= -->
            <div class="expl-card">
              <h3 class="expl-subsection-title">Quota de alunos</h3>

              <div class="expl-quota">
                <p><strong>Limite:</strong> <span id="limite">â€”</span></p>
                <p><strong>Ativos:</strong> <span id="contagem">0</span></p>
                <p><strong>Restantes:</strong> <span id="restantes">â€”</span></p>
              </div>

              <h3 class="expl-subsection-title" style="margin-top:1rem;">AÃ§Ãµes rÃ¡pidas</h3>
              <div class="expl-actions-row">
                <button class="button secondary" id="btn-open-add-aluno">
                  + Adicionar aluno
                </button>
              </div>
            </div>

            <!-- =======================
                CARTÃƒO: LISTA DE ALUNOS
                ======================= -->
            <div class="expl-card" id="lista-alunos-card">

              <h3 class="expl-subsection-title">Lista de alunos</h3>

              <!-- CONTAINER FIXO COM SCROLL VERTICAL -->
              <div class="expl-scroll-card">

                <!-- scroll horizontal apenas da tabela -->
                <div class="table-wrapper">
                  <table class="table" id="tblAlunos">
                    <thead>
                      <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Ano</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>

              </div>
            </div>

          </div>
          <!-- Painel de detalhes do aluno -->
          <div class="expl-card expl-aluno-detail" id="aluno-detail-card" style="margin-top:1.5rem; display:none">

            <h3 class="expl-subsection-title">
              Detalhes do aluno:
              <span id="aluno-detail-nome" class="expl-aluno-detail__nome">â€”</span>
            </h3>

            <p id="aluno-detail-meta" class="expl-aluno-detail__meta"></p>

            <div class="aluno-status-row">
              <span id="aluno-status-badge" class="aluno-status-badge aluno-status-badge--ativo">
                Ativo
              </span>

              <button type="button" id="toggle-aluno-ativo" class="aluno-status-toggle" aria-pressed="true">
                <span class="aluno-status-toggle__label">Aluno ativo</span>
                <span class="aluno-status-toggle__switch">
                  <span class="aluno-status-toggle__knob"></span>
                </span>
              </button>
            </div>

            <div class="expl-grid-2">

              <!-- InformaÃ§Ã£o bÃ¡sica -->
              <div>
                <h4 class="expl-subsection-title">InformaÃ§Ã£o bÃ¡sica</h4>

                <ul class="expl-detail-list">
                  <li><strong>Email:</strong> <span id="aluno-detail-email">â€”</span></li>
                  <li><strong>TelemÃ³vel:</strong> <span id="aluno-detail-tel">â€”</span></li>
                  <li><strong>Ano:</strong> <span id="aluno-detail-ano">â€”</span></li>
                  <li><strong>Valor explicaÃ§Ã£o:</strong> <span id="aluno-detail-valor">â€”</span></li>
                  <li><strong>SessÃµes / mÃªs:</strong> <span id="aluno-detail-sessoes">â€”</span></li>
                </ul>

                <div class="expl-actions-row" style="margin-top:1rem;">
                  <button class="button secondary" id="btn-iniciar-faturacao">Iniciar faturaÃ§Ã£o</button>
                  <button class="button secondary" id="btn-registar-pagamento">Registar pagamento</button>
                  <button class="button secondary" id="btn-editar-pagamento">Editar pagamento</button>
                  <button class="button" id="btn-editar-aluno">Editar aluno</button>
                </div>
              </div>

              <!-- Resumo de mensalidades -->
              <div>
                <h4 class="expl-subsection-title">Resumo de mensalidades</h4>

                <ul class="expl-detail-list">
                  <li>
                    <strong>Valor previsto (mÃªs atual):</strong>
                    <span id="aluno-detail-previsto-mes">â€”</span>
                  </li>

                  <li>
                    <strong>Valor pago (mÃªs atual):</strong>
                    <span id="aluno-detail-pago-mes">â€”</span>
                  </li>

                  <li>
                    <strong>Em falta (total):</strong>
                    <span id="aluno-detail-emfalta">â€”</span>
                  </li>
                </ul>
              </div>

            </div>

            <!-- HistÃ³rico de pagamentos (Fora das UL para nÃ£o quebrar layout) -->
            <div class="expl-subsection" style="margin-top:1.5rem;">
              <h4 class="expl-subsection-title">HistÃ³rico de pagamentos</h4>

              <div class="table-wrapper">
                <table class="table" id="tblPagamentosAluno">
                  <thead>
                    <tr>
                      <th>Ano</th>
                      <th>MÃªs</th>
                      <th>Previsto (â‚¬)</th>
                      <th>Pago (â‚¬)</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="5">Ainda nÃ£o existem pagamentos registados para este aluno.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- SessÃµes do aluno -->
            <div class="expl-subsection" style="margin-top:1.5rem;">
              <div class="expl-section-header" style="margin-bottom:0.5rem;">
                <h4 class="expl-subsection-title">SessÃµes de explicaÃ§Ã£o</h4>
                <button class="button secondary" id="btn-add-sessao">+ Adicionar sessÃ£o</button>
              </div>

              <div class="table-wrapper">
                <table class="table" id="tblSessoesAluno">
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>InÃ­cio</th>
                      <th>Fim</th>
                      <th>DuraÃ§Ã£o (min)</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="5">Ainda nÃ£o existem sessÃµes registadas para este aluno.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </section>

        <!-- ========== FATURAÃ‡ÃƒO (RESUMO MENSALIDADES) ========== -->
        <section class="expl-section" data-section="faturacao">
                <div class="expl-filter-row">
                  <div>
                    <h2 class="expl-section-title">FaturaÃ§Ã£o</h2>
                    <p class="expl-section-sub">
                      Consulta mensalidades pagas e em falta por mÃªs/ano.
                    </p>
                  </div>

                  <div class="expl-filter-controls">
                    <label class="expl-filter-field">
                      <span>MÃªs</span>
                      <select id="fat-filtro-mes">
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">MarÃ§o</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                      </select>
                    </label>

                    <label class="expl-filter-field">
                      <span>Ano</span>
                      <select id="fat-filtro-ano">
                        <!-- JS preenche automaticamente com os anos existentes -->
                      </select>
                    </label>
                  </div>
                </div>
          <div class="expl-grid-2" style="margin-top:1.5rem;">
            <article class="expl-card">
              <h3 class="expl-subsection-title">
                Mensalidades em falta (mÃªs atual)
              </h3>
              <div class="table-wrapper">
                <table class="table table--wide" id="tblMensalidadesPendentes">
                  <thead>
                    <tr>
                      <th>Aluno</th>
                      <th>MÃªs</th>
                      <th>Previsto (â‚¬)</th>
                      <th>Pago (â‚¬)</th>
                      <th>Em falta (â‚¬)</th>
                      <th>Estado</th>
                      <th>Avisado</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="7">Ainda nÃ£o existem mensalidades em falta neste mÃªs.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </article>

            <article class="expl-card">
              <h3 class="expl-subsection-title">
                Mensalidades pagas (mÃªs atual)
              </h3>
              <div class="table-wrapper">
                <table class="table table--wide" id="tblMensalidadesPagas">
                  <thead>
                    <tr>
                      <th>Aluno</th>
                      <th>MÃªs</th>
                      <th>Pago (â‚¬)</th>
                      <th>Previsto (â‚¬)</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="5">Ainda nÃ£o existem mensalidades pagas neste mÃªs.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </article>
          </div>
        </section>

        <!-- ========== CALENDÃRIO ========== -->
        <section class="expl-section" id="expl-sec-calendario" data-section="calendario">
          <div class="expl-section-header">
            <div>
              <h2 class="expl-section-title">CalendÃ¡rio</h2>
              <p class="expl-section-sub">Gerir explicaÃ§Ãµes e horÃ¡rios.</p>
            </div>

            <button type="button" class="button secondary" id="btn-agendar-explicacao">
              Agendar explicaÃ§Ã£o
            </button>
          </div>

          <div class="expl-grid-2" style="margin-top:1.5rem;">
            <!-- CartÃ£o: CalendÃ¡rio semanal -->
            <article class="expl-card">
              <h3 class="expl-subsection-title">CalendÃ¡rio semanal</h3>
              <p class="expl-section-sub">
                VÃª, por semana, em que dias tens explicaÃ§Ãµes e o estado de cada sessÃ£o.
              </p>

              <!-- Legenda dos estados -->
              <div class="calendar-legend">
                <span><span class="dot dot-yellow"></span> Agendada</span>
                <span><span class="dot dot-green"></span> Realizada</span>
                <span><span class="dot dot-orange"></span> Extra / outro</span>
              </div>

              <div class="calendar-week" id="calendar-week">
                <header class="calendar-week__nav">
                  <button id="week-prev" class="calendar-btn" type="button">&#8592;</button>
                  <h3 id="week-label" class="calendar-week__title">Semana atual</h3>
                  <button id="week-next" class="calendar-btn" type="button">&#8594;</button>
                </header>

                <div class="calendar-week__grid" id="calendar-grid">
                  <!-- preenchido via JS -->
                </div>
              </div>
            </article>

            <!-- CartÃ£o: PrÃ³ximas explicaÃ§Ãµes -->
            <article class="expl-card">
              <h3 class="expl-subsection-title">PrÃ³ximas explicaÃ§Ãµes</h3>
              <p class="expl-section-sub">
                Lista das prÃ³ximas sessÃµes agendadas, por ordem cronolÃ³gica.
              </p>

              <div id="calendar-proximas" class="calendar-proximas">
                <!-- preenchido via JS -->
              </div>
            </article>
          </div>
        </section>

        <!-- ========== RELATÃ“RIOS ========== -->
        <section class="expl-section" id="expl-sec-relatorios" data-section="relatorios">
          <div class="rel-kpi-grid">
            <article class="rel-kpi-card">
              <p class="rel-kpi-label">Total de alunos</p>
              <p class="rel-kpi-value" id="rel-kpi-total-alunos">â€”</p>
              <p class="rel-kpi-sub" id="rel-kpi-total-alunos-sub">â€”</p>
            </article>

            <article class="rel-kpi-card">
              <p class="rel-kpi-label">FaturaÃ§Ã£o mÃ©dia</p>
              <p class="rel-kpi-value" id="rel-kpi-fat-media">â€”</p>
              <p class="rel-kpi-sub">Por mÃªs (ano atual)</p>
            </article>

            <article class="rel-kpi-card">
              <p class="rel-kpi-label">SessÃµes / mÃªs</p>
              <p class="rel-kpi-value" id="rel-kpi-sessoes-mes">â€”</p>
              <p class="rel-kpi-sub">MÃ©dia nos Ãºltimos 3 meses</p>
            </article>

            <article class="rel-kpi-card">
              <p class="rel-kpi-label">Crescimento</p>
              <p class="rel-kpi-value" id="rel-kpi-crescimento">â€”</p>
              <p class="rel-kpi-sub">vs mÃªs anterior</p>
            </article>
          </div>
          <article class="expl-card expl-placeholder-card">
            <h2 class="expl-section-title">RelatÃ³rios</h2>
            <p class="expl-section-sub">EstatÃ­sticas e anÃ¡lises da tua atividade.</p>

            <ul class="expl-feature-list">
              <li>
                <span class="expl-feature-label">Resumo mensal</span>
                <span class="expl-feature-value" id="rel-resumo-mensal">
                  Este mÃªs: â‚¬ 0.00 recebidos de â‚¬ 0.00 previstos Â· â‚¬ 0.00 em falta.
                </span>
              </li>
              <li>
                <span class="expl-feature-label">TendÃªncia anual</span>
                <span class="expl-feature-value" id="rel-tendencia-anual">
                  Ano atual: â‚¬ 0.00 faturados de â‚¬ 0.00 previstos.
                </span>
              </li>
              <li>
                <span class="expl-feature-label">Alunos ativos</span>
                <span class="expl-feature-value" id="rel-alunos-ativos">
                  Ainda nÃ£o tens alunos ativos registados.
                </span>
              </li>
            </ul>

            <button type="button" class="expl-link-chip">
              <span class="expl-link-chip-icon">ðŸ“ˆ</span>
              <span>Ver grÃ¡ficos e relatÃ³rios</span>
            </button>
          </article>
          <div class="relatorios-grid">
            <div class="rel-card">
              <h3 class="expl-subsection-title">Previsto vs Pago (mÃªs selecionado)</h3>
              <p class="expl-section-sub">
                Compara o total previsto, pago e em falta para o mÃªs escolhido na faturaÃ§Ã£o.
              </p>
              <div class="rel-chart-box">
                <canvas id="chart-previsto-pago"></canvas>
              </div>
            </div>

            <div class="rel-card">
              <h3 class="expl-subsection-title">Pagamentos por aluno (mÃªs selecionado)</h3>
              <p class="expl-section-sub">
                VÃª quanto cada aluno devia pagar e quanto jÃ¡ pagou nesse mÃªs.
              </p>
              <div class="rel-chart-box">
                <canvas id="chart-por-aluno"></canvas>
              </div>
            </div>

            <div class="rel-card">
              <h3 class="expl-subsection-title">EvoluÃ§Ã£o mensal (ano atual)</h3>
              <p class="expl-section-sub">
                Compara o total previsto e faturado em cada mÃªs do ano atual.
              </p>
              <div class="rel-chart-box">
                <canvas id="chart-evolucao-anual"></canvas>
              </div>
            </div>

          </div>
        </section>
      </div>
      <!-- FAB NAV FLUTUANTE -->
      <nav class="fab-nav" id="fabNav">
        <!-- BotÃ£o principal -->
        <button class="fab-nav__toggle" id="fabToggle" aria-label="Menu rÃ¡pido">
          <svg viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14"
                  stroke="white"
                  stroke-width="2.4"
                  fill="none"
                  stroke-linecap="round" />
          </svg>
        </button>

        <!-- Itens radiais -->
        <div id="fabItems" class="fab-nav__items" hidden aria-hidden="true">

          <!-- Dashboard -->
          <button class="fab-item" data-target="dashboard" aria-label="Dashboard">
            <svg class="fab-icon" viewBox="0 0 24 24" aria-hidden="true">
              <rect x="4"  y="4"  width="7" height="7" rx="1.5" />
              <rect x="13" y="4"  width="7" height="7" rx="1.5" />
              <rect x="4"  y="13" width="7" height="7" rx="1.5" />
              <rect x="13" y="13" width="7" height="7" rx="1.5" />
            </svg>
            <span class="fab-label">Dashboard</span>
          </button>

          <!-- Alunos -->
          <button class="fab-item" data-target="alunos" aria-label="Alunos">
            <svg class="fab-icon" viewBox="0 0 24 24" aria-hidden="true">
              <circle cx="12" cy="9" r="3.2" />
              <path d="M6.5 19.5c1.2-2.3 3-3.6 5.5-3.6s4.3 1.3 5.5 3.6" />
            </svg>
            <span class="fab-label">Alunos</span>
          </button>

          <!-- CalendÃ¡rio -->
          <button class="fab-item" data-target="calendario" aria-label="CalendÃ¡rio">
            <svg class="fab-icon" viewBox="0 0 24 24" aria-hidden="true">
              <rect x="4" y="5.5" width="16" height="14" rx="2" />
              <path d="M4 10h16" />
              <path d="M9 4v3" />
              <path d="M15 4v3" />
            </svg>
            <span class="fab-label">CalendÃ¡rio</span>
          </button>

          <!-- FaturaÃ§Ã£o -->
          <button class="fab-item" data-target="faturacao" aria-label="FaturaÃ§Ã£o">
            <svg class="fab-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M15.5 7.5c-1-.7-2.1-1.1-3.4-1.1-2.6 0-4.6 1.8-4.6 4.6s2 4.6 4.6 4.6c1.3 0 2.4-.4 3.4-1.1" />
              <path d="M11 5v14" />
            </svg>
            <span class="fab-label">FaturaÃ§Ã£o</span>
          </button>

          <!-- RelatÃ³rios -->
          <button class="fab-item" data-target="relatorios" aria-label="RelatÃ³rios">
            <svg class="fab-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M4 18.5h16" />
              <path d="M6.5 15l3.2-4 3.2 2.7 4.1-5.2" />
              <path d="M16.8 8.5h3v3" />
            </svg>
            <span class="fab-label">RelatÃ³rios</span>
          </button>

        </div>
      </nav>
    </div>
  </section>

</main>

<!-- ========== MODAIS ========== -->

<!-- ADICIONAR ALUNO -->
<div class="modal" id="modal-add-aluno">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2>Novo aluno</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint">Preencha os dados do aluno para criar a conta de acesso.</p>
    <form id="fNewAluno" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input name="nome" placeholder="Nome do aluno" required />
        <input name="apelido" placeholder="Apelido (opcional)" />
        <input name="telemovel" placeholder="TelemÃ³vel (opcional)" />
        <input type="number" name="ano" placeholder="Ano de escolaridade" />
        <input type="number" name="idade" placeholder="Idade (opcional)" />
        <input name="dia_semana_preferido" placeholder="Dia preferido (ex.: Segunda)" />
        <input type="time" name="hora_preferida" placeholder="Hora da sessÃ£o" />
        <input type="number" step="0.01" name="valor_explicacao" placeholder="Valor por explicaÃ§Ã£o (â‚¬)" />
        <input type="number" name="sessoes_mes" placeholder="SessÃµes por mÃªs" />
        <input name="nome_pai_cache" placeholder="Nome do encarregado de educaÃ§Ã£o" />
        <input name="contacto_pai_cache" placeholder="Contacto do encarregado" />
        <input type="email" name="email" placeholder="Email (login do aluno)" required />
        <input name="username" placeholder="Username (opcional)" />
        <input type="password" name="password" placeholder="Password" minlength="6" required />
      </div>

      <button id="btnCreateAluno" class="button" type="submit">Criar Aluno</button>
      <div id="msgNewAluno" class="auth__msg"></div>
    </form>
  </div>
</div>

<!-- EDITAR ALUNO -->
<div class="modal" id="modal-edit-aluno">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2>Editar aluno</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint">Atualize os dados do aluno.</p>
    <form id="fEditAluno" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input name="nome_edit" placeholder="Nome do aluno" required />
        <input name="apelido_edit" placeholder="Apelido (opcional)" />
        <input name="telemovel_edit" placeholder="TelemÃ³vel (opcional)" />
        <input type="number" name="ano_edit" placeholder="Ano de escolaridade" />
        <input type="number" name="idade_edit" placeholder="Idade (opcional)" />
        <input name="dia_semana_preferido_edit" placeholder="Dia preferido (ex.: Segunda)" />
        <input type="time" name="hora_preferida" placeholder="Hora da sessÃ£o" />
        <input type="number" step="0.01" name="valor_explicacao_edit" placeholder="Valor por explicaÃ§Ã£o (â‚¬)" />
        <input type="number" name="sessoes_mes_edit" placeholder="SessÃµes por mÃªs" />
        <input name="nome_pai_cache_edit" placeholder="Nome do encarregado de educaÃ§Ã£o" />
        <input name="contacto_pai_cache_edit" placeholder="Contacto do encarregado" />
        <input type="email" name="email_edit" placeholder="Email (login do aluno)" required />
        <input name="username_edit" placeholder="Username (opcional)" />
        <input type="password" name="password_edit" placeholder="Nova password (opcional)" minlength="6" />
      </div>

      <button id="btnSaveEditAluno" class="button" type="submit">Guardar alteraÃ§Ãµes</button>
      <div id="msgEditAluno" class="auth__msg"></div>
    </form>
  </div>
</div>

<!-- SESSÃƒO (ADICIONAR / EDITAR) -->
<div class="modal" id="modal-sessao">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2>SessÃ£o de explicaÃ§Ã£o</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint">Registe ou edite uma sessÃ£o deste aluno.</p>
    <form id="fSessao" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input type="date" name="data_sessao" placeholder="Data" required />
        <input type="time" name="hora_inicio" placeholder="Hora inÃ­cio (opcional)" />
        <input type="time" name="hora_fim" placeholder="Hora fim (opcional)" />
        <input type="number" name="duracao_min" placeholder="DuraÃ§Ã£o (min, opcional)" />
        <select name="estado">
          <option value="AGENDADA">Agendada</option>
          <option value="REALIZADA">Realizada</option>
          <option value="FALTOU">Faltou</option>
          <option value="CANCELADA">Cancelada</option>
        </select>
        <input name="observacoes" placeholder="ObservaÃ§Ãµes (opcional)" />
      </div>

      <div class="expl-actions-row" style="margin-top:0.75rem;">
        <button id="btnSaveSessao" class="button" type="submit">Guardar sessÃ£o</button>
        <button id="btnDeleteSessao" class="button secondary" type="button" style="display:none;">
          Apagar sessÃ£o
        </button>
      </div>

      <div id="msgSessao" class="auth__msg"></div>
    </form>
  </div>
</div>

<!-- PAGAMENTO ALUNO -->
<div class="modal" id="modal-pagamento-aluno">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2 id="pag-modal-title">Registar pagamento</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint" id="pag-modal-hint">
      Preencha os dados do pagamento deste aluno.
    </p>

    <form id="fPagamentoAluno" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input type="number" name="ano" placeholder="Ano" required />
        <input type="number" name="mes" placeholder="MÃªs (1-12)" min="1" max="12" required />

        <input
          type="number"
          name="dia_pagamento"
          placeholder="Dia de pagamento (1-31)"
          min="1"
          max="31"
          style="display:none;"
        />

        <input
          type="number"
          step="0.01"
          name="valor"
          placeholder="Valor (â‚¬)"
          style="display:none;"
        />
      </div>

      <input type="hidden" name="modo" value="registar" />

      <button id="btnSavePagamento" class="button" type="submit">
        Guardar
      </button>
      <div id="msgPagamentoAluno" class="auth__msg"></div>
    </form>
  </div>
</div>

<footer>Â© <span id="y"></span> EduSphere</footer>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // ---------- helper DOM ----------
  const $ = (s) => document.querySelector(s);

  // -------- Helper para chamar a Edge Function expl-alunos com token --------
  async function callExplFn(action, payload = null) {
    const { data: { session } } = await supabase.auth.getSession();
    const accessToken = session?.access_token;

    if (!accessToken) {
      return {
        data: null,
        error: { message: 'Sem sessÃ£o vÃ¡lida (faz login primeiro).', status: 401 },
      };
    }

    return supabase.functions.invoke("expl-alunos", {
      body: { action, payload },
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
    });
  }

  let chartEvolucaoAnual = null;   // <-- novo
  let chartPrevistoPago = null;
  let chartPagamentosPorAluno = null;
  let SESSOES_EXPLICADOR = [];
  let semanaOffset = 0; // 0 = semana atual, -1 = anterior, +1 = prÃ³xima

  const weekLabel   = document.querySelector('#week-label');
  const btnWeekPrev = document.querySelector('#week-prev');
  const btnWeekNext = document.querySelector('#week-next');
  const btnAgendarExplicacao = document.querySelector('#btn-agendar-explicacao');
  const listaProximas        = document.querySelector('#calendar-proximas');

  // Pagamento modal refs
  const modalPag        = $('#modal-pagamento-aluno');
  const formPag         = $('#fPagamentoAluno');
  const msgPag          = $('#msgPagamentoAluno');
  const btnSavePag      = $('#btnSavePagamento');
  const pagModalTitle   = $('#pag-modal-title');
  const pagModalHint    = $('#pag-modal-hint');
  const inputAno        = formPag ? formPag.ano : null;
  const inputMes        = formPag ? formPag.mes : null;
  const inputDiaPag     = formPag ? formPag.dia_pagamento : null;
  const inputValor      = formPag ? formPag.valor : null;

  const elYear      = $('#y');
  const btnLogout   = $('#btnLogout');
  const headerNav   = $('#explSidebarNav');
  const loginBox    = $('#explLogin');
  const panel       = $('#explPanel');
  const msgLogin    = $('#msgExplLogin');
  const formLogin   = $('#fExplLogin');

  const tblBody     = $('#tblAlunos tbody');
  const elLimite    = $('#limite');
  const elContagem  = $('#contagem');
  const elRestantes = $('#restantes');

  const elNomeHeader = $('#expl-nome-header');
  const elNomeMini   = $('#expl-nome-mini');

  const btnFab          = $('#btn-add-aluno');
  const btnOpenAddAluno = $('#btn-open-add-aluno');
  const btnScrollLista  = $('#btn-scroll-lista');

  const modalAddAluno   = $('#modal-add-aluno');
  const formNew         = $('#fNewAluno');
  const msgNewAluno     = $('#msgNewAluno');
  const btnCreate       = $('#btnCreateAluno');

  const modalEditAluno  = $('#modal-edit-aluno');
  const formEdit        = $('#fEditAluno');
  const msgEditAluno    = $('#msgEditAluno');
  const btnSaveEdit     = $('#btnSaveEditAluno');
  const btnEditarAluno  = $('#btn-editar-aluno');

  const alunoStatusBadge = $('#aluno-status-badge');
  const toggleAlunoAtivo = $('#toggle-aluno-ativo');

  const btnIniciarFat   = $('#btn-iniciar-faturacao');
  const btnRegistarPag  = $('#btn-registar-pagamento');
  const btnEditarPag    = $('#btn-editar-pagamento');

  const modalSessao     = $('#modal-sessao');
  const formSessao      = $('#fSessao');
  const msgSessao       = $('#msgSessao');
  const btnSaveSessao   = $('#btnSaveSessao');
  const btnDeleteSessao = $('#btnDeleteSessao');
  const btnAddSessao    = $('#btn-add-sessao');
  const tblSessoesBody  = $('#tblSessoesAluno tbody');

  const btnDashVerAlunos = $('#btn-dashboard-ver-alunos');
  const selFatMes  = document.getElementById("fat-filtro-mes");
  const selFatAno  = document.getElementById("fat-filtro-ano");

  elYear.textContent = new Date().getFullYear();
  
  let EXPLICADOR       = { userId: null, id_explicador: null, max: 0 };
  let ALUNOS_CACHE     = [];
  let PAGAMENTOS_CACHE = [];
  let ALUNO_ATUAL      = null;
  let SESSAO_ATUAL_ID  = null;
    // Filtros atuais da secÃ§Ã£o de faturaÃ§Ã£o
  let FAT_ANO_SELEC = null;
  let FAT_MES_SELEC = null;


  function getInicioSemana(date) {
    const d = new Date(date);
    const day = d.getDay(); // 0=Dom,1=Seg,...6=SÃ¡b
    const diff = (day + 6) % 7; // queremos comeÃ§ar em SEG
    d.setDate(d.getDate() - diff);
    d.setHours(0, 0, 0, 0);
    return d;
  }

  const NOMES_DIAS_CURTOS = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'SÃ¡b', 'Dom'];

  // ---------- helpers supabase ----------
  async function hasRole(uid, roleName) {
    const { data, error } = await supabase
      .from('app_users')
      .select('role')
      .eq('user_id', uid)
      .eq('role', roleName)
      .maybeSingle();
    if (error) {
      console.error('hasRole error', error);
      return false;
    }
    return !!data;
  }

  async function getExplRow(uid) {
    const { data, error } = await supabase
      .from('explicadores')
      .select('id_explicador, nome, apelido, max_alunos')
      .eq('user_id', uid)
      .maybeSingle();
    if (error) throw error;
    return data || null;
  }

  function setState({ loading = false, isExpl = false, isAuthed = false }) {
    if (loading) {
      loginBox.style.display = 'block';
      panel.style.display    = 'none';
      msgLogin.textContent   = 'A verificar sessÃ£o...';
      btnLogout.style.display = 'none';
      headerNav.style.display = 'none';
      return;
    }
    if (isAuthed && isExpl) {
      loginBox.style.display = 'none';
      panel.style.display    = 'flex';
      msgLogin.textContent   = '';
      btnLogout.style.display = 'inline-block';
      headerNav.style.display = 'flex';
      document.querySelector('main.auth').style.display = 'block';
    } else {
      loginBox.style.display = 'block';
      panel.style.display    = 'none';
      btnLogout.style.display = 'none';
      headerNav.style.display = 'none';
      document.querySelector('main.auth').style.display = 'grid';
    }
  }

  // ---------- QUOTA UI ----------
  function updateQuotaUI(total) {
    const max = Number(EXPLICADOR.max || 0);
    elContagem.textContent = String(total);

    if (!max) {
      elLimite.textContent    = 'Sem limite';
      elRestantes.textContent = 'â€”';
      btnCreate && (btnCreate.disabled = false);
      return;
    }

    elLimite.textContent = String(max);
    const rest = Math.max(0, max - total);
    elRestantes.textContent = String(rest);

    if (btnCreate) {
      btnCreate.disabled = rest <= 0;
      btnCreate.title    = rest <= 0 ? 'Limite de alunos atingido.' : '';
    }
  }

  // ---------- DASHBOARD: CARDS DE ALUNOS ----------
  function renderDashboardAlunos() {
    const grid = document.getElementById("dash-alunos-grid");
    const contador = document.getElementById("dash-alunos-contador");
    if (!grid) return;

    const alunosAtivos = (ALUNOS_CACHE || []).filter(a => a.is_active !== false);
    const totalAtivos = alunosAtivos.length;

    if (contador) {
      contador.textContent =
        totalAtivos === 1 ? "(1 ativo)" : `(${totalAtivos} ativos)`;
    }

    if (!totalAtivos) {
      grid.innerHTML =
        '<p class="expl-section-sub">Ainda nÃ£o tens alunos ativos registados.</p>';
      return;
    }

    // sÃ³ mostramos atÃ© 3, como no mock
    const top3 = alunosAtivos.slice(0, 3);

    // helper para mapear estado â†’ label + classe de badge
    function getEstadoInfo(rawEstado) {
      const e = (rawEstado || "").toString().trim().toUpperCase();

      switch (e) {
        case "PAGO":
          return {
            label: "Pago",
            badgeClass:
              "dash-aluno-card__badge dash-aluno-card__badge--pago",
          };
        case "PARCIAL":
          return {
            label: "Parcial",
            badgeClass:
              "dash-aluno-card__badge dash-aluno-card__badge--parcial",
          };
        case "PENDENTE":
        default:
          return {
            label: e ? e.charAt(0) + e.slice(1).toLowerCase() : "Pendente",
            badgeClass:
              "dash-aluno-card__badge dash-aluno-card__badge--pendente",
          };
      }
    }

    grid.innerHTML = top3
      .map((a) => {
        const nome = [a.nome, a.apelido].filter(Boolean).join(" ") || "Aluno";
        const anoLabel = a.ano ? `${a.ano}Âº Ano` : "â€”";

        const proximaMensalidade = a.proxima_mensalidade || "â€”";
        const { label: estadoLabel, badgeClass } = getEstadoInfo(
          a.estado_mensalidade || "PENDENTE"
        );

        return `
          <article class="dash-aluno-card">
            <div>
              <div class="dash-aluno-card__top">
                <div class="dash-aluno-card__avatar"></div>
                <div>
                  <h3 class="dash-aluno-card__name">${nome}</h3>
                  <p class="dash-aluno-card__year">${anoLabel}</p>
                </div>
              </div>

              <p class="dash-aluno-card__label">PrÃ³xima mensalidade:</p>
              <p class="dash-aluno-card__date">${proximaMensalidade}</p>

              <span class="${badgeClass}">
                ${estadoLabel}
              </span>
            </div>

            <button
              type="button"
              class="button secondary dash-aluno-card__btn"
              data-id-aluno="${a.id_aluno}"
            >
              Ver detalhes
            </button>
          </article>
        `;
      })
      .join("");

    // clique em "Ver detalhes" -> vai para secÃ§Ã£o Alunos e abre o painel
    grid.querySelectorAll("[data-id-aluno]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const idAluno = btn.getAttribute("data-id-aluno");
        const aluno = ALUNOS_CACHE.find(
          (x) => String(x.id_aluno) === String(idAluno)
        );
        if (!aluno) return;

        const tabAlunos = document.querySelector(
          '.expl-nav-btn[data-target="alunos"]'
        );
        tabAlunos?.click();

        setTimeout(() => {
          mostrarPainelAluno(aluno);
        }, 150);
      });
    });
  }

  // ---------- STATUS ALUNO (Ativo / Bloqueado) ----------
  function updateAlunoStatusUI(aluno) {
    if (!aluno) return;

    const ativo = aluno.is_active !== false;

    if (alunoStatusBadge) {
      alunoStatusBadge.textContent = ativo ? 'Ativo' : 'Bloqueado';
      alunoStatusBadge.classList.toggle('aluno-status-badge--ativo', ativo);
      alunoStatusBadge.classList.toggle('aluno-status-badge--inativo', !ativo);
    }

    if (toggleAlunoAtivo) {
      toggleAlunoAtivo.classList.toggle('is-off', !ativo);
      toggleAlunoAtivo.setAttribute('aria-pressed', ativo ? 'true' : 'false');
    }
  }

  // ---------- LISTAR ALUNOS ----------
  async function loadAlunos() {
    const { data, error } = await callExplFn("list_alunos", null);

    if (error) {
      console.error("loadAlunos error", error);
      tblBody.innerHTML =
        '<tr><td colspan="3">Erro a carregar alunos.</td></tr>';
      ALUNOS_CACHE = [];
      updateQuotaUI(0);
      renderDashboardAlunos();
      return;
    }

    if (!data || !data.length) {
      tblBody.innerHTML =
        '<tr><td colspan="3">Sem alunos ainda.</td></tr>';
      ALUNOS_CACHE = [];
      updateQuotaUI(0);
      renderDashboardAlunos();
      return;
    }

    ALUNOS_CACHE = data;

    tblBody.innerHTML = data
      .map((a) => {
        const nome = [a.nome, a.apelido].filter(Boolean).join(" ");

        return `
          <tr class="linha-aluno" data-id-aluno="${a.id_aluno}">
            <td>${nome || "-"}</td>
            <td>${a.email ?? "-"}</td>
            <td>${a.ano ?? "-"}</td>
          </tr>
        `;
      })
      .join("");

    updateQuotaUI(data.length);
    renderDashboardAlunos();

    tblBody
      .querySelectorAll("tr.linha-aluno")
      .forEach((row) => {
        row.addEventListener("click", () => {
          const idAluno = row.dataset.idAluno;
          const aluno = ALUNOS_CACHE.find((a) => String(a.id_aluno) === String(idAluno));
          if (aluno) {
            mostrarPainelAluno(aluno);
          }
        });
      });
  }

  // Devolve { ano, mes, mesLabel } garantindo que escolhemos um mÃªs com dados
  function getMesAnoSelecionadosOuUltimoComDados() {
    const selMes = document.getElementById("fat-filtro-mes");
    const selAno = document.getElementById("fat-filtro-ano");
    const now = new Date();

    let ano = selAno && selAno.value ? Number(selAno.value) : null;
    let mes = selMes && selMes.value ? Number(selMes.value) : null;

    const temDadosPara = (a, m) =>
      (PAGAMENTOS_CACHE || []).some(
        (p) => p.ano === a && p.mes === m
      );

    // Se nÃ£o houver seleÃ§Ã£o OU nÃ£o houver dados para esse mÃªs/ano,
    // escolhemos o Ãºltimo mÃªs que tenha dados
    if (!ano || !mes || !temDadosPara(ano, mes)) {
      if (PAGAMENTOS_CACHE && PAGAMENTOS_CACHE.length) {
        const ultimo = PAGAMENTOS_CACHE.reduce((max, p) => {
          if (!max) return p;
          if (p.ano > max.ano) return p;
          if (p.ano === max.ano && p.mes > max.mes) return p;
          return max;
        }, null);
        ano = ultimo.ano;
        mes = ultimo.mes;
      } else {
        ano = now.getFullYear();
        mes = now.getMonth() + 1;
      }
    }

    // Sincronizar selects com esta escolha
    if (selAno) selAno.value = String(ano);
    if (selMes) selMes.value = String(mes);

    const nomesMeses = [
      "Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho",
      "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro",
    ];
    const mesLabel = nomesMeses[mes - 1] || String(mes);

    return { ano, mes, mesLabel };
  }

  // ---------- RESUMO MENSAL ----------
  function getDadosMesSelecionado() {
    const tbodyPend  = document.querySelector("#tblMensalidadesPendentes tbody");
    const tbodyPagas = document.querySelector("#tblMensalidadesPagas tbody");
    if (!tbodyPend || !tbodyPagas) return null;

    const { ano, mes, mesLabel } = getMesAnoSelecionadosOuUltimoComDados();

    const pendentes = [];
    const pagas     = [];

    let totalPrevistoPend  = 0;
    let totalFaltaPend     = 0;
    let totalPagoPagas     = 0;
    let totalPrevistoPagas = 0;

    (PAGAMENTOS_CACHE || []).forEach((p) => {
      // ignorar alunos bloqueados
      const alunoRef = (ALUNOS_CACHE || []).find(
        (a) => String(a.id_aluno) === String(p.id_aluno)
      );
      if (alunoRef && alunoRef.is_active === false) return;

      if (p.ano !== ano || p.mes !== mes) return;

      const previsto = Number(p.valor_previsto) || 0;
      const pago     = Number(p.valor_pago) || 0;
      const falta    = Math.max(previsto - pago, 0);

      if (previsto === 0 && pago === 0) return;

      const linha = {
        aluno:  p.aluno_nome || "Aluno",
        previsto,
        pago,
        falta,
        estado: p.estado || "",
        mes:    mesLabel,
        avisado:"â€”",
      };

      if (falta > 0) {
        pendentes.push(linha);
        totalPrevistoPend += previsto;
        totalFaltaPend    += falta;
      } else {
        pagas.push(linha);
        totalPagoPagas     += pago;
        totalPrevistoPagas += previsto;
      }
    });

    return {
      anoAtual: ano,
      mesAtual: mes,
      mesLabel,
      pendentes,
      pagas,
      totalPrevistoPend,
      totalFaltaPend,
      totalPagoPagas,
      totalPrevistoPagas,
    };
  }

  // ---------- RESUMO MENSAL (tabelas) ----------
  function renderResumoMensal() {
    const tbodyPend = document.querySelector("#tblMensalidadesPendentes tbody");
    const tbodyPagas = document.querySelector("#tblMensalidadesPagas tbody");

    if (!tbodyPend || !tbodyPagas) return;

    const dados = getDadosMesSelecionado();
    if (!dados) return;

    const {
      mesLabel,
      pendentes,
      pagas,
      totalPrevistoPend,
      totalFaltaPend,
      totalPagoPagas,
      totalPrevistoPagas,
    } = dados;

    // Pendentes
    if (!pendentes.length) {
      tbodyPend.innerHTML =
        '<tr><td colspan="7">Ainda nÃ£o existem mensalidades em falta neste mÃªs.</td></tr>';
    } else {
      const rowsPend = pendentes
        .map(
          (r) => `
        <tr>
          <td>${r.aluno}</td>
          <td>${r.mes}</td>
          <td>â‚¬ ${r.previsto.toFixed(2)}</td>
          <td>â‚¬ ${r.pago.toFixed(2)}</td>
          <td>â‚¬ ${r.falta.toFixed(2)}</td>
          <td>${r.estado}</td>
          <td>${r.avisado}</td>
        </tr>
      `
        )
        .join("");

      const totalRow = `
      <tr>
        <td><strong>Total</strong></td>
        <td>${mesLabel}</td>
        <td><strong>â‚¬ ${totalPrevistoPend.toFixed(2)}</strong></td>
        <td></td>
        <td><strong>â‚¬ ${totalFaltaPend.toFixed(2)}</strong></td>
        <td colspan="2"></td>
      </tr>
    `;

      tbodyPend.innerHTML = rowsPend + totalRow;
    }

    // Pagas
    if (!pagas.length) {
      tbodyPagas.innerHTML =
        '<tr><td colspan="5">Ainda nÃ£o existem mensalidades pagas neste mÃªs.</td></tr>';
    } else {
      const rowsPagas = pagas
        .map(
          (r) => `
        <tr>
          <td>${r.aluno}</td>
          <td>${r.mes}</td>
          <td>â‚¬ ${r.pago.toFixed(2)}</td>
          <td>â‚¬ ${r.previsto.toFixed(2)}</td>
          <td>${r.estado}</td>
        </tr>
      `
        )
        .join("");

      const totalRowPagas = `
      <tr>
        <td><strong>Total</strong></td>
        <td>${mesLabel}</td>
        <td><strong>â‚¬ ${totalPagoPagas.toFixed(2)}</strong></td>
        <td><strong>â‚¬ ${totalPrevistoPagas.toFixed(2)}</strong></td>
        <td></td>
      </tr>
    `;

      tbodyPagas.innerHTML = rowsPagas + totalRowPagas;
    }
  }

  function atualizarGraficosPagamentos() {
    const canvasResumo   = document.getElementById("chart-previsto-pago");
    const canvasPorAluno = document.getElementById("chart-por-aluno");

    if (!canvasResumo && !canvasPorAluno) return;

    const dados = getDadosMesSelecionado();
    if (!dados) return;

    const { mesLabel, pendentes, pagas } = dados;
    const todos = [...pendentes, ...pagas];

    const totalPrevisto = todos.reduce((acc, r) => acc + (r.previsto || 0), 0);
    const totalPago     = todos.reduce((acc, r) => acc + (r.pago || 0), 0);
    const totalFalta    = Math.max(totalPrevisto - totalPago, 0);

    // --- GrÃ¡fico 1: Previsto vs Pago vs Em falta ---
    if (chartPrevistoPago) {
      chartPrevistoPago.destroy();
    }
    if (canvasResumo) {
      const ctxResumo = canvasResumo.getContext("2d");
      chartPrevistoPago = new Chart(ctxResumo, {
        type: "bar",
        data: {
          labels: ["Previsto", "Pago", "Em falta"],
          datasets: [
            {
              label: mesLabel,
              data: [totalPrevisto, totalPago, totalFalta],
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,   // <â€“ importante com CSS que vamos pÃ´r
          plugins: {
            legend: { display: false },
          },
          scales: {
            y: { beginAtZero: true },
          },
        },
      });
    }

    // --- GrÃ¡fico 2: Pagamentos por aluno ---
    if (chartPagamentosPorAluno) {
      chartPagamentosPorAluno.destroy();
    }
    if (canvasPorAluno) {
      const ctxPorAluno = canvasPorAluno.getContext("2d");

      const porAluno = new Map();
      todos.forEach((r) => {
        const entry = porAluno.get(r.aluno) || { previsto: 0, pago: 0 };
        entry.previsto += r.previsto || 0;
        entry.pago     += r.pago || 0;
        porAluno.set(r.aluno, entry);
      });

      const labels = Array.from(porAluno.keys());
      const datasetPrevisto = labels.map((nome) => porAluno.get(nome).previsto);
      const datasetPago     = labels.map((nome) => porAluno.get(nome).pago);

      chartPagamentosPorAluno = new Chart(ctxPorAluno, {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Previsto", data: datasetPrevisto },
            { label: "Pago", data: datasetPago },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,   // idem
          scales: {
            y: { beginAtZero: true },
          },
        },
      });
    }
  }

  function atualizarGraficoEvolucaoAnual() {
    const canvas = document.getElementById("chart-evolucao-anual");
    if (!canvas) return;

    const ctx = canvas.getContext("2d");

    const now = new Date();
    const anoAtual = now.getFullYear();

    const nomesMesesCurtos = [
      "Jan","Fev","Mar","Abr","Mai","Jun",
      "Jul","Ago","Set","Out","Nov","Dez"
    ];

    const previstoPorMes = new Array(12).fill(0);
    const pagoPorMes     = new Array(12).fill(0);

    (PAGAMENTOS_CACHE || []).forEach((p) => {
      if (p.ano !== anoAtual) return;

      // ignorar alunos bloqueados
      const alunoRef = (ALUNOS_CACHE || []).find(
        (a) => String(a.id_aluno) === String(p.id_aluno)
      );
      if (alunoRef && alunoRef.is_active === false) return;

      const idxMes = (p.mes || 1) - 1;
      const previsto = Number(p.valor_previsto) || 0;
      const pago     = Number(p.valor_pago) || 0;

      previstoPorMes[idxMes] += previsto;
      pagoPorMes[idxMes]     += pago;
    });

    if (chartEvolucaoAnual) {
      chartEvolucaoAnual.destroy();
    }

    chartEvolucaoAnual = new Chart(ctx, {
      type: "line",
      data: {
        labels: nomesMesesCurtos,
        datasets: [
          {
            label: "Previsto",
            data: previstoPorMes,
          },
          {
            label: "Pago",
            data: pagoPorMes,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "top" },
        },
        scales: {
          y: { beginAtZero: true },
        },
      },
    });
  }


  // ---------- FATURAÃ‡ÃƒO: INICIAR FILTROS (MÃŠS/ANO) ----------
  function initFiltrosFaturacao() {
    if (!selFatMes || !selFatAno) return;

    const agora        = new Date();
    const anoSistema   = agora.getFullYear();
    const mesSistema   = agora.getMonth() + 1;

    // Se ainda nÃ£o houver seleÃ§Ã£o, usar mÃªs/ano atuais
    if (!FAT_ANO_SELEC) FAT_ANO_SELEC = anoSistema;
    if (!FAT_MES_SELEC) FAT_MES_SELEC = mesSistema;

    // Preencher lista de anos com base nos dados + ano atual
    if (!selFatAno.dataset.initialized) {
      const anos = new Set([anoSistema]);
      (PAGAMENTOS_CACHE || []).forEach((p) => {
        if (p.ano) anos.add(p.ano);
      });

      const anosOrdenados = Array.from(anos).sort((a, b) => a - b);
      selFatAno.innerHTML = anosOrdenados
        .map((a) => `<option value="${a}">${a}</option>`)
        .join("");

      selFatAno.dataset.initialized = "1";
    }

    // Sincronizar selects com o estado atual
    selFatMes.value = String(FAT_MES_SELEC);
    selFatAno.value = String(FAT_ANO_SELEC);

    // Listeners (sÃ³ ligamos uma vez)
    if (!selFatMes.dataset.bound) {
      selFatMes.addEventListener("change", () => {
        FAT_MES_SELEC = Number(selFatMes.value) || mesSistema;
        renderResumoMensal();
      });
      selFatMes.dataset.bound = "1";
    }

    if (!selFatAno.dataset.bound) {
      selFatAno.addEventListener("change", () => {
        FAT_ANO_SELEC = Number(selFatAno.value) || anoSistema;
        renderResumoMensal();
      });
      selFatAno.dataset.bound = "1";
    }
  }

  // ---------- RELATÃ“RIOS: RESUMOS NO CARTÃƒO ----------
  function updateResumoRelatorios({
    previstoMesAtual = 0,
    realizadoMesAtual = 0,
    pendenteTotal = 0,
    previstoAnoAtual = 0,
    realizadoAnoAtual = 0,
    nAlunosAtivos = 0,
  } = {}) {
    const elMensal   = document.querySelector('#rel-resumo-mensal');
    const elTend     = document.querySelector('#rel-tendencia-anual');
    const elAlunos   = document.querySelector('#rel-alunos-ativos');

    if (elMensal) {
      elMensal.textContent =
        `Este mÃªs: â‚¬ ${realizadoMesAtual.toFixed(2)} recebidos ` +
        `de â‚¬ ${previstoMesAtual.toFixed(2)} previstos Â· ` +
        `â‚¬ ${pendenteTotal.toFixed(2)} em falta.`;
    }

    if (elTend) {
      elTend.textContent =
        `Ano atual: â‚¬ ${realizadoAnoAtual.toFixed(2)} faturados ` +
        `de â‚¬ ${previstoAnoAtual.toFixed(2)} previstos.`;
    }

    if (elAlunos) {
      if (nAlunosAtivos <= 0) {
        elAlunos.textContent = "Ainda nÃ£o tens alunos ativos registados.";
      } else if (nAlunosAtivos === 1) {
        elAlunos.textContent = "A acompanhar 1 aluno ativo.";
      } else {
        elAlunos.textContent = `A acompanhar ${nAlunosAtivos} alunos ativos.`;
      }
    }
  }

  // ------- KPI's Report cartÃµes -----------
  function updateRelatorioKpis({
      previstoMesAtual = 0,
      realizadoMesAtual = 0,
      previstoAnoAtual = 0,
      realizadoAnoAtual = 0,
    } = {}) {
      // 1) Total de alunos
      const total = (ALUNOS_CACHE || []).length;
      const ativos = (ALUNOS_CACHE || []).filter(a => a.is_active !== false).length;

      const elTot = document.getElementById("rel-kpi-total-alunos");
      const elTotSub = document.getElementById("rel-kpi-total-alunos-sub");
      if (elTot) elTot.textContent = String(total);
      if (elTotSub) {
        elTotSub.textContent =
          ativos === 1 ? "1 ativo" : `${ativos} ativos`;
      }

      // 2) FaturaÃ§Ã£o mÃ©dia / mÃªs (ano atual)
      const hoje = new Date();
      const mesAtual = hoje.getMonth() + 1;
      const mesesConsiderados = Math.max(mesAtual, 1);
      const mediaMes = realizadoAnoAtual / mesesConsiderados;

      const elFatMed = document.getElementById("rel-kpi-fat-media");
      if (elFatMed) elFatMed.textContent = `â‚¬ ${mediaMes.toFixed(0)}/mÃªs`;

      // 3) Crescimento vs mÃªs anterior
      let realizadoMesAnterior = 0;
      const anoAtual = hoje.getFullYear();
      let mesAnterior = mesAtual - 1;
      let anoMesAnterior = anoAtual;

      if (mesAnterior < 1) {
        mesAnterior = 12;
        anoMesAnterior = anoAtual - 1;
      }

      (PAGAMENTOS_CACHE || []).forEach(p => {
        if (p.ano === anoMesAnterior && p.mes === mesAnterior) {
          realizadoMesAnterior += Number(p.valor_pago) || 0;
        }
      });

      let crescimentoTxt = "â€”";
      if (realizadoMesAnterior > 0) {
        const diff = realizadoMesAtual - realizadoMesAnterior;
        const perc = (diff / realizadoMesAnterior) * 100;
        const sinal = perc >= 0 ? "+" : "";
        crescimentoTxt = `${sinal}${perc.toFixed(1)}%`;
      }

      const elCresc = document.getElementById("rel-kpi-crescimento");
      if (elCresc) elCresc.textContent = crescimentoTxt;

      // 4) SessÃµes / mÃªs (mÃ©dia Ãºltimos 3 meses)
      const elSessoes = document.getElementById("rel-kpi-sessoes-mes");
      if (elSessoes) {
        if (!SESSOES_EXPLICADOR || !SESSOES_EXPLICADOR.length) {
          elSessoes.textContent = "â€”";
        } else {
          const hoje = new Date();
          const limite = new Date();
          limite.setMonth(hoje.getMonth() - 2); // Ãºltimos 3 meses

          let cont = 0;
          (SESSOES_EXPLICADOR || []).forEach(s => {
            if (!s.data) return;
            const d = new Date(s.data);
            if (d >= limite && d <= hoje) cont++;
          });

          const media3m = cont / 3;
          elSessoes.textContent = media3m.toFixed(1);
        }
      }
    }

  // ---------- KPI financeiros ----------
  async function loadKpisFinanceiros() {
    if (!EXPLICADOR.id_explicador) return;

    const cardTotalPrev = document.getElementById("card-total-previsto");
    const cardTotalMes  = document.getElementById("card-total-mes");
    const cardPendentes = document.getElementById("card-pendentes");

    try {
      const { data, error } = await supabase
        .from("v_pagamentos_detalhe")
        .select("ano, mes, id_aluno, aluno_nome, valor_previsto, valor_pago, estado")
        .eq("id_explicador", EXPLICADOR.id_explicador);

      if (error) {
        console.error("Erro a carregar KPI financeiros", error);
        return;
      }

      // cache global com todos os pagamentos
      PAGAMENTOS_CACHE = data || [];

      const now      = new Date();
      const anoAtual = now.getFullYear();
      const mesAtual = now.getMonth() + 1;

      let previstoMesAtual      = 0;
      let realizadoMesAtual     = 0;
      let previstoAnoAtual      = 0;
      let realizadoAnoAtual     = 0;
      let pendenteTotalMesAtual = 0;
      const alunosComPendencias = new Set();

      (PAGAMENTOS_CACHE || []).forEach((p) => {
        const previsto = Number(p.valor_previsto) || 0;
        const pago     = Number(p.valor_pago) || 0;
        const falta    = Math.max(previsto - pago, 0);

        // Ano inteiro
        if (p.ano === anoAtual) {
          previstoAnoAtual  += previsto;
          realizadoAnoAtual += pago;
        }

        // SÃ³ mÃªs atual (para os cards da dashboard)
        if (p.ano === anoAtual && p.mes === mesAtual) {
          previstoMesAtual      += previsto;
          realizadoMesAtual     += pago;
          pendenteTotalMesAtual += falta;

          if (falta > 0 && p.id_aluno) {
            alunosComPendencias.add(p.id_aluno);
          }
        }
      });

      // ---- Cards na dashboard ----
      if (cardTotalPrev) {
        cardTotalPrev.textContent = `â‚¬ ${previstoMesAtual.toFixed(2)}`;
      }

      if (cardTotalMes) {
        cardTotalMes.textContent =
          `â‚¬ ${realizadoMesAtual.toFixed(2)} de â‚¬ ${previstoMesAtual.toFixed(2)}`;
      }

      if (cardPendentes) {
        const nAlunosPend = alunosComPendencias.size;
        const labelAlunos =
          nAlunosPend === 0
            ? "Nenhum aluno em falta"
            : nAlunosPend === 1
            ? "1 aluno em falta"
            : `${nAlunosPend} alunos em falta`;

        cardPendentes.textContent =
          `â‚¬ ${pendenteTotalMesAtual.toFixed(2)} (${labelAlunos})`;
      }

      // ---- Resumo dos relatÃ³rios (texto) ----
      const nAlunosAtivos = (ALUNOS_CACHE || []).filter(a => a.is_active !== false).length;
      updateResumoRelatorios({
        previstoMesAtual,
        realizadoMesAtual,
        pendenteTotal: pendenteTotalMesAtual,
        previstoAnoAtual,
        realizadoAnoAtual,
        nAlunosAtivos,
      });
      updateRelatorioKpis({
        previstoMesAtual,
        realizadoMesAtual,
        previstoAnoAtual,
        realizadoAnoAtual,
      });

      // ---- SecÃ§Ã£o FaturaÃ§Ã£o + GrÃ¡ficos ----
      prepararFiltrosFaturacao();   // preenche <select> de mÃªs/ano e liga eventos
      renderResumoMensal();         // preenche tabelas "pagas" + "em falta"
      atualizarGraficosPagamentos && atualizarGraficosPagamentos();
      atualizarGraficoEvolucaoAnual && atualizarGraficoEvolucaoAnual(); // se jÃ¡ definiste os grÃ¡ficos
    } catch (err) {
      console.error("Erro inesperado em loadKpisFinanceiros", err);
    }
  }

  // ---------- FATURAÃ‡ÃƒO: filtros de mÃªs/ano ----------
  function prepararFiltrosFaturacao() {
    const selMes = document.getElementById("fat-filtro-mes");
    const selAno = document.getElementById("fat-filtro-ano");
    if (!selMes || !selAno) return;

    // criar lista de anos com base nos dados existentes
    const anos = new Set();
    (PAGAMENTOS_CACHE || []).forEach((p) => {
      if (p.ano) anos.add(p.ano);
    });
    if (!anos.size) {
      anos.add(new Date().getFullYear());
    }
    const anosArr = Array.from(anos).sort();

    selAno.innerHTML = anosArr
      .map((a) => `<option value="${a}">${a}</option>`)
      .join("");

    // mÃªs/ano por defeito
    const now = new Date();
    if (!selMes.value) {
      selMes.value = String(now.getMonth() + 1);
    }
    if (!selAno.value) {
      selAno.value = anosArr.includes(now.getFullYear())
        ? String(now.getFullYear())
        : String(anosArr[0]);
    }

    const onChange = () => {
      renderResumoMensal();
      atualizarGraficosPagamentos && atualizarGraficosPagamentos();
    };

    // evitar adicionar mÃºltiplos listeners cada vez que chamas loadKpisFinanceiros
    if (!selMes.dataset.bound) {
      selMes.addEventListener("change", onChange);
      selMes.dataset.bound = "1";
    }
    if (!selAno.dataset.bound) {
      selAno.addEventListener("change", onChange);
      selAno.dataset.bound = "1";
    }
  }

  // ---------- CARREGAR SESSÃ•ES DO ALUNO ----------
  async function loadSessoesAluno(alunoId) {
    if (!tblSessoesBody) return;

    tblSessoesBody.innerHTML =
      '<tr><td colspan="5">A carregar sessÃµes...</td></tr>';

    const { data, error } = await callExplFn("list_sessoes_aluno", {
      aluno_id: alunoId,
    });

    if (error) {
      console.error("list_sessoes_aluno error", error);
      tblSessoesBody.innerHTML =
        '<tr><td colspan="5">Erro ao carregar sessÃµes.</td></tr>';
      return;
    }

    if (!data || !data.length) {
      tblSessoesBody.innerHTML =
        '<tr><td colspan="5">Ainda nÃ£o existem sessÃµes registadas para este aluno.</td></tr>';
      return;
    }

    tblSessoesBody.innerHTML = data
      .map((s) => {
        const dataLabel = s.data || "â€”";
        const hIni = s.hora_inicio || "â€”";
        const hFim = s.hora_fim || "â€”";
        const dur = s.duracao_min != null ? s.duracao_min : "â€”";
        const est = s.estado || "â€”";

        return `
          <tr class="linha-sessao" data-id-sessao="${s.id_sessao}">
            <td>${dataLabel}</td>
            <td>${hIni}</td>
            <td>${hFim}</td>
            <td>${dur}</td>
            <td>${est}</td>
          </tr>
        `;
      })
      .join("");

    tblSessoesBody.querySelectorAll("tr.linha-sessao").forEach((row) => {
      row.addEventListener("click", () => {
        const idSessao = row.dataset.idSessao;
        const sessao = (data || []).find(
          (s) => String(s.id_sessao) === String(idSessao),
        );
        if (sessao) {
          abrirModalSessao(sessao);
        }
      });
    });
  }

  // ---------- OPEN/CLOSE MODAL ----------
  function openModal(mod) { mod && mod.classList.add('open'); }
  function closeModal(mod) { mod && mod.classList.remove('open'); }

  // ---------- MODAL PAGAMENTO: ABRIR ----------
  function abrirModalPagamento(modo) {
    if (!formPag) return;
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      alert("Seleciona primeiro um aluno na lista.");
      return;
    }

    const agora = new Date();

    inputAno.value = String(agora.getFullYear());
    inputMes.value = String(agora.getMonth() + 1);
    inputDiaPag.value = "";
    inputValor.value = "";

    formPag.modo.value = modo;
    msgPag.textContent = "";
    msgPag.style.color = "";

    inputDiaPag.style.display = "none";
    inputValor.style.display = "none";

    if (modo === "iniciar") {
      pagModalTitle.textContent = "Iniciar faturaÃ§Ã£o";
      pagModalHint.textContent  =
        "Defina o mÃªs/ano de inÃ­cio e o dia de pagamento da mensalidade.";
      inputDiaPag.style.display = "block";
      btnSavePag.textContent    = "Iniciar faturaÃ§Ã£o";

    } else if (modo === "registar") {
      pagModalTitle.textContent = "Registar pagamento";
      pagModalHint.textContent  =
        "Regista um pagamento a acrescentar ao valor jÃ¡ pago nesse mÃªs.";
      inputValor.style.display  = "block";
      btnSavePag.textContent    = "Registar pagamento";

    } else { // "editar"
      pagModalTitle.textContent = "Editar pagamento";
      pagModalHint.textContent  =
        "Substitui o valor pago nesse mÃªs pelo valor indicado.";
      inputValor.style.display  = "block";
      btnSavePag.textContent    = "Guardar alteraÃ§Ãµes";
    }

    openModal(modalPag);
  }

  btnIniciarFat?.addEventListener("click", () => abrirModalPagamento("iniciar"));
  btnRegistarPag?.addEventListener("click", () => abrirModalPagamento("registar"));
  btnEditarPag?.addEventListener("click", () => abrirModalPagamento("editar"));

  $('#modal-pagamento-aluno .modal__close')?.addEventListener('click', () => {
    closeModal(modalPag);
  });

  modalPag?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalPag);
    }
  });

  // ---------- SUBMIT MODAL PAGAMENTO ----------
  formPag?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      msgPag.textContent = "Nenhum aluno selecionado.";
      return;
    }

    const modo  = formPag.modo.value;
    const ano   = Number(inputAno.value);
    const mes   = Number(inputMes.value);
    const dia   = inputDiaPag.value ? Number(inputDiaPag.value) : null;
    const valor = inputValor.value ? Number(inputValor.value) : null;

    if (!ano || !mes || mes < 1 || mes > 12) {
      msgPag.textContent = "Ano ou mÃªs invÃ¡lidos.";
      return;
    }

    if (modo === "iniciar") {
      if (!dia || dia < 1 || dia > 31) {
        msgPag.textContent = "Dia de pagamento invÃ¡lido.";
        return;
      }
    } else {
      if (valor === null || isNaN(valor) || valor < 0) {
        msgPag.textContent = "Valor invÃ¡lido.";
        return;
      }
    }

    btnSavePag.disabled = true;
    msgPag.textContent  = "A guardar...";

    try {
      let action, payload;

      if (modo === "iniciar") {
        action = "iniciar_faturacao_aluno";
        payload = {
          aluno_id: ALUNO_ATUAL.id_aluno,
          ano,
          mes,
          dia_pagamento: dia,
        };
      } else if (modo === "registar") {
        action = "registar_pagamento_aluno";
        payload = {
          aluno_id: ALUNO_ATUAL.id_aluno,
          ano,
          mes,
          valor,
        };
      } else {
        action = "update_pagamento_aluno";
        payload = {
          aluno_id: ALUNO_ATUAL.id_aluno,
          ano,
          mes,
          valor_pago: valor,
        };
      }

      const { data, error } = await callExplFn(action, payload);

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro pagamento_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
              else extra = " " + raw;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        msgPag.textContent = "NÃ£o foi possÃ­vel guardar." + extra;
        btnSavePag.disabled = false;
        return;
      }

      msgPag.style.color = "#126b3a";
      msgPag.textContent = "Guardado com sucesso.";

      await loadKpisFinanceiros();
      const alunoAtualizado = ALUNOS_CACHE.find(
        (a) => String(a.id_aluno) === String(ALUNO_ATUAL.id_aluno)
      );
      if (alunoAtualizado) {
        await mostrarPainelAluno(alunoAtualizado);
      }
      await loadResumoCalendario();
      setTimeout(() => closeModal(modalPag), 600);
    } catch (e) {
      console.error("pagamento_aluno error", e);
      msgPag.textContent = "Erro inesperado ao guardar.";
    } finally {
      btnSavePag.disabled = false;
    }
  });

  // ---------- Painel de detalhes por aluno ----------
  async function mostrarPainelAluno(aluno) {
    ALUNO_ATUAL = aluno;

    const card = document.getElementById("aluno-detail-card");
    if (!card) return;

    const nomeCompleto = [aluno.nome, aluno.apelido].filter(Boolean).join(" ");
    document.getElementById("aluno-detail-nome").textContent =
      nomeCompleto || "Aluno";

    // Atualizar estado (Ativo / Bloqueado + switch)
    updateAlunoStatusUI(aluno);

    document.getElementById("aluno-detail-meta").textContent =
      aluno.username ? `Username: ${aluno.username}` : "";

    document.getElementById("aluno-detail-email").textContent =
      aluno.email || "â€”";
    document.getElementById("aluno-detail-tel").textContent =
      aluno.telemovel || "â€”";
    document.getElementById("aluno-detail-ano").textContent =
      aluno.ano ?? "â€”";

    const valorExp =
      aluno.valor_explicacao != null
        ? `â‚¬ ${Number(aluno.valor_explicacao).toFixed(2)}`
        : "â€”";
    document.getElementById("aluno-detail-valor").textContent = valorExp;

    const sessoes =
      aluno.sessoes_mes != null ? String(aluno.sessoes_mes) : "â€”";
    document.getElementById("aluno-detail-sessoes").textContent = sessoes;

    card.style.display = "block";

    if (!EXPLICADOR.id_explicador) return;

    const elPrevistoMes = document.getElementById("aluno-detail-previsto-mes");
    const elPagoMes     = document.getElementById("aluno-detail-pago-mes");
    const elEmFalta     = document.getElementById("aluno-detail-emfalta");

    try {
      const now = new Date();
      const anoAtual = now.getFullYear();
      const mesAtual = now.getMonth() + 1;

      const { data, error } = await supabase
        .from("v_pagamentos_detalhe")
        .select("ano, mes, valor_previsto, valor_pago, estado")
        .eq("id_explicador", EXPLICADOR.id_explicador)
        .eq("id_aluno", aluno.id_aluno);

      if (error) {
        console.error("Erro a carregar pagamentos do aluno", error);
        if (elPrevistoMes) elPrevistoMes.textContent = "â€”";
        if (elPagoMes)     elPagoMes.textContent     = "â€”";
        if (elEmFalta)     elEmFalta.textContent     = "â€”";
        return;
      }

      let previstoMes = 0;
      let pagoMes     = 0;
      let emFaltaTotal = 0;

      (data || []).forEach((p) => {
        const previsto = Number(p.valor_previsto) || 0;
        const pago     = Number(p.valor_pago) || 0;
        const falta    = Math.max(previsto - pago, 0);

        if (p.ano === anoAtual && p.mes === mesAtual) {
          previstoMes += previsto;
          pagoMes     += pago;
        }

        emFaltaTotal += falta;
      });

      if ((!data || data.length === 0) &&
          aluno.valor_explicacao != null &&
          aluno.sessoes_mes != null) {

        const estimado = Number(aluno.valor_explicacao) * Number(aluno.sessoes_mes);
        previstoMes   = estimado;
        pagoMes       = 0;
        emFaltaTotal  = estimado;
      }

      if (elPrevistoMes) {
        elPrevistoMes.textContent = `â‚¬ ${previstoMes.toFixed(2)}`;
      }
      if (elPagoMes) {
        elPagoMes.textContent     = `â‚¬ ${pagoMes.toFixed(2)}`;
      }
      if (elEmFalta) {
        elEmFalta.textContent     = `â‚¬ ${emFaltaTotal.toFixed(2)}`;
      }
            // --- Tabela de histÃ³rico de pagamentos do aluno ---
      const tbodyAluno = document.querySelector("#tblPagamentosAluno tbody");

      if (tbodyAluno) {
        if (!data || !data.length) {
          tbodyAluno.innerHTML =
            '<tr><td colspan="5">Ainda nÃ£o existem pagamentos registados para este aluno.</td></tr>';
        } else {
          const nomesMeses = [
            "Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho",
            "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro",
          ];

          const rows = data
            .slice() // cÃ³pia para poder ordenar
            .sort((a, b) => (a.ano - b.ano) || (a.mes - b.mes))
            .map((p) => {
              const mesIdx = (p.mes || 1) - 1;
              const mesLabelLinha =
                nomesMeses[mesIdx] || String(p.mes || "");
              const previstoLinha = Number(p.valor_previsto) || 0;
              const pagoLinha     = Number(p.valor_pago) || 0;
              const estadoLinha   = p.estado || "";

              return `
                <tr>
                  <td>${p.ano || ""}</td>
                  <td>${mesLabelLinha}</td>
                  <td>â‚¬ ${previstoLinha.toFixed(2)}</td>
                  <td>â‚¬ ${pagoLinha.toFixed(2)}</td>
                  <td>${estadoLinha}</td>
                </tr>
              `;
            })
            .join("");

          tbodyAluno.innerHTML = rows;
        }
      }
    } catch (err) {
      console.error("Erro inesperado ao calcular resumo do aluno", err);
    }

    await loadSessoesAluno(aluno.id_aluno);
  }

  // ---------- CRIAR ALUNO ----------
  async function createAluno(payload) {
    const { data, error } = await callExplFn("create_aluno", payload);

    if (error) {
      console.error(error);
      return { ok: false, error: error.message };
    }

    return { ok: true, data };
  }

  // ---------- MODAIS (add / edit / sessÃ£o) ----------
  modalAddAluno?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalAddAluno);
    }
  });

  $('#modal-add-aluno .modal__close')?.addEventListener('click', () => {
    closeModal(modalAddAluno);
  });

  btnFab?.addEventListener('click', () => openModal(modalAddAluno));
  btnOpenAddAluno?.addEventListener('click', () => openModal(modalAddAluno));

  $('#modal-edit-aluno .modal__close')?.addEventListener('click', () => {
    closeModal(modalEditAluno);
  });

  modalEditAluno?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalEditAluno);
    }
  });

  $('#modal-sessao .modal__close')?.addEventListener('click', () => {
    closeModal(modalSessao);
  });

  modalSessao?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalSessao);
    }
  });

  // ---------- PREENCHER MODAL DE EDIÃ‡ÃƒO DO ALUNO ----------
  function preencherModalEdicao(aluno) {
    if (!formEdit || !aluno) return;

    formEdit.nome_edit.value  = aluno.nome || "";
    formEdit.apelido_edit.value = aluno.apelido || "";
    formEdit.telemovel_edit.value = aluno.telemovel || "";
    formEdit.ano_edit.value = aluno.ano != null ? aluno.ano : "";
    formEdit.idade_edit.value = aluno.idade != null ? aluno.idade : "";
    formEdit.dia_semana_preferido_edit.value = aluno.dia_semana_preferido || "";
    formEdit.valor_explicacao_edit.value =
      aluno.valor_explicacao != null ? aluno.valor_explicacao : "";
    formEdit.sessoes_mes_edit.value =
      aluno.sessoes_mes != null ? aluno.sessoes_mes : "";
    formEdit.nome_pai_cache_edit.value = aluno.nome_pai_cache || "";
    formEdit.contacto_pai_cache_edit.value = aluno.contacto_pai_cache || "";
    formEdit.email_edit.value = aluno.email || "";
    formEdit.username_edit.value = aluno.username || "";
    formEdit.password_edit.value = "";
    msgEditAluno.textContent = "";
    msgEditAluno.style.color = "";
  }

  btnEditarAluno?.addEventListener("click", () => {
    if (!ALUNO_ATUAL) {
      alert("Seleciona primeiro um aluno na lista.");
      return;
    }
    preencherModalEdicao(ALUNO_ATUAL);
    openModal(modalEditAluno);
  });

  // ---------- TOGGLE ATIVO / BLOQUEADO ----------
  toggleAlunoAtivo?.addEventListener('click', async () => {
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) return;

    const estavaAtivo = ALUNO_ATUAL.is_active !== false;
    const novoEstado = !estavaAtivo;

    if (!novoEstado) {
      const confirma = confirm(
        'Ao bloquear este aluno ele deixa de conseguir fazer login e deixa de contar como aluno ativo. Continuar?'
      );
      if (!confirma) return;
    }

    // feedback mÃ­nimo
    if (alunoStatusBadge) {
      alunoStatusBadge.textContent = 'A atualizar...';
    }

    const { error } = await callExplFn('update_aluno', {
      id_aluno: ALUNO_ATUAL.id_aluno,
      is_active: novoEstado,
    });

    if (error) {
      console.error('Erro ao alterar estado do aluno', error);
      alert('NÃ£o foi possÃ­vel atualizar o estado do aluno.');
      // volta ao estado anterior no UI
      updateAlunoStatusUI(ALUNO_ATUAL);
      return;
    }

    // Atualizar caches
    ALUNO_ATUAL.is_active = novoEstado;
    const idx = (ALUNOS_CACHE || []).findIndex(
      a => String(a.id_aluno) === String(ALUNO_ATUAL.id_aluno)
    );
    if (idx >= 0) {
      ALUNOS_CACHE[idx].is_active = novoEstado;
    }

    // Atualizar UI dependentes
    updateAlunoStatusUI(ALUNO_ATUAL);
    renderDashboardAlunos();
    await loadKpisFinanceiros();
  });

  // ---------- SUBMIT EDITAR ALUNO ----------
  formEdit?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    msgEditAluno.textContent = "";

    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      msgEditAluno.textContent = "Nenhum aluno selecionado.";
      return;
    }

    const f = ev.target;

    const payload = {
      id_aluno: ALUNO_ATUAL.id_aluno,
      nome: f.nome_edit.value.trim() || null,
      apelido: f.apelido_edit.value.trim() || null,
      telemovel: f.telemovel_edit.value.trim() || null,
      ano: f.ano_edit.value ? Number(f.ano_edit.value) : null,
      idade: f.idade_edit.value ? Number(f.idade_edit.value) : null,
      dia_semana_preferido: f.dia_semana_preferido_edit.value.trim() || null,
      valor_explicacao: f.valor_explicacao_edit.value
        ? Number(f.valor_explicacao_edit.value)
        : null,
      sessoes_mes: f.sessoes_mes_edit.value
        ? Number(f.sessoes_mes_edit.value)
        : null,
      nome_pai_cache: f.nome_pai_cache_edit.value.trim() || null,
      contacto_pai_cache: f.contacto_pai_cache_edit.value.trim() || null,
      email: f.email_edit.value.trim() || null,
      username: f.username_edit.value.trim() || null,
      password: f.password_edit.value.trim() || undefined,
      is_active: ALUNO_ATUAL?.is_active ?? true,
    };

    btnSaveEdit.disabled = true;
    msgEditAluno.textContent = "A guardar alteraÃ§Ãµes...";

    try {
      const { data, error } = await callExplFn("update_aluno", payload);

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro update_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        msgEditAluno.textContent =
          "NÃ£o foi possÃ­vel guardar as alteraÃ§Ãµes." + extra;
        btnSaveEdit.disabled = false;
        return;
      }

      msgEditAluno.style.color = "#126b3a";
      msgEditAluno.textContent = "AlteraÃ§Ãµes guardadas com sucesso.";

      await loadAlunos();
      const alunoAtualizado = ALUNOS_CACHE.find(
        (a) => String(a.id_aluno) === String(ALUNO_ATUAL.id_aluno)
      );
      if (alunoAtualizado) {
        mostrarPainelAluno(alunoAtualizado);
      }

      setTimeout(() => {
        closeModal(modalEditAluno);
      }, 600);
    } catch (e) {
      console.error("update_aluno error", e);
      msgEditAluno.textContent = "Erro inesperado ao guardar alteraÃ§Ãµes.";
    } finally {
      btnSaveEdit.disabled = false;
    }
  });

  // ---------- SUBMIT NOVO ALUNO ----------
  formNew?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    msgNewAluno.textContent = "";

    if (!EXPLICADOR.id_explicador) {
      msgNewAluno.textContent = "Perfil de explicador invÃ¡lido.";
      return;
    }

    const f = ev.target;

    const payload = {
      nome: f.nome?.value.trim() || "",
      apelido: f.apelido?.value.trim() || null,
      telemovel: f.telemovel?.value.trim() || null,
      ano: f.ano?.value ? Number(f.ano.value) : null,
      idade: f.idade?.value ? Number(f.idade.value) : null,
      dia_semana_preferido: f.dia_semana_preferido?.value.trim() || null,
      valor_explicacao: f.valor_explicacao?.value
        ? Number(f.valor_explicacao.value)
        : null,
      sessoes_mes: f.sessoes_mes?.value
        ? Number(f.sessoes_mes.value)
        : null,
      nome_pai_cache: f.nome_pai_cache?.value.trim() || null,
      contacto_pai_cache: f.contacto_pai_cache?.value.trim() || null,
      email: f.email?.value.trim() || "",
      username: f.username?.value.trim() || null,
      password: f.password?.value || "",
      is_active: true,
    };

    if (!payload.nome || !payload.email || !payload.password) {
      msgNewAluno.textContent =
        "Preenche pelo menos Nome, Email e Password.";
      return;
    }

    btnCreate.disabled = true;
    msgNewAluno.textContent = "A criar aluno...";

    const { data, error } = await callExplFn("create_aluno", payload);

    if (error) {
      let extra = "";

      if (error.context) {
        try {
          const resp = error.context;
          const raw = await resp.text();
          console.log("Erro bruto da funÃ§Ã£o expl-alunos:", raw);

          try {
            const json = JSON.parse(raw);
            if (json?.error) {
              extra = " " + json.error;
            } else {
              extra = " " + raw;
            }
          } catch {
            extra = " " + raw;
          }
        } catch (e) {
          console.warn("NÃ£o consegui ler o body da resposta da funÃ§Ã£o", e);
        }
      }

      console.error("create_aluno error", error);
      msgNewAluno.textContent =
        "NÃ£o foi possÃ­vel criar o aluno." + extra;
      btnCreate.disabled = false;
      return;
    }

    msgNewAluno.style.color = "#126b3a";
    msgNewAluno.textContent = "Aluno criado com sucesso!";
    f.reset();
    await loadAlunos();
    await loadKpisFinanceiros();
    btnCreate.disabled = false;
  });

  // ---------- LOGIN ----------
  formLogin?.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    msgLogin.textContent = 'A entrar...';

    const email    = formLogin.email.value.trim();
    const password = formLogin.password.value.trim();

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      console.error(error);
      msgLogin.textContent = 'Credenciais invÃ¡lidas.';
      return;
    }

    const user = data.user;
    if (!(await hasRole(user.id, 'explicador'))) {
      await supabase.auth.signOut().catch(()=>{});
      msgLogin.textContent = 'Esta conta nÃ£o Ã© de explicador.';
      return;
    }

    const exp = await getExplRow(user.id);
    EXPLICADOR = {
      userId: user.id,
      id_explicador: exp?.id_explicador || null,
      max: exp?.max_alunos ?? 0
    };

    const nomeCompleto = [exp?.nome, exp?.apelido].filter(Boolean).join(' ') || 'Professor';
    elNomeHeader.textContent = nomeCompleto;
    elNomeMini.textContent   = nomeCompleto;

    setState({ isExpl: true, isAuthed: true });
    await loadAlunos();
    await loadKpisFinanceiros();
    await loadResumoCalendario();
  });

  // ---------- LOGOUT ----------
  btnLogout?.addEventListener('click', async () => {
    await supabase.auth.signOut().catch(()=>{});
    window.location.href = './index.html';
  });

  // ---------- SESSÃƒO INICIAL ----------
  (async () => {
    setState({ loading: true });

    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) {
      setState({ isExpl: false, isAuthed: false });
      return;
    }

    const user = session.user;
    if (!(await hasRole(user.id, 'explicador'))) {
      await supabase.auth.signOut().catch(()=>{});
      setState({ isExpl: false, isAuthed: false });
      msgLogin.textContent = 'Conta sem permissÃµes de explicador.';
      return;
    }

    const exp = await getExplRow(user.id);
    EXPLICADOR = {
      userId: user.id,
      id_explicador: exp?.id_explicador || null,
      max: exp?.max_alunos ?? 0
    };

    const nomeCompleto = [exp?.nome, exp?.apelido].filter(Boolean).join(' ') || 'Professor';
    elNomeHeader.textContent = nomeCompleto;
    elNomeMini.textContent   = nomeCompleto;

    setState({ isExpl: true, isAuthed: true });
    await loadAlunos();
    await loadKpisFinanceiros();
    await loadResumoCalendario();
  })();

  // ---------- NAVEGAÃ‡ÃƒO LATERAL (tabs) ----------
  const tabs = document.querySelectorAll('.expl-nav-btn');
  const screens = document.querySelectorAll('.expl-section[data-section]');

  function ativarScreen(target) {
    screens.forEach(sec => {
      const key = sec.dataset.section;
      sec.style.display = key === target ? '' : 'none';
    });

    document.querySelector('.expl-body')?.scrollTo({ top: 0, behavior: 'smooth' });
    const title = document.querySelector('.expl-page-title');
    if (title) {
      const mapTitle = {
        dashboard: 'Dashboard',
        alunos: 'Alunos',
        calendario: 'CalendÃ¡rio',
        faturacao: 'FaturaÃ§Ã£o',
        relatorios: 'RelatÃ³rios',
      };
      title.textContent = mapTitle[target] || 'Dashboard';
    }
  }

  tabs.forEach(btn => {
    btn.addEventListener('click', async () => {
      const target = btn.dataset.target;
      tabs.forEach(t => t.classList.remove('expl-nav-btn--active'));
      btn.classList.add('expl-nav-btn--active');
      ativarScreen(target);

      // Sempre que abres o separador CalendÃ¡rio, recarregas as sessÃµes do explicador
      if (target === 'calendario') {
        await loadResumoCalendario();
      }
    });
  });


  // botÃ£o "Ver todos" na dashboard -> tab Alunos
  btnDashVerAlunos?.addEventListener('click', () => {
    const tabAlunos = document.querySelector('.expl-nav-btn[data-target="alunos"]');
    tabAlunos?.click();
  });

  // scroll para lista de alunos
  btnScrollLista?.addEventListener('click', () => {
    document.querySelector('#lista-alunos-card')?.scrollIntoView({
      behavior:'smooth',
      block:'start'
    });
  });

  supabase.auth.onAuthStateChange(async (_evt, session) => {
    if (!session?.user) {
      setState({ isExpl: false, isAuthed: false });
    }
  });

  // ---------- SESSÃ•ES: ABRIR MODAL ----------
  function abrirModalSessao(sessao) {
    if (!formSessao) return;

    if (sessao) {
      SESSAO_ATUAL_ID = sessao.id_sessao;
      formSessao.data_sessao.value = sessao.data || "";
      formSessao.hora_inicio.value = sessao.hora_inicio || "";
      formSessao.hora_fim.value = sessao.hora_fim || "";
      formSessao.duracao_min.value =
        sessao.duracao_min != null ? sessao.duracao_min : "";
      formSessao.estado.value = sessao.estado || "AGENDADA";
      formSessao.observacoes.value = sessao.observacoes || "";
      btnDeleteSessao.style.display = "inline-block";
    } else {
      SESSAO_ATUAL_ID = null;
      formSessao.data_sessao.value = "";
      formSessao.hora_inicio.value = "";
      formSessao.hora_fim.value = "";
      formSessao.duracao_min.value = "";
      formSessao.estado.value = "AGENDADA";
      formSessao.observacoes.value = "";
      btnDeleteSessao.style.display = "none";
    }

    msgSessao.textContent = "";
    msgSessao.style.color = "";
    openModal(modalSessao);
  }

  btnAddSessao?.addEventListener("click", () => {
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      alert("Seleciona primeiro um aluno na lista.");
      return;
    }
    abrirModalSessao(null);
  });

  // BotÃ£o "Agendar explicaÃ§Ã£o" no topo da secÃ§Ã£o CalendÃ¡rio
  btnAgendarExplicacao?.addEventListener('click', () => {
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      alert('Seleciona primeiro um aluno na lista de Alunos para agendar uma sessÃ£o.');

      // muda para o tab Alunos automaticamente
      const tabAlunos = document.querySelector('.expl-nav-btn[data-target="alunos"]');
      tabAlunos?.click();
      return;
    }

    // abre o modal de sessÃ£o em modo "nova sessÃ£o"
    abrirModalSessao(null);
  });

  // ---------- SESSÃ•ES: SUBMIT ----------
  formSessao?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    msgSessao.textContent = "";

    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      msgSessao.textContent = "Nenhum aluno selecionado.";
      return;
    }

    const f = ev.target;

    const data = f.data_sessao.value;
    if (!data) {
      msgSessao.textContent = "Data Ã© obrigatÃ³ria.";
      return;
    }

    const payload = {
      id_sessao: SESSAO_ATUAL_ID || undefined,
      aluno_id: ALUNO_ATUAL.id_aluno,
      data,
      hora_inicio: f.hora_inicio.value || null,
      hora_fim: f.hora_fim.value || null,
      duracao_min: f.duracao_min.value || null,
      estado: f.estado.value || "AGENDADA",
      observacoes: f.observacoes.value || null,
    };

    btnSaveSessao.disabled = true;
    msgSessao.textContent = "A guardar sessÃ£o...";

    try {
      const { data, error } = await callExplFn("upsert_sessao_aluno", payload);

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro upsert_sessao_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        msgSessao.textContent =
          "NÃ£o foi possÃ­vel guardar a sessÃ£o." + extra;
        btnSaveSessao.disabled = false;
        return;
      }

      msgSessao.style.color = "#126b3a";
      msgSessao.textContent = "SessÃ£o guardada com sucesso.";

      await loadSessoesAluno(ALUNO_ATUAL.id_aluno);
      await loadResumoCalendario();
      setTimeout(() => {
        closeModal(modalSessao);
      }, 500);
    } catch (e) {
      console.error("upsert_sessao_aluno error", e);
      msgSessao.textContent = "Erro inesperado ao guardar sessÃ£o.";
    } finally {
      btnSaveSessao.disabled = false;
    }
  });

  // ---------- SESSÃ•ES: APAGAR ----------
  btnDeleteSessao?.addEventListener("click", async () => {
    if (!SESSAO_ATUAL_ID) {
      return;
    }
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      alert("Nenhum aluno selecionado.");
      return;
    }

    const conf = confirm("Tens a certeza que queres apagar esta sessÃ£o?");
    if (!conf) return;

    msgSessao.textContent = "A apagar sessÃ£o...";
    btnDeleteSessao.disabled = true;

    try {
      const { data, error } = await callExplFn("delete_sessao_aluno", {
        id_sessao: SESSAO_ATUAL_ID,
      });

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro delete_sessao_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        msgSessao.textContent =
          "NÃ£o foi possÃ­vel apagar a sessÃ£o." + extra;
        btnDeleteSessao.disabled = false;
        return;
      }

      msgSessao.style.color = "#126b3a";
      msgSessao.textContent = "SessÃ£o apagada com sucesso.";

      await loadSessoesAluno(ALUNO_ATUAL.id_aluno);
      await loadResumoCalendario(); 
      setTimeout(() => {
        closeModal(modalSessao);
      }, 400);
    } catch (e) {
      console.error("delete_sessao_aluno error", e);
      msgSessao.textContent = "Erro inesperado ao apagar sessÃ£o.";
    } finally {
      btnDeleteSessao.disabled = false;
    }
  });

  // ------------------------------------------------------------------
  // RENDER CALENDÃRIO SEMANAL
  // ------------------------------------------------------------------
  function renderCalendarioSemanal() {
    const grid = document.getElementById("calendar-grid");
    const label = document.getElementById("week-label");
    if (!grid || !label) return;

    const hoje = new Date();
    const inicio = getInicioSemana(hoje);
    inicio.setDate(inicio.getDate() + semanaOffset * 7);

    const dias = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(inicio);
      d.setDate(inicio.getDate() + i);
      dias.push(d);
    }

    const fmt = { day: "2-digit", month: "2-digit" };
    label.textContent = `Semana ${dias[0].toLocaleDateString("pt-PT", fmt)} â€“ ${dias[6].toLocaleDateString("pt-PT", fmt)}`;

    const nomes = ["Seg", "Ter", "Qua", "Qui", "Sex", "SÃ¡b", "Dom"];

    grid.innerHTML = dias.map((d, idx) => {
      const dataStr = d.toISOString().slice(0, 10);
      const sessoes = SESSOES_EXPLICADOR.filter(s => s.data === dataStr);

      const temRealizada = sessoes.some(s => s.estado === "REALIZADA");
      const temAgendada  = sessoes.some(s => s.estado === "AGENDADA");
      const temExtra     = sessoes.some(s => s.estado === "EXTRA");

      const dotsHTML = `
        ${temRealizada ? `<span class="dot dot-green"></span>` : ""}
        ${temAgendada  ? `<span class="dot dot-yellow"></span>` : ""}
        ${temExtra     ? `<span class="dot dot-orange"></span>` : ""}
      `.trim();

      const lista = sessoes.length === 0
        ? `<p class="calendar-empty">Sem sessÃµes</p>`
        : sessoes.map(s => `
            <div class="calendar-session">
              <strong>${s.hora_inicio?.slice(0,5) || "--:--"}</strong>
              <span>${s.aluno_nome}</span>
            </div>
          `).join("");

      return `
        <div class="calendar-day">
          <div class="calendar-day__header">
            <span class="calendar-day__weekday">${nomes[idx]}</span>
            <span class="calendar-day__date">${d.toLocaleDateString("pt-PT", fmt)}</span>
          </div>

          <div class="calendar-day__dots">${dotsHTML}</div>
          <div class="calendar-day__list">${lista}</div>
        </div>
      `;
    }).join("");
  }

  function getBadgeInfoSessao(estadoRaw) {
  const e = (estadoRaw || "").toString().trim().toUpperCase();

    switch (e) {
      case "REALIZADA":
        return { label: "Realizada", className: "sessao-badge sessao-badge--realizada" };
      case "FALTOU":
        return { label: "Faltou", className: "sessao-badge sessao-badge--faltou" };
      case "CANCELADA":
        return { label: "Cancelada", className: "sessao-badge sessao-badge--cancelada" };
      case "EXTRA":
        return { label: "Extra", className: "sessao-badge sessao-badge--extra" };
      case "AGENDADA":
      default:
        return { label: "Agendada", className: "sessao-badge sessao-badge--agendada" };
    }
  }

  function renderProximasSessoes(sessoes) {
  const container = document.getElementById("calendar-proximas");
  if (!container) return;

  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);

  const proximas = (sessoes || [])
    .filter((s) => s.data)                            // tem data
    .map((s) => {
      const d = new Date(s.data);
      d.setHours(0, 0, 0, 0);
      return { ...s, _dataObj: d };
    })
    .filter((s) => s._dataObj >= hoje)                // de hoje para a frente
    .sort((a, b) => {
      if (a._dataObj - b._dataObj !== 0) {
        return a._dataObj - b._dataObj;
      }
      // ordenar tambÃ©m por hora se existir
      const ha = a.hora_inicio || "";
      const hb = b.hora_inicio || "";
      return ha.localeCompare(hb);
    })
    .slice(0, 10);                                    // top 10 prÃ³ximas

  if (!proximas.length) {
    container.innerHTML =
      '<p class="calendar-empty">NÃ£o tens prÃ³ximas explicaÃ§Ãµes agendadas.</p>';
    return;
  }

  const fmtData = { day: "2-digit", month: "2-digit", year: "numeric" };

  container.innerHTML = proximas
    .map((s) => {
      const dataObj = s._dataObj;
      const dataLabel = dataObj.toLocaleDateString("pt-PT", fmtData);
      const hora = (s.hora_inicio || "").slice(0, 5) || "--:--";
      const dur = s.duracao_min != null ? `${s.duracao_min} min` : "";
      const aluno = s.aluno_nome || "Aluno";
      const local = s.local || ""; // se algum dia tiveres campo local

      const { label: badgeLabel, className: badgeClass } = getBadgeInfoSessao(s.estado);

      return `
        <article class="sessao-card">
          <header class="sessao-card__header">
            <div>
              <p class="sessao-card__aluno">${aluno}</p>
              <p class="sessao-card__meta">${dataLabel} Â· ${hora}${dur ? " Â· " + dur : ""}</p>
            </div>
            <span class="${badgeClass}">${badgeLabel}</span>
          </header>

          ${
            local
              ? `<p class="sessao-card__footer">${local}</p>`
              : ""
          }
        </article>
      `;
    })
    .join("");
}


  btnWeekPrev?.addEventListener('click', () => {
    semanaOffset -= 1;
    renderCalendarioSemanal();
    updateRelatorioKpis(); // volta a calcular, agora com SESSOES_EXPLICADOR preenchido
  });

  btnWeekNext?.addEventListener('click', () => {
    semanaOffset += 1;
    renderCalendarioSemanal();
  });

  // --------------------------------------------------------------------
  // CARREGAR RESUMO DE CALENDÃRIO
  // --------------------------------------------------------------------
  async function loadResumoCalendario() {
    const { data, error } = await callExplFn("list_sessoes_explicador", null);

    if (error) {
      console.error("Erro a carregar sessÃµes do explicador", error);
      return;
    }

    const sessoes = data || [];
    SESSOES_EXPLICADOR = sessoes;

    // HOJE
    const hojeStr = new Date().toISOString().slice(0, 10);
    const sessoesHoje = sessoes.filter(s => s.data === hojeStr);

    let txtHoje = "Sem sessÃµes registadas";
    if (sessoesHoje.length > 0) {
      const detalhes = sessoesHoje
        .map(s => `${s.hora_inicio?.slice(0, 5) || "--:--"} ${s.aluno_nome || ""}`.trim())
        .join(", ");

      txtHoje = `${sessoesHoje.length} sessÃ£o(Ãµes) hoje Â· ${detalhes}`;
    }

    const elHoje = document.querySelector("#cal-resumo-hoje");
    if (elHoje) elHoje.textContent = txtHoje;

    // PRÃ“XIMOS 7 DIAS
    const hojeDate = new Date();
    const seteDiasDepois = new Date();
    seteDiasDepois.setDate(hojeDate.getDate() + 7);

    const sessoesSemana = sessoes.filter(s => {
      const dataSess = new Date(s.data);
      dataSess.setHours(0, 0, 0, 0);
      return dataSess >= hojeDate && dataSess <= seteDiasDepois;
    });

    let txtSemana = "Agenda em branco por agora";
    if (sessoesSemana.length > 0) {
      const alunosUnicos = new Set(sessoesSemana.map(s => s.aluno_nome));
      txtSemana =
        `${sessoesSemana.length} sessÃµes nos prÃ³ximos 7 dias Â· ` +
        `${alunosUnicos.size} aluno(s) diferente(s)`;
    }

    const elSemana = document.querySelector("#cal-resumo-semana");
    if (elSemana) elSemana.textContent = txtSemana;

        // ----------------------------------------------------
    // PRÃ“XIMAS EXPLICAÃ‡Ã•ES (lista Ã  direita)
    // ----------------------------------------------------
    if (listaProximas) {
      // sÃ³ sessÃµes futuras ou de hoje com hora >= agora
      const agora = new Date();
      const futuras = (sessoes || [])
        .filter((s) => {
          if (!s.data) return false;
          const d = new Date(s.data);
          if (s.hora_inicio) {
            const [h, m] = s.hora_inicio.split(':').map(Number);
            d.setHours(h || 0, m || 0, 0, 0);
          }
          return d >= agora;
        })
        .sort((a, b) => {
          const da = new Date(a.data + 'T' + (a.hora_inicio || '00:00'));
          const db = new Date(b.data + 'T' + (b.hora_inicio || '00:00'));
          return da - db;
        })
        .slice(0, 10); // mostra no mÃ¡ximo 10

      if (!futuras.length) {
        listaProximas.innerHTML =
          '<p class="expl-section-sub">NÃ£o tens prÃ³ximas explicaÃ§Ãµes agendadas.</p>';
      } else {
        listaProximas.innerHTML = futuras
          .map((s) => {
            const dataLabel = s.data
              ? new Date(s.data).toLocaleDateString('pt-PT', {
                  day: '2-digit',
                  month: '2-digit',
                  year: 'numeric'
                })
              : 'â€”';

            const horaLabel = s.hora_inicio
              ? s.hora_inicio.slice(0, 5)
              : '--:--';

            const dur = s.duracao_min != null
              ? `${s.duracao_min} min`
              : '';

            const estado = s.estado || 'AGENDADA';
            const aluno  = s.aluno_nome || 'Aluno';

            return `
              <div class="calendar-proxima-card">
                <div class="calendar-proxima-main">
                  <p class="calendar-proxima-aluno">${aluno}</p>
                  <span class="calendar-proxima-badge">${estado}</span>
                </div>
                <p class="calendar-proxima-meta">
                  <span>${dataLabel}</span> Â·
                  <span>${horaLabel}</span>
                  ${dur ? ` Â· <span>${dur}</span>` : ''}
                </p>
              </div>
            `;
          })
          .join('');
      }
    }

    // Finalmente, atualizar grelha semanal
    renderCalendarioSemanal();
    renderProximasSessoes(sessoes);
  }

  // estado inicial dos tabs
  ativarScreen('dashboard');
  (function () {
  const fab    = document.getElementById("fabNav");
  const toggle = document.getElementById("fabToggle");
  const items  = Array.from(document.querySelectorAll(".fab-item"));

  // raio (podes ajustar se quiseres mais â€œapertadoâ€)
  const radiusDesktop = 95;
  const radiusMobile  = 80;

  function getRadius() {
    return window.innerWidth < 640 ? radiusMobile : radiusDesktop;
  }

    toggle.addEventListener("click", () => {
    const itemsWrapper = document.getElementById("fabItems");
    const isOpening = !fab.classList.contains("is-open");

    fab.classList.toggle("is-open", isOpening);

    if (isOpening) {
      itemsWrapper.hidden = false;
      itemsWrapper.setAttribute("aria-hidden", "false");

      const total  = items.length;
      const radius = getRadius();

      const centerDeg = 270;
      const spreadDeg = 210; // o que jÃ¡ tinhas
      const startDeg  = centerDeg - spreadDeg / 2;
      const step      = total > 1 ? spreadDeg / (total - 1) : 0;

      const labelOffset = 70; // distÃ¢ncia das labels para fora do arco

    items.forEach((btn, i) => {
      const angleDeg = startDeg + step * i;
      const angleRad = angleDeg * Math.PI / 180;

      const x = Math.cos(angleRad) * radius;
      const y = Math.sin(angleRad) * radius;

      btn.style.setProperty('--tx', `${x}px`);
      btn.style.setProperty('--ty', `${y}px`);

      const len = Math.sqrt(x*x + y*y) || 1;
      const ux  = x / len;
      const uy  = y / len;

      const dx = ux * labelOffset;
      const dy = uy * labelOffset;

      const label = btn.querySelector('.fab-label');
      if (label) {
        label.style.setProperty('--lx', `${dx}px`);
        label.style.setProperty('--ly', `${dy}px`);
      }
    });

        } else {
          closeFab();
        }
      });

    function closeFab() {
    const itemsWrapper = document.getElementById("fabItems");
    items.forEach(btn => {
      btn.style.setProperty('--tx', '0px');
      btn.style.setProperty('--ty', '0px');

      const label = btn.querySelector('.fab-label');
      if (label) {
        label.style.setProperty('--lx', '0px');
        label.style.setProperty('--ly', '0px');
      }
    });
    fab.classList.remove("is-open");
    itemsWrapper.setAttribute("aria-hidden", "true");
    setTimeout(() => { itemsWrapper.hidden = true; }, 300);
  }


  // cada item navega para a secÃ§Ã£o e fecha o menu
  items.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.target;
      const original = document.querySelector(
        `.expl-nav-btn[data-target="${target}"]`
      );
      if (original) original.click();
      closeFab();
    });
  });

})();
</script>


</body>
</html>