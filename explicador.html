<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="./styles.css"/>
  <title>EduSphere ‚Äî Explicador</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
</head>

<body class="home">
<header>
  <div class="header-inner">
    <a class="logo" href="./index.html">
      <img src="/public/img/logo-icon.svg" alt="">
      <span>EduSphere</span>
    </a>

    <!-- NAV SUPERIOR (se quiseres usar no futuro; n√£o est√° ligado ao JS) -->
    <nav id="explTopNav" class="expl-main-nav" style="display:none">
      <button class="expl-nav-btn expl-nav-btn--active" data-target="dashboard">Dashboard</button>
      <button class="expl-nav-btn" data-target="alunos">Alunos</button>
      <button class="expl-nav-btn" data-target="calendario">Calend√°rio</button>
      <button class="expl-nav-btn" data-target="faturacao">Fatura√ß√£o</button>
      <button class="expl-nav-btn" data-target="relatorios">Relat√≥rios</button>
    </nav>

    <button id="btnLogout" class="button" style="margin-left:auto; display:none">Sair</button>
  </div>
</header>

<div class="capa__overlay"></div>

<main class="auth">

  <!-- ========== LOGIN DO EXPLICADOR ========== -->
  <section class="auth__panel" id="explLogin">
    <h1>Entrar (Explicador)</h1>
    <p class="auth__hint">Use as credenciais de professor para aceder ao painel.</p>
    <form id="fExplLogin" class="auth__form" autocomplete="on">
      <input type="email"   name="email"    placeholder="Email"    required />
      <input type="password"name="password" placeholder="Password" required />
      <button class="button" type="submit">Entrar</button>
      <div id="msgExplLogin" class="auth__msg"></div>
    </form>
  </section>

  <!-- ========== PAINEL DO EXPLICADOR (FULL PAGE) ========== -->
  <section id="explPanel" class="expl-shell" style="display:none">
    <!-- NAV LATERAL PRINCIPAL -->
    <nav id="explSidebarNav" class="expl-sidebar-nav" style="display:none">
      <button class="expl-nav-btn expl-nav-btn--active" data-target="dashboard">
        Dashboard
      </button>
      <button class="expl-nav-btn" data-target="alunos">Alunos</button>
      <button class="expl-nav-btn" data-target="calendario">Calend√°rio</button>
      <button class="expl-nav-btn" data-target="faturacao">Fatura√ß√£o</button>
      <button class="expl-nav-btn" data-target="relatorios">Relat√≥rios</button>
    </nav>

    <!-- CONTE√öDO PRINCIPAL -->
    <div class="expl-main">
      <!-- Top bar com sauda√ß√£o + utilizador (est√° escondida no CSS) -->
      <header class="expl-header-bar">
        <div class="expl-header-info">
          <h1 class="expl-page-title">Dashboard</h1>
          <p class="expl-hello-sub">
            Bem-vindo, <span id="expl-nome-header">Professor</span>
          </p>
        </div>

        <div class="expl-header-user">
          <button class="expl-bell" aria-label="Notifica√ß√µes">
            <span class="expl-bell-icon">üîî</span>
            <span class="expl-bell-badge" id="expl-notif-count">0</span>
          </button>
          <div class="expl-header-avatar">
            <div class="expl-avatar-circle">E</div>
            <div class="expl-header-name">
              <p id="expl-nome-mini">Professor</p>
              <span>Explicador</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Conte√∫do scroll√°vel -->
      <div class="expl-body">
        <!-- RESUMO FINANCEIRO -->
        <section class="expl-section">
          <h2 class="expl-section-title">Resumo financeiro</h2>

          <div class="expl-kpi-grid">
            <article class="expl-card expl-kpi-card">
              <p class="expl-kpi-label">Fatura√ß√£o prevista (m√™s atual)</p>
              <p class="expl-kpi-value" id="card-total-previsto">‚Äî</p>
            </article>

            <article class="expl-card expl-kpi-card">
              <p class="expl-kpi-label">Fatura√ß√£o realizada (m√™s atual)</p>
              <p class="expl-kpi-value expl-kpi-value--green" id="card-total-mes">‚Äî</p>
            </article>

            <article class="expl-card expl-kpi-card">
              <p class="expl-kpi-label">Pagamentos pendentes</p>
              <p class="expl-kpi-value expl-kpi-value--red" id="card-pendentes">‚Äî</p>
            </article>
          </div>
        </section>

        <!-- ALUNOS + QUOTA -->
        <section class="expl-section" id="expl-sec-alunos">
          <div class="expl-section-header">
            <h2 class="expl-section-title">Alunos <span class="expl-section-sub">(ativos)</span></h2>
            <button class="expl-link-button" type="button" id="btn-scroll-lista">
              Ver lista &rarr;
            </button>
          </div>

          <div class="expl-grid-2">
            <!-- Quota + a√ß√µes -->
            <div class="expl-card">
              <h3 class="expl-subsection-title">Quota de alunos</h3>
              <div class="expl-quota">
                <p><strong>Limite:</strong> <span id="limite">‚Äî</span></p>
                <p><strong>Ativos:</strong> <span id="contagem">0</span></p>
                <p><strong>Restantes:</strong> <span id="restantes">‚Äî</span></p>
              </div>

              <h3 class="expl-subsection-title" style="margin-top:1rem;">A√ß√µes r√°pidas</h3>
              <div class="expl-actions-row">
                <button class="button secondary" type="button" id="btn-open-add-aluno">
                  + Adicionar aluno
                </button>
              </div>
            </div>

            <!-- Lista de alunos -->
            <div class="expl-card" id="lista-alunos-card">
              <h3 class="expl-subsection-title">Lista de alunos</h3>
              <div class="table-wrapper">
                <table class="table" id="tblAlunos">
                  <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Ano</th>
                  </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Painel de detalhes do aluno (aparece ao clicar numa linha) -->
          <div class="expl-card expl-aluno-detail" id="aluno-detail-card" style="margin-top:1.5rem; display:none">
            <h3 class="expl-subsection-title">
              Detalhes do aluno:
              <span id="aluno-detail-nome" class="expl-aluno-detail__nome">‚Äî</span>
            </h3>

            <p id="aluno-detail-meta" class="expl-aluno-detail__meta"></p>

            <div class="expl-grid-2">
              <div>
                <h4 class="expl-subsection-title">Informa√ß√£o b√°sica</h4>
                <ul class="expl-detail-list">
                  <li><strong>Email:</strong> <span id="aluno-detail-email">‚Äî</span></li>
                  <li><strong>Telem√≥vel:</strong> <span id="aluno-detail-tel">‚Äî</span></li>
                  <li><strong>Ano:</strong> <span id="aluno-detail-ano">‚Äî</span></li>
                  <li><strong>Valor explica√ß√£o:</strong> <span id="aluno-detail-valor">‚Äî</span></li>
                  <li><strong>Sess√µes / m√™s:</strong> <span id="aluno-detail-sessoes">‚Äî</span></li>
                </ul>

                <div class="expl-actions-row" style="margin-top:1rem;">
                  <button class="button secondary" type="button" id="btn-iniciar-faturacao">
                    Iniciar fatura√ß√£o
                  </button>
                  <button class="button secondary" type="button" id="btn-registar-pagamento">
                    Registar pagamento
                  </button>
                  <button class="button secondary" type="button" id="btn-editar-pagamento">
                    Editar pagamento
                  </button>
                  <button class="button" type="button" id="btn-editar-aluno">
                    Editar aluno
                  </button>
                </div>
              </div>

              <div>
                <h4 class="expl-subsection-title">Resumo de mensalidades</h4>
                <ul class="expl-detail-list">
                  <li><strong>Valor previsto (m√™s atual):</strong> <span id="aluno-detail-previsto-mes">‚Äî</span></li>
                  <li><strong>Valor pago (m√™s atual):</strong> <span id="aluno-detail-pago-mes">‚Äî</span></li>
                  <li><strong>Em falta (total):</strong> <span id="aluno-detail-emfalta">‚Äî</span></li>
                </ul>
              </div>
            </div>

            <!-- Sess√µes do aluno -->
            <div class="expl-subsection" style="margin-top:1.5rem;">
              <div class="expl-section-header" style="margin-bottom:0.5rem;">
                <h4 class="expl-subsection-title">Sess√µes de explica√ß√£o</h4>
                <button class="button secondary" type="button" id="btn-add-sessao">
                  + Adicionar sess√£o
                </button>
              </div>

              <div class="table-wrapper">
                <table class="table" id="tblSessoesAluno">
                  <thead>
                  <tr>
                    <th>Data</th>
                    <th>In√≠cio</th>
                    <th>Fim</th>
                    <th>Dura√ß√£o (min)</th>
                    <th>Estado</th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr>
                    <td colspan="5">Ainda n√£o existem sess√µes registadas para este aluno.</td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </section>

        <!-- RESUMO MENSALIDADES -->
        <section class="expl-section">
          <div class="expl-grid-2" style="margin-top:1.5rem;">
            <article class="expl-card">
              <h3 class="expl-subsection-title">
                Mensalidades em falta (m√™s atual)
              </h3>
              <div class="table-wrapper">
                <table class="table" id="tblMensalidadesPendentes">
                  <thead>
                  <tr>
                    <th>Aluno</th>
                    <th>M√™s</th>
                    <th>Previsto (‚Ç¨)</th>
                    <th>Pago (‚Ç¨)</th>
                    <th>Em falta (‚Ç¨)</th>
                    <th>Estado</th>
                    <th>Avisado</th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr>
                    <td colspan="7">Ainda n√£o existem mensalidades em falta neste m√™s.</td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </article>

            <article class="expl-card">
              <h3 class="expl-subsection-title">
                Mensalidades pagas (m√™s atual)
              </h3>
              <div class="table-wrapper">
                <table class="table" id="tblMensalidadesPagas">
                  <thead>
                  <tr>
                    <th>Aluno</th>
                    <th>M√™s</th>
                    <th>Pago (‚Ç¨)</th>
                    <th>Previsto (‚Ç¨)</th>
                    <th>Estado</th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr>
                    <td colspan="5">Ainda n√£o existem mensalidades pagas neste m√™s.</td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </article>
          </div>
        </section>

        <!-- CALEND√ÅRIO + RELAT√ìRIOS -->
        <section class="expl-section expl-grid-2" id="expl-sec-outros">
          <!-- CART√ÉO: CALEND√ÅRIO -->
          <article id="expl-sec-calendario" class="expl-card expl-placeholder-card">
            <h2 class="expl-section-title">Calend√°rio</h2>
            <p class="expl-section-sub">Pr√≥ximas explica√ß√µes agendadas.</p>

            <ul class="expl-feature-list">
              <li>
                <span class="expl-feature-label">Hoje</span>
                <span class="expl-feature-value" id="cal-resumo-hoje">
                  Assim que tiveres sess√µes marcadas para hoje, elas aparecem aqui.
                </span>
              </li>
              <li>
                <span class="expl-feature-label">Pr√≥ximos 7 dias</span>
                <span class="expl-feature-value" id="cal-resumo-semana">
                  Usa o calend√°rio para garantir que tens a semana equilibrada.
                </span>
              </li>
              <li>
                <span class="expl-feature-label">Sugest√£o</span>
                <span class="expl-feature-value">
                  Regista sempre as sess√µes logo que combinas o hor√°rio com o aluno.
                </span>
              </li>
            </ul>

            <button type="button" class="expl-link-chip">
              <span class="expl-link-chip-icon">üìÖ</span>
              <span>Ir para o calend√°rio de explica√ß√µes</span>
            </button>
          </article>

          <!-- CART√ÉO: RELAT√ìRIOS -->
          <article id="expl-sec-relatorios" class="expl-card expl-placeholder-card">
            <h2 class="expl-section-title">Relat√≥rios</h2>
            <p class="expl-section-sub">Estat√≠sticas e an√°lises da tua atividade.</p>

            <ul class="expl-feature-list">
              <li>
                <span class="expl-feature-label">Resumo mensal</span>
                <span class="expl-feature-value" id="rel-resumo-mensal">
                  Acompanha num s√≥ local mensalidades pagas, em falta e total faturado.
                </span>
              </li>
              <li>
                <span class="expl-feature-label">Tend√™ncia anual</span>
                <span class="expl-feature-value" id="rel-tendencia-anual">
                  V√™ a evolu√ß√£o da fatura√ß√£o ao longo do ano lectivo e identifica √©pocas fortes.
                </span>
              </li>
              <li>
                <span class="expl-feature-label">Alunos ativos</span>
                <span class="expl-feature-value" id="rel-alunos-ativos">
                  Controla rapidamente quantos alunos acompanhas e como evolui a tua carteira.
                </span>
              </li>
            </ul>

            <button type="button" class="expl-link-chip">
              <span class="expl-link-chip-icon">üìà</span>
              <span>Ver gr√°ficos e relat√≥rios (brevemente)</span>
            </button>
          </article>
        </section>


      </div>

      <!-- Bot√£o flutuante para novo aluno -->
      <button class="expl-fab" id="btn-add-aluno" type="button">+</button>
    </div>
  </section>

</main>

<footer>¬© <span id="y"></span> EduSphere</footer>

<!-- ========== MODAL: ADICIONAR ALUNO ========== -->
<div class="modal" id="modal-add-aluno">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2>Novo aluno</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint">Preencha os dados do aluno para criar a conta de acesso.</p>
    <form id="fNewAluno" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input name="nome" placeholder="Nome do aluno" required />
        <input name="apelido" placeholder="Apelido (opcional)" />

        <input name="telemovel" placeholder="Telem√≥vel (opcional)" />
        <input type="number" name="ano" placeholder="Ano de escolaridade" />

        <input type="number" name="idade" placeholder="Idade (opcional)" />

        <input name="dia_semana_preferido" placeholder="Dia preferido (ex.: Segunda)" />

        <input type="number" step="0.01" name="valor_explicacao" placeholder="Valor por explica√ß√£o (‚Ç¨)" />
        <input type="number" name="sessoes_mes" placeholder="Sess√µes por m√™s" />

        <input name="nome_pai_cache" placeholder="Nome do encarregado de educa√ß√£o" />
        <input name="contacto_pai_cache" placeholder="Contacto do encarregado" />

        <input type="email" name="email" placeholder="Email (login do aluno)" required />
        <input name="username" placeholder="Username (opcional)" />

        <input type="password" name="password" placeholder="Password" minlength="6" required />
      </div>

      <button id="btnCreateAluno" class="button" type="submit">Criar Aluno</button>
      <div id="msgNewAluno" class="auth__msg"></div>
    </form>
  </div>
</div>

<!-- ========== MODAL: EDITAR ALUNO ========== -->
<div class="modal" id="modal-edit-aluno">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2>Editar aluno</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint">Atualize os dados do aluno.</p>
    <form id="fEditAluno" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input name="nome_edit" placeholder="Nome do aluno" required />
        <input name="apelido_edit" placeholder="Apelido (opcional)" />

        <input name="telemovel_edit" placeholder="Telem√≥vel (opcional)" />
        <input type="number" name="ano_edit" placeholder="Ano de escolaridade" />

        <input type="number" name="idade_edit" placeholder="Idade (opcional)" />

        <input name="dia_semana_preferido_edit" placeholder="Dia preferido (ex.: Segunda)" />

        <input type="number" step="0.01" name="valor_explicacao_edit" placeholder="Valor por explica√ß√£o (‚Ç¨)" />
        <input type="number" name="sessoes_mes_edit" placeholder="Sess√µes por m√™s" />

        <input name="nome_pai_cache_edit" placeholder="Nome do encarregado de educa√ß√£o" />
        <input name="contacto_pai_cache_edit" placeholder="Contacto do encarregado" />

        <input type="email" name="email_edit" placeholder="Email (login do aluno)" required />
        <input name="username_edit" placeholder="Username (opcional)" />

        <input type="password" name="password_edit" placeholder="Nova password (opcional)" minlength="6" />
      </div>

      <button id="btnSaveEditAluno" class="button" type="submit">Guardar altera√ß√µes</button>
      <div id="msgEditAluno" class="auth__msg"></div>
    </form>
  </div>
</div>

<!-- ========== MODAL: SESS√ÉO (ADICIONAR / EDITAR) ========== -->
<div class="modal" id="modal-sessao">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2>Sess√£o de explica√ß√£o</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint">Registe ou edite uma sess√£o deste aluno.</p>
    <form id="fSessao" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input type="date" name="data_sessao" placeholder="Data" required />
        <input type="time" name="hora_inicio" placeholder="Hora in√≠cio (opcional)" />

        <input type="time" name="hora_fim" placeholder="Hora fim (opcional)" />
        <input type="number" name="duracao_min" placeholder="Dura√ß√£o (min, opcional)" />

        <select name="estado">
          <option value="AGENDADA">Agendada</option>
          <option value="REALIZADA">Realizada</option>
          <option value="FALTOU">Faltou</option>
          <option value="CANCELADA">Cancelada</option>
        </select>

        <input name="observacoes" placeholder="Observa√ß√µes (opcional)" />
      </div>

      <div class="expl-actions-row" style="margin-top:0.75rem;">
        <button id="btnSaveSessao" class="button" type="submit">Guardar sess√£o</button>
        <button id="btnDeleteSessao" class="button secondary" type="button" style="display:none;">
          Apagar sess√£o
        </button>
      </div>

      <div id="msgSessao" class="auth__msg"></div>
    </form>
  </div>
</div>

<!-- ========== MODAL: PAGAMENTO ALUNO ========== -->
<div class="modal" id="modal-pagamento-aluno">
  <div class="modal__backdrop" data-modal-close></div>
  <div class="modal__dialog">
    <div class="modal__header">
      <h2 id="pag-modal-title">Registar pagamento</h2>
      <button class="modal__close" type="button" data-modal-close>&times;</button>
    </div>
    <p class="auth__hint" id="pag-modal-hint">
      Preencha os dados do pagamento deste aluno.
    </p>

    <form id="fPagamentoAluno" class="auth__form" style="margin-bottom:12px;">
      <div class="grid2">
        <input type="number" name="ano" placeholder="Ano" required />
        <input type="number" name="mes" placeholder="M√™s (1-12)" min="1" max="12" required />

        <!-- s√≥ usado em INICIAR -->
        <input type="number" name="dia_pagamento"
               placeholder="Dia de pagamento (1-31)"
               min="1" max="31"
               style="display:none;" />

        <!-- usado em REGISTAR / EDITAR -->
        <input type="number" step="0.01" name="valor"
               placeholder="Valor (‚Ç¨)" style="display:none;" />
      </div>

      <input type="hidden" name="modo" value="registar" />

      <button id="btnSavePagamento" class="button" type="submit">
        Guardar
      </button>
      <div id="msgPagamentoAluno" class="auth__msg"></div>
    </form>
  </div>
</div>


<script>
  // ---------- helper DOM ----------
  const $ = (s) => document.querySelector(s);

  // Pagamento modal refs
  const modalPag        = $('#modal-pagamento-aluno');
  const formPag         = $('#fPagamentoAluno');
  const msgPag          = $('#msgPagamentoAluno');
  const btnSavePag      = $('#btnSavePagamento');
  const pagModalTitle   = $('#pag-modal-title');
  const pagModalHint    = $('#pag-modal-hint');
  const inputAno        = formPag ? formPag.ano : null;
  const inputMes        = formPag ? formPag.mes : null;
  const inputDiaPag     = formPag ? formPag.dia_pagamento : null;
  const inputValor      = formPag ? formPag.valor : null;

  const elYear      = $('#y');
  const btnLogout   = $('#btnLogout');
  const headerNav   = $('#explSidebarNav');
  const loginBox    = $('#explLogin');
  const panel       = $('#explPanel');
  const msgLogin    = $('#msgExplLogin');
  const formLogin   = $('#fExplLogin');

  const tblBody     = $('#tblAlunos tbody');
  const elLimite    = $('#limite');
  const elContagem  = $('#contagem');
  const elRestantes = $('#restantes');

  const elNomeHeader = $('#expl-nome-header');
  const elNomeMini   = $('#expl-nome-mini');

  const btnFab          = $('#btn-add-aluno');
  const btnOpenAddAluno = $('#btn-open-add-aluno');
  const btnScrollLista  = $('#btn-scroll-lista');

  const modalAddAluno   = $('#modal-add-aluno');
  const formNew         = $('#fNewAluno');
  const msgNewAluno     = $('#msgNewAluno');
  const btnCreate       = $('#btnCreateAluno');

  const modalEditAluno  = $('#modal-edit-aluno');
  const formEdit        = $('#fEditAluno');
  const msgEditAluno    = $('#msgEditAluno');
  const btnSaveEdit     = $('#btnSaveEditAluno');
  const btnEditarAluno  = $('#btn-editar-aluno');

  const btnIniciarFat   = $('#btn-iniciar-faturacao');
  const btnRegistarPag  = $('#btn-registar-pagamento');
  const btnEditarPag    = $('#btn-editar-pagamento');

  const modalSessao     = $('#modal-sessao');
  const formSessao      = $('#fSessao');
  const msgSessao       = $('#msgSessao');
  const btnSaveSessao   = $('#btnSaveSessao');
  const btnDeleteSessao = $('#btnDeleteSessao');
  const btnAddSessao    = $('#btn-add-sessao');
  const tblSessoesBody  = $('#tblSessoesAluno tbody');

  elYear.textContent = new Date().getFullYear();

  let EXPLICADOR       = { userId:null, id_explicador:null, max:0 };
  let ALUNOS_CACHE     = [];
  let PAGAMENTOS_CACHE = [];
  let ALUNO_ATUAL      = null;
  let SESSAO_ATUAL_ID  = null;

  // ---------- helpers supabase ----------
  async function hasRole(uid, roleName){
    const { data, error } = await supabase
      .from('app_users')
      .select('role')
      .eq('user_id', uid)
      .eq('role', roleName)
      .maybeSingle();
    if (error) {
      console.error('hasRole error', error);
      return false;
    }
    return !!data;
  }

  async function getExplRow(uid){
    const { data, error } = await supabase
      .from('explicadores')
      .select('id_explicador, nome, apelido, max_alunos')
      .eq('user_id', uid)
      .maybeSingle();
    if (error) throw error;
    return data || null;
  }

  function setState({ loading=false, isExpl=false, isAuthed=false }){
    if (loading){
      loginBox.style.display = 'block';
      panel.style.display    = 'none';
      msgLogin.textContent   = 'A verificar sess√£o...';
      btnLogout.style.display = 'none';
      headerNav.style.display = 'none';
      return;
    }
    if (isAuthed && isExpl){
      loginBox.style.display = 'none';
      panel.style.display    = 'flex';
      msgLogin.textContent   = '';
      btnLogout.style.display= 'inline-block';
      headerNav.style.display= 'flex';
      document.querySelector('main.auth').style.display = 'block';
    } else {
      loginBox.style.display = 'block';
      panel.style.display    = 'none';
      btnLogout.style.display= 'none';
      headerNav.style.display= 'none';
      document.querySelector('main.auth').style.display = 'grid';
    }
  }

  // ---------- QUOTA UI ----------
  function updateQuotaUI(total){
    const max = Number(EXPLICADOR.max || 0);
    elContagem.textContent = String(total);

    if (!max){
      elLimite.textContent    = 'Sem limite';
      elRestantes.textContent = '‚Äî';
      btnCreate && (btnCreate.disabled = false);
      return;
    }
    elLimite.textContent = String(max);
    const rest = Math.max(0, max - total);
    elRestantes.textContent = String(rest);
    if (btnCreate){
      btnCreate.disabled = rest <= 0;
      btnCreate.title    = rest <= 0 ? 'Limite de alunos atingido.' : '';
    }
  }

  // ---------- LISTAR ALUNOS ----------
  async function loadAlunos() {
    const { data, error } = await supabase.functions.invoke("expl-alunos", {
      body: { action: "list_alunos" },
    });

    if (error) {
      console.error("loadAlunos error", error);
      tblBody.innerHTML =
        '<tr><td colspan="3">Erro a carregar alunos.</td></tr>';
      updateQuotaUI(0);
      return;
    }

    if (!data || !data.length) {
      tblBody.innerHTML =
        '<tr><td colspan="3">Sem alunos ainda.</td></tr>';
      ALUNOS_CACHE = [];
      updateQuotaUI(0);
      return;
    }

    ALUNOS_CACHE = data;

    tblBody.innerHTML = data
      .map((a) => {
        const nome = [a.nome, a.apelido].filter(Boolean).join(" ");

        return `
          <tr class="linha-aluno" data-id-aluno="${a.id_aluno}">
            <td>${nome || "-"}</td>
            <td>${a.email ?? "-"}</td>
            <td>${a.ano ?? "-"}</td>
          </tr>
        `;
      })
      .join("");

    updateQuotaUI(data.length);

    tblBody
      .querySelectorAll("tr.linha-aluno")
      .forEach((row) => {
        row.addEventListener("click", () => {
          const idAluno = row.dataset.idAluno;
          const aluno = ALUNOS_CACHE.find((a) => String(a.id_aluno) === String(idAluno));
          if (aluno) {
            mostrarPainelAluno(aluno);
          }
        });
      });
  }

  // ---------- RESUMO MENSAL ----------
  function renderResumoMensal() {
    const tbodyPend = document.querySelector("#tblMensalidadesPendentes tbody");
    const tbodyPagas = document.querySelector("#tblMensalidadesPagas tbody");

    if (!tbodyPend || !tbodyPagas) return;

    const now = new Date();
    const anoAtual = now.getFullYear();
    const mesAtual = now.getMonth() + 1;

    const nomesMeses = [
      "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
      "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro",
    ];
    const mesLabel = nomesMeses[mesAtual - 1] || String(mesAtual);

    const pendentes = [];
    const pagas = [];

    let totalPrevistoPend = 0;
    let totalFaltaPend = 0;
    let totalPagoPagas = 0;
    let totalPrevistoPagas = 0;

    (PAGAMENTOS_CACHE || []).forEach((p) => {
      if (p.ano !== anoAtual || p.mes !== mesAtual) return;

      const previsto = Number(p.valor_previsto) || 0;
      const pago = Number(p.valor_pago) || 0;
      const falta = Math.max(previsto - pago, 0);

      if (previsto === 0 && pago === 0) return;

      const avisadoLabel = "‚Äî";

      if (falta > 0) {
        pendentes.push({
          aluno: p.aluno_nome || "Aluno",
          previsto,
          pago,
          falta,
          estado: p.estado || "",
          mes: mesLabel,
          avisado: avisadoLabel,
        });
        totalPrevistoPend += previsto;
        totalFaltaPend += falta;
      } else {
        pagas.push({
          aluno: p.aluno_nome || "Aluno",
          previsto,
          pago,
          estado: p.estado || "",
          mes: mesLabel,
        });
        totalPagoPagas += pago;
        totalPrevistoPagas += previsto;
      }
    });

    // Tabela de pendentes
    if (!pendentes.length) {
      tbodyPend.innerHTML =
        '<tr><td colspan="7">Ainda n√£o existem mensalidades em falta neste m√™s.</td></tr>';
    } else {
      const rowsPend = pendentes
        .map(
          (r) => `
        <tr>
          <td>${r.aluno}</td>
          <td>${r.mes}</td>
          <td>‚Ç¨ ${r.previsto.toFixed(2)}</td>
          <td>‚Ç¨ ${r.pago.toFixed(2)}</td>
          <td>‚Ç¨ ${r.falta.toFixed(2)}</td>
          <td>${r.estado}</td>
          <td>${r.avisado}</td>
        </tr>
      `
        )
        .join("");

      const totalRow = `
      <tr>
        <td><strong>Total</strong></td>
        <td>${mesLabel}</td>
        <td><strong>‚Ç¨ ${totalPrevistoPend.toFixed(2)}</strong></td>
        <td></td>
        <td><strong>‚Ç¨ ${totalFaltaPend.toFixed(2)}</strong></td>
        <td colspan="2"></td>
      </tr>
    `;

      tbodyPend.innerHTML = rowsPend + totalRow;
    }

    // Tabela de pagas
    if (!pagas.length) {
      tbodyPagas.innerHTML =
        '<tr><td colspan="5">Ainda n√£o existem mensalidades pagas neste m√™s.</td></tr>';
    } else {
      const rowsPagas = pagas
        .map(
          (r) => `
        <tr>
          <td>${r.aluno}</td>
          <td>${r.mes}</td>
          <td>‚Ç¨ ${r.pago.toFixed(2)}</td>
          <td>‚Ç¨ ${r.previsto.toFixed(2)}</td>
          <td>${r.estado}</td>
        </tr>
      `
        )
        .join("");

      const totalRowPagas = `
      <tr>
        <td><strong>Total</strong></td>
        <td>${mesLabel}</td>
        <td><strong>‚Ç¨ ${totalPagoPagas.toFixed(2)}</strong></td>
        <td><strong>‚Ç¨ ${totalPrevistoPagas.toFixed(2)}</strong></td>
        <td></td>
      </tr>
    `;

      tbodyPagas.innerHTML = rowsPagas + totalRowPagas;
    }
  }

  // ---------- RELAT√ìRIOS: RESUMOS NO CART√ÉO ----------
  function updateResumoRelatorios({
    previstoMesAtual = 0,
    realizadoMesAtual = 0,
    pendenteTotal = 0,
    previstoAnoAtual = 0,
    realizadoAnoAtual = 0,
    nAlunosAtivos = 0,
  } = {}) {
    const elMensal   = document.querySelector('#rel-resumo-mensal');
    const elTend     = document.querySelector('#rel-tendencia-anual');
    const elAlunos   = document.querySelector('#rel-alunos-ativos');

    if (elMensal) {
      elMensal.textContent =
        `Este m√™s: ‚Ç¨ ${realizadoMesAtual.toFixed(2)} recebidos ` +
        `de ‚Ç¨ ${previstoMesAtual.toFixed(2)} previstos ¬∑ ` +
        `‚Ç¨ ${pendenteTotal.toFixed(2)} em falta.`;
    }

    if (elTend) {
      elTend.textContent =
        `Ano atual: ‚Ç¨ ${realizadoAnoAtual.toFixed(2)} faturados ` +
        `de ‚Ç¨ ${previstoAnoAtual.toFixed(2)} previstos.`;
    }

    if (elAlunos) {
      if (nAlunosAtivos <= 0) {
        elAlunos.textContent = "Ainda n√£o tens alunos ativos registados.";
      } else if (nAlunosAtivos === 1) {
        elAlunos.textContent = "A acompanhar 1 aluno ativo.";
      } else {
        elAlunos.textContent = `A acompanhar ${nAlunosAtivos} alunos ativos.`;
      }
    }
  }

  // ---------- KPI financeiros ----------
  async function loadKpisFinanceiros() {
    if (!EXPLICADOR.id_explicador) return;

    const cardTotalPrev = document.getElementById("card-total-previsto");
    const cardTotalMes  = document.getElementById("card-total-mes");
    const cardPendentes = document.getElementById("card-pendentes");

    try {
      const { data, error } = await supabase
        .from("v_pagamentos_detalhe")
        .select("ano, mes, id_aluno, aluno_nome, valor_previsto, valor_pago, estado")
        .eq("id_explicador", EXPLICADOR.id_explicador);

      if (error) {
        console.error("Erro a carregar KPI financeiros", error);
        return;
      }

      PAGAMENTOS_CACHE = data || [];

      const now = new Date();
      const anoAtual = now.getFullYear();
      const mesAtual = now.getMonth() + 1;

      let previstoMesAtual    = 0;
      let realizadoMesAtual   = 0;
      let previstoAnoAtual    = 0;
      let realizadoAnoAtual   = 0;
      let pendenteTotal       = 0;
      const alunosComPendencias = new Set();

      (PAGAMENTOS_CACHE).forEach((p) => {
        const previsto = Number(p.valor_previsto) || 0;
        const pago     = Number(p.valor_pago) || 0;
        const falta    = Math.max(previsto - pago, 0);

        if (p.ano === anoAtual) {
          previstoAnoAtual  += previsto;
          realizadoAnoAtual += pago;
        }

        if (p.ano === anoAtual && p.mes === mesAtual) {
          previstoMesAtual  += previsto;
          realizadoMesAtual += pago;
        }

        pendenteTotal += falta;
        if (falta > 0 && p.id_aluno) {
          alunosComPendencias.add(p.id_aluno);
        }
      });

      if (cardTotalPrev) {
        cardTotalPrev.textContent = `‚Ç¨ ${previstoMesAtual.toFixed(2)}`;
      }

      if (cardTotalMes) {
        cardTotalMes.textContent =
          `‚Ç¨ ${realizadoMesAtual.toFixed(2)} de ‚Ç¨ ${previstoMesAtual.toFixed(2)}`;
      }

      if (cardPendentes) {
        const nAlunosPend = alunosComPendencias.size;
        const labelAlunos =
          nAlunosPend === 0
            ? "Nenhum aluno em falta"
            : nAlunosPend === 1
            ? "1 aluno em falta"
            : `${nAlunosPend} alunos em falta`;

        cardPendentes.textContent =
          `‚Ç¨ ${pendenteTotal.toFixed(2)} (${labelAlunos})`;
      }

      // Atualiza o cart√£o "Relat√≥rios" com base nos mesmos dados
      const nAlunosAtivos = (ALUNOS_CACHE || []).filter(a => a.is_active !== false).length;
      updateResumoRelatorios({
        previstoMesAtual,
        realizadoMesAtual,
        pendenteTotal,
        previstoAnoAtual,
        realizadoAnoAtual,
        nAlunosAtivos,
      });

      renderResumoMensal();
    } catch (err) {
      console.error("Erro inesperado em loadKpisFinanceiros", err);
    }
  }

  // ---------- CARREGAR SESS√ïES DO ALUNO ----------
  async function loadSessoesAluno(alunoId) {
    if (!tblSessoesBody) return;

    tblSessoesBody.innerHTML =
      '<tr><td colspan="5">A carregar sess√µes...</td></tr>';

    const { data, error } = await supabase.functions.invoke("expl-alunos", {
      body: {
        action: "list_sessoes_aluno",
        payload: { aluno_id: alunoId },
      },
    });

    if (error) {
      console.error("list_sessoes_aluno error", error);
      tblSessoesBody.innerHTML =
        '<tr><td colspan="5">Erro ao carregar sess√µes.</td></tr>';
      return;
    }

    if (!data || !data.length) {
      tblSessoesBody.innerHTML =
        '<tr><td colspan="5">Ainda n√£o existem sess√µes registadas para este aluno.</td></tr>';
      return;
    }

    tblSessoesBody.innerHTML = data
      .map((s) => {
        const dataLabel = s.data || "‚Äî";
        const hIni = s.hora_inicio || "‚Äî";
        const hFim = s.hora_fim || "‚Äî";
        const dur = s.duracao_min != null ? s.duracao_min : "‚Äî";
        const est = s.estado || "‚Äî";

        return `
          <tr class="linha-sessao" data-id-sessao="${s.id_sessao}">
            <td>${dataLabel}</td>
            <td>${hIni}</td>
            <td>${hFim}</td>
            <td>${dur}</td>
            <td>${est}</td>
          </tr>
        `;
      })
      .join("");

    // clicar para editar
    tblSessoesBody.querySelectorAll("tr.linha-sessao").forEach((row) => {
      row.addEventListener("click", () => {
        const idSessao = row.dataset.idSessao;
        const sessao = (data || []).find(
          (s) => String(s.id_sessao) === String(idSessao),
        );
        if (sessao) {
          abrirModalSessao(sessao);
        }
      });
    });
  }

  // ---------- OPEN/CLOSE MODAL ----------
  function openModal(mod){ mod && mod.classList.add('open'); }
  function closeModal(mod){ mod && mod.classList.remove('open'); }

  // ---------- MODAL PAGAMENTO: ABRIR ----------
  function abrirModalPagamento(modo) {
    if (!formPag) return;
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      alert("Seleciona primeiro um aluno na lista.");
      return;
    }

    const agora = new Date();

    inputAno.value = String(agora.getFullYear());
    inputMes.value = String(agora.getMonth() + 1);
    inputDiaPag.value = "";
    inputValor.value = "";

    formPag.modo.value = modo;
    msgPag.textContent = "";
    msgPag.style.color = "";

    inputDiaPag.style.display = "none";
    inputValor.style.display = "none";

    if (modo === "iniciar") {
      pagModalTitle.textContent = "Iniciar fatura√ß√£o";
      pagModalHint.textContent  =
        "Defina o m√™s/ano de in√≠cio e o dia de pagamento da mensalidade.";
      inputDiaPag.style.display = "block";
      btnSavePag.textContent    = "Iniciar fatura√ß√£o";

    } else if (modo === "registar") {
      pagModalTitle.textContent = "Registar pagamento";
      pagModalHint.textContent  =
        "Regista um pagamento a acrescentar ao valor j√° pago nesse m√™s.";
      inputValor.style.display  = "block";
      btnSavePag.textContent    = "Registar pagamento";

    } else { // "editar"
      pagModalTitle.textContent = "Editar pagamento";
      pagModalHint.textContent  =
        "Substitui o valor pago nesse m√™s pelo valor indicado.";
      inputValor.style.display  = "block";
      btnSavePag.textContent    = "Guardar altera√ß√µes";
    }

    openModal(modalPag);
  }

  btnIniciarFat?.addEventListener("click", () => abrirModalPagamento("iniciar"));
  btnRegistarPag?.addEventListener("click", () => abrirModalPagamento("registar"));
  btnEditarPag?.addEventListener("click", () => abrirModalPagamento("editar"));

  // Fechar modal pagamento
  $('#modal-pagamento-aluno .modal__close')?.addEventListener('click', () => {
    closeModal(modalPag);
  });
  modalPag?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalPag);
    }
  });

  // ---------- SUBMIT MODAL PAGAMENTO ----------
  formPag?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      msgPag.textContent = "Nenhum aluno selecionado.";
      return;
    }

    const modo  = formPag.modo.value; // iniciar | registar | editar
    const ano   = Number(inputAno.value);
    const mes   = Number(inputMes.value);
    const dia   = inputDiaPag.value ? Number(inputDiaPag.value) : null;
    const valor = inputValor.value ? Number(inputValor.value) : null;

    if (!ano || !mes || mes < 1 || mes > 12) {
      msgPag.textContent = "Ano ou m√™s inv√°lidos.";
      return;
    }

    if (modo === "iniciar") {
      if (!dia || dia < 1 || dia > 31) {
        msgPag.textContent = "Dia de pagamento inv√°lido.";
        return;
      }
    } else { // registar / editar
      if (valor === null || isNaN(valor) || valor < 0) {
        msgPag.textContent = "Valor inv√°lido.";
        return;
      }
    }

    btnSavePag.disabled = true;
    msgPag.textContent  = "A guardar...";

    try {
      let action, payload;

      if (modo === "iniciar") {
        action = "iniciar_faturacao_aluno";
        payload = {
          aluno_id: ALUNO_ATUAL.id_aluno,
          ano,
          mes,
          dia_pagamento: dia,
        };
      } else if (modo === "registar") {
        action = "registar_pagamento_aluno";
        payload = {
          aluno_id: ALUNO_ATUAL.id_aluno,
          ano,
          mes,
          valor,
        };
      } else {
        action = "update_pagamento_aluno";
        payload = {
          aluno_id: ALUNO_ATUAL.id_aluno,
          ano,
          mes,
          valor_pago: valor,
        };
      }

      const { data, error } = await supabase.functions.invoke("expl-alunos", {
        body: { action, payload },
      });

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro pagamento_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
              else extra = " " + raw;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        msgPag.textContent = "N√£o foi poss√≠vel guardar." + extra;
        btnSavePag.disabled = false;
        return;
      }

      msgPag.style.color = "#126b3a";
      msgPag.textContent = "Guardado com sucesso.";

      await loadKpisFinanceiros();
      const alunoAtualizado = ALUNOS_CACHE.find(
        (a) => String(a.id_aluno) === String(ALUNO_ATUAL.id_aluno)
      );
      if (alunoAtualizado) {
        await mostrarPainelAluno(alunoAtualizado);
      }

      setTimeout(() => closeModal(modalPag), 600);
    } catch (e) {
      console.error("pagamento_aluno error", e);
      msgPag.textContent = "Erro inesperado ao guardar.";
    } finally {
      btnSavePag.disabled = false;
    }
  });

  // ---------- Painel de detalhes por aluno ----------
  async function mostrarPainelAluno(aluno) {
    ALUNO_ATUAL = aluno;

    const card = document.getElementById("aluno-detail-card");
    if (!card) return;

    const nomeCompleto = [aluno.nome, aluno.apelido].filter(Boolean).join(" ");
    document.getElementById("aluno-detail-nome").textContent =
      nomeCompleto || "Aluno";

    document.getElementById("aluno-detail-meta").textContent =
      aluno.username ? `Username: ${aluno.username}` : "";

    document.getElementById("aluno-detail-email").textContent =
      aluno.email || "‚Äî";
    document.getElementById("aluno-detail-tel").textContent =
      aluno.telemovel || "‚Äî";
    document.getElementById("aluno-detail-ano").textContent =
      aluno.ano ?? "‚Äî";

    const valorExp =
      aluno.valor_explicacao != null
        ? `‚Ç¨ ${Number(aluno.valor_explicacao).toFixed(2)}`
        : "‚Äî";
    document.getElementById("aluno-detail-valor").textContent = valorExp;

    const sessoes =
      aluno.sessoes_mes != null ? String(aluno.sessoes_mes) : "‚Äî";
    document.getElementById("aluno-detail-sessoes").textContent = sessoes;

    card.style.display = "block";

    if (!EXPLICADOR.id_explicador) return;

    const elPrevistoMes = document.getElementById("aluno-detail-previsto-mes");
    const elPagoMes     = document.getElementById("aluno-detail-pago-mes");
    const elEmFalta     = document.getElementById("aluno-detail-emfalta");

    try {
      const now = new Date();
      const anoAtual = now.getFullYear();
      const mesAtual = now.getMonth() + 1;

      const { data, error } = await supabase
        .from("v_pagamentos_detalhe")
        .select("ano, mes, valor_previsto, valor_pago, estado")
        .eq("id_explicador", EXPLICADOR.id_explicador)
        .eq("id_aluno", aluno.id_aluno);

      if (error) {
        console.error("Erro a carregar pagamentos do aluno", error);
        if (elPrevistoMes) elPrevistoMes.textContent = "‚Äî";
        if (elPagoMes)     elPagoMes.textContent     = "‚Äî";
        if (elEmFalta)     elEmFalta.textContent     = "‚Äî";
        return;
      }

      let previstoMes = 0;
      let pagoMes     = 0;
      let emFaltaTotal = 0;

      (data || []).forEach((p) => {
        const previsto = Number(p.valor_previsto) || 0;
        const pago     = Number(p.valor_pago) || 0;
        const falta    = Math.max(previsto - pago, 0);

        if (p.ano === anoAtual && p.mes === mesAtual) {
          previstoMes += previsto;
          pagoMes     += pago;
        }

        emFaltaTotal += falta;
      });

      if ((!data || data.length === 0) &&
          aluno.valor_explicacao != null &&
          aluno.sessoes_mes != null) {

        const estimado = Number(aluno.valor_explicacao) * Number(aluno.sessoes_mes);
        previstoMes   = estimado;
        pagoMes       = 0;
        emFaltaTotal  = estimado;
      }

      if (elPrevistoMes) {
        elPrevistoMes.textContent = `‚Ç¨ ${previstoMes.toFixed(2)}`;
      }
      if (elPagoMes) {
        elPagoMes.textContent     = `‚Ç¨ ${pagoMes.toFixed(2)}`;
      }
      if (elEmFalta) {
        elEmFalta.textContent     = `‚Ç¨ ${emFaltaTotal.toFixed(2)}`;
      }
    } catch (err) {
      console.error("Erro inesperado ao calcular resumo do aluno", err);
    }

    await loadSessoesAluno(aluno.id_aluno);
  }

  // ---------- CRIAR ALUNO ----------
  async function createAluno(payload){
    const { data, error } = await supabase.functions.invoke("expl-alunos", {
      body: { action: "create_aluno", payload }
    });

    if (error) {
      console.error(error);
      return { ok:false, error: error.message };
    }

    return { ok: true, data };
  }

  // ---------- MODAIS (add / edit / sess√£o) ----------
  // adicionar aluno
  modalAddAluno?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalAddAluno);
    }
  });
  $('#modal-add-aluno .modal__close')?.addEventListener('click', () => {
    closeModal(modalAddAluno);
  });

  btnFab?.addEventListener('click', () => openModal(modalAddAluno));
  btnOpenAddAluno?.addEventListener('click', () => openModal(modalAddAluno));

  // editar aluno
  $('#modal-edit-aluno .modal__close')?.addEventListener('click', () => {
    closeModal(modalEditAluno);
  });
  modalEditAluno?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalEditAluno);
    }
  });

  // modal sess√£o
  $('#modal-sessao .modal__close')?.addEventListener('click', () => {
    closeModal(modalSessao);
  });
  modalSessao?.addEventListener('click', (ev) => {
    if (ev.target.hasAttribute('data-modal-close')) {
      closeModal(modalSessao);
    }
  });

  // ---------- PREENCHER MODAL DE EDI√á√ÉO DO ALUNO ----------
  function preencherModalEdicao(aluno) {
    if (!formEdit || !aluno) return;

    formEdit.nome_edit.value  = aluno.nome || "";
    formEdit.apelido_edit.value = aluno.apelido || "";
    formEdit.telemovel_edit.value = aluno.telemovel || "";
    formEdit.ano_edit.value = aluno.ano != null ? aluno.ano : "";
    formEdit.idade_edit.value = aluno.idade != null ? aluno.idade : "";
    formEdit.dia_semana_preferido_edit.value = aluno.dia_semana_preferido || "";
    formEdit.valor_explicacao_edit.value =
      aluno.valor_explicacao != null ? aluno.valor_explicacao : "";
    formEdit.sessoes_mes_edit.value =
      aluno.sessoes_mes != null ? aluno.sessoes_mes : "";
    formEdit.nome_pai_cache_edit.value = aluno.nome_pai_cache || "";
    formEdit.contacto_pai_cache_edit.value = aluno.contacto_pai_cache || "";
    formEdit.email_edit.value = aluno.email || "";
    formEdit.username_edit.value = aluno.username || "";
    formEdit.password_edit.value = "";
    msgEditAluno.textContent = "";
    msgEditAluno.style.color = "";
  }

  // abrir modal de edi√ß√£o ao clicar no bot√£o
  btnEditarAluno?.addEventListener("click", () => {
    if (!ALUNO_ATUAL) {
      alert("Seleciona primeiro um aluno na lista.");
      return;
    }
    preencherModalEdicao(ALUNO_ATUAL);
    openModal(modalEditAluno);
  });

  // ---------- SUBMIT EDITAR ALUNO ----------
  formEdit?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    msgEditAluno.textContent = "";

    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      msgEditAluno.textContent = "Nenhum aluno selecionado.";
      return;
    }

    const f = ev.target;

    const payload = {
      id_aluno: ALUNO_ATUAL.id_aluno,
      nome: f.nome_edit.value.trim() || null,
      apelido: f.apelido_edit.value.trim() || null,
      telemovel: f.telemovel_edit.value.trim() || null,
      ano: f.ano_edit.value ? Number(f.ano_edit.value) : null,
      idade: f.idade_edit.value ? Number(f.idade_edit.value) : null,
      dia_semana_preferido: f.dia_semana_preferido_edit.value.trim() || null,
      valor_explicacao: f.valor_explicacao_edit.value
        ? Number(f.valor_explicacao_edit.value)
        : null,
      sessoes_mes: f.sessoes_mes_edit.value
        ? Number(f.sessoes_mes_edit.value)
        : null,
      nome_pai_cache: f.nome_pai_cache_edit.value.trim() || null,
      contacto_pai_cache: f.contacto_pai_cache_edit.value.trim() || null,
      email: f.email_edit.value.trim() || null,
      username: f.username_edit.value.trim() || null,
      password: f.password_edit.value.trim() || undefined,
      is_active: true,
    };

    btnSaveEdit.disabled = true;
    msgEditAluno.textContent = "A guardar altera√ß√µes...";

    try {
      const { data, error } = await supabase.functions.invoke("expl-alunos", {
        body: {
          action: "update_aluno",
          payload,
        },
      });

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro update_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        msgEditAluno.textContent =
          "N√£o foi poss√≠vel guardar as altera√ß√µes." + extra;
        btnSaveEdit.disabled = false;
        return;
      }

      msgEditAluno.style.color = "#126b3a";
      msgEditAluno.textContent = "Altera√ß√µes guardadas com sucesso.";

      await loadAlunos();
      const alunoAtualizado = ALUNOS_CACHE.find(
        (a) => String(a.id_aluno) === String(ALUNO_ATUAL.id_aluno)
      );
      if (alunoAtualizado) {
        mostrarPainelAluno(alunoAtualizado);
      }

      setTimeout(() => {
        closeModal(modalEditAluno);
      }, 600);
    } catch (e) {
      console.error("update_aluno error", e);
      msgEditAluno.textContent = "Erro inesperado ao guardar altera√ß√µes.";
    } finally {
      btnSaveEdit.disabled = false;
    }
  });

  // ---------- SUBMIT NOVO ALUNO ----------
  formNew?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    msgNewAluno.textContent = "";

    if (!EXPLICADOR.id_explicador) {
      msgNewAluno.textContent = "Perfil de explicador inv√°lido.";
      return;
    }

    const f = ev.target;

    const payload = {
      nome: f.nome?.value.trim() || "",
      apelido: f.apelido?.value.trim() || null,
      telemovel: f.telemovel?.value.trim() || null,
      ano: f.ano?.value ? Number(f.ano.value) : null,
      idade: f.idade?.value ? Number(f.idade.value) : null,
      dia_semana_preferido: f.dia_semana_preferido?.value.trim() || null,
      valor_explicacao: f.valor_explicacao?.value
        ? Number(f.valor_explicacao.value)
        : null,
      sessoes_mes: f.sessoes_mes?.value
        ? Number(f.sessoes_mes.value)
        : null,
      nome_pai_cache: f.nome_pai_cache?.value.trim() || null,
      contacto_pai_cache: f.contacto_pai_cache?.value.trim() || null,
      email: f.email?.value.trim() || "",
      username: f.username?.value.trim() || null,
      password: f.password?.value || "",
      is_active: true,
    };

    if (!payload.nome || !payload.email || !payload.password) {
      msgNewAluno.textContent =
        "Preenche pelo menos Nome, Email e Password.";
      return;
    }

    btnCreate.disabled = true;
    msgNewAluno.textContent = "A criar aluno...";

    const { data, error } = await supabase.functions.invoke("expl-alunos", {
      body: { action: "create_aluno", payload },
    });

    if (error) {
      let extra = "";

      if (error.context) {
        try {
          const resp = error.context;
          const raw = await resp.text();
          console.log("Erro bruto da fun√ß√£o expl-alunos:", raw);

          try {
            const json = JSON.parse(raw);
            if (json?.error) {
              extra = " " + json.error;
            } else {
              extra = " " + raw;
            }
          } catch {
            extra = " " + raw;
          }
        } catch (e) {
          console.warn("N√£o consegui ler o body da resposta da fun√ß√£o", e);
        }
      }

      console.error("create_aluno error", error);
      msgNewAluno.textContent =
        "N√£o foi poss√≠vel criar o aluno." + extra;
      btnCreate.disabled = false;
      return;
    }

    msgNewAluno.style.color = "#126b3a";
    msgNewAluno.textContent = "Aluno criado com sucesso!";
    f.reset();
    await loadAlunos();
    await loadKpisFinanceiros();
    btnCreate.disabled = false;
  });

  // ---------- LOGIN ----------
  formLogin?.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    msgLogin.textContent = 'A entrar...';

    const email    = formLogin.email.value.trim();
    const password = formLogin.password.value.trim();

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error){
      console.error(error);
      msgLogin.textContent = 'Credenciais inv√°lidas.';
      return;
    }

    const user = data.user;
    if (!(await hasRole(user.id, 'explicador'))){
      await supabase.auth.signOut().catch(()=>{});
      msgLogin.textContent = 'Esta conta n√£o √© de explicador.';
      return;
    }

    const exp = await getExplRow(user.id);
    EXPLICADOR = {
      userId: user.id,
      id_explicador: exp?.id_explicador || null,
      max: exp?.max_alunos ?? 0
    };

    const nomeCompleto = [exp?.nome, exp?.apelido].filter(Boolean).join(' ') || 'Professor';
    elNomeHeader.textContent = nomeCompleto;
    elNomeMini.textContent   = nomeCompleto;

    setState({ isExpl:true, isAuthed:true });
    await loadAlunos();
    await loadKpisFinanceiros();
  });

  // ---------- LOGOUT ----------
  btnLogout?.addEventListener('click', async () => {
    await supabase.auth.signOut().catch(()=>{});
    window.location.href = './index.html';
  });

  // ---------- SESS√ÉO INICIAL ----------
  (async () => {
    setState({ loading:true });

    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user){
      setState({ isExpl:false, isAuthed:false });
      return;
    }

    const user = session.user;
    if (!(await hasRole(user.id, 'explicador'))){
      await supabase.auth.signOut().catch(()=>{});
      setState({ isExpl:false, isAuthed:false });
      msgLogin.textContent = 'Conta sem permiss√µes de explicador.';
      return;
    }

    const exp = await getExplRow(user.id);
    EXPLICADOR = {
      userId: user.id,
      id_explicador: exp?.id_explicador || null,
      max: exp?.max_alunos ?? 0
    };

    const nomeCompleto = [exp?.nome, exp?.apelido].filter(Boolean).join(' ') || 'Professor';
    elNomeHeader.textContent = nomeCompleto;
    elNomeMini.textContent   = nomeCompleto;

    setState({ isExpl:true, isAuthed:true });
    await loadAlunos();
    await loadKpisFinanceiros();
    await loadResumoCalendario();
    await loadResumoCalendario();
  })();

  // ---------- NAVEGA√á√ÉO HEADER ----------
  const tabs = document.querySelectorAll('.expl-nav-btn');
  const sectionMap = {
    dashboard:  document.querySelector('.expl-body'),
    alunos:     document.getElementById('expl-sec-alunos'),
    calendario: document.getElementById('expl-sec-calendario'),
    faturacao:  document.querySelector('.expl-body'),
    relatorios: document.getElementById('expl-sec-relatorios'),
  };

  tabs.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      tabs.forEach(t => t.classList.remove('expl-nav-btn--active', 'expl-tab--active'));
      btn.classList.add('expl-nav-btn--active');
      const sec = sectionMap[target];
      if (sec) sec.scrollIntoView({ behavior:'smooth', block:'start' });
    });
  });

  btnScrollLista?.addEventListener('click', () => {
    document.querySelector('#lista-alunos-card')?.scrollIntoView({
      behavior:'smooth',
      block:'start'
    });
  });

  supabase.auth.onAuthStateChange(async (_evt, session) => {
    if (!session?.user){
      setState({ isExpl:false, isAuthed:false });
    }
  });

  // ---------- SESS√ïES: ABRIR MODAL ----------
  function abrirModalSessao(sessao) {
    if (!formSessao) return;

    if (sessao) {
      SESSAO_ATUAL_ID = sessao.id_sessao;
      formSessao.data_sessao.value = sessao.data || "";
      formSessao.hora_inicio.value = sessao.hora_inicio || "";
      formSessao.hora_fim.value = sessao.hora_fim || "";
      formSessao.duracao_min.value =
        sessao.duracao_min != null ? sessao.duracao_min : "";
      formSessao.estado.value = sessao.estado || "AGENDADA";
      formSessao.observacoes.value = sessao.observacoes || "";
      btnDeleteSessao.style.display = "inline-block";
    } else {
      SESSAO_ATUAL_ID = null;
      formSessao.data_sessao.value = "";
      formSessao.hora_inicio.value = "";
      formSessao.hora_fim.value = "";
      formSessao.duracao_min.value = "";
      formSessao.estado.value = "AGENDADA";
      formSessao.observacoes.value = "";
      btnDeleteSessao.style.display = "none";
    }

    msgSessao.textContent = "";
    msgSessao.style.color = "";
    openModal(modalSessao);
  }

  btnAddSessao?.addEventListener("click", () => {
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      alert("Seleciona primeiro um aluno na lista.");
      return;
    }
    abrirModalSessao(null);
  });

  // ---------- SESS√ïES: SUBMIT ----------
  formSessao?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    msgSessao.textContent = "";

    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      msgSessao.textContent = "Nenhum aluno selecionado.";
      return;
    }

    const f = ev.target;

    const data = f.data_sessao.value;
    if (!data) {
      msgSessao.textContent = "Data √© obrigat√≥ria.";
      return;
    }

    const payload = {
      id_sessao: SESSAO_ATUAL_ID || undefined,
      aluno_id: ALUNO_ATUAL.id_aluno,
      data,
      hora_inicio: f.hora_inicio.value || null,
      hora_fim: f.hora_fim.value || null,
      duracao_min: f.duracao_min.value || null,
      estado: f.estado.value || "AGENDADA",
      observacoes: f.observacoes.value || null,
    };

    btnSaveSessao.disabled = true;
    msgSessao.textContent = "A guardar sess√£o...";

    try {
      const { data, error } = await supabase.functions.invoke("expl-alunos", {
        body: {
          action: "upsert_sessao_aluno",
          payload,
        },
      });

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro upsert_sessao_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        msgSessao.textContent =
          "N√£o foi poss√≠vel guardar a sess√£o." + extra;
        btnSaveSessao.disabled = false;
        return;
      }

      msgSessao.style.color = "#126b3a";
      msgSessao.textContent = "Sess√£o guardada com sucesso.";

      await loadSessoesAluno(ALUNO_ATUAL.id_aluno);
      setTimeout(() => {
        closeModal(modalSessao);
      }, 500);
    } catch (e) {
      console.error("upsert_sessao_aluno error", e);
      msgSessao.textContent = "Erro inesperado ao guardar sess√£o.";
    } finally {
      btnSaveSessao.disabled = false;
    }
  });

  // ---------- SESS√ïES: APAGAR ----------
  btnDeleteSessao?.addEventListener("click", async () => {
    if (!SESSAO_ATUAL_ID) {
      return;
    }
    if (!ALUNO_ATUAL || !ALUNO_ATUAL.id_aluno) {
      alert("Nenhum aluno selecionado.");
      return;
    }

    const conf = confirm("Tens a certeza que queres apagar esta sess√£o?");
    if (!conf) return;

    msgSessao.textContent = "A apagar sess√£o...";
    btnDeleteSessao.disabled = true;

    try {
      const { data, error } = await supabase.functions.invoke("expl-alunos", {
        body: {
          action: "delete_sessao_aluno",
          payload: { id_sessao: SESSAO_ATUAL_ID },
        },
      });

      if (error) {
        let extra = "";
        if (error.context) {
          try {
            const raw = await error.context.text();
            console.log("Erro delete_sessao_aluno:", raw);
            try {
              const json = JSON.parse(raw);
              if (json?.error) extra = " " + json.error;
            } catch {
              extra = " " + raw;
            }
          } catch {}
        }
        msgSessao.textContent =
          "N√£o foi poss√≠vel apagar a sess√£o." + extra;
        btnDeleteSessao.disabled = false;
        return;
      }

      msgSessao.style.color = "#126b3a";
      msgSessao.textContent = "Sess√£o apagada com sucesso.";

      await loadSessoesAluno(ALUNO_ATUAL.id_aluno);
      setTimeout(() => {
        closeModal(modalSessao);
      }, 400);
    } catch (e) {
      console.error("delete_sessao_aluno error", e);
      msgSessao.textContent = "Erro inesperado ao apagar sess√£o.";
    } finally {
      btnDeleteSessao.disabled = false;
    }
  });
//--------------------------------------------------------------------
// CARREGAR RESUMO DE CALEND√ÅRIO
//--------------------------------------------------------------------

async function loadResumoCalendario() {
  console.log("A carregar resumo de calend√°rio...");

  const { data, error } = await supabase.functions.invoke("expl-alunos", {
    body: { action: "list_sessoes_explicador" },
  });

  if (error) {
    console.error("Erro a carregar sess√µes do explicador", error);
    return;
  }

  const sessoes = data || [];

  // === HOJE ===
  const hoje = new Date().toISOString().slice(0, 10);
  const sessoesHoje = sessoes.filter(s => s.data === hoje);

  let txtHoje = "Sem sess√µes registadas";
  if (sessoesHoje.length > 0) {
    const detalhes = sessoesHoje
      .map(s => `${s.hora_inicio?.slice(0, 5)} ${s.aluno_nome}`)
      .join(", ");

    txtHoje = `${sessoesHoje.length} sess√£o(√µes) hoje ¬∑ ${detalhes}`;
  }

  document.querySelector("#cal-resumo-hoje").textContent = txtHoje;


  // === PR√ìXIMOS 7 DIAS ===
  const hojeDate = new Date();
  const seteDiasAntes = new Date();
  seteDiasAntes.setDate(hojeDate.getDate() + 7);

  const sessoesSemana = sessoes.filter(s => {
    const dataSess = new Date(s.data);
    return dataSess >= hojeDate && dataSess <= seteDiasAntes;
  });

  let txtSemana = "Agenda em branco por agora";
  if (sessoesSemana.length > 0) {
    const alunosUnicos = new Set(sessoesSemana.map(s => s.aluno_nome));
    txtSemana = `${sessoesSemana.length} sess√µes nos pr√≥ximos 7 dias ¬∑ ${alunosUnicos.size} alunos diferentes`;
  }

  document.querySelector("#cal-resumo-semana").textContent = txtSemana;
}

</script>
</body>
</html>
