<!doctype html>
<html lang="pt">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="../../styles.css" />
  <link rel="stylesheet" href="../../css/explicador.css" />
  <link rel="stylesheet" href="../../css/aluno-perfil.css" />

  <link rel="stylesheet" href="../../css/nav.css" />
  <title>EduSphere ‚Äî Alunos</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="../../public/js/supabaseClient.js"></script>
</head>

<body class="home has-footer-nav">

  <section id="explPanel" class="expl-shell">

    <!-- NAVIGATION -->
    <nav id="explSidebarNav" class="expl-sidebar-nav">
      <button class="expl-nav-btn" onclick="location.href='dashboard.html'">
        <span class="expl-nav-icon"><svg class="expl-nav-svg" viewBox="0 0 24 24">
            <rect x="4" y="4" width="7" height="7" rx="1.5" />
            <rect x="13" y="4" width="7" height="7" rx="1.5" />
            <rect x="4" y="13" width="7" height="7" rx="1.5" />
            <rect x="13" y="13" width="7" height="7" rx="1.5" />
          </svg></span>
        <span class="expl-nav-label">Dashboard</span>
      </button>

      <button class="expl-nav-btn expl-nav-btn--active" onclick="location.href='alunos.html'">
        <span class="expl-nav-icon"><svg class="expl-nav-svg" viewBox="0 0 24 24">
            <circle cx="12" cy="9" r="3.2" />
            <path d="M6.5 19.5c1.2-2.3 3-3.6 5.5-3.6s4.3 1.3 5.5 3.6" />
          </svg></span>
        <span class="expl-nav-label">Alunos</span>
      </button>

      <button class="expl-nav-btn" onclick="location.href='calendario.html'">
        <span class="expl-nav-icon"><svg class="expl-nav-svg" viewBox="0 0 24 24">
            <rect x="4" y="5.5" width="16" height="14" rx="2" />
            <path d="M4 10h16" />
            <path d="M9 4v3" />
            <path d="M15 4v3" />
          </svg></span>
        <span class="expl-nav-label">Calend√°rio</span>
      </button>

      <button class="expl-nav-btn" onclick="location.href='faturacao.html'">
        <span class="expl-nav-icon"><svg class="expl-nav-svg" viewBox="0 0 24 24">
            <path d="M15.5 7.5c-1-.7-2.1-1.1-3.4-1.1-2.6 0-4.6 1.8-4.6 4.6s2 4.6 4.6 4.6c1.3 0 2.4-.4 3.4-1.1" />
            <path d="M11 5v14" />
          </svg></span>
        <span class="expl-nav-label">Fatura√ß√£o</span>
      </button>

      <button class="expl-nav-btn" onclick="location.href='relatorios.html'">
        <span class="expl-nav-icon"><svg class="expl-nav-svg" viewBox="0 0 24 24">
            <path d="M4 18.5h16" />
            <path d="M6.5 15l3.2-4 3.2 2.7 4.1-5.2" />
            <path d="M16.8 8.5h3v3" />
          </svg></span>
        <span class="expl-nav-label">Relat√≥rios</span>
      </button>

      <div style="margin-top:auto">
        <button class="expl-nav-btn" id="btnLogoutNav" style="color:#ef4444">
          <span class="expl-nav-label">Sair</span>
        </button>
      </div>
    </nav>

    <!-- CONTENT -->
    <div class="expl-main">
      <header class="expl-header-bar">
        <div class="expl-header-info">
          <h1 class="expl-page-title">Alunos</h1>
          <p class="expl-hello-sub">Gerir inscritos, pagamentos e perfis.</p>
        </div>
      </header>

      <div class="expl-body">

        <!-- LISTA DE ALUNOS -->
        <section id="view-lista-alunos">
          <!-- CART√ÉO PEQUENO: QUOTA + A√á√ïES R√ÅPIDAS -->
          <div class="expl-card expl-card--quota">
            <h3 class="expl-subsection-title">Quota de alunos</h3>
            <div class="expl-quota">
              <p><strong>Limite:</strong> <span id="limite">Sem limite</span></p>
              <p><strong>Ativos:</strong> <span id="contagem">0</span></p>
              <p><strong>Restantes:</strong> <span id="restantes">‚Äî</span></p>
            </div>
            <h3 class="expl-subsection-title" style="margin-top:1rem;">A√ß√µes r√°pidas</h3>
            <div class="expl-actions-row">
              <button class="button secondary" id="btn-open-add-aluno">
                + Adicionar aluno
              </button>
            </div>
          </div>

          <!-- CART√ÉO GRANDE: LISTA DE ALUNOS -->
          <div class="expl-card" style="margin-top:1.5rem;">
            <h3 class="expl-subsection-title">Lista de alunos</h3>
            <div class="dash-alunos-grid" id="alunos-cards-grid">
              <!-- JS Fill -->
              <p style="color:#999">A carregar lista de alunos...</p>
            </div>
          </div>
        </section>

        <!-- PERFIL DO ALUNO (OCULTO INICIALMENTE) -->
        <section id="view-perfil-aluno" style="display:none">

          <div class="perfil-wrapper">
            <!-- HEADER -->
            <div class="perfil-header">
              <button class="back-btn" onclick="fecharPerfilAluno()">
                ‚Üê Voltar
              </button>
              <h2>Perfil do Aluno</h2>
              <p class="subtitle">Informa√ß√£o detalhada e hist√≥rico</p>
            </div>

            <!-- INFO CARD -->
            <section class="perfil-card perfil-card--main" id="aluno-info-card">
              <div class="perfil-left">
                <div class="avatar" id="alunoAvatar">??</div>
                <div>
                  <h3 id="alunoNome">‚Äî</h3>
                  <p class="ano" id="alunoAno">‚Äî</p>
                  <div class="badge-row">
                    <span class="badge status active" id="alunoStatus">Ativo</span>
                  </div>
                  <div class="contact-row">
                    <p><strong>Email:</strong> <span id="alunoEmail">‚Äî</span></p>
                    <p><strong>Telem√≥vel:</strong> <span id="alunoTele">‚Äî</span></p>
                    <p><strong>Inscrito desde:</strong> <span id="alunoDataInscricao">‚Äî</span></p>
                  </div>
                </div>
              </div>

              <div class="perfil-right">
                <button id="btnPerfilEditar" class="edit-btn">Editar Perfil</button>
              </div>
            </section>

            <!-- PR√ìXIMA AULA -->
            <section class="perfil-card perfil-card--next">
              <div class="proxima-aula">
                <span class="icon">üïí</span>
                <span><strong>Pr√≥xima Aula:</strong> <span id="proximaAulaTxt">A carregar.</span></span>
              </div>
            </section>

            <!-- TABS -->
            <section class="perfil-card perfil-card--tabs">
              <div class="tabs">
                <button class="tab active" data-tab="explicacoes"
                  onclick="showPerfilTab('explicacoes')">Explica√ß√µes</button>
                <button class="tab" data-tab="pagamentos" onclick="showPerfilTab('pagamentos')">Pagamentos</button>
                <button class="tab" data-tab="exercicios" onclick="showPerfilTab('exercicios')">Exerc√≠cios</button>
              </div>

              <div class="tabs-content-wrapper">
                <!-- EXPLICA√á√ïES -->
                <div id="tab-explicacoes" class="tab-content active">
                  <h3>Hist√≥rico de Explica√ß√µes</h3>
                  <div class="table-wrapper perfil-table-wrapper">
                    <table class="tabela perfil-tabela">
                      <thead>
                        <tr>
                          <th>Data</th>
                          <th>In√≠cio</th>
                          <th>Fim</th>
                          <th>Dura√ß√£o</th>
                          <th>Estado</th>
                        </tr>
                      </thead>
                      <tbody id="listaExplicacoes"></tbody>
                    </table>
                  </div>
                </div>
                <!-- PAGAMENTOS -->
                <div id="tab-pagamentos" class="tab-content">
                  <div class="pag-header">
                    <h3>Hist√≥rico de Pagamentos</h3>
                    <div style="display:flex; gap:10px; align-items:center;">
                      <button class="button secondary button--sm" id="btn-registar-pagamento">+ Registar
                        pagamento</button>
                      <div class="total">‚Ç¨<span id="pagTotal">0.00</span> <small>Total Recebido</small></div>
                    </div>
                  </div>
                  <div class="table-wrapper perfil-table-wrapper">
                    <table class="tabela perfil-tabela">
                      <thead>
                        <tr>
                          <th>Data</th>
                          <th>Per√≠odo</th>
                          <th>Valor</th>
                          <th>M√©todo</th>
                          <th>Estado</th>
                          <th>A√ß√µes</th>
                        </tr>
                      </thead>
                      <tbody id="listaPagamentos"></tbody>
                    </table>
                  </div>
                </div>
                <!-- EXERC√çCIOS -->
                <div id="tab-exercicios" class="tab-content">
                  <div class="pag-header">
                    <h3>Exerc√≠cios e TPC</h3>
                    <button class="button secondary button--sm" id="btn-novo-exercicio">+ Enviar exerc√≠cio</button>
                  </div>
                  <div class="table-wrapper perfil-table-wrapper">
                    <table class="tabela perfil-tabela">
                      <thead>
                        <tr>
                          <th>Data</th>
                          <th>T√≠tulo</th>
                          <th>Entrega</th>
                          <th>Estado</th>
                          <th>A√ß√µes</th>
                        </tr>
                      </thead>
                      <tbody id="listaExercicios">
                        <tr>
                          <td colspan="5">A carregar...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </section>
      </div>
    </div>
    <!-- BOTTOM NAVIGATION (MOBILE) -->
    <nav class="app-footer-nav">
      <a href="dashboard.html" class="app-nav-item">
        <span class="material-symbols-outlined">grid_view</span>
        <span>Dashboard</span>
      </a>
      <a href="alunos.html" class="app-nav-item">
        <span class="material-symbols-outlined">group</span>
        <span>Alunos</span>
      </a>
      <a href="calendario.html" class="app-nav-item">
        <span class="material-symbols-outlined">calendar_month</span>
        <span>Calend√°rio</span>
      </a>
      <a href="faturacao.html" class="app-nav-item">
        <span class="material-symbols-outlined">payments</span>
        <span>Fatura√ß√£o</span>
      </a>
      <a href="relatorios.html" class="app-nav-item">
        <span class="material-symbols-outlined">trending_up</span>
        <span>Relat√≥rios</span>
      </a>
    </nav>
  </section>

  <!-- Navigation Logic -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
  <script src="../../public/js/nav.js"></script>

  <!-- MODAL ADD ALUNO -->
  <div class="modal" id="modal-add-aluno">
    <div class="modal__backdrop" onclick="closeModal('modal-add-aluno')"></div>
    <div class="modal__dialog" style="max-width:560px;">
      <div class="modal__header">
        <h2>Adicionar Aluno</h2>
        <button class="modal__close" onclick="closeModal('modal-add-aluno')">&times;</button>
      </div>
      <form id="fNewAluno">
        <!-- Dados pessoais -->
        <p
          style="font-weight:600; margin:0 0 0.5rem; color:#64748b; font-size:0.8rem; text-transform:uppercase; letter-spacing:0.05em;">
          Dados Pessoais</p>
        <div class="expl-grid-2">
          <label>Nome <input type="text" class="input" name="nome" required /></label>
          <label>Apelido <input type="text" class="input" name="apelido" /></label>
        </div>
        <label>Email (para login) <input type="email" class="input" name="email" required /></label>
        <div class="expl-grid-2">
          <label>Telem√≥vel <input type="tel" class="input" name="telemovel" /></label>
          <label>Ano Escolar <input type="number" class="input" name="ano" min="1" max="12" /></label>
        </div>

        <hr style="border:none; border-top:1px solid #e2e8f0; margin:1rem 0;">

        <!-- Fatura√ß√£o -->
        <p
          style="font-weight:600; margin:0 0 0.5rem; color:#64748b; font-size:0.8rem; text-transform:uppercase; letter-spacing:0.05em;">
          Fatura√ß√£o & Hor√°rio</p>
        <div class="expl-grid-2">
          <label>Valor / Sess√£o (‚Ç¨) <input type="number" class="input" name="valor_explicacao" step="0.50" min="0"
              id="in-add-valor" oninput="calcPrevistoAdd()" /></label>
          <label>Sess√µes / M√™s <input type="number" class="input" name="sessoes_semana" min="1" max="7" value="1"
              id="in-add-sessoes" oninput="calcPrevistoAdd()" /></label>
        </div>
        <div class="expl-grid-2">
          <label>Dia preferido
            <select class="input" name="dia_semana_preferido">
              <option value="">‚Äî</option>
              <option value="Segunda">Segunda</option>
              <option value="Ter√ßa">Ter√ßa</option>
              <option value="Quarta">Quarta</option>
              <option value="Quinta">Quinta</option>
              <option value="Sexta">Sexta</option>
              <option value="S√°bado">S√°bado</option>
            </select>
          </label>
          <label>Hora preferida <input type="time" class="input" name="hora_preferida" value="16:00" /></label>
        </div>

        <!-- Valor previsto -->
        <div
          style="background:#f0fdf4; border-radius:10px; padding:0.75rem 1rem; margin-top:0.75rem; display:flex; justify-content:space-between; align-items:center;">
          <span style="font-size:0.85rem; color:#64748b;">Valor Previsto Mensal</span>
          <span id="add-previsto-mensal" style="font-size:1.1rem; font-weight:700; color:#16a34a;">‚Ç¨0,00</span>
        </div>

        <hr style="border:none; border-top:1px solid #e2e8f0; margin:1rem 0;">

        <!-- Encarregado -->
        <p
          style="font-weight:600; margin:0 0 0.5rem; color:#64748b; font-size:0.8rem; text-transform:uppercase; letter-spacing:0.05em;">
          Encarregado de Educa√ß√£o (opcional)</p>
        <div class="expl-grid-2">
          <label>Nome <input type="text" class="input" name="nome_pai_cache" /></label>
          <label>Contacto <input type="tel" class="input" name="contacto_pai_cache" /></label>
        </div>

        <div style="margin-top:1.25rem; text-align:right;">
          <button type="submit" class="button primary" id="btnCreateAluno">Criar Aluno</button>
        </div>
        <div id="msgNewAluno" style="color:red; margin-top:10px;"></div>
      </form>
    </div>
  </div>

  <!-- MODAL EDIT ALUNO -->
  <div class="modal" id="modal-edit-aluno">
    <div class="modal__backdrop" onclick="closeModal('modal-edit-aluno')"></div>
    <div class="modal__dialog" style="max-width:560px;">
      <div class="modal__header">
        <h2>Editar Aluno</h2>
        <button class="modal__close" onclick="closeModal('modal-edit-aluno')">&times;</button>
      </div>
      <form id="fEditAluno">
        <input type="hidden" name="id_aluno" id="edit-id-aluno" />

        <p
          style="font-weight:600; margin:0 0 0.5rem; color:#64748b; font-size:0.8rem; text-transform:uppercase; letter-spacing:0.05em;">
          Dados Pessoais</p>
        <div class="expl-grid-2">
          <label>Nome <input type="text" class="input" name="nome" id="edit-nome" required /></label>
          <label>Apelido <input type="text" class="input" name="apelido" id="edit-apelido" /></label>
        </div>
        <div class="expl-grid-2">
          <label>Telem√≥vel <input type="tel" class="input" name="telemovel" id="edit-telemovel" /></label>
          <label>Ano Escolar <input type="number" class="input" name="ano" id="edit-ano" min="1" max="12" /></label>
        </div>

        <hr style="border:none; border-top:1px solid #e2e8f0; margin:1rem 0;">

        <p
          style="font-weight:600; margin:0 0 0.5rem; color:#64748b; font-size:0.8rem; text-transform:uppercase; letter-spacing:0.05em;">
          Fatura√ß√£o & Hor√°rio</p>
        <div class="expl-grid-2">
          <label>Valor / Sess√£o (‚Ç¨) <input type="number" class="input" name="valor_explicacao" id="edit-valor"
              step="0.50" min="0" oninput="calcPrevistoEdit()" /></label>
          <label>Sess√µes / Semana <input type="number" class="input" name="sessoes_semana" id="edit-sessoes" min="1"
              max="7" oninput="calcPrevistoEdit()" /></label>
        </div>
        <div class="expl-grid-2">
          <label>Dia preferido
            <select class="input" name="dia_semana_preferido" id="edit-dia">
              <option value="">‚Äî</option>
              <option value="Segunda">Segunda</option>
              <option value="Ter√ßa">Ter√ßa</option>
              <option value="Quarta">Quarta</option>
              <option value="Quinta">Quinta</option>
              <option value="Sexta">Sexta</option>
              <option value="S√°bado">S√°bado</option>
            </select>
          </label>
          <label>Hora preferida <input type="time" class="input" name="hora_preferida" id="edit-hora" /></label>
        </div>

        <div
          style="background:#f0fdf4; border-radius:10px; padding:0.75rem 1rem; margin-top:0.75rem; display:flex; justify-content:space-between; align-items:center;">
          <span style="font-size:0.85rem; color:#64748b;">Valor Previsto Mensal</span>
          <span id="edit-previsto-mensal" style="font-size:1.1rem; font-weight:700; color:#16a34a;">‚Ç¨0,00</span>
        </div>

        <hr style="border:none; border-top:1px solid #e2e8f0; margin:1rem 0;">

        <p
          style="font-weight:600; margin:0 0 0.5rem; color:#64748b; font-size:0.8rem; text-transform:uppercase; letter-spacing:0.05em;">
          Encarregado de Educa√ß√£o</p>
        <div class="expl-grid-2">
          <label>Nome <input type="text" class="input" name="nome_pai_cache" id="edit-nome-pai" /></label>
          <label>Contacto <input type="tel" class="input" name="contacto_pai_cache" id="edit-contacto-pai" /></label>
        </div>

        <div class="expl-grid-2" style="margin-top:1rem;">
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" name="is_active" id="edit-active" checked />
            Aluno ativo
          </label>
        </div>

        <div style="margin-top:1.25rem; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
          <button type="button" class="button secondary" onclick="closeModal('modal-edit-aluno')">Cancelar</button>
          <button type="submit" class="button primary" id="btnSaveEditAluno">Guardar Altera√ß√µes</button>
        </div>
        <div id="msgEditAluno" style="margin-top:10px; font-size:12px; text-align:center;"></div>
      </form>
    </div>
  </div>

  <!-- MODAL NOVO EXERC√çCIO -->
  <div class="modal" id="modal-novo-exercicio">
    <div class="modal__backdrop" onclick="closeModal('modal-novo-exercicio')"></div>
    <div class="modal__dialog">
      <div class="modal__header">
        <h2>Enviar Exerc√≠cio</h2>
        <button class="modal__close" onclick="closeModal('modal-novo-exercicio')">&times;</button>
      </div>
      <form id="fNewExercicio">
        <label>T√≠tulo / Descri√ß√£o <input type="text" class="input" name="titulo" required
            placeholder="Ex: Ficha de Equa√ß√µes 2" /></label>

        <div class="expl-grid-2">
          <label>Data de Entrega <input type="date" class="input" name="data_entrega" /></label>
          <label>Tipo
            <select class="input" name="tipo">
              <option value="FICHEIRO">Ficheiro (PDF/Imagem)</option>
              <option value="LINK">Link Externo</option>
              <option value="OUTRO">Apenas Texto/Outro</option>
            </select>
          </label>
        </div>

        <div id="wrapper-input-file">
          <label>Ficheiro <input type="file" class="input" name="ficheiro" id="inExercicioFile" /></label>
        </div>

        <div id="wrapper-input-link" style="display:none">
          <label>URL / Link <input type="url" class="input" name="url" placeholder="https://..." /></label>
        </div>

        <div style="margin-top:1rem; text-align:right;">
          <button type="submit" class="button primary" id="btnSendExercicio">Enviar</button>
        </div>
        <div id="msgNewExercicio" style="margin-top:10px; font-size:12px;"></div>
      </form>
    </div>
  </div>

  <script>
    // Navigation Logic
    function fecharPerfilAluno() {
      document.getElementById('view-perfil-aluno').style.display = 'none';
      document.getElementById('view-lista-alunos').style.display = 'block';
    }
    // Toggle Tabs
    function showPerfilTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('tab-' + tabId).classList.add('active');
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
    }
  </script>
  <!-- MODAL PAGAMENTO -->
  <div class="modal" id="modal-pagamento">
    <div class="modal__backdrop" onclick="closeModal('modal-pagamento')"></div>
    <div class="modal__dialog">
      <div class="modal__header">
        <h2 id="modal-pagamento-titulo">Registar Pagamento</h2>
        <button class="modal__close" onclick="closeModal('modal-pagamento')">&times;</button>
      </div>
      <form id="fPagamento">
        <input type="hidden" name="id_pagamento" id="in-pag-id" />

        <div class="expl-grid-2">
          <label>M√™s
            <select class="input" name="mes" id="in-pag-mes" required>
              <option value="1">Janeiro</option>
              <option value="2">Fevereiro</option>
              <option value="3">Mar√ßo</option>
              <option value="4">Abril</option>
              <option value="5">Maio</option>
              <option value="6">Junho</option>
              <option value="7">Julho</option>
              <option value="8">Agosto</option>
              <option value="9">Setembro</option>
              <option value="10">Outubro</option>
              <option value="11">Novembro</option>
              <option value="12">Dezembro</option>
            </select>
          </label>
          <label>Ano
            <input type="number" class="input" name="ano" id="in-pag-ano" value="2026" required />
          </label>
        </div>

        <div class="expl-grid-2">
          <label>Valor Previsto (‚Ç¨)
            <input type="number" class="input" name="valor_previsto" id="in-pag-prev" step="0.01" required />
          </label>
          <label>Valor Pago (‚Ç¨)
            <input type="number" class="input" name="valor_pago" id="in-pag-pago" step="0.01" value="0.00" />
          </label>
        </div>

        <div class="expl-grid-2">
          <label>Data Pagamento
            <input type="date" class="input" name="data_pagamento" id="in-pag-data" />
          </label>
          <label>Estado
            <select class="input" name="estado" id="in-pag-estado">
              <option value="PENDENTE">Pendente</option>
              <option value="PARCIAL">Parcial</option>
              <option value="PAGO">Pago</option>
              <option value="EM_ATRASO">Em atraso</option>
            </select>
          </label>
        </div>

        <div style="margin-top:1.5rem; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
          <button type="submit" class="button primary" id="btnSavePagamento">Gravar</button>
        </div>
        <div id="msgPagamento" style="margin-top:10px; font-size:12px; text-align:center;"></div>
      </form>
    </div>
  </div>

  <script src="../../public/js/explicador-service.js"></script>
  <script src="../../public/js/alunos-explicador.js"></script>
</body>

</html>