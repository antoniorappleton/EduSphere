<!doctype html>
<html lang="pt">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="../../styles.css" />
  <link rel="stylesheet" href="../../css/explicador.css" />

  <link rel="stylesheet" href="../../css/nav.css" />
  <title>EduSphere — Calendário</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="../../public/js/supabaseClient.js"></script>
</head>

<body class="home has-footer-nav">

  <section id="explPanel" class="expl-shell">

    <!-- NAVIGATION -->
    <nav id="explSidebarNav" class="expl-sidebar-nav">
      <button class="expl-nav-btn" onclick="location.href='dashboard.html'">
        <span class="expl-nav-icon"><svg class="expl-nav-svg" viewBox="0 0 24 24">
            <rect x="4" y="4" width="7" height="7" rx="1.5" />
            <rect x="13" y="4" width="7" height="7" rx="1.5" />
            <rect x="4" y="13" width="7" height="7" rx="1.5" />
            <rect x="13" y="13" width="7" height="7" rx="1.5" />
          </svg></span>
        <span class="expl-nav-label">Dashboard</span>
      </button>

      <button class="expl-nav-btn" onclick="location.href='alunos.html'">
        <span class="expl-nav-icon"><svg class="expl-nav-svg" viewBox="0 0 24 24">
            <circle cx="12" cy="9" r="3.2" />
            <path d="M6.5 19.5c1.2-2.3 3-3.6 5.5-3.6s4.3 1.3 5.5 3.6" />
          </svg></span>
        <span class="expl-nav-label">Alunos</span>
      </button>

      <button class="expl-nav-btn expl-nav-btn--active" onclick="location.href='calendario.html'">
        <span class="expl-nav-icon"><svg class="expl-nav-svg" viewBox="0 0 24 24">
            <rect x="4" y="5.5" width="16" height="14" rx="2" />
            <path d="M4 10h16" />
            <path d="M9 4v3" />
            <path d="M15 4v3" />
          </svg></span>
        <span class="expl-nav-label">Calendário</span>
      </button>

      <button class="expl-nav-btn" onclick="location.href='faturacao.html'">
        <span class="expl-nav-icon"><svg class="expl-nav-svg" viewBox="0 0 24 24">
            <path d="M15.5 7.5c-1-.7-2.1-1.1-3.4-1.1-2.6 0-4.6 1.8-4.6 4.6s2 4.6 4.6 4.6c1.3 0 2.4-.4 3.4-1.1" />
            <path d="M11 5v14" />
          </svg></span>
        <span class="expl-nav-label">Faturação</span>
      </button>

      <button class="expl-nav-btn" onclick="location.href='relatorios.html'">
        <span class="expl-nav-icon"><svg class="expl-nav-svg" viewBox="0 0 24 24">
            <path d="M4 18.5h16" />
            <path d="M6.5 15l3.2-4 3.2 2.7 4.1-5.2" />
            <path d="M16.8 8.5h3v3" />
          </svg></span>
        <span class="expl-nav-label">Relatórios</span>
      </button>

      <div style="margin-top:auto">
        <button class="expl-nav-btn" id="btnLogoutNav" style="color:#ef4444">
          <span class="expl-nav-label">Sair</span>
        </button>
      </div>
    </nav>

    <!-- CONTENT -->
    <div class="expl-main">
      <header class="expl-header-bar">
        <div class="expl-header-info">
          <h1 class="expl-page-title">Calendário</h1>
          <p class="expl-hello-sub">Gerir explicações e horários.</p>
        </div>
      </header>

      <div class="expl-body">

        <!-- TOOLBAR: AGENDAR -->
        <div style="display:flex; justify-content:flex-end; margin-bottom:1rem;">
          <button type="button" class="button secondary" id="btn-agendar-explicacao">
            Agendar explicação
          </button>
        </div>

        <!-- KPIs SEMANAIS -->
        <div class="cal-kpi-grid">
          <article class="expl-card cal-kpi-card">
            <p class="cal-kpi-label">Sessões esta semana</p>
            <p class="cal-kpi-value" id="cal-kpi-sessoes-semana">—</p>
          </article>
          <article class="expl-card cal-kpi-card">
            <p class="cal-kpi-label">Horas totais</p>
            <p class="cal-kpi-value" id="cal-kpi-horas">—</p>
          </article>
          <article class="expl-card cal-kpi-card">
            <p class="cal-kpi-label">Faturação semana</p>
            <p class="cal-kpi-value" id="cal-kpi-fat-semana">—</p>
          </article>
          <article class="expl-card cal-kpi-card">
            <p class="cal-kpi-label">Próxima sessão</p>
            <p class="cal-kpi-value" id="cal-kpi-proxima">—</p>
          </article>
        </div>

        <!-- CALENDÁRIO SEMANAL & PRÓXIMAS -->
        <div class="expl-grid-2" style="margin-top:1.5rem;">
          <!-- Semana atual -->
          <article class="expl-card">
            <h3 class="expl-subsection-title">Calendário semanal</h3>
            <p class="expl-section-sub">Vê, por semana, em que dias tens explicações.</p>

            <div class="calendar-week" id="calendar-week">
              <header class="calendar-week__nav">
                <button id="week-prev" class="calendar-btn" type="button">&#8592;</button>
                <h3 id="week-label" class="calendar-week__title">Semana atual</h3>
                <button id="week-next" class="calendar-btn" type="button">&#8594;</button>
              </header>
              <div class="calendar-week__grid" id="calendar-grid">
                <!-- JS Fill -->
              </div>
            </div>
          </article>

          <!-- Próximas sessões -->
          <article class="expl-card">
            <h3 class="expl-subsection-title">Próximas explicações</h3>
            <div id="calendar-proximas" class="calendar-proximas">
              <!-- JS Fill -->
            </div>
          </article>
        </div>

        <!-- TODAS AS EXPLICAÇÕES -->
        <article class="expl-card" style="margin-top:1.5rem;">
          <div class="expl-card-header">
            <h3 class="expl-subsection-title">Todas as explicações</h3>
          </div>
          <div id="cal-view-lista">
            <!-- JS Fill -->
          </div>
        </article>
      </div>
    </div>
    <!-- BOTTOM NAVIGATION (MOBILE) -->
    <nav class="app-footer-nav">
      <a href="dashboard.html" class="app-nav-item">
        <span class="material-symbols-outlined">grid_view</span>
        <span>Dashboard</span>
      </a>
      <a href="alunos.html" class="app-nav-item">
        <span class="material-symbols-outlined">group</span>
        <span>Alunos</span>
      </a>
      <a href="calendario.html" class="app-nav-item">
        <span class="material-symbols-outlined">calendar_month</span>
        <span>Calendário</span>
      </a>
      <a href="faturacao.html" class="app-nav-item">
        <span class="material-symbols-outlined">payments</span>
        <span>Faturação</span>
      </a>
      <a href="relatorios.html" class="app-nav-item">
        <span class="material-symbols-outlined">trending_up</span>
        <span>Relatórios</span>
      </a>
    </nav>
  </section>

  <!-- Navigation Logic -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
  <script src="../../public/js/nav.js"></script>

  <script>
    document.getElementById('btnLogoutNav')?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      location.href = '../../login.html';
    });

    // Auth Check
    (async function () {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) location.href = '../../index.html';
    })();
  </script>
  <!-- MODAL AGENDAR -->
  <div class="modal" id="modal-sessao">
    <div class="modal__backdrop" onclick="closeModalSessao()"></div>
    <div class="modal__dialog">
      <div class="modal__header">
        <h2 id="modal-sessao-titulo">Agendar Explicação</h2>
        <button class="modal__close" onclick="closeModalSessao()">&times;</button>
      </div>
      <form id="fSessao">
        <input type="hidden" name="id_sessao" id="in-sessao-id" />

        <label>Aluno
          <select class="input" name="id_aluno" id="sel-aluno" required>
            <option value="">A carregar alunos...</option>
          </select>
        </label>

        <div class="expl-grid-2">
          <label>Data <input type="date" class="input" name="data" id="in-sessao-data" required /></label>
          <label>Hora <input type="time" class="input" name="hora" id="in-sessao-hora" required /></label>
        </div>

        <div class="expl-grid-2">
          <label>Duração (min) <input type="number" class="input" name="duracao" id="in-sessao-dur" value="60"
              step="15" /></label>
          <label>Estado
            <select class="input" name="estado" id="sel-sessao-estado">
              <option value="AGENDADA">Agendada</option>
              <option value="REALIZADA">Realizada</option>
              <option value="CANCELADA">Cancelada</option>
            </select>
          </label>
        </div>

        <label>Notas
          <textarea class="input" name="notas" id="in-sessao-notas" rows="2"></textarea>
        </label>

        <div style="margin-top:1rem; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
          <button type="button" class="button secondary" id="btn-delete-sessao"
            style="display:none; background:#fee2e2; color:#ef4444; border:none;">Eliminar</button>
          <button type="submit" class="button primary" id="btn-save-sessao">Gravar</button>
        </div>
        <div id="msgSessao" style="margin-top:10px; font-size:12px;"></div>
      </form>
    </div>
  </div>

  <script src="../../public/js/explicador-service.js"></script>
  <script src="../../public/js/calendario-explicador.js"></script>
</body>

</html>