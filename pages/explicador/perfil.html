<!doctype html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="../../styles.css" />
    <link rel="stylesheet" href="../../css/explicador.css" />
    <link rel="stylesheet" href="../../css/nav.css" />
    <title>EduSphere — O Meu Perfil</title>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="../../public/js/supabaseClient.js"></script>
    <script src="../../public/js/auth.js"></script>
  </head>

  <body class="home has-footer-nav">
    <section id="explPanel" class="expl-shell">
      <!-- NAVIGATION (SHARED) -->
      <nav id="explSidebarNav" class="expl-sidebar-nav">
        <button class="expl-nav-btn" onclick="location.href = 'dashboard.html'">
          <span class="expl-nav-icon">
            <svg class="expl-nav-svg" viewBox="0 0 24 24">
              <rect x="4" y="4" width="7" height="7" rx="1.5" />
              <rect x="13" y="4" width="7" height="7" rx="1.5" />
              <rect x="4" y="13" width="7" height="7" rx="1.5" />
              <rect x="13" y="13" width="7" height="7" rx="1.5" />
            </svg>
          </span>
          <span class="expl-nav-label">Dashboard</span>
        </button>

        <button class="expl-nav-btn" onclick="location.href = 'alunos.html'">
          <span class="expl-nav-icon">
            <svg class="expl-nav-svg" viewBox="0 0 24 24">
              <circle cx="12" cy="9" r="3.2" />
              <path d="M6.5 19.5c1.2-2.3 3-3.6 5.5-3.6s4.3 1.3 5.5 3.6" />
            </svg>
          </span>
          <span class="expl-nav-label">Alunos</span>
        </button>

        <button
          class="expl-nav-btn"
          onclick="location.href = 'calendario.html'"
        >
          <span class="expl-nav-icon">
            <svg class="expl-nav-svg" viewBox="0 0 24 24">
              <rect x="4" y="5.5" width="16" height="14" rx="2" />
              <path d="M4 10h16" />
              <path d="M9 4v3" />
              <path d="M15 4v3" />
            </svg>
          </span>
          <span class="expl-nav-label">Calendário</span>
        </button>

        <button class="expl-nav-btn" onclick="location.href = 'faturacao.html'">
          <span class="expl-nav-icon">
            <svg class="expl-nav-svg" viewBox="0 0 24 24">
              <path
                d="M15.5 7.5c-1-.7-2.1-1.1-3.4-1.1-2.6 0-4.6 1.8-4.6 4.6s2 4.6 4.6 4.6c1.3 0 2.4-.4 3.4-1.1"
              />
              <path d="M11 5v14" />
            </svg>
          </span>
          <span class="expl-nav-label">Faturação</span>
        </button>

        <button
          class="expl-nav-btn"
          onclick="location.href = 'relatorios.html'"
        >
          <span class="expl-nav-icon">
            <svg class="expl-nav-svg" viewBox="0 0 24 24">
              <path d="M4 18.5h16" />
              <path d="M6.5 15l3.2-4 3.2 2.7 4.1-5.2" />
              <path d="M16.8 8.5h3v3" />
            </svg>
          </span>
          <span class="expl-nav-label">Relatórios</span>
        </button>

        <button
          class="expl-nav-btn expl-nav-btn--active"
          onclick="location.href = 'perfil.html'"
        >
          <span class="expl-nav-icon">
            <svg
              class="expl-nav-svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          <span class="expl-nav-label">Perfil</span>
        </button>

        <div style="margin-top: auto">
          <button class="expl-nav-btn" id="btnLogoutNav" style="color: #ef4444">
            <span class="expl-nav-label">Sair</span>
          </button>
        </div>
      </nav>

      <!-- MAIN CONTENT -->
      <div class="expl-main">
        <header class="expl-header-bar">
          <div class="expl-header-info">
            <h1 class="expl-page-title">O Meu Perfil</h1>
            <p class="expl-hello-sub">Gere as tuas definições e segurança</p>
          </div>
        </header>

        <div class="expl-body">
          <section class="admin-card" style="max-width: 500px">
            <header class="admin-card__header">
              <h2>Alterar Palavra-passe</h2>
              <p class="auth__hint">
                Define uma nova password para a tua conta.
              </p>
            </header>

            <form id="fChangePw" class="auth__form">
              <div class="password-wrapper">
                <input
                  name="newPassword"
                  type="password"
                  placeholder="Nova Password"
                  minlength="6"
                  required
                />
                <button type="button" class="password-toggle" tabindex="-1">
                  <svg
                    class="eye-icon"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                    ></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
              </div>
              <div class="password-wrapper">
                <input
                  name="confirmPassword"
                  type="password"
                  placeholder="Confirmar Nova Password"
                  minlength="6"
                  required
                />
                <button type="button" class="password-toggle" tabindex="-1">
                  <svg
                    class="eye-icon"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                    ></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
              </div>
              <button
                class="button"
                type="submit"
                style="width: 100%; margin-top: 10px"
              >
                Atualizar Password
              </button>
              <div id="pwMsg" class="auth__msg"></div>
            </form>

            <hr
              style="
                margin: 24px 0;
                border: 0;
                border-top: 1px solid var(--border);
              "
            />

            <div style="text-align: center">
              <button
                id="btnProfileLogout"
                class="button"
                style="background-color: #ef4444; width: 100%"
              >
                Sair da Conta
              </button>
            </div>
          </section>
        </div>
      </div>

      <!-- BOTTOM NAVIGATION (MOBILE) -->
      <nav class="app-footer-nav">
        <a href="dashboard.html" class="app-nav-item">
          <span class="material-symbols-outlined">grid_view</span>
          <span>Dashboard</span>
        </a>
        <a href="alunos.html" class="app-nav-item">
          <span class="material-symbols-outlined">group</span>
          <span>Alunos</span>
        </a>
        <a href="calendario.html" class="app-nav-item">
          <span class="material-symbols-outlined">calendar_month</span>
          <span>Calendário</span>
        </a>
        <a href="faturacao.html" class="app-nav-item">
          <span class="material-symbols-outlined">payments</span>
          <span>Faturação</span>
        </a>
        <a href="perfil.html" class="app-nav-item">
          <span class="material-symbols-outlined">person</span>
          <span>Perfil</span>
        </a>
      </nav>
    </section>

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
    />
    <script src="../../public/js/nav.js"></script>

    <script>
      // --- PASSWORD VISIBILITY TOGGLE ---
      function initPasswordToggles() {
        document.querySelectorAll(".password-toggle").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            const wrapper = btn.closest(".password-wrapper");
            const input = wrapper.querySelector("input");
            const isPassword = input.type === "password";
            input.type = isPassword ? "text" : "password";

            const eyeIcon = btn.querySelector(".eye-icon");
            if (eyeIcon) {
              if (isPassword) {
                eyeIcon.innerHTML =
                  '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
              } else {
                eyeIcon.innerHTML =
                  '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
              }
            }
          });
        });
      }

      document.addEventListener("DOMContentLoaded", async () => {
        initPasswordToggles();

        document
          .getElementById("btnProfileLogout")
          ?.addEventListener("click", () => {
            Auth.signOut("../../index.html");
          });

        // Proteger a página
        const user = await Auth.requireRole("explicador", "../../index.html");
        if (!user) return;

        const form = document.getElementById("fChangePw");
        const msg = document.getElementById("pwMsg");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          msg.textContent = "";
          msg.style.color = "var(--danger)";

          const newPw = form.newPassword.value;
          const confirmPw = form.confirmPassword.value;

          if (newPw !== confirmPw) {
            msg.textContent = "As passwords não coincidem.";
            return;
          }

          if (newPw.length < 6) {
            msg.textContent = "A password deve ter pelo menos 6 caracteres.";
            return;
          }

          try {
            const { error } = await supabase.auth.updateUser({
              password: newPw,
            });
            if (error) throw error;

            msg.style.color = "var(--success)";
            msg.textContent = "Password atualizada com sucesso!";
            form.reset();
          } catch (err) {
            msg.textContent = "Erro ao atualizar: " + err.message;
          }
        });
      });
    </script>
  </body>
</html>
