<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="../../css/base.css" />
  <link rel="stylesheet" href="../../css/aluno.css" />
  <link rel="stylesheet" href="../../css/explicador.css" />
  
  <title>EduSphere — Aluno Calendário</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="../../public/js/supabaseClient.js"></script>
</head>
<body class="home">

  <section class="expl-shell aluno-shell">
    
    <!-- MENU LATERAL -->
    <nav class="expl-sidebar-nav aluno-sidebar-nav">
      <button class="expl-nav-btn" onclick="location.href='dashboard.html'">
        <span class="expl-nav-icon"><svg class="expl-nav-svg" viewBox="0 0 24 24"><rect x="4" y="4" width="7" height="7" rx="1.5"/><rect x="13" y="4" width="7" height="7" rx="1.5"/><rect x="4" y="13" width="7" height="7" rx="1.5"/><rect x="13" y="13" width="7" height="7" rx="1.5"/></svg></span>
        <span class="expl-nav-label">Início</span>
      </button>

      <button class="expl-nav-btn expl-nav-btn--active" onclick="location.href='calendario.html'">
        <span class="expl-nav-icon"><svg class="expl-nav-svg" viewBox="0 0 24 24"><rect x="4" y="5.5" width="16" height="14" rx="2"/><path d="M4 10h16"/><path d="M9 4v3"/><path d="M15 4v3"/></svg></span>
        <span class="expl-nav-label">Calendário</span>
      </button>

      <button class="expl-nav-btn" onclick="location.href='pagamentos.html'">
        <span class="expl-nav-icon"><svg class="expl-nav-svg" viewBox="0 0 24 24"><path d="M7 8h7.5"/><path d="M7 12h6"/><path d="M10 4v16"/></svg></span>
        <span class="expl-nav-label">Pagamentos</span>
      </button>

      <div style="margin-top:auto">
         <button class="expl-nav-btn" id="btnLogoutNav" style="color:#ef4444">
           <span class="expl-nav-label">Sair</span>
         </button>
      </div>
    </nav>

    <!-- CONTENT -->
    <div class="expl-main">
      <div class="expl-body">
         <div class="cal-view">
            <div class="cal-header-block">
              <h2 class="expl-section-title">Calendário de Explicações</h2>
              <p class="expl-section-sub">Consulta e gere as tuas aulas agendadas</p>
            </div>

            <div class="cal-grid">
               <!-- CALENDAR WIDGET -->
               <article class="expl-card">
                  <div class="expl-section-header">
                     <h3 class="expl-subsection-title">Este mês</h3>
                  </div>
                  <div id="cal-ui" class="calendar-ui" style="position:relative; min-height:250px;">
                     <!-- Placeholders for visual calendar -->
                     <div class="cal-month-header" id="calMonthLabel">...</div>
                     <div class="cal-weekdays">
                       <span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span><span>Dom</span>
                     </div>
                     <div class="cal-month-grid" id="calGrid"></div>
                  </div>
               </article>

               <!-- UPCOMING LIST -->
               <article class="expl-card cal-col-span-2">
                 <div class="expl-section-header">
                   <h3 class="expl-subsection-title">Próximas Aulas</h3>
                 </div>
                 <div id="calProximas" class="cal-list-modern">
                   <p>A carregar…</p>
                 </div>
               </article>
            </div>

            <article class="expl-card" style="margin-top:2rem;">
              <div class="expl-section-header">
                <h3 class="expl-subsection-title">Histórico de Aulas</h3>
              </div>
              <div id="calHistorico" class="cal-list-modern">
                <p>A carregar…</p>
              </div>
            </article>
         </div>
      </div>
    </div>
  </section>

  <script>
    document.getElementById('btnLogoutNav')?.addEventListener('click', async () => {
       await supabase.auth.signOut();
       location.href = '../../index.html';
    });

    (async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { location.href = '../../index.html'; return; }
        
        const { data: map } = await supabase.from('app_users').select('ref_id').eq('user_id', session.user.id).single();
        if (!map) return;
        
        const alunoId = map.ref_id;
        
        // Load Sessions
        const { data: sessoes, error } = await supabase.from('sessoes_explicacao')
           .select('*')
           .eq('id_aluno', alunoId).order('data', {ascending:true});
        
        if (sessoes) {
           renderCalendar(sessoes);
           renderLists(sessoes);
        }
    })();

    function renderCalendar(sessoes) {
       // Simplified Render Logic
       const now = new Date();
       document.getElementById('calMonthLabel').textContent = now.toLocaleDateString('pt-PT', {month:'long', year:'numeric'});
       const grid = document.getElementById('calGrid');
       // ... (Implementation specific logic would go here, mimicking the original file)
       grid.innerHTML = '<div style="padding:20px; text-align:center; color:#999">Visualização simplificada</div>';
    }

    function renderLists(sessoes) {
       const hoje = new Date().toISOString().slice(0, 10);
       const futuras = sessoes.filter(s => s.data >= hoje);
       const passadas = sessoes.filter(s => s.data < hoje);

       const proxDiv = document.getElementById('calProximas');
       if (futuras.length) {
          proxDiv.innerHTML = futuras.map(s => `
             <div class="cal-item-row" style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee">
               <div><b>${new Date(s.data).toLocaleDateString()}</b> ${s.hora_inicio.slice(0,5)}</div>
               <div>${s.estado || 'Agendada'}</div>
             </div>
          `).join('');
       } else {
          proxDiv.innerHTML = '<p>Sem aulas futuras.</p>';
       }
       
       const histDiv = document.getElementById('calHistorico');
        if (passadas.length) {
          histDiv.innerHTML = passadas.slice(0,5).map(s => `
             <div class="cal-item-row" style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee">
               <div><b>${new Date(s.data).toLocaleDateString()}</b> ${s.hora_inicio.slice(0,5)}</div>
               <div>${s.estado || 'Concluída'}</div>
             </div>
          `).join('');
       } else {
          histDiv.innerHTML = '<p>Sem histórico.</p>';
       }
    }
  </script>
</body>
</html>
