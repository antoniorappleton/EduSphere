<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- estilos do aluno -->
  <link rel="stylesheet" href="./css/base.css" />
  <link rel="stylesheet" href="./css/aluno.css" />
  <link rel="stylesheet" href="./css/aluno-perfil.css" />

  <!-- estilos do painel (cards, sidebar, grids) -->
  <link rel="stylesheet" href="./css/explicador.css" />

  <title>EduSphere ‚Äî √Årea do Aluno</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
  <script src="./public/js/auth.js"></script>
</head>

<body class="home">
<header>
  <div class="header-inner">
    <a class="logo" href="./index.html">
      <img src="/public/img/imagens/logo-icon192.png" alt="">
      <span>EduSphere</span>
    </a>
    <!-- usa id="logout" para o aluno.js apanhar -->
    <button id="btnLogout" class="button" style="margin-left:auto">Sair</button>
  </div>
</header>
<div class="capa__overlay"></div>

<main class="auth">
  <section class="expl-shell aluno-shell">
    
    <!-- MENU LATERAL -->
    <nav class="expl-sidebar-nav aluno-sidebar-nav">
      <button class="expl-nav-btn expl-nav-btn--active" data-target="inicio">
        <span class="expl-nav-icon">
          <!-- √≠cone ‚Äúdashboard‚Äù -->
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <rect x="4" y="4" width="7" height="7" rx="1.5" />
            <rect x="13" y="4" width="7" height="7" rx="1.5" />
            <rect x="4" y="13" width="7" height="7" rx="1.5" />
            <rect x="13" y="13" width="7" height="7" rx="1.5" />
          </svg>
        </span>
        <span class="expl-nav-label">In√≠cio</span>
      </button>

      <button class="expl-nav-btn" data-target="calendario">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <rect x="4" y="5.5" width="16" height="14" rx="2" />
            <path d="M4 10h16" />
            <path d="M9 4v3" />
            <path d="M15 4v3" />
          </svg>
        </span>
        <span class="expl-nav-label">Calend√°rio</span>
      </button>

      <button class="expl-nav-btn" data-target="pagamentos">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M7 8h7.5" />
            <path d="M7 12h6" />
            <path d="M10 4v16" />
          </svg>
        </span>
        <span class="expl-nav-label">Pagamentos</span>
      </button>

      <button class="expl-nav-btn" data-target="exercicios">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M5 4h11a2 2 0 0 1 2 2v13H7a2 2 0 0 1-2-2V4z" />
            <path d="M7 4v13a2 2 0 0 0 2 2h11" />
          </svg>
        </span>
        <span class="expl-nav-label">Exerc√≠cios</span>
      </button>

      <button class="expl-nav-btn" data-target="notificacoes">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M18 15V11a6 6 0 0 0-12 0v4L4 17v1h16v-1z" />
            <path d="M10 20a2 2 0 0 0 4 0" />
          </svg>
        </span>
        <span class="expl-nav-label">Notifica√ß√µes</span>
      </button>

      <button class="expl-nav-btn" data-target="perfil">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="9" r="3.2" />
            <path d="M6.5 19.5c1.2-2.3 3-3.6 5.5-3.6s4.3 1.3 5.5 3.6" />
          </svg>
        </span>
        <span class="expl-nav-label">Perfil</span>
      </button>
    </nav>

    <!-- CONTE√öDO PRINCIPAL -->
    <div class="expl-main">
      <div class="expl-body">
                <!-- ========== VISTA: IN√çCIO (DASHBOARD) ========== -->
        <section class="expl-section aluno-dashboard" data-view-name="inicio">
          <!-- HEADER DO ALUNO -->
          <div class="aluno-header">
            <div class="aluno-header-main">
              <div class="avatar" id="alunoAvatar">??</div>
              <div>
                <h1 id="alunoNomeTitulo">Bem-vindo üëã</h1>
                <p id="alunoInfo">A carregar‚Ä¶</p>
              </div>
            </div>
          </div>

          <!-- Quick stats (4 cards) -->
          <div class="expl-kpi-grid aluno-kpi-grid">
            <!-- Pr√≥xima aula -->
            <article class="expl-card expl-kpi-card" data-goto="calendario">
              <p class="expl-kpi-label">Pr√≥xima Aula</p>
              <p class="expl-kpi-value" id="kpiProximaAula">‚Äî</p>
              <p class="expl-section-sub" id="kpiProximaAulaDesc">
                V√™ os detalhes em ‚ÄúPr√≥ximas aulas‚Äù.
              </p>
            </article>

            <!-- Exerc√≠cios pendentes -->
            <article class="expl-card expl-kpi-card" data-goto="exercicios">
              <p class="expl-kpi-label">Exerc√≠cios Pendentes</p>
              <p class="expl-kpi-value expl-kpi-value--orange" id="kpiExerciciosPendentes">‚Äî</p>
              <p class="expl-section-sub">Por completar</p>
            </article>

            <!-- Pagamento / resumo r√°pido (usa IDs existentes) -->
            <article class="expl-card expl-kpi-card card--highlight" id="resumoRapido" data-goto="pagamentos">
              <p class="expl-kpi-label">Pagamento</p>
              <p class="expl-kpi-value" id="resumoValor">‚Äî</p>
              <p class="expl-section-sub">
                <span id="resumoMesLabel">Pr√≥xima mensalidade</span> ¬∑
                <span class="resumo-badge" id="resumoEstado">‚Äî</span>
              </p>
              <div class="resumo-actions" style="margin-top:10px;">
                <button id="btnDownloadFatura" class="button secondary" disabled>
                  üìÑ Download fatura
                </button>
              </div>
              <p class="resumo-hint" id="resumoHint"></p>
            </article>

            <!-- Notifica√ß√µes -->
            <article class="expl-card expl-kpi-card" data-goto="notificacoes">
              <p class="expl-kpi-label">Notifica√ß√µes</p>
              <p class="expl-kpi-value expl-kpi-value--red" id="kpiNotificacoes">‚Äî</p>
              <p class="expl-section-sub">N√£o lidas</p>
              <div class="notif-preferences" style="margin-top:12px;">
                <label class="expl-section-sub" style="display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" id="chkEmailNotif" />
                  Receber alertas por email
                </label>
              </div>
            </article>
          </div>

          <!-- Pr√≥ximas aulas + Exerc√≠cios pendentes -->
          <div class="expl-grid-2" style="margin-top:2rem;">
            <!-- Pr√≥ximas Aulas (usa #agenda que o aluno.js preenche) -->
            <article class="expl-card">
              <div class="expl-section-header">
                <h2 class="expl-subsection-title">Pr√≥ximas Aulas</h2>
                <span class="expl-section-link" data-goto="calendario">Ver todas ‚Üí</span>
              </div>
              <div id="agenda" class="agenda-list">
                <p>A carregar agenda‚Ä¶</p>
              </div>
            </article>

            <!-- Exerc√≠cios Pendentes (usa #exlist) -->
            <article class="expl-card">
              <div class="expl-section-header">
                <h2 class="expl-subsection-title">Exerc√≠cios Pendentes</h2>
                <span class="expl-section-link" data-goto="exercicios">Ver todos ‚Üí</span>
              </div>
              <ul id="exlist" class="ex-list">
                <li>A carregar exerc√≠cios‚Ä¶</li>
              </ul>
            </article>
          </div>

          <!-- Notifica√ß√µes Recentes (est√°tico por agora ou podes ligar a dados) -->
          <article class="expl-card" style="margin-top:2rem;">
            <div class="expl-section-header">
              <h2 class="expl-subsection-title">Notifica√ß√µes Recentes</h2>
              <span class="expl-section-link" data-goto="notificacoes">Ver todas ‚Üí</span>
            </div>
            <div id="notifRecentes" class="notif-list">
              <div class="notif-item notif-item--unread">
                <span class="notif-dot"></span>
                <div>
                  <p class="notif-msg">Novo exerc√≠cio dispon√≠vel: Equa√ß√µes 2¬∫ Grau</p>
                  <p class="notif-time">h√° 2 horas</p>
                </div>
              </div>
              <div class="notif-item">
                <span class="notif-dot"></span>
                <div>
                  <p class="notif-msg">Lembrete: Aula de Matem√°tica amanh√£ √†s 14:00</p>
                  <p class="notif-time">h√° 1 dia</p>
                </div>
              </div>
            </div>
          </article>
        </section>

        <!-- ========== VISTA: CALEND√ÅRIO ========== -->
        <section class="expl-section" data-view-name="calendario">
          <div class="cal-view">
            <div class="cal-header-block">
              <h2 class="expl-section-title">Calend√°rio de Explica√ß√µes</h2>
              <p class="expl-section-sub">Consulta e gere as tuas aulas agendadas</p>
            </div>

            <div class="cal-grid">
              <article class="expl-card">
                <div class="expl-section-header">
                  <h3 class="expl-subsection-title">Calend√°rio</h3>
                </div>
                <div id="cal-ui" class="calendar-ui"></div>
              </article>

              <article class="expl-card cal-col-span-2">
                <div class="expl-section-header">
                  <h3 class="expl-subsection-title">Pr√≥ximas Aulas</h3>
                </div>
                <div id="calProximas" class="cal-list-modern">
                  <p>A carregar‚Ä¶</p>
                </div>
              </article>
            </div>

            <article class="expl-card" style="margin-top:2rem;">
              <div class="expl-section-header">
                <h3 class="expl-subsection-title">Hist√≥rico de Aulas</h3>
              </div>
              <div id="calHistorico" class="cal-list-modern">
                <p>A carregar‚Ä¶</p>
              </div>
            </article>
          </div>
        </section>

        <!-- ========== VISTA: PAGAMENTOS ========== -->
        <section id="pagamentos" class="expl-section" data-view-name="pagamentos">
          <!-- Cabe√ßalho + resumo -->
          <article class="expl-card pag-card">
            <h2 class="expl-section-title">Pagamentos</h2>
            <p class="expl-section-sub">Consulte o estado dos seus pagamentos</p>

            <!-- ALERTA pagamento pendente -->
            <div id="pagAlert" class="pag-alert" aria-live="polite" style="display:none;"></div>

            <!-- 3 cart√µes de resumo -->
            <div class="pag-resumo-grid">
              <!-- TOTAL PAGO -->
              <div class="pag-resumo-card pag-resumo-card--total" id="pagCardTotal">
                <div class="pag-resumo-header">
                  <span class="pag-resumo-icon pag-resumo-icon--green" aria-hidden="true">
                    <!-- √≠cone ‚Äúcheck‚Äù -->
                    <svg viewBox="0 0 24 24" class="pag-resumo-svg">
                      <circle cx="12" cy="12" r="10"></circle>
                      <path d="M8 12.5l2.5 2.5L16 9"></path>
                    </svg>
                  </span>
                  <p class="pag-resumo-label">Total Pago</p>
                </div>
                <p class="pag-resumo-valor pag-resumo-valor--green" id="pagTotalPago">‚Ç¨0,00</p>
                <p class="pag-resumo-sub">Desde o in√≠cio</p>
              </div>

              <!-- VALOR PENDENTE -->
              <div class="pag-resumo-card pag-resumo-card--pendente" id="pagCardPendente">
                <div class="pag-resumo-header">
                  <span class="pag-resumo-icon pag-resumo-icon--orange" aria-hidden="true">
                    <!-- √≠cone ‚Äúalerta‚Äù -->
                    <svg viewBox="0 0 24 24" class="pag-resumo-svg">
                      <path d="M12 3L3 20h18L12 3z"></path>
                      <path d="M12 9v5"></path>
                      <circle cx="12" cy="16" r="1"></circle>
                    </svg>
                  </span>
                  <p class="pag-resumo-label">Valor Pendente</p>
                </div>
                <p class="pag-resumo-valor pag-resumo-valor--orange" id="pagValorPendente">‚Ç¨0,00</p>
                <p class="pag-resumo-sub">A pagar</p>
              </div>

              <!-- PR√ìXIMO VENCIMENTO -->
              <div class="pag-resumo-card" id="pagCardVenc">
                <div class="pag-resumo-header">
                  <span class="pag-resumo-icon" aria-hidden="true">
                    <!-- √≠cone ‚Äúcalend√°rio‚Äù simples -->
                    <svg viewBox="0 0 24 24" class="pag-resumo-svg">
                      <rect x="4" y="5" width="16" height="15" rx="2"></rect>
                      <path d="M4 9h16"></path>
                      <path d="M9 3v4"></path>
                      <path d="M15 3v4"></path>
                    </svg>
                  </span>
                  <p class="pag-resumo-label">Pr√≥ximo Vencimento</p>
                </div>
                <p class="pag-resumo-valor" id="pagProxVencimento">‚Äî</p>
                <p class="pag-resumo-sub" id="pagProxMes">‚Äî</p>
              </div>
            </div>
          </article>

          <!-- Dados para Pagamento -->
          <article class="expl-card pag-card">
            <h3 class="expl-subsection-title">Dados para Pagamento</h3>

            <div id="pagDados" class="pag-dados">
              <!-- preenchido por JS -->
              <p class="pag-empty">N√£o existem pagamentos pendentes neste momento. üéâ</p>
            </div>

            <div class="pag-dados-actions">
              <button class="button pag-btn-primary" id="btnPagarAgora" disabled>
                üí≥ Pagar Agora
              </button>
              <button class="button secondary pag-btn-secondary" id="btnComprovativo" disabled>
                üìÑ Comprovativo
              </button>
            </div>
          </article>

          <!-- Hist√≥rico de Pagamentos -->
          <article class="expl-card">
            <div class="expl-section-header">
              <h3 class="expl-subsection-title">Hist√≥rico de Pagamentos</h3>
            </div>

            <div class="table-wrapper">
              <table id="tabPag" class="table table--wide pag-table">
                <thead>
                  <tr>
                    <th>M√™s</th>
                    <th>Valor</th>
                    <th>Data Pagamento</th>
                    <th>M√©todo</th>
                    <th>Estado</th>
                    <th class="text-right">Recibo</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- preenchido por JS -->
                </tbody>
              </table>
            </div>
          </article>
        </section>

        <!-- ========== VISTA: EXERC√çCIOS ========== -->
        <section class="expl-section" data-view-name="exercicios" style="display:none;">
          <article class="expl-card">
            <h2 class="expl-section-title">Exerc√≠cios</h2>
            <p class="expl-section-sub">
              Ficheiros e links de exerc√≠cios enviados pelo explicador.
            </p>
            <ul id="exlist-detalhe" class="ex-list">
              <!-- opcional: podes duplicar a lista aqui via JS se quiseres uma vista mais detalhada -->
              <li>Usar a mesma fonte de dados do painel.</li>
            </ul>
          </article>
        </section>

        <!-- ========== VISTA: NOTIFICA√á√ïES / MENSAGENS ========== -->
        <section class="expl-section" data-view-name="notificacoes" style="display:none;">
          <article class="expl-card">
            <h2 class="expl-section-title">Mensagens</h2>
            <p class="expl-section-sub">
              Comunica diretamente com o teu explicador. As √∫ltimas mensagens funcionam como notifica√ß√µes.
            </p>

            <div id="msgList" class="msg-list">
              <p>A carregar conversas‚Ä¶</p>
            </div>

            <form id="fMsg" class="msg-form">
              <label for="msgInput">Enviar mensagem ao explicador</label>
              <textarea
                id="msgInput"
                name="msg"
                rows="3"
                required
                placeholder="Escreve aqui a tua mensagem‚Ä¶"
              ></textarea>
              <button type="submit" class="button">Enviar</button>
              <p id="msgStatus" class="form__msg"></p>
            </form>
          </article>
        </section>

        <!-- ========== VISTA: PERFIL (PASSWORD) ========== -->
        <section class="expl-section" data-view-name="perfil" style="display:none;">
          <article class="expl-card">
            <h2 class="expl-section-title">Perfil</h2>
            <p class="expl-section-sub">
              Atualiza a tua palavra-passe de acesso √† plataforma.
            </p>

            <form id="fPwd">
              <label for="pwd">Nova palavra-passe</label>
              <input
                type="password"
                id="pwd"
                name="pwd"
                required
                minlength="6"
                autocomplete="new-password"
              />
              <button type="submit" class="button">Atualizar palavra-passe</button>
              <p id="pwdMsg" class="form__msg"></p>
            </form>
          </article>
        </section>
      </div>
    </div>

  </section>
</main>

<footer>¬© <span id="y"></span> EduSphere</footer>

<script>
  // for√ßa o browser a n√£o usar cache para esta p√°gina
      if (window.history && window.history.replaceState) {
        window.history.replaceState(null, '', window.location.href);
      }

      window.addEventListener("pageshow", (event) => {
        if (event.persisted) {
          window.location.reload();
        }
      });

  // Bloquear voltar atr√°s ap√≥s logout
      window.history.pushState(null, "", window.location.href);
      window.addEventListener("popstate", function () {
        window.history.pushState(null, "", window.location.href);
      });

  // =========================
  // UTIL: ano no footer
  // =========================
  const yEl = document.getElementById('y');
  if (yEl) yEl.textContent = new Date().getFullYear();

  // =========================
  // NAVEGA√á√ÉO ENTRE VISTAS
  // (menu lateral + "Ver todas ‚Üí" nos cards)
  // =========================
  document.addEventListener('DOMContentLoaded', () => {
    const navButtons = document.querySelectorAll('.expl-nav-btn');
    const views = document.querySelectorAll('[data-view-name]');
    const gotoEls = document.querySelectorAll('[data-goto]');

    function showView(name) {
      views.forEach((v) => {
        const active = v.dataset.viewName === name;
        v.style.display = active ? '' : 'none';
      });

      navButtons.forEach((btn) => {
        btn.classList.toggle(
          'expl-nav-btn--active',
          btn.dataset.target === name
        );
      });

      console.log('Vista activa:', name);

      // sempre que entrares no calend√°rio, recarrega os dados
      if (name === 'calendario') {
        carregarCalendarioNovo();
      }
    }

    navButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.target;
        if (target) showView(target);
      });
    });

    gotoEls.forEach((el) => {
      el.addEventListener('click', () => {
        const target = el.dataset.goto;
        if (target) showView(target);
      });
    });

    // vista inicial
    showView('inicio');
  });

  // =========================
  // ESTADO GLOBAL
  // =========================
  window.ALUNO = null;

// ========= CALEND√ÅRIO (Pr√≥ximas + Hist√≥rico + grelha visual) =========
async function carregarCalendarioNovo() {
  const proxContainer = document.getElementById("calProximas");
  const histContainer = document.getElementById("calHistorico");
  const calUi = document.getElementById("cal-ui");

  if (!proxContainer || !histContainer || !calUi) return;

  if (!window.ALUNO || !ALUNO.id_aluno) {
    proxContainer.innerHTML = "<p>Erro ao identificar o aluno.</p>";
    histContainer.innerHTML = "<p>Erro ao identificar o aluno.</p>";
    calUi.innerHTML = "<p>Erro ao identificar o aluno.</p>";
    return;
  }

  const hoje = new Date().toISOString().slice(0, 10);

  const { data, error } = await supabase
    .from("sessoes_explicacao")
    .select(`
      id_sessao,
      data,
      hora_inicio,
      duracao_min,
      estado,
      explicador:explicadores(nome)
    `)
    .eq("id_aluno", ALUNO.id_aluno)
    .order("data", { ascending: true })
    .order("hora_inicio", { ascending: true });

  if (error) {
    console.error("Erro ao carregar aulas", error);
    proxContainer.innerHTML = "<p>Erro ao carregar aulas.</p>";
    histContainer.innerHTML = "<p>Erro ao carregar aulas.</p>";
    calUi.innerHTML = "<p>Erro ao carregar aulas.</p>";
    return;
  }

  const sessoes = data || [];
  const futuras = sessoes.filter((s) => s.data >= hoje);
  const passadas = sessoes.filter((s) => s.data < hoje);

  proxContainer.innerHTML = futuras.length
    ? futuras.map((a) => renderCalendarioItem(a)).join("")
    : "<p>Sem aulas futuras.</p>";

  histContainer.innerHTML = passadas.length
    ? passadas.map((a) => renderCalendarioItem(a)).join("")
    : "<p>Sem hist√≥rico de aulas.</p>";

  // desenhar o calend√°rio visual com TODAS as sess√µes
  renderCalendarioVisual(sessoes);
}

function renderCalendarioVisual(sessoes) {
  const cal = document.getElementById("cal-ui");
  if (!cal) return;

  const hoje = new Date();
  const ano = hoje.getFullYear();
  const mesIndex = hoje.getMonth(); // 0 = janeiro

  // Mapa dia -> sess√µes nesse dia (apenas m√™s actual)
  const sessoesPorDia = {};
  sessoes.forEach((s) => {
    if (!s.data) return;
    const d = new Date(s.data);
    if (d.getFullYear() !== ano || d.getMonth() !== mesIndex) return;
    const dia = d.getDate();
    if (!sessoesPorDia[dia]) sessoesPorDia[dia] = [];
    sessoesPorDia[dia].push(s);
  });

  const firstDay = new Date(ano, mesIndex, 1);
  const lastDay = new Date(ano, mesIndex + 1, 0);
  const diasNoMes = lastDay.getDate();

  // Em JS: 0=Dom,1=Seg,... Queremos calend√°rio a come√ßar em Seg
  const offsetSegunda = (firstDay.getDay() + 6) % 7;

  const labelMes = firstDay.toLocaleDateString("pt-PT", {
    month: "long",
    year: "numeric",
  });

  let html = `
    <div class="cal-month-header">${labelMes}</div>
    <div class="cal-weekdays">
      <span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>S√°b</span><span>Dom</span>
    </div>
    <div class="cal-month-grid">
  `;

  // espa√ßos em branco antes do primeiro dia
  for (let i = 0; i < offsetSegunda; i++) {
    html += `<div class="cal-day cal-day--empty"></div>`;
  }

  for (let dia = 1; dia <= diasNoMes; dia++) {
    const temSessao = !!sessoesPorDia[dia];
    html += `
      <div class="cal-day ${temSessao ? "cal-day--has" : ""}">
        <span class="cal-day-number">${dia}</span>
        ${temSessao ? '<span class="cal-day-dot"></span>' : ""}
      </div>
    `;
  }

  html += `</div>`; // fecha .cal-month-grid

  cal.innerHTML = html;
}

function renderCalendarioItem(a) {
    const dataFmt = a.data
      ? new Date(a.data).toLocaleDateString("pt-PT", {
          day: "2-digit",
          month: "short",
          year: "numeric",
        })
      : "‚Äî";

    const hora = a.hora_inicio ? a.hora_inicio.slice(0, 5) : "--:--";
    const dur = a.duracao_min ? `${a.duracao_min} min` : "";

    return `
      <div>
        <div class="cal-item-left">
          <div class="cal-icon-box">üìÖ</div>
          <div>
            <p class="cal-item-title">${dataFmt}</p>
            <p class="cal-item-details">
              ${hora}${dur ? " ¬∑ " + dur : ""} 
            </p>
          </div>
        </div>
        <div class="cal-item-right">
          ${a.estado || ""}
        </div>
      </div>
    `;
  }

  // =========================
  // BOOTSTRAP DA P√ÅGINA
  // =========================
  (async () => {
    const user = await Auth.requireRole('aluno', './login.html');
    if (!user) return;

    // 1) mapear utilizador -> aluno
    const { data: map, error: mapErr } = await supabase
      .from('app_users')
      .select('ref_id')
      .eq('user_id', user.id)
      .single();

    if (mapErr || !map?.ref_id) {
      console.error('Erro a mapear utilizador para aluno', mapErr);
      const infoEl = document.getElementById('alunoInfo');
      if (infoEl) infoEl.textContent = 'N√£o foi poss√≠vel carregar os dados do aluno.';
      return;
    }

    // 2) obter dados do aluno
    const { data: aluno, error: alunoErr } = await supabase
      .from('alunos')
      .select('id_aluno, nome, apelido, ano')
      .eq('id_aluno', map.ref_id)
      .single();

    if (alunoErr || !aluno) {
      console.error('Erro a carregar aluno', alunoErr);
      const infoEl = document.getElementById('alunoInfo');
      if (infoEl) infoEl.textContent = 'Perfil n√£o encontrado';
      return;
    }

    // guardar globalmente
    window.ALUNO = aluno;

    // 3) preencher header (nome + ano + avatar)
    const nomeCompleto = `${aluno.nome} ${aluno.apelido ?? ''}`.trim();
    const iniciais = (aluno.nome?.[0] || '?') + (aluno.apelido?.[0] || '');
    const titulo = `${nomeCompleto} ‚Äî Ano ${aluno.ano ?? 'n/d'}`;

    const infoEl = document.getElementById('alunoInfo');
    if (infoEl) infoEl.textContent = titulo;

    const avatarEl = document.getElementById('alunoAvatar');
    const tituloEl = document.getElementById('alunoNomeTitulo');
    if (avatarEl) avatarEl.textContent = iniciais.toUpperCase();
    if (tituloEl) tituloEl.textContent = nomeCompleto || 'Bem-vindo üëã';

    // 4) carregar cart√µes / dados iniciais
    await Promise.all([
      carregarResumoPagamentos(),
      carregarProximasExplicacoes(),
      carregarCalendarioNovo(),
    ]);
  })();

  // =========================
  // PR√ìXIMAS EXPLICA√á√ïES (dashboard)
  // =========================
  async function carregarProximasExplicacoes() {
    const container = document.getElementById('agenda');
    if (!container) return;

    if (!window.ALUNO || !ALUNO.id_aluno) {
      container.innerHTML = '<p>Erro ao carregar sess√µes.</p>';
      return;
    }

    container.innerHTML = '<p>A carregar agenda‚Ä¶</p>';

    const hojeStr = new Date().toISOString().slice(0, 10);

    const { data, error } = await supabase
      .from('sessoes_explicacao')
      .select('id_sessao, data, hora_inicio, duracao_min, estado, observacoes')
      .eq('id_aluno', ALUNO.id_aluno)
      .gte('data', hojeStr)
      .order('data', { ascending: true })
      .order('hora_inicio', { ascending: true })
      .limit(5);

    if (error) {
      console.error('Erro a carregar sess√µes do aluno', error);
      container.innerHTML = '<p>Erro ao carregar sess√µes.</p>';
      return;
    }

    const sessoes = data || [];

    if (!sessoes.length) {
      container.innerHTML = '<p>N√£o tens pr√≥ximas explica√ß√µes agendadas.</p>';

      const kpi = document.getElementById('kpiProximaAula');
      const kpiDesc = document.getElementById('kpiProximaAulaDesc');
      if (kpi) kpi.textContent = '‚Äî';
      if (kpiDesc) kpiDesc.textContent = 'Sem sess√µes agendadas.';
      return;
    }

    const fmtData = { day: '2-digit', month: '2-digit', year: 'numeric' };

    const html = `
      <ul class="agenda-list">
        ${sessoes
          .map((s) => {
            const d = s.data ? new Date(s.data) : null;
            const dataLabel = d ? d.toLocaleDateString('pt-PT', fmtData) : '‚Äî';
            const hora = s.hora_inicio ? s.hora_inicio.slice(0, 5) : '--:--';
            const dur =
              s.duracao_min != null && s.duracao_min !== ''
                ? `${s.duracao_min} min`
                : '';
            const estado = s.estado || '';
            return `
              <li>
                <strong>${dataLabel}</strong> ¬∑ ${hora}
                ${dur ? ' ¬∑ ' + dur : ''} ‚Äî ${estado}
              </li>
            `;
          })
          .join('')}
      </ul>
    `;

    container.innerHTML = html;

    // KPI "Pr√≥xima Aula" com a primeira sess√£o
    const primeira = sessoes[0];
    const kpi = document.getElementById('kpiProximaAula');
    const kpiDesc = document.getElementById('kpiProximaAulaDesc');
    if (primeira && kpi && kpiDesc) {
      const d = primeira.data ? new Date(primeira.data) : null;
      const diaMes = d
        ? d.toLocaleDateString('pt-PT', { day: '2-digit', month: 'short' })
        : '‚Äî';
      const hora = primeira.hora_inicio
        ? primeira.hora_inicio.slice(0, 5)
        : '--:--';
      kpi.textContent = diaMes;
      kpiDesc.textContent = `Explica√ß√£o √†s ${hora}`;
    }
  }

  // =========================
// PAGAMENTOS (resumo + detalhes + hist√≥rico)
// =========================
async function carregarResumoPagamentos() {
  const tbody = document.querySelector('#tabPag tbody');
  const alertEl = document.getElementById('pagAlert');
  const totalPagoEl = document.getElementById('pagTotalPago');
  const pendenteEl = document.getElementById('pagValorPendente');
  const proxVencEl = document.getElementById('pagProxVencimento');
  const proxMesEl = document.getElementById('pagProxMes');
  const dadosEl = document.getElementById('pagDados');
  const btnPagarAgora = document.getElementById('btnPagarAgora');
  const btnComprovativo = document.getElementById('btnComprovativo');

  // cart√£o r√°pido do dashboard (resumo)
  const resumoValorEl = document.getElementById('resumoValor');
  const resumoMesLabelEl = document.getElementById('resumoMesLabel');
  const resumoEstadoEl = document.getElementById('resumoEstado');
  const resumoHintEl = document.getElementById('resumoHint');
  const btnDownloadFatura = document.getElementById('btnDownloadFatura');

  if (!tbody) return;

  if (!window.ALUNO || !ALUNO.id_aluno) {
    tbody.innerHTML =
      "<tr><td colspan='6'>Erro ao carregar pagamentos.</td></tr>";
    if (alertEl) {
      alertEl.style.display = 'block';
      alertEl.textContent = 'Erro ao identificar o aluno.';
    }
    return;
  }

  // estado inicial
  tbody.innerHTML = "<tr><td colspan='6'>A carregar‚Ä¶</td></tr>";
  if (alertEl) {
    alertEl.style.display = 'none';
    alertEl.textContent = '';
  }

  // ------- pedido ao backend (view v_pagamentos_detalhe) -------
  const { data, error } = await supabase
    .from('v_pagamentos_detalhe')
    .select('*')
    .eq('id_aluno', ALUNO.id_aluno)
    .order('ano', { ascending: true })
    .order('mes', { ascending: true });

  if (error) {
    console.error('Erro a carregar pagamentos do aluno', error);
    tbody.innerHTML =
      "<tr><td colspan='6'>Erro ao carregar pagamentos.</td></tr>";

    // dashboard
    if (resumoValorEl) resumoValorEl.textContent = '‚Äî';
    if (resumoMesLabelEl) resumoMesLabelEl.textContent = 'Pr√≥xima mensalidade';
    if (resumoEstadoEl) resumoEstadoEl.textContent = 'Erro';
    if (resumoHintEl) resumoHintEl.textContent = 'Tenta voltar a carregar a p√°gina.';
    if (btnDownloadFatura) btnDownloadFatura.disabled = true;
    return;
  }

  const pag = (data || []).filter(Boolean);

  // ------- helpers -------
  function labelMesAno(ano, mes) {
    if (!ano || !mes) return '‚Äî';
    const d = new Date(ano, mes - 1, 1);
    return d.toLocaleDateString('pt-PT', {
      month: 'long',
      year: 'numeric',
    });
  }

  function formatEuro(n) {
    const v = Number(n) || 0;
    return v.toLocaleString('pt-PT', {
      style: 'currency',
      currency: 'EUR',
    });
  }

  const campos = {
    valorPrevisto(p) {
      return (
        Number(
          p.valor_previsto ??
            p.valor_mensalidade ??
            p.valor ??
            p.montante_previsto ??
            0
        ) || 0
      );
    },
    valorPago(p) {
      return (
        Number(
          p.valor_pago ??
            p.total_pago ??
            p.montante_pago ??
            0
        ) || 0
      );
    },
    estado(p) {
      return String(p.estado ?? p.status ?? '').toLowerCase();
    },
    referencia(p) {
      return p.referencia ?? p.ref_pagamento ?? p.ref ?? '';
    },
    iban(p) {
      return p.iban ?? p.iban_pagamento ?? '';
    },
    vencimentoRaw(p) {
      return p.vencimento ?? p.data_vencimento ?? p.data_limite ?? null;
    },
    dataPagamento(p) {
      return p.data_pagamento ?? p.dt_pagamento ?? p.pago_em ?? null;
    },
    metodo(p) {
      return p.metodo ?? p.metodo_pagamento ?? p.metodo_pgto ?? '';
    },
  };

  function formatDataCurta(dateLike) {
    if (!dateLike) return '‚Äî';
    const d = new Date(dateLike);
    if (Number.isNaN(d.getTime())) return '‚Äî';
    return d.toLocaleDateString('pt-PT', {
      day: '2-digit',
      month: 'short',
      year: 'numeric',
    });
  }

  // ---- se n√£o h√° pagamentos ----
  if (!pag.length) {
    tbody.innerHTML =
      "<tr><td colspan='6'>Ainda n√£o existem pagamentos registados.</td></tr>";

    if (totalPagoEl) totalPagoEl.textContent = formatEuro(0);
    if (pendenteEl) pendenteEl.textContent = formatEuro(0);
    if (proxVencEl) proxVencEl.textContent = '‚Äî';
    if (proxMesEl) proxMesEl.textContent = 'Sem mensalidades';

    if (dadosEl) {
      dadosEl.innerHTML =
        '<p class="pag-empty">Ainda n√£o existem mensalidades configuradas.</p>';
    }
    if (alertEl) {
      alertEl.style.display = 'block';
      alertEl.innerHTML =
        '<strong>Sem dados de pagamentos.</strong> Contacta a secretaria se achares que √© um erro.';
    }

    // cart√£o r√°pido
    if (resumoValorEl) resumoValorEl.textContent = '‚Äî';
    if (resumoMesLabelEl) resumoMesLabelEl.textContent = 'Pr√≥xima mensalidade';
    if (resumoEstadoEl) resumoEstadoEl.textContent = 'Sem dados';
    if (resumoHintEl)
      resumoHintEl.textContent =
        'Ainda n√£o existem mensalidades configuradas para a tua conta.';
    if (btnDownloadFatura) btnDownloadFatura.disabled = true;

    btnPagarAgora && (btnPagarAgora.disabled = true);
    btnComprovativo && (btnComprovativo.disabled = true);

    window.PAG_PROX_PENDENTE = null;
    return;
  }

  // ---- regra do "m√™s seguinte pendente a partir do dia 8" ----
  const hoje = new Date();
  const diaHoje = hoje.getDate();
  const anoHoje = hoje.getFullYear();
  const mesHoje = hoje.getMonth() + 1;

  let nextMes = mesHoje + 1;
  let nextAno = anoHoje;
  if (nextMes === 13) {
    nextMes = 1;
    nextAno += 1;
  }

  function estadoLogico(p) {
    const base = campos.estado(p); // ex: 'pago', 'pendente', 'futuro'...

    if (base === 'pago') return 'pago';

    const isNextMonth = p.ano === nextAno && p.mes === nextMes;

    // Antes do dia 8 do m√™s, o m√™s seguinte ainda n√£o aparece como pendente
    if (isNextMonth && diaHoje < 8) {
      return 'futuro';
    }

    // A partir do dia 8, o m√™s seguinte √© tratado como pendente
    if (isNextMonth && diaHoje >= 8) {
      return 'pendente';
    }

    // fallback: se n√£o for pago, considera pendente
    return base || 'pendente';
  }

  // -------- 1) resumo --------
  const totalPago = pag.reduce((acc, p) => acc + campos.valorPago(p), 0);

  const pendentes = pag.filter((p) => estadoLogico(p) === 'pendente');

  const totalPendente = pendentes.reduce(
    (acc, p) => acc + (campos.valorPrevisto(p) - campos.valorPago(p)),
    0
  );

  // Pr√≥xima mensalidade pendente (mais antiga)
  let prox = null;
  if (pendentes.length) {
    prox = [...pendentes].sort((a, b) => {
      if (a.ano !== b.ano) return a.ano - b.ano;
      return a.mes - b.mes;
    })[0];
  }

  if (totalPagoEl) totalPagoEl.textContent = formatEuro(totalPago);
  if (pendenteEl) pendenteEl.textContent = formatEuro(totalPendente);

  if (prox) {
    const mesLabel = labelMesAno(prox.ano, prox.mes);
    const vencRaw = campos.vencimentoRaw(prox);
    const vencLabel =
      vencRaw
        ? formatDataCurta(vencRaw)
        : formatDataCurta(new Date(prox.ano, prox.mes - 1, 31));

    const valorEmFalta =
      campos.valorPrevisto(prox) - campos.valorPago(prox) || 0;

    if (proxVencEl) proxVencEl.textContent = vencLabel;
    if (proxMesEl) proxMesEl.textContent = mesLabel;

    if (alertEl) {
      alertEl.style.display = 'block';
      alertEl.innerHTML = `
        Tem um pagamento de <strong>${formatEuro(
          valorEmFalta
        )}</strong> referente a
        <strong>${mesLabel}</strong> com vencimento a
        <strong>${vencLabel}</strong>.
      `;
    }

    if (dadosEl) {
      dadosEl.innerHTML = `
        <div class="pag-dados-row">
          <span class="pag-dados-label">M√™s:</span>
          <span class="pag-dados-value">${mesLabel}</span>
        </div>
        <div class="pag-dados-row">
          <span class="pag-dados-label">Valor:</span>
          <span class="pag-dados-value">${formatEuro(valorEmFalta)}</span>
        </div>
        <div class="pag-dados-row">
          <span class="pag-dados-label">Refer√™ncia:</span>
          <span class="pag-dados-value pag-dados-ref">${
            campos.referencia(prox) || '‚Äî'
          }</span>
        </div>
        <div class="pag-dados-row">
          <span class="pag-dados-label">IBAN:</span>
          <span class="pag-dados-value pag-dados-iban">${
            campos.iban(prox) || 'PT50 0000 0000 0000 0000 0000 0'
          }</span>
        </div>
        <div class="pag-dados-row">
          <span class="pag-dados-label">MbWay:</span>
          <span class="pag-dados-value">
            Refer√™ncia de pagamento por MB Way associada a esta mensalidade.
          </span>
        </div>
      `;
    }

    btnPagarAgora && (btnPagarAgora.disabled = false);
    btnComprovativo && (btnComprovativo.disabled = false);

    // cart√£o r√°pido na dashboard
    if (resumoValorEl) resumoValorEl.textContent = formatEuro(valorEmFalta);
    if (resumoMesLabelEl) resumoMesLabelEl.textContent = mesLabel;
    if (resumoEstadoEl) resumoEstadoEl.textContent = 'Pendente';
    if (resumoHintEl) resumoHintEl.textContent = `Vence a ${vencLabel}.`;
    if (btnDownloadFatura) btnDownloadFatura.disabled = false;

    // guardar info para o bot√£o "Pagar Agora"
    window.PAG_PROX_PENDENTE = {
      ...prox,
      valor_em_falta: valorEmFalta,
      mes_label: mesLabel,
    };
  } else {
    // Sem pendentes
    if (proxVencEl) proxVencEl.textContent = '‚Äî';
    if (proxMesEl) proxMesEl.textContent = 'Sem mensalidades pendentes';

    if (alertEl) {
      alertEl.style.display = 'block';
      alertEl.innerHTML =
        '<strong>Sem pagamentos pendentes.</strong> Todas as mensalidades est√£o em dia. üéâ';
    }

    if (dadosEl) {
      dadosEl.innerHTML =
        '<p class="pag-empty">Sem pagamentos pendentes neste momento.</p>';
    }

    btnPagarAgora && (btnPagarAgora.disabled = true);
    btnComprovativo && (btnComprovativo.disabled = false);

    // cart√£o r√°pido
    if (resumoValorEl) resumoValorEl.textContent = formatEuro(0);
    if (resumoMesLabelEl) resumoMesLabelEl.textContent = 'Pr√≥xima mensalidade';
    if (resumoEstadoEl) resumoEstadoEl.textContent = 'Em dia';
    if (resumoHintEl)
      resumoHintEl.textContent = 'N√£o tens mensalidades em atraso. üëç';
    if (btnDownloadFatura) btnDownloadFatura.disabled = false;

    window.PAG_PROX_PENDENTE = null;
  }

  // -------- 2) tabela de hist√≥rico --------
  const historico = pag
    .filter((p) => estadoLogico(p) === 'pago')
    .sort((a, b) => {
      if (a.ano !== b.ano) return b.ano - a.ano;
      return b.mes - a.mes;
    });

  if (!historico.length) {
    tbody.innerHTML =
      "<tr><td colspan='6'>Ainda n√£o existem pagamentos registados.</td></tr>";
  } else {
    tbody.innerHTML = historico
      .map((p) => {
        const mesLabel = labelMesAno(p.ano, p.mes);
        const dataPag = campos.dataPagamento(p)
          ? formatDataCurta(campos.dataPagamento(p))
          : '‚Äî';
        const metodo = campos.metodo(p) || '‚Äî';
        const est = 'Pago';
        const badgeClass = 'pag-badge pag-badge--pago';

        return `
          <tr>
            <td><strong>${mesLabel}</strong></td>
            <td>${formatEuro(campos.valorPrevisto(p))}</td>
            <td>${dataPag}</td>
            <td>${metodo}</td>
            <td><span class="${badgeClass}">${est}</span></td>
            <td class="text-right">
              <button class="button secondary" style="padding:4px 8px;font-size:0.8rem;">
                ‚¨á
              </button>
            </td>
          </tr>
        `;
      })
      .join('');
  }

  // -------- 3) handlers dos bot√µes --------
  if (btnPagarAgora && !btnPagarAgora._bound) {
    btnPagarAgora._bound = true;
    btnPagarAgora.addEventListener('click', () => {
      const prox = window.PAG_PROX_PENDENTE;
      if (!prox) {
        alert('Neste momento n√£o tens pagamentos pendentes.');
        return;
      }

      const mesLabel =
        prox.mes_label || labelMesAno(prox.ano, prox.mes);
      const valor = typeof prox.valor_em_falta === 'number'
        ? prox.valor_em_falta
        : campos.valorPrevisto(prox) - campos.valorPago(prox);

      const vencRaw = campos.vencimentoRaw(prox);
      const vencLabel = vencRaw ? formatDataCurta(vencRaw) : '‚Äî';

      alert(
        `Pagamento de ${formatEuro(valor)} referente a ${mesLabel}.\n\n` +
          `Vencimento: ${vencLabel}\n` +
          `Refer√™ncia: ${campos.referencia(prox) || '‚Äî'}\n` +
          `IBAN: ${
            campos.iban(prox) || 'PT50 0000 0000 0000 0000 0000 0'
          }\n` +
          `M√©todo: MB Way / Transfer√™ncia`
      );
    });
  }

  if (btnComprovativo && !btnComprovativo._bound) {
    btnComprovativo._bound = true;
    btnComprovativo.addEventListener('click', () => {
      alert(
        'Aqui ligas este bot√£o a um endpoint que devolve o PDF do recibo/fatura.'
      );
    });
  }

  if (btnDownloadFatura && !btnDownloadFatura._bound) {
    btnDownloadFatura._bound = true;
    btnDownloadFatura.addEventListener('click', () => {
      alert(
        'Download da fatura/recibo mais recente.\n' +
          'Liga este bot√£o ao endpoint da API que devolve o PDF.'
      );
    });
  }
}

</script>

<!-- Toast / feedback visual -->
<div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>
<!-- script com a l√≥gica de agenda/pagamentos/exerc√≠cios/password -->
</body>
</html>
