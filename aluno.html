<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- estilos do aluno -->
  <link rel="stylesheet" href="./css/base.css" />
  <link rel="stylesheet" href="./css/aluno.css" />
  <link rel="stylesheet" href="./css/aluno-perfil.css" />

  <!-- estilos do painel (cards, sidebar, grids) -->
  <link rel="stylesheet" href="./css/explicador.css" />

  <title>EduSphere ‚Äî √Årea do Aluno</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
  <script src="./public/js/auth.js"></script>
</head>

<body class="home">
<header>
  <div class="header-inner">
    <a class="logo" href="./index.html">
      <img src="/public/img/imagens/logo-icon192.png" alt="">
      <span>EduSphere</span>
    </a>
    <!-- usa id="logout" para o aluno.js apanhar -->
    <button id="logout" class="button" style="margin-left:auto">Sair</button>
  </div>
</header>
<div class="capa__overlay"></div>

<main class="auth">
  <section class="expl-shell aluno-shell">
    
    <!-- MENU LATERAL -->
    <nav class="expl-sidebar-nav aluno-sidebar-nav">
      <button class="expl-nav-btn expl-nav-btn--active" data-target="inicio">
        <span class="expl-nav-icon">
          <!-- √≠cone ‚Äúdashboard‚Äù -->
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <rect x="4" y="4" width="7" height="7" rx="1.5" />
            <rect x="13" y="4" width="7" height="7" rx="1.5" />
            <rect x="4" y="13" width="7" height="7" rx="1.5" />
            <rect x="13" y="13" width="7" height="7" rx="1.5" />
          </svg>
        </span>
        <span class="expl-nav-label">In√≠cio</span>
      </button>

      <button class="expl-nav-btn" data-target="calendario">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <rect x="4" y="5.5" width="16" height="14" rx="2" />
            <path d="M4 10h16" />
            <path d="M9 4v3" />
            <path d="M15 4v3" />
          </svg>
        </span>
        <span class="expl-nav-label">Calend√°rio</span>
      </button>

      <button class="expl-nav-btn" data-target="pagamentos">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M7 8h7.5" />
            <path d="M7 12h6" />
            <path d="M10 4v16" />
          </svg>
        </span>
        <span class="expl-nav-label">Pagamentos</span>
      </button>

      <button class="expl-nav-btn" data-target="exercicios">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M5 4h11a2 2 0 0 1 2 2v13H7a2 2 0 0 1-2-2V4z" />
            <path d="M7 4v13a2 2 0 0 0 2 2h11" />
          </svg>
        </span>
        <span class="expl-nav-label">Exerc√≠cios</span>
      </button>

      <button class="expl-nav-btn" data-target="notificacoes">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M18 15V11a6 6 0 0 0-12 0v4L4 17v1h16v-1z" />
            <path d="M10 20a2 2 0 0 0 4 0" />
          </svg>
        </span>
        <span class="expl-nav-label">Notifica√ß√µes</span>
      </button>

      <button class="expl-nav-btn" data-target="perfil">
        <span class="expl-nav-icon">
          <svg class="expl-nav-svg" viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="9" r="3.2" />
            <path d="M6.5 19.5c1.2-2.3 3-3.6 5.5-3.6s4.3 1.3 5.5 3.6" />
          </svg>
        </span>
        <span class="expl-nav-label">Perfil</span>
      </button>
    </nav>

    <!-- CONTE√öDO PRINCIPAL -->
    <div class="expl-main">
      <div class="expl-body">
                <!-- ========== VISTA: IN√çCIO (DASHBOARD) ========== -->
        <section class="expl-section aluno-dashboard" data-view-name="inicio">
          <!-- HEADER DO ALUNO -->
          <div class="aluno-header">
            <div class="aluno-header-main">
              <div class="avatar" id="alunoAvatar">??</div>
              <div>
                <h1 id="alunoNomeTitulo">Bem-vindo üëã</h1>
                <p id="alunoInfo">A carregar‚Ä¶</p>
              </div>
            </div>
          </div>

          <!-- Quick stats (4 cards) -->
          <div class="expl-kpi-grid aluno-kpi-grid">
            <!-- Pr√≥xima aula -->
            <article class="expl-card expl-kpi-card" data-goto="calendario">
              <p class="expl-kpi-label">Pr√≥xima Aula</p>
              <p class="expl-kpi-value" id="kpiProximaAula">‚Äî</p>
              <p class="expl-section-sub" id="kpiProximaAulaDesc">
                V√™ os detalhes em ‚ÄúPr√≥ximas aulas‚Äù.
              </p>
            </article>

            <!-- Exerc√≠cios pendentes -->
            <article class="expl-card expl-kpi-card" data-goto="exercicios">
              <p class="expl-kpi-label">Exerc√≠cios Pendentes</p>
              <p class="expl-kpi-value expl-kpi-value--orange" id="kpiExerciciosPendentes">‚Äî</p>
              <p class="expl-section-sub">Por completar</p>
            </article>

            <!-- Pagamento / resumo r√°pido (usa IDs existentes) -->
            <article class="expl-card expl-kpi-card card--highlight" id="resumoRapido" data-goto="pagamentos">
              <p class="expl-kpi-label">Pagamento</p>
              <p class="expl-kpi-value" id="resumoValor">‚Äî</p>
              <p class="expl-section-sub">
                <span id="resumoMesLabel">Pr√≥xima mensalidade</span> ¬∑
                <span class="resumo-badge" id="resumoEstado">‚Äî</span>
              </p>
              <div class="resumo-actions" style="margin-top:10px;">
                <button id="btnDownloadFatura" class="button secondary" disabled>
                  üìÑ Download fatura
                </button>
              </div>
              <p class="resumo-hint" id="resumoHint"></p>
            </article>

            <!-- Notifica√ß√µes -->
            <article class="expl-card expl-kpi-card" data-goto="notificacoes">
              <p class="expl-kpi-label">Notifica√ß√µes</p>
              <p class="expl-kpi-value expl-kpi-value--red" id="kpiNotificacoes">‚Äî</p>
              <p class="expl-section-sub">N√£o lidas</p>
              <div class="notif-preferences" style="margin-top:12px;">
                <label class="expl-section-sub" style="display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" id="chkEmailNotif" />
                  Receber alertas por email
                </label>
              </div>
            </article>
          </div>

          <!-- Pr√≥ximas aulas + Exerc√≠cios pendentes -->
          <div class="expl-grid-2" style="margin-top:2rem;">
            <!-- Pr√≥ximas Aulas (usa #agenda que o aluno.js preenche) -->
            <article class="expl-card">
              <div class="expl-section-header">
                <h2 class="expl-subsection-title">Pr√≥ximas Aulas</h2>
                <span class="expl-section-link" data-goto="calendario">Ver todas ‚Üí</span>
              </div>
              <div id="agenda" class="agenda-list">
                <p>A carregar agenda‚Ä¶</p>
              </div>
            </article>

            <!-- Exerc√≠cios Pendentes (usa #exlist) -->
            <article class="expl-card">
              <div class="expl-section-header">
                <h2 class="expl-subsection-title">Exerc√≠cios Pendentes</h2>
                <span class="expl-section-link" data-goto="exercicios">Ver todos ‚Üí</span>
              </div>
              <ul id="exlist" class="ex-list">
                <li>A carregar exerc√≠cios‚Ä¶</li>
              </ul>
            </article>
          </div>

          <!-- Notifica√ß√µes Recentes (est√°tico por agora ou podes ligar a dados) -->
          <article class="expl-card" style="margin-top:2rem;">
            <div class="expl-section-header">
              <h2 class="expl-subsection-title">Notifica√ß√µes Recentes</h2>
              <span class="expl-section-link" data-goto="notificacoes">Ver todas ‚Üí</span>
            </div>
            <div id="notifRecentes" class="notif-list">
              <div class="notif-item notif-item--unread">
                <span class="notif-dot"></span>
                <div>
                  <p class="notif-msg">Novo exerc√≠cio dispon√≠vel: Equa√ß√µes 2¬∫ Grau</p>
                  <p class="notif-time">h√° 2 horas</p>
                </div>
              </div>
              <div class="notif-item">
                <span class="notif-dot"></span>
                <div>
                  <p class="notif-msg">Lembrete: Aula de Matem√°tica amanh√£ √†s 14:00</p>
                  <p class="notif-time">h√° 1 dia</p>
                </div>
              </div>
            </div>
          </article>
        </section>

        <!-- ========== VISTA: CALEND√ÅRIO ========== -->
        <section class="expl-section" data-view-name="calendario" style="display:none;">
          <article class="expl-card">
            <div class="expl-section-header">
              <h2 class="expl-section-title">Calend√°rio de explica√ß√µes</h2>
              <p class="expl-section-sub">Visualiza as tuas sess√µes por m√™s.</p>
            </div>

            <div class="calendario-header">
              <button id="calPrev" class="icon-button" type="button">‚óÄ</button>
              <p id="calMesTitulo"></p>
              <button id="calNext" class="icon-button" type="button">‚ñ∂</button>
            </div>

            <ul id="calList" class="cal-list">
              <li>A carregar calend√°rio‚Ä¶</li>
            </ul>

            <p class="cal-hint">
              Confirma a tua presen√ßa nas sess√µes futuras para ajudar o explicador a planear.
            </p>
          </article>
        </section>

        <!-- ========== VISTA: PAGAMENTOS ========== -->
        <section class="expl-section" data-view-name="pagamentos" style="display:none;">
          <article class="expl-card">
            <h2 class="expl-section-title">Pagamentos</h2>
            <p class="expl-section-sub">Hist√≥rico de mensalidades registadas.</p>

            <div class="table-wrapper">
              <table id="tabPag" class="table table--wide">
                <thead>
                  <tr>
                    <th>M√™s</th>
                    <th>Previsto</th>
                    <th>Pago</th>
                    <th>Estado</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="4">A carregar pagamentos‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
          </article>
        </section>

        <!-- ========== VISTA: EXERC√çCIOS ========== -->
        <section class="expl-section" data-view-name="exercicios" style="display:none;">
          <article class="expl-card">
            <h2 class="expl-section-title">Exerc√≠cios</h2>
            <p class="expl-section-sub">
              Ficheiros e links de exerc√≠cios enviados pelo explicador.
            </p>
            <ul id="exlist-detalhe" class="ex-list">
              <!-- opcional: podes duplicar a lista aqui via JS se quiseres uma vista mais detalhada -->
              <li>Usar a mesma fonte de dados do painel.</li>
            </ul>
          </article>
        </section>

        <!-- ========== VISTA: NOTIFICA√á√ïES / MENSAGENS ========== -->
        <section class="expl-section" data-view-name="notificacoes" style="display:none;">
          <article class="expl-card">
            <h2 class="expl-section-title">Mensagens</h2>
            <p class="expl-section-sub">
              Comunica diretamente com o teu explicador. As √∫ltimas mensagens funcionam como notifica√ß√µes.
            </p>

            <div id="msgList" class="msg-list">
              <p>A carregar conversas‚Ä¶</p>
            </div>

            <form id="fMsg" class="msg-form">
              <label for="msgInput">Enviar mensagem ao explicador</label>
              <textarea
                id="msgInput"
                name="msg"
                rows="3"
                required
                placeholder="Escreve aqui a tua mensagem‚Ä¶"
              ></textarea>
              <button type="submit" class="button">Enviar</button>
              <p id="msgStatus" class="form__msg"></p>
            </form>
          </article>
        </section>

        <!-- ========== VISTA: PERFIL (PASSWORD) ========== -->
        <section class="expl-section" data-view-name="perfil" style="display:none;">
          <article class="expl-card">
            <h2 class="expl-section-title">Perfil</h2>
            <p class="expl-section-sub">
              Atualiza a tua palavra-passe de acesso √† plataforma.
            </p>

            <form id="fPwd">
              <label for="pwd">Nova palavra-passe</label>
              <input
                type="password"
                id="pwd"
                name="pwd"
                required
                minlength="6"
                autocomplete="new-password"
              />
              <button type="submit" class="button">Atualizar palavra-passe</button>
              <p id="pwdMsg" class="form__msg"></p>
            </form>
          </article>
        </section>
      </div>
    </div>

  </section>
</main>


<footer>¬© <span id="y"></span> EduSphere</footer>

<script>
  // =========================
  // UTIL: ano no footer
  // =========================
  const yEl = document.getElementById('y');
  if (yEl) yEl.textContent = new Date().getFullYear();

  // =========================
  // NAVEGA√á√ÉO ENTRE VISTAS
  // (menu lateral + "Ver todas ‚Üí" nos cards)
  // =========================
  document.addEventListener('DOMContentLoaded', () => {
    const navButtons = document.querySelectorAll('.expl-nav-btn');
    const views = document.querySelectorAll('[data-view-name]');
    const gotoEls = document.querySelectorAll('[data-goto]');

    function showView(name) {
      // mostra / esconde sec√ß√µes principais
      views.forEach((v) => {
        const active = v.dataset.viewName === name;
        v.style.display = active ? '' : 'none';
      });

      // atualiza estado visual do menu lateral
      navButtons.forEach((btn) => {
        btn.classList.toggle(
          'expl-nav-btn--active',
          btn.dataset.target === name
        );
      });
    }

    // clicar nos bot√µes do menu
    navButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.target;
        if (target) showView(target);
      });
    });

    // elementos com data-goto="vista" (cards, links "Ver todas ‚Üí")
    gotoEls.forEach((el) => {
      el.addEventListener('click', () => {
        const target = el.dataset.goto;
        if (target) showView(target);
      });
    });

    // vista inicial
    showView('inicio');
  });

  // =========================
  // ESTADO GLOBAL
  // =========================
  window.ALUNO = null;
  let CAL_ANO_ATUAL;
  let CAL_MES_ATUAL;

  // =========================
  // BOOTSTRAP DA P√ÅGINA
  // =========================
  (async () => {
    const user = await Auth.requireRole('aluno', './login.html');
    if (!user) return;

    // 1) mapear utilizador -> aluno
    const { data: map, error: mapErr } = await supabase
      .from('app_users')
      .select('ref_id')
      .eq('user_id', user.id)
      .single();

    if (mapErr || !map?.ref_id) {
      console.error('Erro a mapear utilizador para aluno', mapErr);
      const infoEl = document.getElementById('alunoInfo');
      if (infoEl) infoEl.textContent = 'N√£o foi poss√≠vel carregar os dados do aluno.';
      return;
    }

    // 2) obter dados do aluno
    const { data: aluno, error: alunoErr } = await supabase
      .from('alunos')
      .select('id_aluno, nome, apelido, ano')
      .eq('id_aluno', map.ref_id)
      .single();

    if (alunoErr || !aluno) {
      console.error('Erro a carregar aluno', alunoErr);
      const infoEl = document.getElementById('alunoInfo');
      if (infoEl) infoEl.textContent = 'Perfil n√£o encontrado';
      return;
    }

    // guardar globalmente
    window.ALUNO = aluno;

    // 3) preencher header (nome + ano + avatar)
    const nomeCompleto = `${aluno.nome} ${aluno.apelido ?? ''}`.trim();
    const iniciais = (aluno.nome?.[0] || '?') + (aluno.apelido?.[0] || '');
    const titulo = `${nomeCompleto} ‚Äî Ano ${aluno.ano ?? 'n/d'}`;

    const infoEl = document.getElementById('alunoInfo');
    if (infoEl) infoEl.textContent = titulo;

    const avatarEl = document.getElementById('alunoAvatar');
    const tituloEl = document.getElementById('alunoNomeTitulo');
    if (avatarEl) avatarEl.textContent = iniciais.toUpperCase();
    if (tituloEl) tituloEl.textContent = nomeCompleto || 'Bem-vindo üëã';

    // 4) inicializar navega√ß√£o do calend√°rio (m√™s atual)
    initCalendarioEstadoInicial();

    // 5) carregar cart√µes / dados iniciais
    await Promise.all([
      carregarResumoPagamentos(),
      carregarProximasExplicacoes(),
      carregarCalendarioExplicacoes(),
    ]);
  })();

  // =========================
  // PR√ìXIMAS EXPLICA√á√ïES
  // =========================
  async function carregarProximasExplicacoes() {
    const container = document.getElementById('agenda');
    if (!container) return;

    if (!window.ALUNO || !ALUNO.id_aluno) {
      container.innerHTML = '<p>Erro ao carregar sess√µes.</p>';
      return;
    }

    container.innerHTML = '<p>A carregar agenda‚Ä¶</p>';

    const hojeStr = new Date().toISOString().slice(0, 10);

    const { data, error } = await supabase
      .from('sessoes_explicacao')
      .select('id_sessao, data, hora_inicio, duracao_min, estado, observacoes')
      .eq('id_aluno', ALUNO.id_aluno)
      .gte('data', hojeStr)               // s√≥ hoje em diante
      .order('data', { ascending: true })
      .order('hora_inicio', { ascending: true })
      .limit(5);

    if (error) {
      console.error('Erro a carregar sess√µes do aluno', error);
      container.innerHTML = '<p>Erro ao carregar sess√µes.</p>';
      return;
    }

    const sessoes = data || [];

    if (!sessoes.length) {
      container.innerHTML = '<p>N√£o tens pr√≥ximas explica√ß√µes agendadas.</p>';

      // KPI de pr√≥xima aula
      const kpi = document.getElementById('kpiProximaAula');
      const kpiDesc = document.getElementById('kpiProximaAulaDesc');
      if (kpi) kpi.textContent = '‚Äî';
      if (kpiDesc) kpiDesc.textContent = 'Sem sess√µes agendadas.';
      return;
    }

    const fmtData = { day: '2-digit', month: '2-digit', year: 'numeric' };

    const html = `
      <ul class="agenda-list">
        ${sessoes
          .map((s) => {
            const d = s.data ? new Date(s.data) : null;
            const dataLabel = d ? d.toLocaleDateString('pt-PT', fmtData) : '‚Äî';
            const hora = s.hora_inicio ? s.hora_inicio.slice(0, 5) : '--:--';
            const dur =
              s.duracao_min != null && s.duracao_min !== ''
                ? `${s.duracao_min} min`
                : '';
            const estado = s.estado || '';
            return `
              <li>
                <strong>${dataLabel}</strong> ¬∑ ${hora}
                ${dur ? ' ¬∑ ' + dur : ''} ‚Äî ${estado}
              </li>
            `;
          })
          .join('')}
      </ul>
    `;

    container.innerHTML = html;

    // Atualizar KPI "Pr√≥xima Aula" com a primeira sess√£o
    const primeira = sessoes[0];
    const kpi = document.getElementById('kpiProximaAula');
    const kpiDesc = document.getElementById('kpiProximaAulaDesc');
    if (primeira && kpi && kpiDesc) {
      const d = primeira.data ? new Date(primeira.data) : null;
      const diaMes = d
        ? d.toLocaleDateString('pt-PT', { day: '2-digit', month: 'short' })
        : '‚Äî';
      const hora = primeira.hora_inicio
        ? primeira.hora_inicio.slice(0, 5)
        : '--:--';
      kpi.textContent = diaMes;
      kpiDesc.textContent = `Explica√ß√£o √†s ${hora}`;
    }
  }

  // =========================
  // CALEND√ÅRIO MENSAL
  // =========================
  function initCalendarioEstadoInicial() {
    const hoje = new Date();
    CAL_ANO_ATUAL = hoje.getFullYear();
    CAL_MES_ATUAL = hoje.getMonth() + 1;

    const btnPrev = document.getElementById('calPrev');
    const btnNext = document.getElementById('calNext');

    btnPrev?.addEventListener('click', () => {
      CAL_MES_ATUAL--;
      if (CAL_MES_ATUAL === 0) {
        CAL_MES_ATUAL = 12;
        CAL_ANO_ATUAL--;
      }
      carregarCalendarioExplicacoes();
    });

    btnNext?.addEventListener('click', () => {
      CAL_MES_ATUAL++;
      if (CAL_MES_ATUAL === 13) {
        CAL_MES_ATUAL = 1;
        CAL_ANO_ATUAL++;
      }
      carregarCalendarioExplicacoes();
    });
  }

  async function carregarCalendarioExplicacoes() {
    const ul = document.getElementById('calList');
    const titulo = document.getElementById('calMesTitulo');
    if (!ul || !titulo) return;
    if (!window.ALUNO || !ALUNO.id_aluno) return;

    const nomesMeses = [
      'janeiro',
      'fevereiro',
      'mar√ßo',
      'abril',
      'maio',
      'junho',
      'julho',
      'agosto',
      'setembro',
      'outubro',
      'novembro',
      'dezembro',
    ];

    titulo.textContent =
      (nomesMeses[CAL_MES_ATUAL - 1] || CAL_MES_ATUAL) +
      ' de ' +
      CAL_ANO_ATUAL;

    ul.innerHTML = '<li>A carregar calend√°rio‚Ä¶</li>';

    const inicio = new Date(CAL_ANO_ATUAL, CAL_MES_ATUAL - 1, 1)
      .toISOString()
      .slice(0, 10);
    const fim = new Date(CAL_ANO_ATUAL, CAL_MES_ATUAL, 0)
      .toISOString()
      .slice(0, 10);

    const { data, error } = await supabase
      .from('sessoes_explicacao')
      .select('id_sessao, data, hora_inicio, duracao_min, estado')
      .eq('id_aluno', ALUNO.id_aluno)
      .gte('data', inicio)
      .lte('data', fim)
      .order('data', { ascending: true })
      .order('hora_inicio', { ascending: true });

    if (error) {
      console.error('Erro ao carregar calend√°rio', error);
      ul.innerHTML = '<li>Erro ao carregar sess√µes.</li>';
      return;
    }

    const sessoes = data || [];

    if (!sessoes.length) {
      ul.innerHTML = '<li>Sem explica√ß√µes neste m√™s.</li>';
      return;
    }

    ul.innerHTML = '';

    // agrupar por data
    const grupos = {};
    sessoes.forEach((s) => {
      if (!s.data) return;
      if (!grupos[s.data]) grupos[s.data] = [];
      grupos[s.data].push(s);
    });

    Object.keys(grupos)
      .sort()
      .forEach((dataStr) => {
        const d = new Date(dataStr);
        const dataLabel = d.toLocaleDateString('pt-PT', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
        });

        const li = document.createElement('li');
        li.innerHTML =
          `<strong>${dataLabel}</strong>` +
          '<ul>' +
          grupos[dataStr]
            .map((s) => {
              const hora = s.hora_inicio
                ? s.hora_inicio.slice(0, 5)
                : '--:--';
              const dur =
                s.duracao_min != null ? `${s.duracao_min} min` : '';
              const estado = s.estado || '';
              return `<li>${hora}${dur ? ' ¬∑ ' + dur : ''} ‚Äî ${estado}</li>`;
            })
            .join('') +
          '</ul>';
        ul.appendChild(li);
      });
  }

  // =========================
  // PAGAMENTOS (tabela + KPI)
  // =========================
  async function carregarResumoPagamentos() {
    const tbody = document.querySelector('#tabPag tbody');
    if (!tbody) return;

    if (!window.ALUNO || !ALUNO.id_aluno) {
      tbody.innerHTML =
        "<tr><td colspan='4'>Erro ao carregar pagamentos.</td></tr>";
      return;
    }

    tbody.innerHTML =
      "<tr><td colspan='4'>A carregar‚Ä¶</td></tr>";

    const { data, error } = await supabase
      .from('v_pagamentos_detalhe')
      .select('ano, mes, valor_previsto, valor_pago, estado')
      .eq('id_aluno', ALUNO.id_aluno)
      .order('ano', { ascending: true })
      .order('mes', { ascending: true });

    if (error) {
      console.error('Erro a carregar pagamentos do aluno', error);
      tbody.innerHTML =
        "<tr><td colspan='4'>Erro ao carregar pagamentos.</td></tr>";
      return;
    }

    const pag = data || [];
    if (!pag.length) {
      tbody.innerHTML =
        "<tr><td colspan='4'>Ainda n√£o existem pagamentos registados.</td></tr>";

      const resumoValor = document.getElementById('resumoValor');
      const resumoMesLabel = document.getElementById('resumoMesLabel');
      const resumoEstado = document.getElementById('resumoEstado');
      if (resumoValor) resumoValor.textContent = '‚Äî';
      if (resumoMesLabel) resumoMesLabel.textContent = 'Sem mensalidades';
      if (resumoEstado) resumoEstado.textContent = 'N/A';

      return;
    }

    tbody.innerHTML = pag
      .map((p) => {
        const mes = String(p.mes).padStart(2, '0');
        const labelMes = `${mes}/${p.ano}`;
        const previsto = Number(p.valor_previsto) || 0;
        const pago = Number(p.valor_pago) || 0;
        const estado = p.estado || '‚Äî';
        return `
          <tr>
            <td>${labelMes}</td>
            <td>${previsto.toFixed(2)} ‚Ç¨</td>
            <td>${pago.toFixed(2)} ‚Ç¨</td>
            <td>${estado}</td>
          </tr>
        `;
      })
      .join('');

    // Atualizar card "Pagamento" com o √∫ltimo m√™s
    const ultimo = pag[pag.length - 1];
    const resumoValor = document.getElementById('resumoValor');
    const resumoMesLabel = document.getElementById('resumoMesLabel');
    const resumoEstado = document.getElementById('resumoEstado');

    if (ultimo && resumoValor && resumoMesLabel && resumoEstado) {
      const previsto = Number(ultimo.valor_previsto) || 0;
      const mes = String(ultimo.mes).padStart(2, '0');
      resumoValor.textContent = `${previsto.toFixed(2)} ‚Ç¨`;
      resumoMesLabel.textContent = `Mensalidade ${mes}/${ultimo.ano}`;
      resumoEstado.textContent = ultimo.estado || '‚Äî';
    }
  }
</script>

<!-- Toast / feedback visual -->
<div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>
<!-- script com a l√≥gica de agenda/pagamentos/exerc√≠cios/password -->
<script src="./public/js/pages/aluno.js"></script>
</body>
</html>
