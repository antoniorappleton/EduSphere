<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./css/aluno.css" />
  <link rel="stylesheet" href="./css/base.css" />
  <title>EduSphere ‚Äî √Årea do Aluno</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
  <script src="./public/js/auth.js"></script>
</head>
<body class="home">
<header>
  <div class="header-inner">
    <a class="logo" href="./index.html">
      <img src="/public/img/logo-icon.svg" alt="">
      <span>EduSphere</span>
    </a>
    <!-- usa id="logout" para o aluno.js apanhar -->
    <button id="logout" class="button" style="margin-left:auto">Sair</button>
  </div>
</header>
<div class="capa__overlay"></div>

<main class="auth">
  <section class="auth__panel">
    <h1>Bem-vindo üëã</h1>
    <p id="alunoInfo">A carregar‚Ä¶</p>

        <!-- RESUMO R√ÅPIDO -->
    <div class="card card--highlight" id="resumoRapido">
      <h2>Resumo r√°pido</h2>
      <div class="resumo-grid">
        <div>
          <p class="resumo-label">Pr√≥xima mensalidade</p>
          <p class="resumo-value" id="resumoMesLabel">‚Äî</p>
        </div>
        <div>
          <p class="resumo-label">Estado</p>
          <p class="resumo-badge" id="resumoEstado">‚Äî</p>
        </div>
        <div>
          <p class="resumo-label">Valor</p>
          <p class="resumo-value" id="resumoValor">‚Äî</p>
        </div>
        <div class="resumo-actions">
          <button id="btnDownloadFatura" class="button secondary" disabled>
            üìÑ Download fatura
          </button>
        </div>
      </div>
      <p class="resumo-hint" id="resumoHint"></p>
    </div>

    <!-- Pr√≥ximas explica√ß√µes -->
    <div class="card">
      <h2>Pr√≥ximas explica√ß√µes</h2>
      <div id="agenda">
        <p>A carregar agenda‚Ä¶</p>
      </div>
    </div>

        <!-- Calend√°rio interativo -->
    <div class="card">
      <h2>Calend√°rio de explica√ß√µes</h2>
      <div class="calendario-header">
        <button id="calPrev" class="icon-button" type="button">‚óÄ</button>
        <p id="calMesTitulo"></p>
        <button id="calNext" class="icon-button" type="button">‚ñ∂</button>
      </div>
      <ul id="calList" class="cal-list">
        <li>A carregar calend√°rio‚Ä¶</li>
      </ul>
      <p class="cal-hint">
        Confirma a tua presen√ßa nas sess√µes futuras para ajudar o explicador a planear.
      </p>
    </div>


    <!-- Pagamentos -->
    <div class="card">
      <h2>Pagamentos</h2>
      <div class="table-wrapper">
        <table id="tabPag">
          <thead>
            <tr>
              <th>M√™s</th>
              <th>Previsto</th>
              <th>Pago</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="4">A carregar pagamentos‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Exerc√≠cios -->
    <div class="card">
      <h2>Exerc√≠cios</h2>
      <ul id="exlist">
        <li>A carregar exerc√≠cios‚Ä¶</li>
      </ul>
    </div>

        <!-- Mensagens com o explicador -->
    <div class="card">
      <h2>Mensagens</h2>
      <div id="msgList" class="msg-list">
        <p>A carregar conversas‚Ä¶</p>
      </div>

      <form id="fMsg" class="msg-form">
        <label for="msgInput">Enviar mensagem ao explicador</label>
        <textarea id="msgInput" name="msg" rows="3" required
          placeholder="Escreve aqui a tua mensagem‚Ä¶"></textarea>
        <button type="submit" class="button">Enviar</button>
        <p id="msgStatus" class="form__msg"></p>
      </form>
    </div>


    <!-- Alterar password -->
    <div class="card">
      <h2>Alterar palavra-passe</h2>
      <form id="fPwd">
        <label for="pwd">Nova palavra-passe</label>
        <input
          type="password"
          id="pwd"
          name="pwd"
          required
          minlength="6"
          autocomplete="new-password"
        />
        <button type="submit" class="button">Atualizar palavra-passe</button>
        <p id="pwdMsg" class="form__msg"></p>
      </form>
    </div>
  </section>
</main>

<footer>¬© <span id="y"></span> EduSphere</footer>

<script>
  // ano no footer
  document.getElementById('y').textContent = new Date().getFullYear();

  // manter o que j√° tinhas para carregar nome + ano do aluno
  (async () => {
    const user = await Auth.requireRole('aluno', './login.html');
    if (!user) return;

    const { data: map, error: mapErr } = await supabase
      .from('app_users')
      .select('ref_id')
      .eq('user_id', user.id)
      .single();

    console.log('DEBUG app_users map', { map, mapErr });

    const { data: aluno, error: alunoErr } = await supabase
      .from('alunos')
      .select('id_aluno, nome, apelido, ano')
      .eq('id_aluno', map.ref_id)
      .single();

    if (alunoErr) {
      console.error('Erro a carregar aluno', alunoErr);
    }

    const t = aluno
      ? `${aluno.nome} ${aluno.apelido ?? ''} ‚Äî Ano ${aluno.ano ?? 'n/d'}`
      : 'Perfil n√£o encontrado';

    document.getElementById('alunoInfo').textContent = t;
  })();
</script>

<!-- Toast / feedback visual -->
<div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>
<!-- script com a l√≥gica de agenda/pagamentos/exerc√≠cios/password -->
<script src="./public/js/pages/aluno.js"></script>
</body>
</html>
