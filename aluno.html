<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />
  <title>EduSphere ‚Äî √Årea do Aluno</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
  <script src="./public/js/auth.js"></script>
</head>
<body class="home">
<header>
  <div class="header-inner">
    <a class="logo" href="./index.html">
      <img src="/public/img/logo-icon.svg" alt="">
      <span>EduSphere</span>
    </a>
    <!-- usa id="logout" para o aluno.js apanhar -->
    <button id="logout" class="button" style="margin-left:auto">Sair</button>
  </div>
</header>
<div class="capa__overlay"></div>

<main class="auth">
  <section class="auth__panel">
    <h1>Bem-vindo üëã</h1>
    <p id="alunoInfo">A carregar‚Ä¶</p>

    <!-- Pr√≥ximas explica√ß√µes -->
    <div class="card">
      <h2>Pr√≥ximas explica√ß√µes</h2>
      <div id="agenda">
        <p>A carregar agenda‚Ä¶</p>
      </div>
    </div>

    <!-- Pagamentos -->
    <div class="card">
      <h2>Pagamentos</h2>
      <div class="table-wrapper">
        <table id="tabPag">
          <thead>
            <tr>
              <th>M√™s</th>
              <th>Previsto</th>
              <th>Pago</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="4">A carregar pagamentos‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Exerc√≠cios -->
    <div class="card">
      <h2>Exerc√≠cios</h2>
      <ul id="exlist">
        <li>A carregar exerc√≠cios‚Ä¶</li>
      </ul>
    </div>

    <!-- Alterar password -->
    <div class="card">
      <h2>Alterar palavra-passe</h2>
      <form id="fPwd">
        <label for="pwd">Nova palavra-passe</label>
        <input
          type="password"
          id="pwd"
          name="pwd"
          required
          minlength="6"
          autocomplete="new-password"
        />
        <button type="submit" class="button">Atualizar palavra-passe</button>
        <p id="pwdMsg" class="form__msg"></p>
      </form>
    </div>
  </section>
</main>

<footer>¬© <span id="y"></span> EduSphere</footer>

<script>
  // ano no footer
  document.getElementById('y').textContent = new Date().getFullYear();

  // manter o que j√° tinhas para carregar nome + ano do aluno
  (async () => {
    const user = await Auth.requireRole('aluno', './login.html');
    if (!user) return;

    const { data: map, error: mapErr } = await supabase
      .from('app_users')
      .select('ref_id')
      .eq('user_id', user.id)
      .single();

    console.log('DEBUG app_users map', { map, mapErr });

    const { data: aluno, error: alunoErr } = await supabase
      .from('alunos')
      .select('id_aluno, nome, apelido, ano')
      .eq('id_aluno', map.ref_id)
      .single();

    if (alunoErr) {
      console.error('Erro a carregar aluno', alunoErr);
    }

    const t = aluno
      ? `${aluno.nome} ${aluno.apelido ?? ''} ‚Äî Ano ${aluno.ano ?? 'n/d'}`
      : 'Perfil n√£o encontrado';

    document.getElementById('alunoInfo').textContent = t;
  })();
</script>

<!-- script com a l√≥gica de agenda/pagamentos/exerc√≠cios/password -->
<script src="./public/js/pages/aluno.js"></script>
</body>
</html>
