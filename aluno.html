<!doctype html>
<html lang="pt">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>EduSphere — Área do Aluno</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Material Symbols -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
  <script src="./public/js/auth.js"></script>
  <link rel="stylesheet" href="./css/nav.css" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            primary: '#2563eb',
            secondary: '#475569',
          }
        }
      }
    }
  </script>
  <style>
    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    body {
      background-color: #f3f4f6;
    }
  </style>
</head>

<body class="text-gray-900 overflow-hidden">

  <!-- Mobile Container -->
  <div
    class="fixed inset-0 w-full h-full bg-gray-50 flex flex-col max-w-md mx-auto shadow-2xl relative overflow-hidden">

    <!-- Header -->
    <header
      class="bg-white/90 backdrop-blur-md border-b border-gray-100 p-4 sticky top-0 z-20 flex items-center justify-between shadow-sm flex-shrink-0">
      <div class="flex items-center gap-3">
        <div id="alunoAvatar"
          class="h-10 w-10 rounded-full bg-primary/10 text-primary flex items-center justify-center font-bold text-sm border border-primary/20">
          ??
        </div>
        <div>
          <h1 id="alunoNomeTitulo" class="font-bold text-gray-900 text-sm leading-tight">Bem-vindo</h1>
          <p id="alunoInfo" class="text-xs text-gray-500">A carregar...</p>
        </div>
      </div>
      <button id="btnLogout"
        class="p-2 rounded-full text-gray-400 hover:bg-gray-100 hover:text-red-600 transition-colors">
        <span class="material-symbols-outlined text-[20px]">logout</span>
      </button>
    </header>

    <!-- Main Content Area (Scrollable) -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden custom-scrollbar pb-28 p-4 space-y-6 relative">

      <!-- VIEW: DASHBOARD (INÍCIO) -->
      <section id="view-inicio" class="view-section space-y-6">

        <!-- KPI Grid -->
        <div class="grid grid-cols-2 gap-3">
          <!-- Próxima Aula -->
          <div
            class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm relative overflow-hidden group hover:border-primary/30 transition-colors cursor-pointer"
            onclick="document.querySelector('[data-target=calendario]').click()">
            <div
              class="absolute -right-4 -top-4 bg-blue-50 h-16 w-16 rounded-full group-hover:scale-110 transition-transform">
            </div>
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wide relative z-10">Próxima Aula</p>
            <p id="kpiProximaAula" class="text-xl font-bold text-gray-900 mt-1 relative z-10">—</p>
            <p id="kpiProximaAulaDesc" class="text-[10px] text-gray-500 mt-1 relative z-10 font-medium">Ver calendário
            </p>
          </div>

          <!-- Pagamentos -->
          <div
            class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm relative overflow-hidden group hover:border-green-500/30 transition-colors cursor-pointer"
            onclick="document.querySelector('[data-target=pagamentos]').click()">
            <div
              class="absolute -right-4 -top-4 bg-green-50 h-16 w-16 rounded-full group-hover:scale-110 transition-transform">
            </div>
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wide relative z-10">Mensalidade</p>
            <p id="resumoValor" class="text-xl font-bold text-gray-900 mt-1 relative z-10">—</p>
            <div class="flex items-center gap-1 mt-1 relative z-10">
              <span id="resumoEstado"
                class="text-[10px] font-bold uppercase px-1.5 py-0.5 rounded bg-gray-100 text-gray-500">—</span>
            </div>
          </div>
        </div>

        <!-- Quick Actions / Warnings -->
        <div id="pagAlert" class="hidden bg-amber-50 border border-amber-100 rounded-xl p-4 flex items-start gap-3">
          <span class="material-symbols-outlined text-amber-600">warning</span>
          <div>
            <h3 class="font-bold text-amber-900 text-sm">Atenção Necessária</h3>
            <p class="text-xs text-amber-700 mt-1 text-alert-content">Verifique os pagamentos pendentes.</p>
          </div>
        </div>

        <!-- Próximas Aulas List -->
        <div>
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-bold text-gray-900">Agenda</h2>
            <button class="text-xs font-bold text-primary hover:text-primary/80"
              onclick="document.querySelector('[data-target=calendario]').click()">Ver tudo</button>
          </div>
          <div id="agenda" class="flex flex-col gap-2">
            <div class="p-8 text-center text-gray-400 text-sm bg-white rounded-xl border border-gray-100 border-dashed">
              A carregar agenda...</div>
          </div>
        </div>

        <!-- Quick links -->
        <div class="grid grid-cols-1 gap-3">
          <div
            class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between cursor-pointer hover:bg-gray-50"
            onclick="document.querySelector('[data-target=mensagens]').click()">
            <div class="flex items-center gap-3">
              <div class="h-8 w-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center">
                <span class="material-symbols-outlined text-lg">chat</span>
              </div>
              <div>
                <p class="text-sm font-bold text-gray-900">Mensagens</p>
                <p id="kpiMensagens" class="text-xs text-gray-500">Falar com o explicador</p>
              </div>
            </div>
            <span class="material-symbols-outlined text-gray-300">chevron_right</span>
          </div>
        </div>

      </section>

      <!-- VIEW: CALENDÁRIO -->
      <section id="view-calendario" class="view-section hidden space-y-6">
        <h2 class="text-xl font-bold text-gray-900 mb-2">Explicador</h2>

        <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
          <div id="cal-ui" class="calendar-ui-grid">
            <!-- Grid Calendar injected by JS -->
          </div>
        </div>

        <div>
          <h3 class="font-bold text-gray-900 mb-3 text-sm uppercase text-gray-500">Próximas</h3>
          <div id="calProximas" class="space-y-2"></div>
        </div>

        <div>
          <h3 class="font-bold text-gray-900 mb-3 text-sm uppercase text-gray-500">Histórico</h3>
          <div id="calHistorico" class="space-y-2 opacity-70"></div>
        </div>
      </section>

      <!-- VIEW: PAGAMENTOS -->
      <section id="view-pagamentos" class="view-section hidden space-y-6">
        <h2 class="text-xl font-bold text-gray-900">Financeiro</h2>

        <!-- Cards Resumo -->
        <div class="grid grid-cols-2 gap-3">
          <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
            <p class="text-xs text-gray-500 font-bold uppercase">Total Pago</p>
            <p id="pagTotalPago" class="text-lg font-bold text-green-600 mt-1">€0,00</p>
          </div>
          <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
            <p class="text-xs text-gray-500 font-bold uppercase">Pendente</p>
            <p id="pagValorPendente" class="text-lg font-bold text-amber-600 mt-1">€0,00</p>
          </div>
        </div>

        <!-- Detalhe Pagamento Pendente -->
        <div class="bg-white rounded-xl border border-gray-100 p-4 shadow-sm">
          <h3 class="font-bold text-sm text-gray-900 mb-4 pb-2 border-b border-gray-100">Próximo Vencimento</h3>
          <div id="pagDados" class="space-y-3 text-sm">
            <p class="text-gray-500 italic text-center text-xs py-2">Sem pagamentos pendentes.</p>
          </div>

          <button id="btnPagarAgora"
            class="w-full mt-4 bg-gray-900 text-white font-medium py-2.5 rounded-lg text-sm shadow-lg shadow-gray-200 active:scale-95 transition-transform disabled:opacity-50 disabled:cursor-not-allowed">
            Pagar Agora
          </button>

          <div class="flex gap-2 mt-2">
            <button id="btnComprovativo"
              class="flex-1 bg-white border border-gray-200 text-gray-600 font-medium py-2 rounded-lg text-xs hover:bg-gray-50 disabled:opacity-50">
              Enviar Comprovativo
            </button>
            <button id="btnDownloadFatura"
              class="flex-1 bg-white border border-gray-200 text-gray-600 font-medium py-2 rounded-lg text-xs hover:bg-gray-50 disabled:opacity-50">
              Última Fatura
            </button>
          </div>
        </div>

        <!-- Tabela Histórico -->
        <div class="bg-white rounded-xl border border-gray-100 overflow-hidden shadow-sm">
          <div class="px-4 py-3 border-b border-gray-100 bg-gray-50/50">
            <h3 class="font-bold text-sm text-gray-800">Histórico</h3>
          </div>
          <div class="overflow-x-auto">
            <table id="tabPag" class="w-full text-left">
              <thead class="text-xs text-gray-400 uppercase font-medium bg-gray-50">
                <tr>
                  <th class="px-4 py-3 font-semibold">Mês</th>
                  <th class="px-4 py-3 font-semibold">Valor</th>
                  <th class="px-4 py-3 font-semibold text-right">Estado</th>
                </tr>
              </thead>
              <tbody class="text-sm divide-y divide-gray-100">
                <!-- JS Fill -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Hidden Helper IDs for compatibility -->
        <span id="pagProxVencimento" class="hidden"></span>
        <span id="pagProxMes" class="hidden"></span>
        <span id="resumoHint" class="hidden"></span>
        <span id="resumoMesLabel" class="hidden"></span>
      </section>

      <!-- VIEW: MENSAGENS -->
      <section id="view-mensagens" class="view-section hidden"
        style="flex-direction:column; height:calc(100vh - 140px);">
        <h2 class="text-xl font-bold text-gray-900 mb-3 flex-shrink-0">Mensagens</h2>

        <!-- Chat Container -->
        <div id="chatContainer" class="flex-1 overflow-y-auto space-y-3 pb-3 custom-scrollbar" style="min-height:0;">
          <div class="text-center py-8">
            <div
              class="bg-indigo-50 h-14 w-14 rounded-full flex items-center justify-center mx-auto mb-3 text-indigo-400">
              <span class="material-symbols-outlined text-2xl">chat_bubble</span>
            </div>
            <p class="text-xs text-gray-400">Envia uma mensagem ao teu explicador</p>
          </div>
        </div>

        <!-- Message Input -->
        <form id="fMsg"
          class="flex-shrink-0 bg-white border border-gray-100 rounded-xl p-2 flex items-center gap-2 shadow-sm">
          <input type="text" name="msg" id="msgInput" autocomplete="off"
            class="flex-1 text-sm px-3 py-2 bg-gray-50 rounded-lg border-0 focus:ring-2 focus:ring-primary/20 outline-none"
            placeholder="Escreve aqui..." />
          <button type="submit"
            class="h-9 w-9 rounded-lg bg-primary text-white flex items-center justify-center flex-shrink-0 hover:bg-primary/90 active:scale-95 transition-transform">
            <span class="material-symbols-outlined text-lg">send</span>
          </button>
        </form>
        <p id="msgStatus" class="text-xs text-center text-gray-500 mt-1 flex-shrink-0"></p>
      </section>

      <!-- VIEW: PERFIL -->
      <section id="view-perfil" class="view-section hidden space-y-6">
        <h2 class="text-xl font-bold text-gray-900">O Meu Perfil</h2>

        <div class="bg-white rounded-xl border border-gray-100 p-4 shadow-sm">
          <h3 class="font-bold text-sm text-gray-800 mb-4">Segurança</h3>
          <form id="fPwd" class="space-y-4">
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nova Password</label>
              <input type="password" id="pwd"
                class="w-full bg-gray-50 border border-gray-200 rounded-lg h-10 px-3 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all">
            </div>
            <button type="submit"
              class="w-full bg-gray-900 text-white font-medium py-2.5 rounded-lg text-sm shadow-lg shadow-gray-200 active:scale-95 transition-transform">
              Atualizar Password
            </button>
            <p id="pwdMsg" class="text-xs text-center text-gray-500"></p>
          </form>
        </div>

        <div class="text-center">
          <p class="text-[10px] text-gray-400">EduSphere App v2.0 · <span id="y"></span></p>
        </div>
      </section>

    </main>

    <!-- Bottom Navigation -->
    <nav class="app-footer-nav shadow-[0_-4px_10px_rgba(0,0,0,0.05)]"
      style="display: flex !important; position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 448px; height: 70px; z-index: 50;">
      <button class="app-nav-item active" data-target="inicio">
        <span class="material-symbols-outlined">dashboard</span>
        <span>Início</span>
      </button>
      <button class="app-nav-item" data-target="calendario">
        <span class="material-symbols-outlined">calendar_month</span>
        <span>Aulas</span>
      </button>
      <button class="app-nav-item relative" data-target="pagamentos">
        <span class="material-symbols-outlined">payments</span>
        <span>Contas</span>
        <span id="nav-dot-pag" class="absolute top-2 right-4 h-2 w-2 rounded-full bg-red-500 hidden"></span>
      </button>
      <button class="app-nav-item" data-target="mensagens">
        <span class="material-symbols-outlined">chat</span>
        <span>Chat</span>
      </button>
      <button class="app-nav-item" data-target="perfil">
        <span class="material-symbols-outlined">person</span>
        <span>Eu</span>
      </button>
    </nav>

  </div>

  <script>
    // --- Navigation Logic ---
    const navBtns = document.querySelectorAll('.app-nav-item');
    const sections = document.querySelectorAll('.view-section');

    function switchTab(targetId) {
      // Hide all sections
      sections.forEach(sec => { sec.classList.add('hidden'); sec.style.display = ''; });
      // Show target
      const targetSec = document.getElementById(`view-${targetId}`);
      if (targetSec) {
        targetSec.classList.remove('hidden');
        if (targetId === 'mensagens') targetSec.style.display = 'flex';
      }

      // Update nav
      navBtns.forEach(btn => {
        if (btn.dataset.target === targetId) btn.classList.add('active');
        else btn.classList.remove('active');
      });

      // Logic hooks
      if (targetId === 'calendario') carregarCalendarioNovo();
      if (targetId === 'mensagens') carregarMensagens();
    }

    navBtns.forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn.dataset.target));
    });

    // Default View
    switchTab('inicio');


    // ============================================
    // APPLICATION LOGIC (Adapted for Tailwind UI)
    // ============================================

    window.ALUNO = null;
    const yEl = document.getElementById('y');
    if (yEl) yEl.textContent = new Date().getFullYear();

    // Prevent Back Nav
    if (window.history && window.history.replaceState) {
      window.history.replaceState(null, '', window.location.href);
    }
    window.addEventListener("popstate", () => {
      window.history.pushState(null, "", window.location.href);
    });


    // --- CALENDAR LOGIC ---
    async function carregarCalendarioNovo() {
      const proxContainer = document.getElementById("calProximas");
      const histContainer = document.getElementById("calHistorico");
      const calUi = document.getElementById("cal-ui");

      if (!window.ALUNO || !ALUNO.id_aluno) return;

      const hoje = new Date().toISOString().slice(0, 10);
      const { data, error } = await supabase
        .from("sessoes_explicacao")
        .select(`id_sessao, data, hora_inicio, duracao_min, estado, explicador:explicadores(nome)`)
        .eq("id_aluno", ALUNO.id_aluno)
        .order("data", { ascending: true })
        .order("hora_inicio", { ascending: true });

      if (error) {
        console.error(error);
        if (proxContainer) proxContainer.innerHTML = "<p class='text-xs text-red-500'>Erro ao carregar.</p>";
        return;
      }

      const sessoes = data || [];
      const futuras = sessoes.filter((s) => s.data >= hoje);
      const passadas = sessoes.filter((s) => s.data < hoje);

      if (proxContainer) {
        proxContainer.innerHTML = futuras.length
          ? futuras.map((a) => renderCalendarioItem(a, true)).join("")
          : "<p class='text-xs text-gray-400 italic'>Sem aulas agendadas.</p>";
      }

      if (histContainer) {
        histContainer.innerHTML = passadas.length
          ? passadas.map((a) => renderCalendarioItem(a, false)).join("")
          : "<p class='text-xs text-gray-400 italic'>Histórico vazio.</p>";
      }

      renderCalendarioVisual(sessoes);
    }

    function renderCalendarioItem(a, isFuture) {
      const d = a.data ? new Date(a.data) : null;
      const dataFmt = d ? d.toLocaleDateString("pt-PT", { day: "2-digit", month: "short" }) : "—";
      const hora = a.hora_inicio ? a.hora_inicio.slice(0, 5) : "--:--";
      // Status Badge Logic
      let statusColor = "bg-gray-100 text-gray-500";
      let statusText = a.estado || 'AGENDADA';
      if (a.estado === "REALIZADA") statusColor = "bg-green-100 text-green-700";
      if (a.estado === "AGENDADA") statusColor = "bg-blue-100 text-blue-700";
      if (a.estado === "CONFIRMADA") { statusColor = "bg-emerald-100 text-emerald-700"; statusText = "Confirmada"; }
      if (a.estado === "CANCELADA") statusColor = "bg-red-50 text-red-400";

      // Show confirm button for future AGENDADA sessions
      const confirmBtn = (isFuture && a.estado === 'AGENDADA')
        ? `<button onclick="confirmarPresenca('${a.id_sessao}', this)" class="mt-2 w-full text-[10px] font-bold py-1.5 rounded-lg bg-emerald-50 text-emerald-700 hover:bg-emerald-100 transition-colors border border-emerald-100">Confirmar presença</button>`
        : '';

      return `
          <div class="bg-white border border-gray-100 p-3 rounded-lg shadow-sm">
             <div class="flex items-center justify-between">
               <div class="flex items-center gap-3">
                 <div class="h-10 w-10 rounded-lg bg-gray-50 flex flex-col items-center justify-center border border-gray-100">
                    <span class="text-[10px] text-gray-400 uppercase font-bold leading-none">${d ? d.toLocaleDateString("pt-PT", { weekday: 'short' }).replace('.', '') : ''}</span>
                    <span class="text-sm font-bold text-gray-900 leading-none mt-0.5">${d ? d.getDate() : ''}</span>
                 </div>
                 <div>
                    <p class="text-sm font-bold text-gray-900">${a.explicador?.nome || 'Explicação'}</p>
                    <p class="text-xs text-gray-500">${hora} · ${a.duracao_min} min</p>
                 </div>
               </div>
               <span class="text-[9px] font-bold px-1.5 py-0.5 rounded uppercase ${statusColor}">${statusText}</span>
             </div>
             ${confirmBtn}
          </div>
        `;
    }

    function renderCalendarioVisual(sessoes) {
      const cal = document.getElementById("cal-ui");
      if (!cal) return;

      const hoje = new Date();
      const ano = hoje.getFullYear();
      const mesIndex = hoje.getMonth();
      const sessoesPorDia = {};

      sessoes.forEach((s) => {
        if (!s.data) return;
        const d = new Date(s.data);
        if (d.getFullYear() !== ano || d.getMonth() !== mesIndex) return;
        const dia = d.getDate();
        if (!sessoesPorDia[dia]) sessoesPorDia[dia] = [];
        sessoesPorDia[dia].push(s);
      });

      const firstDay = new Date(ano, mesIndex, 1);
      const lastDay = new Date(ano, mesIndex + 1, 0);
      const diasNoMes = lastDay.getDate();
      const offsetSegunda = (firstDay.getDay() + 6) % 7;

      const labelMes = firstDay.toLocaleDateString("pt-PT", { month: "long", year: "numeric" });

      let html = `
        <div class="flex items-center justify-between mb-4">
           <h3 class="font-bold text-gray-900 capitalize">${labelMes}</h3>
           <div class="flex gap-1">
             <div class="h-2 w-2 rounded-full bg-green-500" title="Realizada"></div>
             <div class="h-2 w-2 rounded-full bg-blue-500" title="Agendada"></div>
           </div>
        </div>
        <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-400 font-medium mb-2">
            <div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div><div>Dom</div>
        </div>
        <div class="grid grid-cols-7 gap-1">
      `;

      for (let i = 0; i < offsetSegunda; i++) html += `<div class="h-8"></div>`;

      for (let dia = 1; dia <= diasNoMes; dia++) {
        const sessList = sessoesPorDia[dia] || [];
        const hasSession = sessList.length > 0;
        let dotColor = "bg-gray-300";
        if (hasSession) {
          if (sessList.some(s => s.estado === 'REALIZADA')) dotColor = "bg-green-500";
          else if (sessList.some(s => s.estado === 'AGENDADA')) dotColor = "bg-blue-500";
        }

        const activeClass = hasSession ? "font-bold text-gray-900 bg-gray-50 rounded-lg" : "text-gray-500";
        const dotHtml = hasSession ? `<div class="mx-auto mt-0.5 h-1 w-1 rounded-full ${dotColor}"></div>` : '';

        html += `
          <div class="h-9 flex flex-col items-center justify-center ${activeClass}">
             <span>${dia}</span>
             ${dotHtml}
          </div>
        `;
      }
      html += `</div>`;
      cal.innerHTML = html;
    }


    // --- PAYMENTS LOGIC ---
    async function carregarResumoPagamentos() {
      const tbody = document.querySelector('#tabPag tbody');
      const alertEl = document.getElementById('pagAlert');
      const totalPagoEl = document.getElementById('pagTotalPago');
      const pendenteEl = document.getElementById('pagValorPendente');
      const dadosEl = document.getElementById('pagDados');
      const btnPagarAgora = document.getElementById('btnPagarAgora');

      // KPI Cards
      const resumoValorEl = document.getElementById('resumoValor');
      const resumoEstadoEl = document.getElementById('resumoEstado');

      if (!window.ALUNO || !ALUNO.id_aluno) return;

      // Initial state
      if (tbody) tbody.innerHTML = "<tr><td colspan='3' class='p-4 text-center text-xs text-gray-400'>A carregar...</td></tr>";

      const { data, error } = await supabase
        .from('v_pagamentos_detalhe')
        .select('*')
        .eq('id_aluno', ALUNO.id_aluno)
        .order('ano', { ascending: true })
        .order('mes', { ascending: true });

      if (error) return;

      const pag = (data || []).filter(Boolean);
      const totalPago = pag.reduce((acc, p) => acc + (Number(p.valor_pago || 0)), 0);

      // Update Totals
      if (totalPagoEl) totalPagoEl.textContent = "€ " + totalPago.toLocaleString('pt-PT', { minimumFractionDigits: 2 });

      // Logic for Pending Info: Find the first record that is NOT 'PAGO'
      const pendentes = pag.filter(p => (p.estado || '').toUpperCase() !== 'PAGO')
        .sort((a, b) => (a.ano * 100 + a.mes) - (b.ano * 100 + b.mes));

      let pendingVal = 0;
      let pendingLabel = "Em dia";
      let pendingDetailHtml = "<p class='text-gray-500 italic text-center text-xs py-2'>Sem pagamentos pendentes.</p>";
      let hasPending = false;
      let pendingTarget = null;

      if (pendentes.length > 0) {
        pendingTarget = pendentes[0];
        hasPending = true;
      } else {
        // Predictive: Check current month if not in pag list
        const hoje = new Date();
        const anoA = hoje.getFullYear();
        const mesA = hoje.getMonth() + 1;
        const hasRec = pag.some(p => p.ano === anoA && p.mes === mesA);
        if (!hasRec) {
          const start = `${anoA}-${String(mesA).padStart(2, '0')}-01`;
          const end = new Date(anoA, mesA, 0).toISOString().slice(0, 10);
          const { data: expMes } = await supabase.from('sessoes_explicacao').select('id_sessao').eq('id_aluno', ALUNO.id_aluno).gte('data', start).lte('data', end);
          if (expMes && expMes.length > 0) {
            hasPending = true;
            pendingTarget = { ano: anoA, mes: mesA, valor_previsto: expMes.length * 25, valor_pago: 0, estado: 'PREVISTO' };
          }
        }
      }

      if (hasPending && pendingTarget) {
        const p = pendingTarget;
        pendingVal = Number(p.valor_previsto || 0) - Number(p.valor_pago || 0);

        if (pendingVal > 0) {
          hasPending = true;
          const dateObj = new Date(p.ano, p.mes - 1, 1);
          pendingLabel = dateObj.toLocaleDateString("pt-PT", { month: 'long' });

          pendingDetailHtml = `
                <div class="flex justify-between py-2 border-b border-gray-50 last:border-0 hover:bg-gray-50 px-2 rounded -mx-2">
                    <span class="text-gray-500">Mês</span>
                    <span class="font-bold text-gray-900 capitalize">${pendingLabel}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-50 last:border-0 hover:bg-gray-50 px-2 rounded -mx-2">
                    <span class="text-gray-500">Estado</span>
                    <span class="font-bold text-amber-600">${p.estado}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-50 last:border-0 hover:bg-gray-50 px-2 rounded -mx-2">
                    <span class="text-gray-500">Valor em Falta</span>
                    <span class="font-bold text-primary">€ ${pendingVal.toFixed(2)}</span>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg mt-2">
                    <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">IBAN para Transferência</p>
                    <p class="font-mono text-xs text-gray-800 tracking-wide select-all">PT50 0023 0000 4571 5712 9719 4</p>
                </div>
            `;
        }
      }

      // Update Pending UI
      if (pendenteEl) pendenteEl.textContent = "€ " + pendingVal.toLocaleString('pt-PT', { minimumFractionDigits: 2 });
      if (dadosEl) dadosEl.innerHTML = pendingDetailHtml;

      // KPI Dashboard Updates
      if (resumoValorEl) resumoValorEl.textContent = hasPending ? `€ ${pendingVal}` : "Em dia";
      if (resumoValorEl && !hasPending) resumoValorEl.classList.replace('text-gray-900', 'text-green-600');
      if (resumoEstadoEl) {
        resumoEstadoEl.textContent = hasPending ? pendingLabel : "Regularizado";
        resumoEstadoEl.className = hasPending
          ? "text-[10px] font-bold uppercase px-1.5 py-0.5 rounded bg-amber-100 text-amber-700"
          : "text-[10px] font-bold uppercase px-1.5 py-0.5 rounded bg-green-100 text-green-700";
      }

      // Alert Logic
      if (alertEl) {
        if (hasPending) {
          alertEl.classList.remove('hidden');
          const alertContent = alertEl.querySelector('.text-alert-content');
          if (alertContent) alertContent.textContent = `Pagamento de ${pendingLabel} em falta (€${pendingVal}).`;
          // Also show nav dot
          document.getElementById('nav-dot-pag')?.classList.remove('hidden');
        } else {
          alertEl.classList.add('hidden');
          document.getElementById('nav-dot-pag')?.classList.add('hidden');
        }
      }

      if (btnPagarAgora) btnPagarAgora.disabled = !hasPending;

      // Render History Table
      const historyPagos = pag.filter(p => (p.estado || '').toLowerCase() === 'pago').sort((a, b) => (b.ano * 100 + b.mes) - (a.ano * 100 + a.mes));

      if (tbody) {
        if (!historyPagos.length) {
          tbody.innerHTML = "<tr><td colspan='3' class='p-4 text-center text-xs text-gray-400'>Histórico vazio.</td></tr>";
        } else {
          tbody.innerHTML = historyPagos.map(p => {
            const mLabel = new Date(p.ano, p.mes - 1, 1).toLocaleDateString("pt-PT", { month: 'short' });
            return `
              <tr class="hover:bg-gray-50 border-b border-gray-50 last:border-0 text-gray-700">
                <td class="px-4 py-3 font-medium capitalize text-gray-900">${mLabel} ${p.ano}</td>
                <td class="px-4 py-3">€ ${Number(p.valor_pago).toFixed(2)}</td>
                <td class="px-4 py-3 text-right"><span class="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-0.5 rounded uppercase">Pago</span></td>
              </tr>
            `;
          }).join("");
        }
      }
    }


    // --- DASHBOARD: UPCOMING LESSONS ---
    async function carregarProximasExplicacoes() {
      const container = document.getElementById('agenda');
      if (!container || !ALUNO.id_aluno) return;

      const hojeStr = new Date().toISOString().slice(0, 10);
      const { data } = await supabase.from('sessoes_explicacao')
        .select('*').eq('id_aluno', ALUNO.id_aluno).gte('data', hojeStr)
        .order('data', { ascending: true }).limit(3);

      const sessoes = data || [];

      if (!sessoes.length) {
        container.innerHTML = "<p class='p-4 text-center text-xs text-gray-400 border border-gray-100 rounded-xl bg-white'>Sem aulas próximas.</p>";
        document.getElementById('kpiProximaAula').textContent = "—";
        document.getElementById('kpiProximaAulaDesc').textContent = "Sem agendamento";
        return;
      }

      // Update KPI
      const next = sessoes[0];
      const nextDate = new Date(next.data);
      document.getElementById('kpiProximaAula').textContent = nextDate.getDate() + " " + nextDate.toLocaleDateString("pt-PT", { month: 'short' }).replace('.', '');
      document.getElementById('kpiProximaAulaDesc').textContent = (next.hora_inicio || '').slice(0, 5);

      // Render List
      container.innerHTML = sessoes.map(s => {
        const d = new Date(s.data);
        const hora = (s.hora_inicio || '').slice(0, 5);
        return `
               <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between">
                  <div class="flex items-center gap-3">
                     <div class="bg-blue-50 text-blue-600 h-10 w-10 rounded-lg flex flex-col items-center justify-center">
                        <span class="text-[10px] font-bold uppercase leading-none text-blue-400">${d.toLocaleDateString("pt-PT", { weekday: 'short' }).replace('.', '')}</span>
                        <span class="text-sm font-bold leading-none mt-0.5">${d.getDate()}</span>
                     </div>
                     <div>
                        <p class="text-sm font-bold text-gray-900">Explicação</p>
                        <p class="text-xs text-gray-500">${hora} · ${s.duracao_min}m</p>
                     </div>
                  </div>
                  <span class="material-symbols-outlined text-gray-300">chevron_right</span>
               </div>
             `;
      }).join("");
    }


    // --- BOOTSTRAP ---
    (async () => {
      const user = await Auth.requireRole('aluno', './login.html');
      if (!user) return;

      // Map User
      const { data: map } = await supabase.from('app_users').select('ref_id').eq('user_id', user.id).single();
      if (!map) return;

      // Fetch Aluno
      const { data: aluno } = await supabase.from('alunos').select('*').eq('id_aluno', map.ref_id).single();
      if (aluno) {
        // Also fetch explicador's auth user_id for messaging
        const { data: expl } = await supabase.from('explicadores').select('user_id').eq('id_explicador', aluno.id_explicador).single();
        aluno.auth_user_id = user.id;
        aluno.explicador_user_id = expl?.user_id || null;

        window.ALUNO = aluno;
        // Update Header
        document.getElementById('alunoNomeTitulo').textContent = aluno.nome + " " + (aluno.apelido || '');
        const ini = (aluno.nome?.[0] || '') + (aluno.apelido?.[0] || '');
        document.getElementById('alunoAvatar').textContent = ini.toUpperCase();
        document.getElementById('alunoInfo').textContent = (aluno.ano ? `${aluno.ano}º Ano` : 'Aluno');

        // Load Data
        carregarProximasExplicacoes();
        carregarResumoPagamentos();
      }
    })();


    // --- LOGOUT ---
    document.getElementById('btnLogout')?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = './login.html';
    });

    // --- CONFIRM ATTENDANCE ---
    async function confirmarPresenca(idSessao, btn) {
      btn.disabled = true;
      btn.textContent = 'A confirmar...';
      const { error } = await supabase
        .from('sessoes_explicacao')
        .update({ estado: 'CONFIRMADA' })
        .eq('id_sessao', idSessao);

      if (error) {
        console.error(error);
        btn.textContent = 'Erro - tentar novamente';
        btn.disabled = false;
      } else {
        btn.textContent = '✓ Presença confirmada';
        btn.className = 'mt-2 w-full text-[10px] font-bold py-1.5 rounded-lg bg-emerald-100 text-emerald-700 border border-emerald-200 cursor-default';
        // Refresh calendar
        setTimeout(() => carregarCalendarioNovo(), 500);
      }
    }
    // Make it globally accessible
    window.confirmarPresenca = confirmarPresenca;


    // --- MESSAGING LOGIC ---
    async function carregarMensagens() {
      const container = document.getElementById('chatContainer');
      if (!container || !ALUNO?.id_explicador) return;

      try {
        const { data, error } = await supabase
          .from('mensagens')
          .select('*')
          .or(`and(de_user_id.eq.${ALUNO.auth_user_id},para_user_id.eq.${ALUNO.explicador_user_id}),and(de_user_id.eq.${ALUNO.explicador_user_id},para_user_id.eq.${ALUNO.auth_user_id})`)
          .order('created_at', { ascending: true });

        if (error) throw error;

        const msgs = data || [];
        if (!msgs.length) {
          container.innerHTML = `
            <div class="text-center py-8">
              <div class="bg-indigo-50 h-14 w-14 rounded-full flex items-center justify-center mx-auto mb-3 text-indigo-400">
                <span class="material-symbols-outlined text-2xl">chat_bubble</span>
              </div>
              <p class="text-xs text-gray-400">Envia uma mensagem ao teu explicador</p>
            </div>`;
          return;
        }

        container.innerHTML = msgs.map(m => {
          const isMine = m.de_user_id === ALUNO.auth_user_id;
          const time = new Date(m.created_at).toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
          const date = new Date(m.created_at).toLocaleDateString('pt-PT', { day: '2-digit', month: 'short' });
          return `
            <div class="flex ${isMine ? 'justify-end' : 'justify-start'}">
              <div class="max-w-[75%] px-3 py-2 rounded-2xl text-sm ${isMine ? 'bg-primary text-white rounded-br-sm' : 'bg-white border border-gray-100 text-gray-800 rounded-bl-sm shadow-sm'}">
                <p>${m.texto}</p>
                <p class="text-[9px] mt-1 ${isMine ? 'text-white/60' : 'text-gray-400'}">${date} ${time}</p>
              </div>
            </div>`;
        }).join('');

        container.scrollTop = container.scrollHeight;
      } catch (err) {
        console.error('Erro ao carregar mensagens:', err);
        container.innerHTML = `
          <div class="text-center py-8">
            <div class="bg-indigo-50 h-14 w-14 rounded-full flex items-center justify-center mx-auto mb-3 text-indigo-400">
              <span class="material-symbols-outlined text-2xl">chat_bubble</span>
            </div>
            <p class="text-xs text-gray-400">Envia uma mensagem ao teu explicador</p>
          </div>`;
      }
    }

    // --- Message Form ---
    document.getElementById('fMsg')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = document.getElementById('msgInput');
      const texto = input?.value?.trim();
      if (!texto || !ALUNO?.id_explicador) return;

      const statusEl = document.getElementById('msgStatus');
      try {
        const { error } = await supabase.from('mensagens').insert({
          de_user_id: ALUNO.auth_user_id,
          para_user_id: ALUNO.explicador_user_id,
          texto: texto,
          id_aluno: ALUNO.id_aluno
        });

        if (error) throw error;
        input.value = '';
        await carregarMensagens();
      } catch (err) {
        console.error(err);
        if (statusEl) {
          statusEl.textContent = 'Erro ao enviar. Tenta novamente.';
          setTimeout(() => statusEl.textContent = '', 3000);
        }
      }
    });

  </script>
</body>

</html>