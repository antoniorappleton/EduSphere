<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="./styles.css"/>
  <title>EduSphere ‚Äî √Årea do Aluno</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
  <script src="./public/js/auth.js"></script>
</head>
<body class="home">
<header>
  <div class="header-inner">
    <a class="logo" href="./index.html"><img src="/public/img/logo-icon.svg" alt=""><span>EduSphere</span></a>
    <button id="btnLogout" class="button" style="margin-left:auto">Sair</button>
  </div>
</header>
<div class="capa__overlay"></div>

<main class="auth">
  <section class="auth__panel">
    <h1>Bem-vindo üëã</h1>
    <p id="alunoInfo">A carregar‚Ä¶</p>

    <div class="card">
      <h2>Pr√≥ximas explica√ß√µes</h2>
      <p>(Brevemente)</p>
    </div>

    <div class="card">
      <h2>Pagamentos</h2>
      <p>(Brevemente)</p>
    </div>
  </section>
</main>

<footer>¬© <span id="y"></span> EduSphere</footer>
<script>
document.getElementById('y').textContent = new Date().getFullYear();
document.getElementById('btnLogout')?.addEventListener('click', ()=> Auth.signOut('./index.html'));

(async ()=>{
  const user = await Auth.requireRole('aluno', './login.html'); 
  if(!user) return;

  const { data: map, error: mapErr } = await supabase
    .from('app_users')
    .select('ref_id')
    .eq('user_id', user.id)
    .single();

  console.log('DEBUG app_users map', { map, mapErr });

  const { data: aluno, error: alunoErr } = await supabase
  .from('alunos')
  .select('id_aluno, nome, apelido, ano')
  .eq('id_aluno', map.ref_id)
  .single();

if (alunoErr) {
  console.error('Erro a carregar aluno', alunoErr);
}

const t = aluno
  ? `${aluno.nome} ${aluno.apelido ?? ''} ‚Äî Ano ${aluno.ano ?? 'n/d'}`
  : 'Perfil n√£o encontrado';

document.getElementById('alunoInfo').textContent = t;

})();
</script>

</body>
</html>
