<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./css/aluno.css" />
  <link rel="stylesheet" href="./css/base.css" />
  <link rel="stylesheet" href="./css/aluno-perfil.css" />

  <title>EduSphere ‚Äî √Årea do Aluno</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
  <script src="./public/js/auth.js"></script>
</head>
<body class="home">
<header>
  <div class="header-inner">
    <a class="logo" href="./index.html">
      <img src="/public/img/imagens/logo-icon192.png" alt="">
      <span>EduSphere</span>
    </a>
    <!-- usa id="logout" para o aluno.js apanhar -->
    <button id="logout" class="button" style="margin-left:auto">Sair</button>
  </div>
</header>
<div class="capa__overlay"></div>

<main class="auth">
  
    <!-- HEADER DO ALUNO -->
    <div class="aluno-header">
      <div class="aluno-header-main">
        <div class="avatar" id="alunoAvatar">??</div>
        <div>
          <h1 id="alunoNomeTitulo">Bem-vindo üëã</h1>
          <p id="alunoInfo">A carregar‚Ä¶</p>
        </div>
      </div>
    </div>

    <!-- RESUMO R√ÅPIDO -->
    <div class="card card--highlight" id="resumoRapido">
      <h2>Resumo r√°pido</h2>
      <div class="resumo-grid">
        <div>
          <p class="resumo-label">Pr√≥xima mensalidade</p>
          <p class="resumo-value" id="resumoMesLabel">‚Äî</p>
        </div>
        <div>
          <p class="resumo-label">Estado</p>
          <p class="resumo-badge" id="resumoEstado">‚Äî</p>
        </div>
        <div>
          <p class="resumo-label">Valor</p>
          <p class="resumo-value" id="resumoValor">‚Äî</p>
        </div>
        <div class="resumo-actions">
          <button id="btnDownloadFatura" class="button secondary" disabled>
            üìÑ Download fatura
          </button>
        </div>
      </div>
      <p class="resumo-hint" id="resumoHint"></p>
    </div>
    <div class="aluno-grid">

      <!-- Calend√°rio interativo -->
      <div class="card">
        <h2>Calend√°rio de explica√ß√µes</h2>
        <div class="calendario-header">
          <button id="calPrev" class="icon-button" type="button">‚óÄ</button>
          <p id="calMesTitulo"></p>
          <button id="calNext" class="icon-button" type="button">‚ñ∂</button>
        </div>
        <ul id="calList" class="cal-list">
          <li>A carregar calend√°rio‚Ä¶</li>
        </ul>
        <p class="cal-hint">
          Confirma a tua presen√ßa nas sess√µes futuras para ajudar o explicador a planear.
        </p>
      </div>

      <!-- Pagamentos -->
      <div class="card">
        <h2>Pagamentos</h2>
        <div class="table-wrapper">
          <table id="tabPag" class="table table--wide">
            <thead>
              <tr>
                <th>M√™s</th>
                <th>Previsto</th>
                <th>Pago</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4">A carregar pagamentos‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Exerc√≠cios -->
      <div class="card">
        <h2>Exerc√≠cios</h2>
        <ul id="exlist">
          <li>A carregar exerc√≠cios‚Ä¶</li>
        </ul>
      </div>

          <!-- Mensagens com o explicador -->
      <div class="card">
        <h2>Mensagens</h2>
        <div id="msgList" class="msg-list">
          <p>A carregar conversas‚Ä¶</p>
        </div>

        <form id="fMsg" class="msg-form">
          <label for="msgInput">Enviar mensagem ao explicador</label>
          <textarea id="msgInput" name="msg" rows="3" required
            placeholder="Escreve aqui a tua mensagem‚Ä¶"></textarea>
          <button type="submit" class="button">Enviar</button>
          <p id="msgStatus" class="form__msg"></p>
        </form>
      </div>


      <!-- Alterar password -->
      <div class="card">
        <h2>Alterar palavra-passe</h2>
        <form id="fPwd">
          <label for="pwd">Nova palavra-passe</label>
          <input
            type="password"
            id="pwd"
            name="pwd"
            required
            minlength="6"
            autocomplete="new-password"
          />
          <button type="submit" class="button">Atualizar palavra-passe</button>
          <p id="pwdMsg" class="form__msg"></p>
        </form>
      </div>
    </div>
</main>

<footer>¬© <span id="y"></span> EduSphere</footer>

<script>
  // =========================
  // UTIL: ano no footer
  // =========================
  const yEl = document.getElementById('y');
  if (yEl) yEl.textContent = new Date().getFullYear();

  // =========================
  // ESTADO GLOBAL
  // =========================
  window.ALUNO = null;
  let CAL_ANO_ATUAL;
  let CAL_MES_ATUAL;

  // =========================
  // BOOTSTRAP DA P√ÅGINA
  // =========================
  (async () => {
    const user = await Auth.requireRole('aluno', './login.html');
    if (!user) return;

    // 1) mapear utilizador -> aluno
    const { data: map, error: mapErr } = await supabase
      .from('app_users')
      .select('ref_id')
      .eq('user_id', user.id)
      .single();

    if (mapErr || !map?.ref_id) {
      console.error('Erro a mapear utilizador para aluno', mapErr);
      const infoEl = document.getElementById('alunoInfo');
      if (infoEl) infoEl.textContent = 'N√£o foi poss√≠vel carregar os dados do aluno.';
      return;
    }

    // 2) obter dados do aluno
    const { data: aluno, error: alunoErr } = await supabase
      .from('alunos')
      .select('id_aluno, nome, apelido, ano')
      .eq('id_aluno', map.ref_id)
      .single();

    if (alunoErr || !aluno) {
      console.error('Erro a carregar aluno', alunoErr);
      const infoEl = document.getElementById('alunoInfo');
      if (infoEl) infoEl.textContent = 'Perfil n√£o encontrado';
      return;
    }

    // guardar globalmente
    window.ALUNO = aluno;

    // 3) preencher header (nome + ano + avatar)
    const nomeCompleto = `${aluno.nome} ${aluno.apelido ?? ''}`.trim();
    const iniciais = (aluno.nome?.[0] || '?') + (aluno.apelido?.[0] || '');
    const titulo = `${nomeCompleto} ‚Äî Ano ${aluno.ano ?? 'n/d'}`;

    const infoEl = document.getElementById('alunoInfo');
    if (infoEl) infoEl.textContent = titulo;

    const avatarEl = document.getElementById('alunoAvatar');
    const tituloEl = document.getElementById('alunoNomeTitulo');
    if (avatarEl) avatarEl.textContent = iniciais.toUpperCase();
    if (tituloEl) tituloEl.textContent = nomeCompleto || 'Bem-vindo üëã';

    // 4) inicializar navega√ß√£o do calend√°rio (m√™s atual)
    initCalendarioEstadoInicial();

    // 5) carregar cart√µes
    await Promise.all([
      carregarResumoPagamentos(),
      carregarProximasExplicacoes(),
      carregarCalendarioExplicacoes(),
    ]);
  })();

  // =========================
  // PR√ìXIMAS EXPLICA√á√ïES
  // =========================
  async function carregarProximasExplicacoes() {
    const container = document.getElementById('agenda');
    if (!container) return;

    if (!window.ALUNO || !ALUNO.id_aluno) {
      container.innerHTML = '<p>Erro ao carregar sess√µes.</p>';
      return;
    }

    container.innerHTML = '<p>A carregar agenda‚Ä¶</p>';

    const hojeStr = new Date().toISOString().slice(0, 10);

    const { data, error } = await supabase
      .from('sessoes_explicacao')
      .select('id_sessao, data, hora_inicio, duracao_min, estado, observacoes')
      .eq('id_aluno', ALUNO.id_aluno)
      .gte('data', hojeStr)               // s√≥ hoje em diante
      .order('data', { ascending: true })
      .order('hora_inicio', { ascending: true })
      .limit(5);

    if (error) {
      console.error('Erro a carregar sess√µes do aluno', error);
      container.innerHTML = '<p>Erro ao carregar sess√µes.</p>';
      return;
    }

    const sessoes = data || [];

    if (!sessoes.length) {
      container.innerHTML = '<p>N√£o tens pr√≥ximas explica√ß√µes agendadas.</p>';
      return;
    }

    const fmtData = { day: '2-digit', month: '2-digit', year: 'numeric' };

    const html = `
      <ul class="agenda-list">
        ${sessoes
          .map((s) => {
            const d = s.data ? new Date(s.data) : null;
            const dataLabel = d ? d.toLocaleDateString('pt-PT', fmtData) : '‚Äî';
            const hora = s.hora_inicio ? s.hora_inicio.slice(0, 5) : '--:--';
            const dur =
              s.duracao_min != null && s.duracao_min !== ''
                ? `${s.duracao_min} min`
                : '';
            const estado = s.estado || '';
            return `
              <li>
                <strong>${dataLabel}</strong> ¬∑ ${hora}
                ${dur ? ' ¬∑ ' + dur : ''} ‚Äî ${estado}
              </li>
            `;
          })
          .join('')}
      </ul>
    `;

    container.innerHTML = html;
  }

  // =========================
  // CALEND√ÅRIO MENSAL
  // =========================
  function initCalendarioEstadoInicial() {
    const hoje = new Date();
    CAL_ANO_ATUAL = hoje.getFullYear();
    CAL_MES_ATUAL = hoje.getMonth() + 1;

    const btnPrev = document.getElementById('calPrev');
    const btnNext = document.getElementById('calNext');

    btnPrev?.addEventListener('click', () => {
      CAL_MES_ATUAL--;
      if (CAL_MES_ATUAL === 0) {
        CAL_MES_ATUAL = 12;
        CAL_ANO_ATUAL--;
      }
      carregarCalendarioExplicacoes();
    });

    btnNext?.addEventListener('click', () => {
      CAL_MES_ATUAL++;
      if (CAL_MES_ATUAL === 13) {
        CAL_MES_ATUAL = 1;
        CAL_ANO_ATUAL++;
      }
      carregarCalendarioExplicacoes();
    });
  }

  async function carregarCalendarioExplicacoes() {
    const ul = document.getElementById('calList');
    const titulo = document.getElementById('calMesTitulo');
    if (!ul || !titulo) return;
    if (!window.ALUNO || !ALUNO.id_aluno) return;

    const nomesMeses = [
      'janeiro',
      'fevereiro',
      'mar√ßo',
      'abril',
      'maio',
      'junho',
      'julho',
      'agosto',
      'setembro',
      'outubro',
      'novembro',
      'dezembro',
    ];

    titulo.textContent =
      (nomesMeses[CAL_MES_ATUAL - 1] || CAL_MES_ATUAL) +
      ' de ' +
      CAL_ANO_ATUAL;

    ul.innerHTML = '<li>A carregar calend√°rio‚Ä¶</li>';

    const inicio = new Date(CAL_ANO_ATUAL, CAL_MES_ATUAL - 1, 1)
      .toISOString()
      .slice(0, 10);
    const fim = new Date(CAL_ANO_ATUAL, CAL_MES_ATUAL, 0)
      .toISOString()
      .slice(0, 10);

    const { data, error } = await supabase
      .from('sessoes_explicacao')
      .select('id_sessao, data, hora_inicio, duracao_min, estado')
      .eq('id_aluno', ALUNO.id_aluno)
      .gte('data', inicio)
      .lte('data', fim)
      .order('data', { ascending: true })
      .order('hora_inicio', { ascending: true });

    if (error) {
      console.error('Erro ao carregar calend√°rio', error);
      ul.innerHTML = '<li>Erro ao carregar sess√µes.</li>';
      return;
    }

    const sessoes = data || [];

    if (!sessoes.length) {
      ul.innerHTML = '<li>Sem explica√ß√µes neste m√™s.</li>';
      return;
    }

    ul.innerHTML = '';

    // agrupar por data
    const grupos = {};
    sessoes.forEach((s) => {
      if (!s.data) return;
      if (!grupos[s.data]) grupos[s.data] = [];
      grupos[s.data].push(s);
    });

    Object.keys(grupos)
      .sort()
      .forEach((dataStr) => {
        const d = new Date(dataStr);
        const dataLabel = d.toLocaleDateString('pt-PT', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
        });

        const li = document.createElement('li');
        li.innerHTML =
          `<strong>${dataLabel}</strong>` +
          '<ul>' +
          grupos[dataStr]
            .map((s) => {
              const hora = s.hora_inicio
                ? s.hora_inicio.slice(0, 5)
                : '--:--';
              const dur =
                s.duracao_min != null ? `${s.duracao_min} min` : '';
              const estado = s.estado || '';
              return `<li>${hora}${dur ? ' ¬∑ ' + dur : ''} ‚Äî ${estado}</li>`;
            })
            .join('') +
          '</ul>';
        ul.appendChild(li);
      });
  }

  // =========================
  // PAGAMENTOS (tabela)
  // =========================
  async function carregarResumoPagamentos() {
    const tbody = document.querySelector('#tabPag tbody');
    if (!tbody) return;

    if (!window.ALUNO || !ALUNO.id_aluno) {
      tbody.innerHTML =
        "<tr><td colspan='4'>Erro ao carregar pagamentos.</td></tr>";
      return;
    }

    tbody.innerHTML =
      "<tr><td colspan='4'>A carregar‚Ä¶</td></tr>";

    const { data, error } = await supabase
      .from('v_pagamentos_detalhe')
      .select('ano, mes, valor_previsto, valor_pago, estado')
      .eq('id_aluno', ALUNO.id_aluno)
      .order('ano', { ascending: true })
      .order('mes', { ascending: true });

    if (error) {
      console.error('Erro a carregar pagamentos do aluno', error);
      tbody.innerHTML =
        "<tr><td colspan='4'>Erro ao carregar pagamentos.</td></tr>";
      return;
    }

    const pag = data || [];
    if (!pag.length) {
      tbody.innerHTML =
        "<tr><td colspan='4'>Ainda n√£o existem pagamentos registados.</td></tr>";
      return;
    }

    tbody.innerHTML = pag
      .map((p) => {
        const mes = String(p.mes).padStart(2, '0');
        const labelMes = `${mes}/${p.ano}`;
        const previsto = Number(p.valor_previsto) || 0;
        const pago = Number(p.valor_pago) || 0;
        const estado = p.estado || '‚Äî';
        return `
          <tr>
            <td>${labelMes}</td>
            <td>${previsto.toFixed(2)} ‚Ç¨</td>
            <td>${pago.toFixed(2)} ‚Ç¨</td>
            <td>${estado}</td>
          </tr>
        `;
      })
      .join('');
  }
</script>


<!-- Toast / feedback visual -->
<div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>
<!-- script com a l√≥gica de agenda/pagamentos/exerc√≠cios/password -->
<script src="./public/js/pages/aluno.js"></script>
</body>
</html>
