<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="./styles.css"/>
  <title>EduSphere â€” Ãrea do Aluno</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./public/js/supabaseClient.js"></script>
  <script src="./public/js/auth.js"></script>
</head>
<body class="home">
<header>
  <div class="header-inner">
    <a class="logo" href="./index.html"><img src="/public/img/logo-icon.svg" alt=""><span>EduSphere</span></a>
    <button id="btnLogout" class="button" style="margin-left:auto">Sair</button>
  </div>
</header>
<div class="capa__overlay"></div>

<main class="auth">
  <section class="auth__panel">
    <h1>Bem-vindo ğŸ‘‹</h1>
    <p id="alunoInfo">A carregarâ€¦</p>

    <div class="card">
      <h2>PrÃ³ximas explicaÃ§Ãµes</h2>
      <p>(Brevemente)</p>
    </div>

    <div class="card">
      <h2>Pagamentos</h2>
      <p>(Brevemente)</p>
    </div>
  </section>
</main>

<footer>Â© <span id="y"></span> EduSphere</footer>
<script>
document.getElementById('y').textContent = new Date().getFullYear();
document.getElementById('btnLogout')?.addEventListener('click', ()=> Auth.signOut('./index.html'));

(async ()=>{
  const user = await Auth.requireRole('aluno', './login.html'); 
  if(!user) return;

  const { data: map, error: mapErr } = await supabase
    .from('app_users')
    .select('ref_id')
    .eq('user_id', user.id)
    .single();

  console.log('DEBUG app_users map', { map, mapErr });

  const { data: aluno, error: alunoErr } = await supabase
    .from('alunos')
    .select('id, nome, apelido, ano_escolaridade')   // <â€“ aqui vamos ver se alguma coluna estÃ¡ errada
    .eq('id', map.ref_id)
    .single();

  console.log('DEBUG aluno', { aluno, alunoErr });

  if (alunoErr) {
    console.error('Erro a carregar aluno', alunoErr);
  }

  const t = aluno
    ? `${aluno.nome} ${aluno.apelido ?? ''} â€” Ano ${aluno.ano_escolaridade ?? 'n/d'}`
    : 'Perfil nÃ£o encontrado';

  document.getElementById('alunoInfo').textContent = t;
})();
</script>

</body>
</html>
